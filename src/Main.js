import{a as n0,b as ht}from"../chunks/chunk-B3G4DJQ2.js";var ee=90*Math.PI/180,F0=ee*.5,ut=.01,mt=.01,v=15,wt=1.4,u0=.95,c0=.6,S0="#101b2e",m0=5,l0=10,pt=3.33;var Gt=0,gt=0;var z=document.getElementById("view"),p=z.getContext("2d");p.imageSmoothingEnabled=!1;u0&&u0!==1&&(z.width=Math.max(1,Math.round(z.width*u0)),z.height=Math.max(1,Math.round(z.height*u0)));var y=z.width,M=z.height,N=document.getElementById("mini"),I=N.getContext("2d");I.imageSmoothingEnabled=!1;var bt=document.getElementById("hpBar"),xt=document.getElementById("ammoBar"),yt=document.getElementById("hpText"),Mt=document.getElementById("ammoText"),St=document.getElementById("msg"),Et=document.getElementById("btnReset"),Bt=document.getElementById("btnToggleMap");var c={x:3.5,y:3.5,a:0,speed:2,rotSpeed:2.6,health:6,maxHealth:6,ammo:1,hasBlueKey:!1,tenacity:20,maxTenacity:20},I0=.2,Q=1,Ct=1,oe=99;function k0(e){Q=Math.max(Ct,Math.min(oe,e|0||Ct))}function E0(){let e=Math.cos(c.a),t=Math.sin(c.a),o=-t*Math.tan(F0),n=e*Math.tan(F0),a=1/(o*t-e*n);return{dirX:e,dirY:t,planeX:o,planeY:n,invDet:a}}function a0(e=64,t=64){let o=document.createElement("canvas");return o.width=e,o.height=t,o}function j(e,t){let o=parseInt(e.slice(1),16),n=o>>16&255,a=o>>8&255,r=o&255,i=s=>n0(((s/255)**2.2+t)*255,0,255)|0;return`#${(i(n)<<16|i(a)<<8|i(r)).toString(16).padStart(6,"0")}`}function w0(e,t,o,n){let a=(o*e.width+t)*4,r=parseInt(n.slice(1),16);e.data[a]=r>>16&255,e.data[a+1]=r>>8&255,e.data[a+2]=r&255,e.data[a+3]=255}function ne(){let e=a0(),t=e.getContext("2d"),o=e.width,n=e.height,a=t.createImageData(o,n),r=["#7a7a7a","#8a8a8a","#9a9a9a","#6a6a6a"];for(let i=0;i<n;i++)for(let s=0;s<o;s++){let f=i%16===15||s%16===15,l=(Math.sin(s*.18)+Math.cos(i*.12))*.06,u=f?"#222222":r[(Math.floor(s/16)+Math.floor(i/16))%r.length];w0(a,s,i,j(u,l))}return t.putImageData(a,0,0),e}function ae(){let e=a0(),t=e.getContext("2d"),o=e.width,n=e.height,a=t.createImageData(o,n);for(let r=0;r<n;r++)for(let i=0;i<o;i++){let s=i%32===0||r%16===0,f=(Math.sin(i*.12)+Math.cos(r*.17))*.07+(((i^r)&7)/128-.03),u=j(s?"#2a2a2a":"#6a6f73",f);(i*13+r*7)%97===0&&(u=j(u,-.25)),w0(a,i,r,u)}return t.putImageData(a,0,0),e}function re(){let e=a0(),t=e.getContext("2d"),o=e.width,n=e.height,a=t.createImageData(o,n);for(let r=0;r<n;r++)for(let i=0;i<o;i++){let s=Math.sin((i+r)*.18)*.1+Math.cos((i-r)*.14)*.08,f=((i^r<<1)&15)/255-.02,l=j("#2e6a2e",s+f);((i+r*2)%13===0||(i*3-r)%29===0)&&(l=j(l,-.18)),(i*5+r*7)%101===0&&(l=j(l,.18)),w0(a,i,r,l)}return t.putImageData(a,0,0),e}function At(e="#5b4b2a"){let t=a0(),o=t.getContext("2d"),n=t.width,a=t.height,r=o.createImageData(n,a);for(let i=0;i<a;i++)for(let s=0;s<n;s++){let f=Math.sin(s*.22+Math.cos(i*.05)*.4)*.08+Math.sin(i*.07)*.02;w0(r,s,i,j(e,f))}o.putImageData(r,0,0),o.fillStyle="#3a3a3a",o.fillRect(0,18,n,4),o.fillRect(0,42,n,4),o.fillStyle="#6a6a6a";for(let i=6;i<n;i+=12)o.fillRect(i,19,2,2),o.fillRect(i,43,2,2);return o.strokeStyle="#444",o.lineWidth=2,o.beginPath(),o.arc(46,32,4,0,Math.PI*2),o.stroke(),t}function ie(){let e=a0(),t=e.getContext("2d"),o=e.width,n=e.height;t.fillStyle="#1f1f24",t.fillRect(0,0,o,n);let a=o/2,r=n/2,i=t.createRadialGradient(a,r,4,a,r,28);i.addColorStop(0,"#74CCEA"),i.addColorStop(.5,"#20B2DB"),i.addColorStop(1,"#FFE300"),t.fillStyle=i,t.beginPath(),t.arc(a,r,26,0,Math.PI*2),t.fill(),t.strokeStyle="rgba(255,255,255,0.25)";for(let s=0;s<6;s++){t.beginPath();let f=8+s*3;t.arc(a,r,f,s*.6,s*.6+Math.PI*1.2),t.stroke()}return t.strokeStyle="#3a3a3a",t.lineWidth=4,t.beginPath(),t.arc(a,r,28,0,Math.PI*2),t.stroke(),e}function se(){let e=At("#6a4a2a"),t=e.getContext("2d");t.fillStyle="#103b5f",t.fillRect(28,8,8,48),t.fillStyle="#74c8ff";for(let o=12;o<52;o+=8)t.fillRect(30,o,4,2);return e}function ce(){let e=a0(),t=e.getContext("2d"),o=e.width,n=e.height,a=t.createImageData(o,n),r=(d,h,m)=>{let G=parseInt(d.slice(1),16),b=parseInt(h.slice(1),16),E=G>>16&255,B=G>>8&255,x=G&255,R=b>>16&255,C=b>>8&255,P=b&255,A=E+(R-E)*m|0,_=B+(C-B)*m|0,F=x+(P-x)*m|0;return`#${(A<<16|_<<8|F).toString(16).padStart(6,"0")}`},i=1337,s=()=>(i=i*1664525+1013904223>>>0)/4294967295,f=[];for(let d=0;d<7;d++)f.push({x:6+s()*(o-12),y:6+s()*(n-12),r:5+s()*9});let l=[];for(let d=0;d<4;d++){let h=s()*o,m=s()*n,G=s()*Math.PI*2,b=20+s()*28,E=h+Math.cos(G)*b,B=m+Math.sin(G)*b,x=2+s()*2.5;l.push({sx:h,sy:m,ex:E,ey:B,rad:x})}let u=(d,h,m,G,b,E)=>{let B=b-m,x=E-G,R=d-m,C=h-G,P=B*B+x*x||1,A=(R*B+C*x)/P;A=A<0?0:A>1?1:A;let _=m+A*B-d,F=G+A*x-h;return Math.sqrt(_*_+F*F)};for(let d=0;d<n;d++)for(let h=0;h<o;h++){let m=Math.sin(h*.23)*.07+Math.cos(d*.19)*.06,G=Math.sin((h+d)*.09)*.05+Math.cos((h-d)*.08)*.04,b=Math.sin(h*.6+d*.15)*.02+Math.cos(h*.2-d*.5)*.015,E=((h*31^d*17)&31)/255-.03,B=m+G+b,x="#FE6660",R=0;for(let g=0;g<f.length;g++){let $=h-f[g].x,e0=d-f[g].y,b0=Math.sqrt($*$+e0*e0);b0<f[g].r&&(R=Math.max(R,1-b0/f[g].r))}R>0&&(x=r(x,"#f3e08a",Math.min(.45,R*.6)));let C=0;for(let g=0;g<l.length;g++){let $=u(h,d,l[g].sx,l[g].sy,l[g].ex,l[g].ey),e0=1-Math.min(1,$/l[g].rad);e0>0&&(C=Math.max(C,e0))}C>0&&(x=r(x,"#f3d37a",Math.min(.5,C*.8)));let A=(h*13+d*29)%211===0||(h+d*5&63)===7?-.3:0,_=(h*7-d*11)%197===0?.16:0,F=B+E+A+_;w0(a,h,d,j(x,F))}t.putImageData(a,0,0),t.globalAlpha=.5,t.strokeStyle="#9F0000",t.lineWidth=1;for(let d=0;d<10;d++){t.beginPath();let h=2+d*8;t.moveTo(2,h);for(let m=2;m<o-2;m+=8){let G=h+Math.sin((m+d*7)*.4)*3+(d%2?2:-2);t.lineTo(m,G)}t.stroke()}return t.globalAlpha=1,t.strokeStyle="#7E1A09",t.lineWidth=2,t.strokeRect(1,1,o-2,n-2),e}var le=[null,ne(),ae(),re(),At(),ie(),se(),ce()],f0=[...le];function vt(e){let o=e.getContext("2d").getImageData(0,0,e.width,e.height),n=[];for(let a=0;a<e.width;a++){let r=new Uint8ClampedArray(e.height*4);for(let i=0;i<e.height;i++){let s=(i*e.width+a)*4,f=i*4;r[f]=o.data[s],r[f+1]=o.data[s+1],r[f+2]=o.data[s+2],r[f+3]=o.data[s+3]}n.push({data:r,h:e.height})}return{cols:n,w:e.width,h:e.height}}var W=f0.map(e=>e?vt(e):null);function fe(){W.length=0,f0.forEach(e=>{W.push(e?vt(e):null)})}async function de(e){let t=`../assets/gfx/${e}`;return new Promise((o,n)=>{let a=new Image;a.onload=()=>{let r=a0(64,64),i=r.getContext("2d");i.imageSmoothingEnabled=!1,i.drawImage(a,0,0,64,64),o(r)},a.onerror=()=>n(new Error(`Failed to load texture: ${t}`)),a.src=t})}async function Tt(){try{let e=await he();f0[1]=e,fe()}catch(e){console.warn("Failed to init backrooms wallpaper:",e)}}async function he(){return await de("backrooms_wallpaper.jpg")}var V={x:10,y:8},J={x:3.5,y:3.5},w={MAP:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,2,6,2,0,0,0,0,0,0,0,2,6,2,0,0,1],[1,0,0,0,2,0,2,0,0,0,0,0,0,0,2,0,2,0,0,1],[1,0,0,0,2,2,2,0,0,0,0,0,0,0,2,2,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,5,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,3,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,3,3,1,3,3,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,0,0,0,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,2,2,2,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,1,0,2,0,2,0,1,0,3,0,0,0,1],[1,0,0,0,0,0,0,0,0,2,6,2,0,0,0,0,0,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],MAP_W:-1,MAP_H:-1,cielingColorFront:"",floorColorFront:"",cielingColorBack:"",floorColorBack:""},p0=[{name:"Village",mapLayout:[[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,1,1,1,1,1,1,6,6,1,1,1,1,1,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3]],exitPos:{x:10,y:12},startPos:{x:9.5,y:1.5}},{name:"TowerFloor1",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,1,1,1,1,1,0,0,1,1,1,1,1,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,3,3,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,3,3,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,1,6,6,1,1,0,0,1,1,6,6,1,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,1,1,1,1,1,6,6,1,1,1,1,1,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,1,1,1,1,1,1,0,0,0,1,0,0,1],[1,0,0,1,1,1,1,1,0,0,0,0,1,1,1,1,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,4,4,1,1,1,1,1,1,1,1,1]],exitPos:{x:10,y:17},startPos:{x:5.5,y:4.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#000000",floorColorBack:"#000000"},{name:"Gallery",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,4,4,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,0,0,0,3,1],[1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,3,1,0,0,0,0,0,1],[1,1,0,0,0,7,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,2,0,0,1],[1,1,1,7,1,1,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0,0,2,0,0,1],[1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,0,0,2,0,0,1],[1,1,0,0,0,3,0,0,0,0,0,3,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,3,0,0,0,0,0,3,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,3,0,0,0,0,0,3,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,3,0,0,0,0,0,3,0,0,0,1,0,0,2,0,0,1],[1,1,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,0,0,2,0,0,1],[1,0,2,2,2,2,2,2,2,2,2,0,1,0,1,0,1,0,1,0,0,2,0,0,1],[4,0,2,2,2,2,2,2,2,2,2,0,6,0,6,0,6,0,6,0,0,2,0,0,1],[1,0,2,2,2,2,2,2,2,2,2,0,1,0,1,0,1,0,1,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,3,0,0,0,3,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],exitPos:{x:3,y:3},startPos:{x:1.5,y:21.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#ECDE60",floorColorBack:"#000000"},{name:"LongHallways",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,1,0,0,0,0,0,0,3,3,3,3,3,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,1,0,0,0,0,0,3,3,3,3,3,3,3,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,3,3,3,0,0,0,3,3,3,0,0,0,0,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,3,3,3,3,0,4,0,3,3,3,3,0,0,0,1,1,1],[1,7,7,1,1,6,1,1,1,6,1,1,1,6,1,1,1,6,1,1,0,0,3,3,3,3,3,0,0,0,3,3,3,3,3,0,0,1,1,1],[1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,0,1],[1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,6,0,1],[1,7,7,1,1,6,1,1,1,1,1,1,1,1,1,1,1,6,1,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,0,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,2,2,0,2,2,2,2,6,2,2,2,2,0,2,2,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,3,0,0,0,0,0,3,2,0,0,0,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,0,3,3,3,3,3,0,3,3,3,3,3,0,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,1,0,0,0,0,3,3,3,3,0,3,3,3,3,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,2,3,0,0,0,0,0,3,2,0,0,0,1,0,0,0,0,0,3,3,3,0,3,3,3,0,0,0,0,0,1,1,1],[1,7,7,1,2,2,0,2,2,2,2,6,2,2,2,2,0,2,2,1,0,0,0,0,0,0,3,3,0,3,3,0,0,0,0,0,0,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,1,1,1,1,1,1,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1],[1,7,7,1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,1,1,1],[1,7,7,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1],[1,7,7,1,0,0,6,0,3,3,3,3,3,3,3,3,3,3,3,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,1,1,1],[1,7,7,1,0,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,3,3,3,3,3,3,3,3,3,3,3,0,4,0,0,1,1,1],[1,7,7,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1],[1,7,7,1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,1,1,1],[1,7,7,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7,0,0,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,1,1],[1,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],exitPos:{x:1,y:1},startPos:{x:9.5,y:3.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#000000",floorColorBack:"#000000"}];var Z=new Float32Array(y);function ue(e,t,o,n,a,r,i,s){let f=n-o;if(f<=0)return;let l=(s||a.h)/f,u=i||0,d=e.createImageData(1,f);for(let h=0;h<f;h++){let m=Math.floor(u)*4|0;u+=l,d.data[h*4]=a.data[m]*r|0,d.data[h*4+1]=a.data[m+1]*r|0,d.data[h*4+2]=a.data[m+2]*r|0,d.data[h*4+3]=255}e.putImageData(d,t,o)}function me(e,t,o,n,a,r,i,s,f){let l=n-o;if(l<=0)return;e.save(),e.imageSmoothingEnabled=!1;let u=Math.max(0,Math.min(a.height,s||0)),d=Math.max(0,Math.min(a.height-u,f||a.height));if(e.drawImage(a,r,u,1,d,t,o,1,l),i<.999){let m=Math.max(0,Math.min(1,i))*255|0;e.globalCompositeOperation="multiply",e.fillStyle=`rgb(${m},${m},${m})`,e.fillRect(t,o,1,l)}e.restore()}function Rt(e,t,o,n,a){let{dirX:r,dirY:i,planeX:s,planeY:f}=t,l=p.createLinearGradient(0,0,0,M/2);l.addColorStop(0,w.cielingColorFront||"#6495ED"),w.cielingColorBack&&l.addColorStop(.5,w.cielingColorBack||"#6495ED"),l.addColorStop(.9,S0),p.fillStyle=l,p.fillRect(0,0,y,M/2);let u=p.createLinearGradient(0,M,0,M/2);u.addColorStop(0,w.floorColorFront||"#054213"),u.addColorStop(.85,w.floorColorBack||"#03210A"),u.addColorStop(.95,S0),p.fillStyle=u,p.fillRect(0,M/2,y,M/2);let d=p.createLinearGradient(0,0,0,M);d.addColorStop(0,"rgba(16,27,46,0.08)"),d.addColorStop(.5,"rgba(16,27,46,0.16)"),d.addColorStop(1,"rgba(16,27,46,0.20)"),p.save(),p.fillStyle=d,p.fillRect(0,0,y,M),p.restore();for(let h=0;h<y;h++){let m=2*(h+.5)/y-1,G=r+s*m,b=i+f*m,E=c.x|0,B=c.y|0,x=Math.abs(1/(G||1e-9)),R=Math.abs(1/(b||1e-9)),C,P,A,_;G<0?(C=-1,A=(c.x-E)*x):(C=1,A=(E+1-c.x)*x),b<0?(P=-1,_=(c.y-B)*R):(P=1,_=(B+1-c.y)*R);let F=0,g=1,$=!1,e0=0,b0=0;for(;!$&&e0++<256;){if(A<_?(A+=x,E+=C,F=0):(_+=R,B+=P,F=1),v>0){let M0=Math.min(A,_);if(M0>v){$=!1,g=0,b0=M0;break}}if(E<0||B<0||E>=n||B>=a){$=!0,g=1;break}let o0=o[B][E];if(o0>0){$=!0,g=o0;break}}if(g===0){Z[h]=Number.POSITIVE_INFINITY;continue}let X;F===0?X=A-x:X=_-R,X=Math.max(ut,X);let nt=0,jt=F===0?C:0,Jt=F===1?P:0,at=Math.abs(jt*r+Jt*i)>=.9&&Math.abs(m)<=.9&&X<nt?nt:X,rt=c.x+at*G,it=c.y+at*b,h0;F===0?h0=it-Math.floor(it):h0=rt-Math.floor(rt),h0=Math.min(.999999,Math.max(0,h0+1e-6));let v0=g===1?W[1]:g===2?W[2]:g===3?W[3]:g===5?W[5]:g===6?W[6]:g===7?W[7]:W[4],i0=f0[g],x0=i0?i0.width|0:v0.w|0,K=Math.floor(h0*x0)|0;(F===0&&C>0||F===1&&P<0)&&(K=x0-K-1),K<0&&(K=0),K>=x0&&(K=x0-1);let Zt=Math.max(mt,X),y0=M/Zt|0,Qe=M*wt|0,T0=(M-y0)/2|0,te=T0+y0,U=T0,s0=te;U<0&&(U=0),s0>M&&(s0=M);let st=s0-U;if(st<=0){Z[h]=X;continue}let ct=(i0?i0.height:v0.h||f0[g]?.height||64)|0,lt=(U-T0)*(ct/Math.max(1,y0)),ft=st*(ct/Math.max(1,y0)),R0=1/(1+X*.25)*(F?.5:1);if(g===7&&(R0*=.8+.2*Math.sin(e*6+h*.05)),i0)me(p,h,U,s0,i0,K,R0,lt,ft);else{let o0=v0.cols[K];ue(p,h,U,s0,o0,R0,lt,ft)}if(v>0&&X>v*c0){let o0=v*c0,M0=v,dt=Math.min(1,Math.max(0,(X-o0)/Math.max(1e-6,M0-o0)));dt>0&&(p.save(),p.globalAlpha=dt*.85,p.fillStyle=S0,p.fillRect(h,U,1,s0-U),p.restore())}Z[h]=X}}function we(e){return M/e}function pe(e,t,o){let{dirY:n,dirX:a,planeY:r,planeX:i,invDet:s}=o,f=s*(n*e-a*t),l=s*(-r*e+i*t);return{transX:f,transY:l}}function Ge(e,t){return Math.round((y>>1)*(1+e/t))}function ge(e,t=0,o=.5){let n=t*100,i=(M>>1)+(e>>1)+(n|0),s=i-e;return s<0&&(s=0),{startY:s,endY:i}}function be(e){let o=(M>>1)-(e>>1);o<0&&(o=0);let n=o+e;return{startY:o,endY:n}}function B0(e,t){let o=e.x-c.x,n=e.y-c.y,{transX:a,transY:r}=pe(o,n,t);if(r<=.01)return null;let i=Ge(a,r),s=e&&typeof e.scale=="number"?e.scale:e&&e.img&&typeof e.img.scale=="number"?e.img.scale:1,f=we(r)*s,l=typeof e._hR=="number"?e._hR:Math.round(f),u=.1,d=l;(f>l+u||f<l-u)&&(d=Math.round(f)),e._hR=d;let h=d,m=e.img,G=m&&m.width&&m.height?m.width/m.height:1,b=Math.max(1,Math.round(h*G)),E=h/M,B=(e.floorBias??0)*s*E,x=Math.min(.9,Math.max(.2,s)),R=e.ground?ge(h,B,x):be(h),C=Math.round(i-(b>>1)),P=C+b;return{drawStartX:C,drawEndX:P,drawStartY:R.startY,drawEndY:R.endY,depth:r,size:h,width:P-C}}function G0(e,t,o=1){let n=e.trim().split(`
`).map(d=>d.replace(/\s+/g,"")),a=n.length-1;for(;a>=0&&n[a].split("").every(d=>d===".");)a--;a>=0&&a<n.length-1&&(n=n.slice(0,a+1));let r=n.length,i=n[0].length,s=1,f=document.createElement("canvas");f.width=i,f.height=r;let l=f.getContext("2d");l.imageSmoothingEnabled=!1;let u=l.createImageData(i,r);for(let d=0;d<r;d++)for(let h=0;h<i;h++){let m=n[d][h],G=(d*i+h)*4;if(m==="."){u.data[G+3]=0;continue}let b=t[m]||"#ffffff",E=parseInt(b.slice(1),16);u.data[G]=E>>16&255,u.data[G+1]=E>>8&255,u.data[G+2]=E&255,u.data[G+3]=255}if(l.putImageData(u,0,0),o!==1){let d=document.createElement("canvas");d.width=i*o,d.height=r*o;let h=d.getContext("2d");return h.imageSmoothingEnabled=!1,h.drawImage(f,0,0,d.width,d.height),d.baseline=s,d.scale=o,d}return f.baseline=s,f.scale=1,f}async function xe(e,t){return await ye(e,t,1)}async function ye(e,t=1,o=1){let n=`../assets/gfx/${e}`;return new Promise((a,r)=>{let i=new Image;i.onload=()=>{let s=document.createElement("canvas"),f=i.width,l=i.height;s.width=f*t,s.height=l*t;let u=s.getContext("2d");u.imageSmoothingEnabled=!1,u.drawImage(i,0,0,s.width,s.height),s.baseline=o,s.scale=t,a(s)},i.onerror=()=>r(new Error(`Failed to load sprite: ${n}`)),i.src=n})}var Me={B:"#2c1810",b:"#5c3d2e",g:"#7a6b5c",G:"#a89080",k:"#080508",w:"#e8e0d5",W:"#f5f0e8",r:"#8b4513",y:"#ffeb9c"},D0=G0(`
  ................................
  ..............BB..BB............
  .............BbbbbbbB...........
  ...........BbbbGGGGbbbB.........
  ..........BbbbGGGGGGbbbB........
  .........BbbGGGGGGGGGGbbB.......
  ........BbbGGGgGGGGgGGbbB.......
  ........BbbGGgGyyGgGGGbbB.......
  .......BbbGGGGGGGGGGGGbbB.......
  .......BbbGGGGGGGGGGGGbbB.......
  ......BbbGGGGGGGGGGGGGGbbB......
  ......BbbGGGGgGGGGgGGGGbbB......
  ......BbbGGGGwwwwwwGGGGbbB......
  .....BbbGGGwwwWWkWWwwwGGbbB.....
  .....BbbGGGwwwwkkwwwwGGbbB......
  .....BbbGGGwwwwrwwwwGGGbbB......
  .....BbbGGGwwwwwwwwwGGGbbB......
  .....BbbGGGGwwwwwwwGGGGbbB......
  .....BbbGGGGGGGGGGGGGGGbbB......
  .....BbbGGGGGGGGGGGGGGGbbB......
  ......BbbGGGGGGGGGGGGGbbB.......
  ......BbbGGGGGGGGGGGGGbbB.......
  .......BBbbbgggGGGGgggbbBB......
  ........BBBbbbbbbbbbbbbBBB......
  ................................
  `,Me,4),Se={k:"#0a0f10",g:"#1b5c3a",G:"#2e874f",s:"#7fffd4",b:"#0e1620"},P0=G0(`
  ............
  ....bbbb....
  ..bbGGGGbb..
  .bGGGGGGGGb.
  .bGGgGGgGGb.
  .bGGGGGGGGb.
  .bGgGGGGgGb.
  .bGGGGGGGGb.
  .bGGgGGgGGb.
  .bGGGGGGGGb.
  .bGgGGGGgGb.
  .bGGGGGGGGb.
  .bGGgGGgGGb.
  .bGGGGGGGGb.
  .bGGgGGgGGb.
  .bGGGGGGGGb.
  ..bbGGGGbb..
  ....bbbb....
  ............
  ............
  `,Se,3),_0=await xe("apple.png",3),Ee={k:"#5a4500",g:"#FFD700",G:"#FFA500",s:"#FFF5CC",b:"#4169E1",B:"#87CEEB"},L0=G0(`
  ................
  .....B....B.....
  ....BBBBBBBB....
  ...BBbBBbBBB....
  ...BBbgBgbBB....
  ....BBgggBB.....
  .....kGGGk......
  ....kGGsGGk.....
  ...kGGGGGGGk....
  ...kGGGGGGGk....
  ....kGGGGGk.....
  .....kGGGk......
  .......GG.......
  .......GG.......
  .....GGGGGG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GGggGG.....
  `,Ee,4),Be={b:"#100904",d:"#8f715b",f:"#5a3b1a",r:"#DC143C",s:"#000000",w:"#4d260a"},H0=G0(`
  ............r...
  ............rr..
  ...........w..r.
  .......sb.w...rr
  .......bdw...w..
  .......sfd..w...
  ......sfffdw....
  .....sfffffdb...
  ....sfbffffss...
  ...sfbfbffs.....
  ..sfbfbfbs......
  .sfbfbfbs.......
  .sffbfbs........
  ..sffbs.........
  ...sss..........
  ................
  `,Be,3),Ce={b:"#5a3b1a",f:"#B8860B",r:"#DC143C",s:"#C0C0C0",w:"#8B4513"},C0=G0(`
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ........................................................w.......
  ......................................................sww.......
  ..................................................wwwwws........
  ...............................................wwwwwwww.s.......
  ..............................................wwwwww....s.......
  ...........................................wwwwwww......s.......
  ...........................................wwwww........s.......
  ..........................................wwwww..........s......
  .........................................wwwww...........s......
  ........................................wwwwww...........s......
  ........................................wwwww............s......
  .......................................wwwww.............s......
  .......................................wwwww.............s......
  .......................................wwww...............s.....
  ......................................wwwww...............s.....
  ......................................wwww................s.....
  .....................................wwwww................s.....
  .....................................wwwww................s.....
  .....................................wwww.................s.....
  .....................................wwww.................s.....
  ....................................wwwww.................s.....
  ....................................wwww..................s.....
  ....................................wwww..................s.....
  ..............................ssss.wwwww..................s.....
  ..............................sss..wwww...................s.....
  ..............................s.bb.wwww....................s....
  ..............................s..bbwwww....................s....
  ..................................bwwww....................s....
  ..................................bbwww....................s....
  ...................................bbww....................s....
  ..................................wwbbww...................s....
  ..................................wwwbbb....................s...
  ..................................wwwwwbb...................s...
  ...................................wwwwwbb..................s...
  ....................................wwww.bb.................s...
  ....................................wwww..bbb...............s...
  ....................................wwww....bb..............s...
  ....................................wwww.....bb..............s..
  ....................................wwww......bb.............s..
  ...................................wwwww.......bb............s..
  ..................................wwwwww........bbb..........s..
  ..................................wwwwww.........bbb.........ss.
  ..................................wwwwww...........bbrrrrr....s.
  ..................................wwwwww...........fbbbrrrr...s.
  ...................................wwwww...........ffffbbrrr..s.
  ...................................wwwwww...........ffffbbrrr.s.
  ...................................wwwwww...........ffffffbb.ss.
  ...................................wwwwww.............ffff.bbbs.
  ...................................wwwwwww..............ff...bs.
  `,Ce,3),k=[];function Ft(e){I.clearRect(0,0,N.width,N.height);let t=8;N.width=2+w.MAP_W*t+2,N.height=2+w.MAP_H*t+2;for(let a=0;a<w.MAP_H;a++)for(let r=0;r<w.MAP_W;r++){let i=w.MAP[a][r],s="#0c1220";i===1?s="#ECDE60":i===2?s="#707a88":i===3?s="#00e676":i===4?s="#996633":i===5?s="#FFE300":i===6?s=" #3561ff":i===7&&(s="#FE6660"),I.fillStyle=s,I.fillRect(2+r*t,2+a*t,t-1,t-1)}for(let a of e)a.alive&&(I.fillStyle=a.type==="demon"?"#ff6a6a":a.type==="barrel"?"#57d694":a.type==="key"?"#6aa2ff":a.type==="med"?"#f5f1c9":a.type==="ammo"?"#9cf58d":"#ffffff",I.fillRect(2+a.x*t-2,2+a.y*t-2,4,4));I.fillStyle="#e7f3ff",I.beginPath(),I.arc(2+c.x*t,2+c.y*t,2.5,0,ht),I.fill();let o=Math.cos(c.a),n=Math.sin(c.a);I.strokeStyle="#78f3d3",I.beginPath(),I.moveTo(2+c.x*t,2+c.y*t),I.lineTo(2+(c.x+o*1.5)*t,2+(c.y+n*1.5)*t),I.stroke()}function It(e){if(!Array.isArray(e)||e.length===0)throw new Error("Array must be non-empty.");let t=D(e.length)-1;return e[t]}function D(e){if(e<=0)throw new Error("The maximum value must be greater than 0.");return Math.floor(Math.random()*e)+1}var S=null,r0=null,H=null,O0=null,kt=null;function Y0(){S||(S=new(window.AudioContext||window.webkitAudioContext))}function L({freq:e=440,dur:t=.1,type:o="square",vol:n=.2,slide:a=0}){if(!S)return;let r=S.createOscillator(),i=S.createGain();r.type=o,r.frequency.value=e,i.gain.value=n,r.connect(i).connect(S.destination);let s=S.currentTime;a&&(r.frequency.setValueAtTime(e,s),r.frequency.linearRampToValueAtTime(e+a,s+t)),i.gain.setValueAtTime(n,s),i.gain.exponentialRampToValueAtTime(.001,s+t),r.start(s),r.stop(s+t)}function X0({dur:e=.2,vol:t=.2,lp:o=1200}){if(!S)return;let n=S.createBuffer(1,S.sampleRate*e,S.sampleRate),a=n.getChannelData(0);for(let l=0;l<a.length;l++)a[l]=Math.random()*2-1;let r=S.createBufferSource(),i=S.createGain(),s=S.createBiquadFilter();r.buffer=n,i.gain.value=t,s.type="lowpass",s.frequency.value=o,r.connect(s).connect(i).connect(S.destination);let f=S.currentTime;r.start(f),r.stop(f+e)}var Y={shot:()=>{let e=D(50),t=-D(50);L({freq:220+e+t,dur:.05+D(3)/100,type:"square",vol:.25,slide:120}),X0({dur:.03+D(3)/100,vol:.15,lp:800})},pickup:()=>{L({freq:880,dur:.06,type:"triangle",vol:.2}),L({freq:1180,dur:.08,type:"triangle",vol:.18})},explode:()=>{X0({dur:1,vol:.3,lp:800}),L({freq:90,dur:.7,type:"sawtooth",vol:.12,slide:-60})},hurt:()=>{L({freq:140,dur:.12,type:"sawtooth",vol:.2,slide:-50})},killedDrone:()=>{let e=Math.random()*16-8;L({freq:320+e,dur:.26,type:"triangle",vol:.3,slide:-220}),L({freq:480+e,dur:.22,type:"sawtooth",vol:.1,slide:-260}),L({freq:90,dur:.08,type:"sine",vol:.18}),X0({dur:.05,vol:.1,lp:1e3}),setTimeout(()=>{L({freq:170+e,dur:.07,type:"triangle",vol:.16,slide:70})},90)},door:()=>{L({freq:420,dur:.12,type:"square",vol:.15})},portal:()=>{L({freq:600,dur:.5,type:"sawtooth",vol:.2}),L({freq:400,dur:.3,type:"sawtooth",vol:.2,slide:50}),L({freq:600,dur:.5,type:"sawtooth",vol:.2})}};async function Ae(e,{volume:t=.15}={}){if(S)try{if(!O0||e!==kt){let n=await(await fetch(e,{cache:"force-cache"})).arrayBuffer();O0=await S.decodeAudioData(n),kt=e}Dt(),H=S.createBufferSource(),H.buffer=O0,H.loop=!0,r0=S.createGain(),r0.gain.value=t,H.connect(r0).connect(S.destination),H.start()}catch(o){try{Dt();let n=new Audio(e);n.loop=!0,n.volume=Math.max(0,Math.min(1,t)),await n.play(),H={stop:()=>n.pause(),disconnect:()=>{}},r0=null}catch(n){}}}function Dt(){try{H&&H.stop(0)}catch(e){}if(H&&H.disconnect)try{H.disconnect()}catch(e){}if(r0)try{r0.disconnect()}catch(e){}H=null,r0=null}var Pt=!1;async function N0(){if(!S||H||Pt)return;Pt=!0,await Ae("../assets/sfx/HexenST02SLowed.ogg",{volume:.12})}function t0(e,t){if(e<0||t<0||e>=w.MAP_W||t>=w.MAP_H)return!0;let o=w.MAP[t|0][e|0];return o===0||o===5?!1:o===7?!c.hasBlueKey:o!==6}function W0(e,t,o){return!!(t0(e,t)||t0(e-o,t)||t0(e+o,t)||t0(e,t-o)||t0(e,t+o))}var V0=0,O=new Set,q0=!1,$0=0,z0=!1;function Ht(e){window.addEventListener("keydown",t=>{O.add(t.code),Y0(),N0(),t.code==="Space"&&(t.preventDefault(),_t()),t.code==="KeyM"&&(t.preventDefault(),N.classList.toggle("visible"))}),window.addEventListener("keyup",t=>O.delete(t.code)),e.addEventListener("mousedown",t=>{t.button===0&&_t(),q0=!0,$0=t.clientX,Y0(),N0()}),window.addEventListener("mouseup",()=>q0=!1),window.addEventListener("mousemove",t=>{if(q0){let o=t.clientX-$0;$0=t.clientX,c.a+=o*.0035}}),Et.onclick=()=>ke(),Bt.onclick=()=>N.classList.toggle("visible")}function Ot(e){let t=O.has("ShiftLeft")||O.has("ShiftRight"),o=c.speed*(t?2:1)*e,n=c.rotSpeed*e,a=Math.cos(c.a),r=Math.sin(c.a),i=-r,s=a,f=0,l=0;O.has("ArrowLeft")&&(c.a-=n),O.has("ArrowRight")&&(c.a+=n),O.has("ArrowUp")&&(f+=a*o,l+=r*o),O.has("ArrowDown")&&(f-=a*o,l-=r*o),O.has("KeyW")&&(f+=a*o,l+=r*o),O.has("KeyS")&&(f-=a*o,l-=r*o),O.has("KeyA")&&(f-=i*o,l-=s*o),O.has("KeyD")&&(f+=i*o,l+=s*o);let u=c.x+f,d=c.y+l;W0(u,c.y,I0)||(c.x=u),W0(c.x,d,I0)||(c.y=d)}function _t(){let e=!1;c.ammo>0&&(c.ammo--,q(),Y.shot(),e=!0);let t=E0(),o=ve(t);o?(o.type==="wolf"&&(e?(o.alive=!1,T("Drone defeated!"),Y.killedDrone()):T("No arrows.")),o.type==="barrel"&&e&&(o.alive=!1,Te(o.x,o.y,2.5),T("Kaboom!"),Y.explode()),o.type==="key"&&(o.alive=!1,c.hasBlueKey=!0,Y.door(),T("Realmchild Growths Destroyed! Find the exit!"),Nt()),o.type==="food"&&(o.alive=!1,c.health>=c.maxHealth?(c.maxHealth+=1,c.health=n0(c.health+l0,0,c.maxHealth),T("Became Stronger.")):(c.health=n0(c.health+l0,0,c.maxHealth),T("Health restored.")),q(),Y.pickup()),o.type==="arrows"&&(o.alive=!1,c.ammo=Math.min(60,c.ammo+m0),q(),T(`Arrows +${m0}`),Y.pickup())):e||T("No arrows. Look for quivers.")}function Xt(){for(let e of k){if(!e.alive||!["key","food","arrows"].includes(e.type))continue;Math.hypot(e.x-c.x,e.y-c.y)<.6&&(e.alive=!1,e.type==="key"&&(c.hasBlueKey=!0,Y.door(),T("Realmchild Growths Destroyed! Find the exit!"),Nt()),e.type==="food"&&(c.health>=c.maxHealth?(T("Became Stronger"),c.maxHealth+=1,c.health=n0(c.health+l0,0,c.maxHealth)):(c.health=n0(c.health+l0,0,c.maxHealth),T(`Health +${l0}`)),q(),Y.pickup()),e.type==="arrows"&&(c.ammo=Math.min(60,c.ammo+m0),q(),Y.pickup(),T(`Arrows +${m0}`)))}}function Yt(){if(z0)return;let e=c.x|0,t=c.y|0;w.MAP[t][e]===5&&(Y.portal(),T(`You escaped! Wave ${Q} cleared.`),k0(Q+1),z0=!0,setTimeout(()=>{Ie(!0),z0=!1},100))}function ve(e){let t=(window.devicePixelRatio?Math.round(document.getElementById("view").width/2):document.getElementById("view").width/2)|0,o=Z[t]||1e9,n=null,a=1e9;for(let r of k){if(!r.alive)continue;let i=B0(r,e);i&&(v>0&&i.depth>v||t>=i.drawStartX&&t<i.drawEndX&&i.depth<o+.1&&i.depth<a&&(n=r,a=i.depth))}return n}function Te(e,t,o){for(let n of k){if(!n.alive)continue;Math.hypot(n.x-e,n.y-t)<o&&(n.alive=!1)}}function g0(e=2){let t=0;for(;t++<200;){let o=(Math.random()*(w.MAP_W-2)|0)+1,n=(Math.random()*(w.MAP_H-2)|0)+1;if(w.MAP[n][o]!==0)continue;let a=o+.5-c.x,r=n+.5-c.y;if(!(Math.hypot(a,r)<e))return{x:o,y:n}}return{x:9,y:9}}function Nt(){let e=w.MAP_W,t=w.MAP_H;for(let o=0;o<t;o++)for(let n=0;n<e;n++)w.MAP[o][n]===7&&(w.MAP[o][n]=0)}function Wt(){let e=V.x,t=V.y;for(let o=t-1;o<=t+1;o++)for(let n=e-1;n<=e+1;n++)n===e&&o===t||(w.MAP[o][n]=7)}function Vt(e){let{barrel:t,enchantedKey:o,food:n,arrowQuiver:a,wolfIdle:r}=e;if(k.length=0,D(100)<50)for(let l=0;l<D(2)*Math.floor(w.MAP_H/20);l++){let u=g0(1);k.push({x:u.x+.5,y:u.y+.5,img:t,type:"barrel",alive:!0,dist:0,ground:!0,scale:.5,floorBias:5})}let i=g0(4);k.push({x:i.x+.5,y:i.y+.5,img:o,type:"key",alive:!0,dist:0,ground:!0,scale:.25,floorBias:35});let s=g0(3);k.push({x:s.x+.5,y:s.y+.5,img:n,type:"food",alive:!0,dist:0,ground:!0,scale:.25,floorBias:35});for(let l=0;l<(1+Math.floor(Q/3))*Math.floor(w.MAP_H/20);l++)if(l<=1&&D(100)<50||l<1&&c.ammo<=0&&D(100)<80||D(100)<25){let u=g0(3);k.push({x:u.x+.5,y:u.y+.5,img:a,type:"arrows",alive:!0,dist:0,ground:!0,scale:.25,floorBias:35})}let f=Math.min((2+(Q-1)*2)*Math.floor(w.MAP_H/20),8);for(let l=0;l<f;l++){let u=g0(3.5);k.push({x:u.x+.5,y:u.y+.5,img:r,type:"wolf",alive:!0,dist:0,vx:0,vy:0,hurtCD:0,ground:!0,scale:.5,floorBias:5})}}function q(){bt.style.width=`${c.health/c.maxHealth*100}%`,xt.style.width=`${c.ammo/60*100}%`,yt.textContent=Math.max(0,c.health),Mt.textContent=c.ammo}var K0=0,U0=0,Q0=!1,Lt=!1;function T(e){let t=document.getElementById("gameLog"),o=t?.querySelector(".log-items");if(!o)return;let n=document.createElement("div");n.textContent=e,o.prepend(n),t.classList.contains("collapsed")||requestAnimationFrame(()=>{o.scrollTop=0})}function qt(e){K0>0&&(K0-=e,K0<=0&&(St.textContent=c.hasBlueKey?"Find the exit.":"Find the enchanted key."))}function Re(){Q0||c.health<=0&&(Q0=!0,c.speed=0,c.rotSpeed=0,U0=2,T("YOU DIED! Soul disconnecting from the node..."))}function $t(e){Q0&&(U0-=e,U0<=0&&Fe())}function Fe(){if(Lt)return;Lt=!0;let e=document.getElementById("game");if(e){let t=document.createElement("div");t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100vw",t.style.height="100vh",t.style.background="#ff0000",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.zIndex="999999",t.style.fontFamily='"Courier New", monospace',t.style.opacity="0",t.style.transition="opacity 2s ease-in",t.innerHTML=`
      <div style="
        background: #000;
        border: 3px solid #04650d;
        color: #20b2db;
        width: 600px;
        max-width: 90vw;
        box-shadow: 0 0 20px #04650d;
        font-family: 'Courier New', monospace;
      ">
        <div style="
          background:#000;
          color: #04650d;
          padding: 8px 15px;
          display: flex;
          justify-content: space-between;
          font-weight: bold;
          font-size: 12px;
        ">
          <span style ="color: #FFFFFF; border: 1px solid #04650d;">Death...</span>
        </div>
        <div style="padding: 20px; min-height: 200px;">
          <div style="margin-bottom: 30px;">
            <div style="text-align: center; color: #FFFFFF; font-size: 32px; margin: 8px 0;">YOU HAVE DIED</div>
          </div>
          <div style="text-align: center; margin-top: 20px;">
            <button id="returnBtn" style="
              background: #000;
              border: 2px solid #04650d;
              color: #04650d;
              padding: 12px 24px;
              font-family: 'Courier New', monospace;
              font-size: 14px;
              font-weight: bold;
              cursor: pointer;
              text-transform: uppercase;
              letter-spacing: 1px;
            ">RETURN TO TERMINAL</button>
          </div>
        </div>
      </div>
    `,document.body.appendChild(t);let o=t.querySelector("#returnBtn");if(o){let n=!1;o.addEventListener("click",a=>{a.preventDefault(),!n&&(n=!0,setTimeout(()=>{window.location.href="../index.html"},100))})}setTimeout(()=>{t.style.opacity="1"},50),e.classList.add("game-paused"),O.clear()}}function j0(e=!1){e&&d0(),c.x=J.x,c.y=J.y,c.a=0,c.hasBlueKey=!1,w.MAP[V.y][V.x]=5,Wt(),Vt({wolfIdle:D0,barrel:P0,enchantedKey:L0,food:_0,arrowQuiver:H0}),q(),T(`Wave ${Q}: Find the enchanted key.`)}function Ie(e=!1){e&&(V0>=p0.length-1?d0():(V0+=1,d0(V0))),c.x=J.x,c.y=J.y,c.a=0,c.hasBlueKey=!1,w.MAP[V.y][V.x]=5,Wt(),Vt({wolfIdle:D0,barrel:P0,enchantedKey:L0,food:_0,arrowQuiver:H0}),q(),T(`Wave ${Q}: Find the enchanted key.`)}function ke(){k0(1),d0(0),j0()}function zt(e){for(let t of k){if(!t.alive||t.type!=="wolf")continue;let o=c.x-t.x,n=c.y-t.y,a=Math.hypot(o,n);if(a>.3){let r=.9*e,i=o/a,s=n/a,f=t.x+i*r,l=t.y+s*r;t0(f,t.y)||(t.x=f),t0(t.x,l)||(t.y=l)}a<.6&&t.hurtCD<=0&&(c.health=Math.floor(Math.max(0,c.health-pt)),q(),T("Drone bite!"),Y.hurt(),t.hurtCD=.8,Re()),t.hurtCD>0&&(t.hurtCD-=e)}}Tt();Ht(z);var et=null,ot=null,J0=0,Z0=0;function De(){let e=y|0,t=M|0,o=document.createElement("canvas");o.width=e,o.height=t;let n=o.getContext("2d");n.imageSmoothingEnabled=!1;let a=e*.5,r=t*.5,i=Math.min(a,r)*0,s=Math.hypot(a,r),f=n.createRadialGradient(a,r,i,a,r,s);f.addColorStop(0,"rgba(0,0,0,0)"),f.addColorStop(.5,"rgba(0,0,0,1)"),n.fillStyle=f,n.fillRect(0,0,e,t);let l=document.createElement("canvas");l.width=e,l.height=t;let u=l.getContext("2d");u.imageSmoothingEnabled=!1;let d=u.createLinearGradient(0,0,e*.5,0);d.addColorStop(.35,"rgba(0,0,0,1)"),d.addColorStop(1,"rgba(0,0,0,0)"),u.fillStyle=d,u.fillRect(0,0,e*.5,t),et=l;let h=document.createElement("canvas");h.width=e,h.height=t;let m=h.getContext("2d");m.imageSmoothingEnabled=!1;let G=m.createLinearGradient(e,0,e*.5,0);G.addColorStop(.35,"rgba(0,0,0,1)"),G.addColorStop(1,"rgba(0,0,0,0)"),m.fillStyle=G,m.fillRect(e*.5,0,e*.5,t),ot=h}De();var A0=0;function Pe(e){let t=`FPS: ${Math.round(e)}`;p.save(),p.font="12px monospace",p.textAlign="right",p.textBaseline="top";let o=y-8,n=6,a=p.measureText(t).width+8,r=16;p.fillStyle="rgba(10, 15, 25, 0.6)",p.fillRect(o-a,n-2,a,r),p.strokeStyle="rgba(60, 80, 130, 0.9)",p.strokeRect(o-a+.5,n-2+.5,a-1,r-1),p.fillStyle="#dfe6ff",p.fillText(t,o,n),p.restore()}function d0(e=-1){let t;if(e!==-1){let o=p0[e];o&&(t=o)}else t=It(p0);V.x=t.exitPos.x,V.y=t.exitPos.y,J.x=t.startPos.x,J.y=t.startPos.y,c.health=c.maxHealth,w.cielingColorFront=t.cielingColorFront||"#6495ED",w.floorColorFront=t.floorColorFront||"#054213",w.cielingColorBack=t.cielingColorBack||"#6495ED",w.floorColorBack=t.floorColorBack||"#03210A",w.MAP=t.mapLayout,w.MAP_W=w.MAP[0].length,w.MAP_H=w.MAP.length,c.x=c.x=t.startPos.x,c.y=t.startPos.y}function _e(){d0(0),j0(),c.maxHealth=6+D(6),c.health=c.maxHealth,c.ammo=5+D(5),q(),requestAnimationFrame(Qt)}function Le(e){let t=E0();Rt(e,t,w.MAP,w.MAP_W,w.MAP_H),He(),k.sort((o,n)=>n.dist-o.dist),p.imageSmoothingEnabled=!1,Oe(t),Ne(),We()}function He(){for(let e of k){let t=e.x-c.x,o=e.y-c.y;e.dist=t*t+o*o}}function Oe(e){for(let t of k){if(!t.alive)continue;let o=B0(t,e);if(!o||v>0&&o.depth>v)continue;let n=Xe(o);Ye(t,o,n)}}function Xe(e){let t=1/(1+e.depth*.3);if(v>0&&e.depth>v*c0){let a=v*c0,r=Math.min(1,Math.max(0,(e.depth-a)/Math.max(1e-6,v-a)));t*=1-r*.6}let o=[1,.85,.7,.55,.4];return{quantizedShade:o.reduce((a,r)=>Math.abs(r-t)<Math.abs(a-t)?r:a,o[0])}}function Ye(e,t,o){p.save(),o.quantizedShade<.999&&(p.filter=`brightness(${o.quantizedShade})`);let n=Math.max(1,(t.width??t.drawEndX-t.drawStartX)|0),a=t.drawStartY,r=t.drawEndY-t.drawStartY,i=l=>Math.floor((l-t.drawStartX)*e.img.width/n),s=-1,f=0;for(let l=t.drawStartX;l<=t.drawEndX;l++){let d=l>=0&&l<y&&l<t.drawEndX&&t.depth<=Z[l];if(d&&s===-1&&(s=l,f=i(l)),(!d||l===t.drawEndX)&&s!==-1){let h=l,m=h-s,G=i(h);G<=f&&(G=f+1);let b=Math.min(e.img.width-f,G-f);m>0&&b>0&&r>0&&p.drawImage(e.img,f,0,b,e.img.height,s,a,m,r),s=-1}}p.restore()}function Ne(){let e=Math.round(y*.42),t=Math.round(e*(C0.height/C0.width)),o=Math.max(8,y*.02|0),n=y*.8-e-o,a=M-t-o+20;p.drawImage(C0,n,a,e,t)}function We(){if(!et||!ot)return;let e=Ve(),t={center:tt(e.center),left:tt(e.left),right:tt(e.right)},o=qe(t);J0=J0*.85+o.left*.15,Z0=Z0*.85+o.right*.15,Kt(et,J0),Kt(ot,Z0)}function Ve(){let t=Math.max(6,y*.28|0),o=Math.max(8,y*.3|0),n=y-o>>1|0,a=n+o,r=0,i=Math.min(y,t),s=Math.max(0,y-t),f=y,l=(u,d)=>{let h=Number.POSITIVE_INFINITY;for(let m=u;m<d;m++){let G=Z[m];G<h&&(h=G)}return h};return{center:l(n,a),left:l(r,i),right:l(s,f)}}function tt(e){let t=Math.max(gt,1e-6),o=Math.max(t+1e-6,Gt);if(!isFinite(e))return 0;let n=(e-t)/(o-t);return Math.max(0,Math.min(1,1-n))}function qe(e){let{center:t,left:o,right:n}=e,a=0,r=0,i=Math.min(o,n),s=Math.max(o,n),f=.05;return i>.5?(a=i,r=i):o>n+f?(a=s,r=0):n>o+f?(r=s,a=0):(a=s,r=s),{left:a,right:r}}function Kt(e,t){e&&t>.001&&(p.save(),p.globalAlpha=Math.min(1,t),p.drawImage(e,0,0),p.restore())}var Ut=performance.now();function Qt(e){let t=Math.min(.05,(e-Ut)/1e3);Ut=e;let o=t>0?1/t:0;A0=A0?A0*.9+o*.1:o,Ot(t),zt(t),Xt(),Le(e/1e3),N.classList.contains("visible")&&Ft(k),Yt(),qt(t),$t(t),Pe(A0),requestAnimationFrame(Qt)}_e();export{d0 as ChangeMapLevel};
