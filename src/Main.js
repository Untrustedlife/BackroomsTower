import{a as i0,b as dt}from"../chunks/chunk-B3G4DJQ2.js";var ne=90*Math.PI/180,O0=ne*.5,ut=.01,Y0=.01,M=15;var m0=.95,s0=.6,A0="#101b2e",w0=5,h0=10,mt=3.33;var N=document.getElementById("view"),w=N.getContext("2d");w.imageSmoothingEnabled=!1;m0&&m0!==1&&(N.width=Math.max(1,Math.round(N.width*m0)),N.height=Math.max(1,Math.round(N.height*m0)));var A=N.width,B=N.height,_=document.getElementById("mini"),S=_.getContext("2d");S.imageSmoothingEnabled=!1;var wt=document.getElementById("hpBar"),ht=document.getElementById("ammoBar"),pt=document.getElementById("hpText"),Gt=document.getElementById("ammoText"),bt=document.getElementById("msg"),gt=document.getElementById("btnReset"),xt=document.getElementById("btnToggleMap");var s={x:3.5,y:3.5,a:0,speed:2,rotSpeed:2.6,health:6,maxHealth:6,ammo:1,hasBlueKey:!1,tenacity:20,maxTenacity:20},L0=.2,z=1,yt=1,re=99;function X0(t){z=Math.max(yt,Math.min(re,t|0||yt))}function C0(){let t=Math.cos(s.a),e=Math.sin(s.a),o=-e*Math.tan(O0),n=t*Math.tan(O0),i=1/(o*e-t*n);return{dirX:t,dirY:e,planeX:o,planeY:n,invDet:i}}function n0(t=64,e=64){let o=document.createElement("canvas");return o.width=t,o.height=e,o}function $(t,e){let o=parseInt(t.slice(1),16),n=o>>16&255,i=o>>8&255,r=o&255,a=c=>i0(((c/255)**2.2+e)*255,0,255)|0;return`#${(a(n)<<16|a(i)<<8|a(r)).toString(16).padStart(6,"0")}`}function G0(t,e,o,n){let i=(o*t.width+e)*4,r=parseInt(n.slice(1),16);t.data[i]=r>>16&255,t.data[i+1]=r>>8&255,t.data[i+2]=r&255,t.data[i+3]=255}function ae(){let t=n0(),e=t.getContext("2d",{willReadFrequently:!0}),o=t.width,n=t.height,i=e.createImageData(o,n),r=["#7a7a7a","#8a8a8a","#9a9a9a","#6a6a6a"];for(let a=0;a<n;a++)for(let c=0;c<o;c++){let l=a%16===15||c%16===15,f=(Math.sin(c*.18)+Math.cos(a*.12))*.06,p=l?"#222222":r[((c/16|0)+(a/16|0))%r.length];G0(i,c,a,$(p,f))}return e.putImageData(i,0,0),t}function ie(){let t=n0(),e=t.getContext("2d",{willReadFrequently:!0}),o=t.width,n=t.height,i=e.createImageData(o,n);for(let r=0;r<n;r++)for(let a=0;a<o;a++){let c=a%32===0||r%16===0,l=(Math.sin(a*.12)+Math.cos(r*.17))*.07+(((a^r)&7)/128-.03),p=$(c?"#2a2a2a":"#6a6f73",l);(a*13+r*7)%97===0&&(p=$(p,-.25)),G0(i,a,r,p)}return e.putImageData(i,0,0),t}function se(){let t=n0(),e=t.getContext("2d",{willReadFrequently:!0}),o=t.width,n=t.height,i=e.createImageData(o,n);for(let r=0;r<n;r++)for(let a=0;a<o;a++){let c=Math.sin((a+r)*.18)*.1+Math.cos((a-r)*.14)*.08,l=((a^r<<1)&15)/255-.02,f=$("#2e6a2e",c+l);((a+r*2)%13===0||(a*3-r)%29===0)&&(f=$(f,-.18)),(a*5+r*7)%101===0&&(f=$(f,.18)),G0(i,a,r,f)}return e.putImageData(i,0,0),t}function Mt(t="#5b4b2a"){let e=n0(),o=e.getContext("2d",{willReadFrequently:!0}),n=e.width,i=e.height,r=o.createImageData(n,i);for(let a=0;a<i;a++)for(let c=0;c<n;c++){let l=Math.sin(c*.22+Math.cos(a*.05)*.4)*.08+Math.sin(a*.07)*.02;G0(r,c,a,$(t,l))}o.putImageData(r,0,0),o.fillStyle="#3a3a3a",o.fillRect(0,18,n,4),o.fillRect(0,42,n,4),o.fillStyle="#6a6a6a";for(let a=6;a<n;a+=12)o.fillRect(a,19,2,2),o.fillRect(a,43,2,2);return o.strokeStyle="#444",o.lineWidth=2,o.beginPath(),o.arc(46,32,4,0,Math.PI*2),o.stroke(),e}function ce(){let t=n0(),e=t.getContext("2d",{willReadFrequently:!0}),o=t.width,n=t.height;e.fillStyle="#1f1f24",e.fillRect(0,0,o,n);let i=o/2,r=n/2,a=e.createRadialGradient(i,r,4,i,r,28);a.addColorStop(0,"#74CCEA"),a.addColorStop(.5,"#20B2DB"),a.addColorStop(1,"#FFE300"),e.fillStyle=a,e.beginPath(),e.arc(i,r,26,0,Math.PI*2),e.fill(),e.strokeStyle="rgba(255,255,255,0.25)";for(let c=0;c<6;c++){e.beginPath();let l=8+c*3;e.arc(i,r,l,c*.6,c*.6+Math.PI*1.2),e.stroke()}return e.strokeStyle="#3a3a3a",e.lineWidth=4,e.beginPath(),e.arc(i,r,28,0,Math.PI*2),e.stroke(),t}function le(){let t=Mt("#6a4a2a"),e=t.getContext("2d",{willReadFrequently:!0});e.fillStyle="#103b5f",e.fillRect(28,8,8,48),e.fillStyle="#74c8ff";for(let o=12;o<52;o+=8)e.fillRect(30,o,4,2);return t}function fe(){let t=n0(),e=t.getContext("2d",{willReadFrequently:!0}),o=t.width,n=t.height,i=e.createImageData(o,n),r="#00D9FF",a=5,c=.6,l=.1,f=.04,p=.5,d=.8660254,m=o*.5,b=n*.5,g=Math.min(o,n);for(let h=0;h<n;h++)for(let G=0;G<o;G++){let F=G/a,D=(G*p+h*d)/a,P=(G*p-h*d)/a,Y=1-Math.abs(Math.sin(Math.PI*F)),W=1-Math.abs(Math.sin(Math.PI*D)),J=1-Math.abs(Math.sin(Math.PI*P)),Z=(Y+W+J)/3,L=1-Math.min(G,h,o-1-G,n-1-h)/(g*.5);L<0&&(L=0);let q=(G*13+h*17)%23/23-.5,H=Z*c+L*l+q*f;G0(i,G,h,$(r,H))}e.putImageData(i,0,0),e.globalAlpha=.35,e.strokeStyle="#6FEAFF",e.lineWidth=1;for(let h=0;h<9;h++){e.beginPath();let G=3+h*Math.floor(n/10);e.moveTo(2,G);for(let F=2;F<o-2;F+=6){let D=G+Math.sin((F+h*7)*.35)*2.5+Math.sin((F*.5-h*9)*.12)*1.5;e.lineTo(F,D)}e.stroke()}return t}var de=[null,ae(),ie(),se(),Mt(),ce(),le(),fe()],K=[...de];function Bt(t){let o=t.getContext("2d").getImageData(0,0,t.width,t.height),n=[];for(let i=0;i<t.width;i++){let r=new Uint8ClampedArray(t.height*4);for(let a=0;a<t.height;a++){let c=(a*t.width+i)*4,l=a*4;r[l]=o.data[c],r[l+1]=o.data[c+1],r[l+2]=o.data[c+2],r[l+3]=o.data[c+3]}n.push({data:r,h:t.height})}return{cols:n,w:t.width,h:t.height}}var p0=K.map(t=>t?Bt(t):null);function ue(){p0.length=0,K.forEach(t=>{p0.push(t?Bt(t):null)})}async function me(t){let e=`../assets/gfx/${t}`;return new Promise((o,n)=>{let i=new Image;i.onload=()=>{let r=n0(64,64),a=r.getContext("2d",{willReadFrequently:!0});a.imageSmoothingEnabled=!1,a.drawImage(i,0,0,64,64),o(r)},i.onerror=()=>n(new Error(`Failed to load texture: ${e}`)),i.src=e})}async function St(){try{await we([{index:1,image:"OfficeWall.png"},{index:6,image:"OfficeDoor.png"},{index:4,image:"OfficeDoor2.png"}]),ue()}catch(t){console.warn("Failed to init backrooms wallpaper:",t)}}async function we(t){if(!Array.isArray(t)){console.warn("Expected an array of { index, image } objects. In loadImagesToReplaceTextures");return}let e=t.map(async(o,n)=>{let{index:i,image:r}=o||{};try{let a=await me(r);i&&i>=0&&i<K.length?K[i]=a:K.push(a)}catch(a){console.warn(`Failed to load texture "${r}" for index ${i} and dont support replacing with cool gmod missing texture:`,a)}});await Promise.all(e)}var X={x:10,y:8},U={x:3.5,y:3.5},u={MAP:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,2,6,2,0,0,0,0,0,0,0,2,6,2,0,0,1],[1,0,0,0,2,0,2,0,0,0,0,0,0,0,2,0,2,0,0,1],[1,0,0,0,2,2,2,0,0,0,0,0,0,0,2,2,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,5,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,3,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,3,3,1,3,3,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,0,0,0,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,2,2,2,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,1,0,2,0,2,0,1,0,3,0,0,0,1],[1,0,0,0,0,0,0,0,0,2,6,2,0,0,0,0,0,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],MAP_W:-1,MAP_H:-1,cielingColorFront:"",floorColorFront:"",cielingColorBack:"",floorColorBack:""},b0=[{name:"Village",mapLayout:[[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,1,1,1,1,1,6,1,1,6,1,1,1,1,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3]],exitPos:{x:10,y:12},startPos:{x:9.5,y:1.5}},{name:"TowerFloor1",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,1,1,1,1,1,0,0,1,1,1,1,1,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,3,3,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,3,3,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,6,1,1,1,1,0,0,1,6,1,1,1,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,1,1,1,1,1,1,6,1,1,1,1,1,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,1,1,1,1,1,1,0,0,0,1,0,0,1],[1,0,0,1,1,1,1,1,0,0,0,0,1,1,1,1,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,4,4,1,1,1,1,1,1,1,1,1]],exitPos:{x:10,y:17},startPos:{x:5.5,y:4.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#000000",floorColorBack:"#000000"},{name:"Gallery",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,4,4,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,0,0,0,3,1],[1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,3,1,0,0,0,0,0,1],[1,1,0,0,0,7,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,2,0,0,1],[1,1,1,7,1,1,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,6],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0,0,2,0,0,1],[1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,0,0,2,0,0,1],[1,1,0,0,0,3,0,0,0,0,0,3,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,3,0,0,0,0,0,3,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,3,0,0,0,0,0,3,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,3,0,0,0,0,0,3,0,0,0,1,0,0,2,0,0,1],[1,1,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,0,0,2,0,0,1],[1,0,2,2,2,2,2,2,2,2,2,0,1,0,1,0,1,0,1,0,0,2,0,0,1],[4,0,2,2,2,2,2,2,2,2,2,0,6,0,6,0,6,0,6,0,0,2,0,0,1],[1,0,2,2,2,2,2,2,2,2,2,0,1,0,1,0,1,0,1,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,3,0,0,0,3,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],exitPos:{x:3,y:3},startPos:{x:1.5,y:21.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#ECDE60",floorColorBack:"#000000"},{name:"LongHallways",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,1,0,0,0,0,0,0,3,3,3,3,3,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,1,0,0,0,0,0,3,3,3,3,3,3,3,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,3,3,3,0,0,0,3,3,3,0,0,0,0,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,3,3,3,3,0,4,0,3,3,3,3,0,0,0,1,1,1],[1,7,7,1,1,6,1,1,1,6,1,1,1,6,1,1,1,6,1,1,0,0,3,3,3,3,3,0,0,0,3,3,3,3,3,0,0,1,1,1],[1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,0,1],[1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,6,0,1],[1,7,7,1,1,6,1,1,1,1,1,1,1,1,1,1,1,6,1,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,0,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,2,2,0,2,2,2,2,6,2,2,2,2,0,2,2,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,3,0,0,0,0,0,3,2,0,0,0,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,0,3,3,3,3,3,0,3,3,3,3,3,0,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,1,0,0,0,0,3,3,3,3,0,3,3,3,3,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,2,3,0,0,0,0,0,3,2,0,0,0,1,0,0,0,0,0,3,3,3,0,3,3,3,0,0,0,0,0,1,1,1],[1,7,7,1,2,2,0,2,2,2,2,6,2,2,2,2,0,2,2,1,0,0,0,0,0,0,3,3,0,3,3,0,0,0,0,0,0,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,1,1,1,1,1,1,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1],[1,7,7,1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,1,1,1],[1,7,7,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1],[1,7,7,1,0,0,6,0,3,3,3,3,3,3,3,3,3,3,3,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,1,1,1],[1,7,7,1,0,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,3,3,3,3,3,3,3,3,3,3,3,0,4,0,0,1,1,1],[1,7,7,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1],[1,7,7,1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,1,1,1],[1,7,7,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7,0,0,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,1,1],[1,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],exitPos:{x:1,y:1},startPos:{x:9.5,y:3.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#000000",floorColorBack:"#000000"}];var j=new Float32Array(A);function he(t,e,o,n,i,r,a,c,l){let f=n-o;if(f<=0)return;t.save(),t.imageSmoothingEnabled=!1;let p=c||0,d=p<0?0:p>i.height?i.height:p,m=l||i.height,b=i.height-d,g=m<0?0:m>b?b:m;if(t.drawImage(i,r,d,1,g,e,o,1,f),a<.999){let G=(a<0?0:a)*255|0;t.globalCompositeOperation="multiply",t.fillStyle=`rgb(${G},${G},${G})`,t.fillRect(e,o,1,f)}t.restore()}var g0=B>>1;function Et(t,e,o,n,i){let{dirX:r,dirY:a,planeX:c,planeY:l}=e,f=w.createLinearGradient(0,0,0,g0);f.addColorStop(0,u.cielingColorFront||"#6495ED"),u.cielingColorBack&&f.addColorStop(.5,u.cielingColorBack||"#6495ED"),f.addColorStop(.9,A0),w.fillStyle=f,w.fillRect(0,0,A,g0);let p=w.createLinearGradient(0,B,0,g0);p.addColorStop(0,u.floorColorFront||"#054213"),p.addColorStop(.85,u.floorColorBack||"#03210A"),p.addColorStop(.95,A0),w.fillStyle=p,w.fillRect(0,g0,A,g0);let d=w.createLinearGradient(0,0,0,B);d.addColorStop(0,"rgba(16,27,46,0.08)"),d.addColorStop(.5,"rgba(16,27,46,0.16)"),d.addColorStop(1,"rgba(16,27,46,0.20)"),w.save(),w.fillStyle=d,w.fillRect(0,0,A,B),w.restore();for(let m=0;m<A;m++){let b=2*(m+.5)/A-1,g=r+c*b,h=a+l*b;if(g<1e-8&&g>-1e-8&&h<1e-8&&h>-1e-8){j[m]=Number.POSITIVE_INFINITY;continue}let G=1/(g||1e-9),F=1/(h||1e-9),D=s.x|0,P=s.y|0,Y=G<0?-G:G,W=F<0?-F:F,J,Z,L,q;g<0?(J=-1,L=(s.x-D)*Y):(J=1,L=(D+1-s.x)*Y),h<0?(Z=-1,q=(s.y-P)*W):(Z=1,q=(P+1-s.y)*W);let H=0,V=1,M0=!1,Ut=0,jt=0;for(;!M0&&Ut++<256;){if(L<q?(L+=Y,D+=J,H=0):(q+=W,P+=Z,H=1),M>0){let E0=Math.min(L,q);if(E0>M){M0=!1,V=0,jt=E0;break}}if(D<0||P<0||D>=n||P>=i){M0=!0,V=1;break}let u0=o[P][D];if(u0>0){M0=!0,V=u0;break}}if(V===0){j[m]=Number.POSITIVE_INFINITY;continue}let v;H===0?v=L-Y:v=q-W,v=Math.max(ut,v);let ot=0,Qt=H===0?J:0,Jt=H===1?Z:0,nt=Math.abs(Qt*r+Jt*a)>=.9&&Math.abs(b)<=.9&&v<ot?ot:v,rt=s.x+nt*g,at=s.y+nt*h,t0;H===0?t0=at-(at|0):t0=rt-(rt|0),t0=t0<0?0:t0>.999999?.999999:t0+1e-6;let it=p0[V]||p0[4],f0=K[V],B0=f0?f0.width|0:it.w|0,e0=t0*B0|0;(H===0&&J>0||H===1&&Z<0)&&(e0=B0-e0-1),e0=e0<0?0:e0>=B0?B0-1:e0;let Zt=v<Y0?Y0:v,S0=B/Zt|0,_0=(B-S0)/2|0,te=_0+S0,o0=_0,d0=te;o0<0&&(o0=0),d0>B&&(d0=B);let st=d0-o0;if(st<=0){j[m]=v;continue}let ct=(f0?f0.height:it.h||K[V]?.height||64)|0,ee=(o0-_0)*(ct/Math.max(1,S0)),oe=st*(ct/Math.max(1,S0)),lt=1/(1+v*.25)*(H?.5:1);if(V===7&&(lt*=.8+.2*Math.sin(t*6+m*.05)),he(w,m,o0,d0,f0,e0,lt,ee,oe),M>0&&v>M*s0){let u0=M*s0,E0=M,ft=Math.min(1,Math.max(0,(v-u0)/Math.max(1e-6,E0-u0)));ft>0&&(w.save(),w.globalAlpha=ft*.85,w.fillStyle=A0,w.fillRect(m,o0,1,d0-o0),w.restore())}j[m]=v}}function pe(t){return B/t}function Ge(t,e,o){let{dirY:n,dirX:i,planeY:r,planeX:a,invDet:c}=o,l=c*(n*t-i*e),f=c*(-r*t+a*e);return{transX:l,transY:f}}function be(t,e){return Math.round((A>>1)*(1+t/e))}function ge(t,e=0,o=.5){let n=e*100,a=(B>>1)+(t>>1)+(n|0),c=a-t;return c<0&&(c=0),{startY:c,endY:a}}function xe(t){let o=(B>>1)-(t>>1);o<0&&(o=0);let n=o+t;return{startY:o,endY:n}}function F0(t,e){let o=t.x-s.x,n=t.y-s.y,{transX:i,transY:r}=Ge(o,n,e);if(r<=.01)return null;let a=be(i,r),c=t&&typeof t.scale=="number"?t.scale:t&&t.img&&typeof t.img.scale=="number"?t.img.scale:1,l=pe(r)*c,f=typeof t._hR=="number"?t._hR:Math.round(l),p=.1,d=f;(l>f+p||l<f-p)&&(d=Math.round(l)),t._hR=d;let m=d,b=t.img,g=b&&b.width&&b.height?b.width/b.height:1,h=Math.max(1,Math.round(m*g)),G=m/B,F=(t.floorBias??0)*c*G,D=Math.min(.9,Math.max(.2,c)),P=t.ground?ge(m,F,D):xe(m),Y=Math.round(a-(h>>1)),W=Y+h;return{drawStartX:Y,drawEndX:W,drawStartY:P.startY,drawEndY:P.endY,depth:r,size:m,width:W-Y}}function x0(t,e,o=1){let n=t.trim().split(`
`).map(d=>d.replace(/\s+/g,"")),i=n.length-1;for(;i>=0&&n[i].split("").every(d=>d===".");)i--;i>=0&&i<n.length-1&&(n=n.slice(0,i+1));let r=n.length,a=n[0].length,c=1,l=document.createElement("canvas");l.width=a,l.height=r;let f=l.getContext("2d");f.imageSmoothingEnabled=!1;let p=f.createImageData(a,r);for(let d=0;d<r;d++)for(let m=0;m<a;m++){let b=n[d][m],g=(d*a+m)*4;if(b==="."){p.data[g+3]=0;continue}let h=e[b]||"#ffffff",G=parseInt(h.slice(1),16);p.data[g]=G>>16&255,p.data[g+1]=G>>8&255,p.data[g+2]=G&255,p.data[g+3]=255}if(f.putImageData(p,0,0),o!==1){let d=document.createElement("canvas");d.width=a*o,d.height=r*o;let m=d.getContext("2d");return m.imageSmoothingEnabled=!1,m.drawImage(l,0,0,d.width,d.height),d.baseline=c,d.scale=o,d}return l.baseline=c,l.scale=1,l}async function ye(t,e){return await Me(t,e,1)}async function Me(t,e=1,o=1){let n=`../assets/gfx/${t}`;return new Promise((i,r)=>{let a=new Image;a.onload=()=>{let c=document.createElement("canvas"),l=a.width,f=a.height;c.width=l*e,c.height=f*e;let p=c.getContext("2d");p.imageSmoothingEnabled=!1,p.drawImage(a,0,0,c.width,c.height),c.baseline=o,c.scale=e,i(c)},a.onerror=()=>r(new Error(`Failed to load sprite: ${n}`)),a.src=n})}var c0,v0,T0,R0,k0,I0;async function At(){v0=v0=x0(`
  ................................
  ..............BB..BB............
  .............BbbbbbbB...........
  ...........BbbbGGGGbbbB.........
  ..........BbbbGGGGGGbbbB........
  .........BbbGGGGGGGGGGbbB.......
  ........BbbGGGgGGGGgGGbbB.......
  ........BbbGGgGyyGgGGGbbB.......
  .......BbbGGGGGGGGGGGGbbB.......
  .......BbbGGGGGGGGGGGGbbB.......
  ......BbbGGGGGGGGGGGGGGbbB......
  ......BbbGGGGgGGGGgGGGGbbB......
  ......BbbGGGGwwwwwwGGGGbbB......
  .....BbbGGGwwwWWkWWwwwGGbbB.....
  .....BbbGGGwwwwkkwwwwGGbbB......
  .....BbbGGGwwwwrwwwwGGGbbB......
  .....BbbGGGwwwwwwwwwGGGbbB......
  .....BbbGGGGwwwwwwwGGGGbbB......
  .....BbbGGGGGGGGGGGGGGGbbB......
  .....BbbGGGGGGGGGGGGGGGbbB......
  ......BbbGGGGGGGGGGGGGbbB.......
  ......BbbGGGGGGGGGGGGGbbB.......
  .......BBbbbgggGGGGgggbbBB......
  ........BBBbbbbbbbbbbbbBBB......
  ................................
  `,{B:"#2c1810",b:"#5c3d2e",g:"#7a6b5c",G:"#a89080",k:"#080508",w:"#e8e0d5",W:"#f5f0e8",r:"#8b4513",y:"#ffeb9c"},4),I0=x0(`
  ............
  ....bbbb....
  ..bbGGGGbb..
  .bGGGGGGGGb.
  .bGGgGGgGGb.
  .bGGGGGGGGb.
  .bGgGGGGgGb.
  .bGGGGGGGGb.
  .bGGgGGgGGb.
  .bGGGGGGGGb.
  .bGgGGGGgGb.
  .bGGGGGGGGb.
  .bGGgGGgGGb.
  .bGGGGGGGGb.
  .bGGgGGgGGb.
  .bGGGGGGGGb.
  ..bbGGGGbb..
  ....bbbb....
  ............
  ............
  `,{k:"#0a0f10",g:"#1b5c3a",G:"#2e874f",s:"#7fffd4",b:"#0e1620"},3),R0=x0(`
  ................
  .....B....B.....
  ....BBBBBBBB....
  ...BBbBBbBBB....
  ...BBbgBgbBB....
  ....BBgggBB.....
  .....kGGGk......
  ....kGGsGGk.....
  ...kGGGGGGGk....
  ...kGGGGGGGk....
  ....kGGGGGk.....
  .....kGGGk......
  .......GG.......
  .......GG.......
  .....GGGGGG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GGggGG.....
  `,{k:"#5a4500",g:"#FFD700",G:"#FFA500",s:"#FFF5CC",b:"#4169E1",B:"#87CEEB"},4),T0=x0(`
  ............r...
  ............rr..
  ...........w..r.
  .......sb.w...rr
  .......bdw...w..
  .......sfd..w...
  ......sfffdw....
  .....sfffffdb...
  ....sfbffffss...
  ...sfbfbffs.....
  ..sfbfbfbs......
  .sfbfbfbs.......
  .sffbfbs........
  ..sffbs.........
  ...sss..........
  ................
  `,{b:"#100904",d:"#8f715b",f:"#5a3b1a",r:"#DC143C",s:"#000000",w:"#4d260a"},3),c0=c0=x0(`
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ........................................................w.......
  ......................................................sww.......
  ..................................................wwwwws........
  ...............................................wwwwwwww.s.......
  ..............................................wwwwww....s.......
  ...........................................wwwwwww......s.......
  ...........................................wwwww........s.......
  ..........................................wwwww..........s......
  .........................................wwwww...........s......
  ........................................wwwwww...........s......
  ........................................wwwww............s......
  .......................................wwwww.............s......
  .......................................wwwww.............s......
  .......................................wwww...............s.....
  ......................................wwwww...............s.....
  ......................................wwww................s.....
  .....................................wwwww................s.....
  .....................................wwwww................s.....
  .....................................wwww.................s.....
  .....................................wwww.................s.....
  ....................................wwwww.................s.....
  ....................................wwww..................s.....
  ....................................wwww..................s.....
  ..............................ssss.wwwww..................s.....
  ..............................sss..wwww...................s.....
  ..............................s.bb.wwww....................s....
  ..............................s..bbwwww....................s....
  ..................................bwwww....................s....
  ..................................bbwww....................s....
  ...................................bbww....................s....
  ..................................wwbbww...................s....
  ..................................wwwbbb....................s...
  ..................................wwwwwbb...................s...
  ...................................wwwwwbb..................s...
  ....................................wwww.bb.................s...
  ....................................wwww..bbb...............s...
  ....................................wwww....bb..............s...
  ....................................wwww.....bb..............s..
  ....................................wwww......bb.............s..
  ...................................wwwww.......bb............s..
  ..................................wwwwww........bbb..........s..
  ..................................wwwwww.........bbb.........ss.
  ..................................wwwwww...........bbrrrrr....s.
  ..................................wwwwww...........fbbbrrrr...s.
  ...................................wwwww...........ffffbbrrr..s.
  ...................................wwwwww...........ffffbbrrr.s.
  ...................................wwwwww...........ffffffbb.ss.
  ...................................wwwwww.............ffff.bbbs.
  ...................................wwwwwww..............ff...bs.
  `,{b:"#5a3b1a",f:"#B8860B",r:"#DC143C",s:"#C0C0C0",w:"#8B4513"},3),k0=await ye("apple.png",3)}var E=[];function Ct(t){S.clearRect(0,0,_.width,_.height);let e=6,o=20,n=2,i=Math.floor(o/2),r=Math.max(0,Math.min((s.x|0)-i,u.MAP_W-o)),a=Math.max(0,Math.min((s.y|0)-i,u.MAP_H-o));_.width=n+o*e+n,_.height=n+o*e+n;for(let d=0;d<o;d++)for(let m=0;m<o;m++){let b=a+d,g=r+m,h=u.MAP[b]?.[g]??0,G="#0c1220";h===1?G="#ECDE60":h===2?G="#707a88":h===3?G="#00e676":h===4?G="#996633":h===5?G="#FFE300":h===6?G=" #3561ff":h===7&&(G="#00FFFF"),S.fillStyle=G,S.fillRect(n+m*e,n+d*e,e-1,e-1)}for(let d of t){if(!d.alive)continue;let m=n+(d.x-r)*e,b=n+(d.y-a)*e;S.fillStyle=d.type==="entity"?"#ffeb9c":d.type==="barrel"?"#57d694":d.type==="key"?"#6aa2ff":d.type==="food"?"#7fffd4":d.type==="arrows"?"#DC143C":"#ffffff",S.fillRect(m-2,b-2,4,4)}let c=n+(s.x-r)*e,l=n+(s.y-a)*e;S.fillStyle="#e7f3ff",S.beginPath(),S.arc(c,l,2.5,0,dt),S.fill();let f=Math.cos(s.a),p=Math.sin(s.a);S.strokeStyle="#78f3d3",S.beginPath(),S.moveTo(c,l),S.lineTo(c+f*1.5*e,l+p*1.5*e),S.stroke()}function Ft(t){if(!Array.isArray(t)||t.length===0)throw new Error("Array must be non-empty.");let e=C(t.length)-1;return t[e]}function C(t){if(t<=0)throw new Error("The maximum value must be greater than 0.");return Math.floor(Math.random()*t)+1}var x=null,r0=null,R=null,W0=null,vt=null;function q0(){x||(x=new(window.AudioContext||window.webkitAudioContext))}function T({freq:t=440,dur:e=.1,type:o="square",vol:n=.2,slide:i=0}){if(!x)return;let r=x.createOscillator(),a=x.createGain();r.type=o,r.frequency.value=t,a.gain.value=n,r.connect(a).connect(x.destination);let c=x.currentTime;i&&(r.frequency.setValueAtTime(t,c),r.frequency.linearRampToValueAtTime(t+i,c+e)),a.gain.setValueAtTime(n,c),a.gain.exponentialRampToValueAtTime(.001,c+e),r.start(c),r.stop(c+e)}function N0({dur:t=.2,vol:e=.2,lp:o=1200}){if(!x)return;let n=x.createBuffer(1,x.sampleRate*t,x.sampleRate),i=n.getChannelData(0);for(let f=0;f<i.length;f++)i[f]=Math.random()*2-1;let r=x.createBufferSource(),a=x.createGain(),c=x.createBiquadFilter();r.buffer=n,a.gain.value=e,c.type="lowpass",c.frequency.value=o,r.connect(c).connect(a).connect(x.destination);let l=x.currentTime;r.start(l),r.stop(l+t)}var k={shot:()=>{let t=C(50),e=-C(50);T({freq:220+t+e,dur:.05+C(3)/100,type:"square",vol:.25,slide:120}),N0({dur:.03+C(3)/100,vol:.15,lp:800})},pickup:()=>{T({freq:880,dur:.06,type:"triangle",vol:.2}),T({freq:1180,dur:.08,type:"triangle",vol:.18})},explode:()=>{N0({dur:1,vol:.3,lp:800}),T({freq:90,dur:.7,type:"sawtooth",vol:.12,slide:-60})},hurt:()=>{T({freq:140,dur:.12,type:"sawtooth",vol:.2,slide:-50})},killedEntity:()=>{let t=Math.random()*16-8;T({freq:320+t,dur:.26,type:"triangle",vol:.3,slide:-220}),T({freq:480+t,dur:.22,type:"sawtooth",vol:.1,slide:-260}),T({freq:90,dur:.08,type:"sine",vol:.18}),N0({dur:.05,vol:.1,lp:1e3}),setTimeout(()=>{T({freq:170+t,dur:.07,type:"triangle",vol:.16,slide:70})},90)},door:()=>{T({freq:420,dur:.12,type:"square",vol:.15})},portal:()=>{T({freq:600,dur:.5,type:"sawtooth",vol:.2}),T({freq:400,dur:.3,type:"sawtooth",vol:.2,slide:50}),T({freq:600,dur:.5,type:"sawtooth",vol:.2})}};async function Be(t,{volume:e=.15}={}){if(x)try{if(!W0||t!==vt){let n=await(await fetch(t,{cache:"force-cache"})).arrayBuffer();W0=await x.decodeAudioData(n),vt=t}Tt(),R=x.createBufferSource(),R.buffer=W0,R.loop=!0,r0=x.createGain(),r0.gain.value=e,R.connect(r0).connect(x.destination),R.start()}catch(o){try{Tt();let n=new Audio(t);n.loop=!0,n.volume=Math.max(0,Math.min(1,e)),await n.play(),R={stop:()=>n.pause(),disconnect:()=>{}},r0=null}catch(n){}}}function Tt(){try{R&&R.stop(0)}catch(t){}if(R&&R.disconnect)try{R.disconnect()}catch(t){}if(r0)try{r0.disconnect()}catch(t){}R=null,r0=null}var Rt=!1;async function V0(){if(!x||R||Rt)return;Rt=!0,await Be("../assets/sfx/HexenST02SLowed.ogg",{volume:.12})}function Q(t,e){if(t<0||e<0||t>=u.MAP_W||e>=u.MAP_H)return!0;let o=u.MAP[e|0][t|0];return o===0||o===5?!1:o===7?!s.hasBlueKey:o!==6}function z0(t,e,o){return!!(Q(t,e)||Q(t-o,e)||Q(t+o,e)||Q(t,e-o)||Q(t,e+o))}var a0=Object.freeze({entity:"entity"}),D0={[a0.entity]:{type:a0.entity,ground:!0,scale:.66,floorBias:3}};Object.freeze(D0);for(let t in D0)Object.freeze(D0[t]);var P0={[a0.entity]:{ai(t,e){if(!t.alive)return;let o=s.x-t.x,n=s.y-t.y,i=Math.hypot(o,n);if(i>.3){let r=.9*e,a=o/i,c=n/i,l=t.x+a*r,f=t.y+c*r;Q(l,t.y)||(t.x=l),Q(t.x,f)||(t.y=f)}i<.6&&t.hurtCD<=0&&(s.health=Math.max(0,s.health-mt)|0,O(),y("Entity attacks!"),k.hurt(),t.hurtCD=.8,It()),t.hurtCD>0&&(t.hurtCD-=e)},onHit(t,e){if(e){t.alive=!1;let o=["Entity murdered!","Entity destroyed!","Entity purged!"];y(chooseRandomElementFromArray(o)),k.killedEntity()}else y("No arrows.")},onTouch(t){Dt(a0.entity,1e4)&&y("You hear something like water nearby...")}}};Object.freeze(P0);for(let t in P0)Object.freeze(P0[t]);var Se=0;function kt(t,e={x:0,y:0},o=void 0){let n=D0[t],i=P0[t],r=Object.assign(Object.create(i),n);switch(r.id=Se++,r.x=e.x+.5,r.y=e.y+.5,r.dist=0,r.alive=!0,r.hurtCD=0,t){case a0.entity:r.img=v0;break}return o&&Object.assign(r,o),r}var $0=0,I=new Set,K0=!1,U0=0,j0=!1;function _t(t){window.addEventListener("keydown",e=>{I.add(e.code),q0(),V0(),e.code==="Space"&&(e.preventDefault(),Pt()),e.code==="KeyM"&&(e.preventDefault(),_.classList.toggle("visible"))}),window.addEventListener("keyup",e=>I.delete(e.code)),t.addEventListener("mousedown",e=>{e.button===0&&Pt(),K0=!0,U0=e.clientX,q0(),V0()}),window.addEventListener("mouseup",()=>K0=!1),window.addEventListener("mousemove",e=>{if(K0){let o=e.clientX-U0;U0=e.clientX,s.a+=o*.0035}}),gt.onclick=()=>ve(),xt.onclick=()=>_.classList.toggle("visible")}function Ot(t){let e=I.has("ShiftLeft")||I.has("ShiftRight"),o=s.speed*(e?2:1)*t,n=s.rotSpeed*t,i=Math.cos(s.a),r=Math.sin(s.a),a=-r,c=i,l=0,f=0;I.has("ArrowLeft")&&(s.a-=n),I.has("ArrowRight")&&(s.a+=n),(I.has("ArrowUp")||I.has("KeyW"))&&(l+=i*o,f+=r*o),(I.has("ArrowDown")||I.has("KeyS"))&&(l-=i*o,f-=r*o),I.has("KeyA")&&(l-=a*o,f-=c*o),I.has("KeyD")&&(l+=a*o,f+=c*o);let p=s.x+l,d=s.y+f;z0(p,s.y,L0)||(s.x=p),z0(s.x,d,L0)||(s.y=d)}function Pt(){let t=!1;s.ammo>0&&(s.ammo--,O(),k.shot(),t=!0);let e=C0(),o=Ee(e);if(!o){t||y("No arrows. Look for quivers.");return}switch(o.type){case"barrel":t&&(o.alive=!1,Ae(o.x,o.y,2.5),y("Kaboom!"),k.explode());break;case"key":o.alive=!1,s.hasBlueKey=!0,k.door(),y("Keycard found! Find the exit!"),Xt();break;case"food":{o.alive=!1;let n=s.health>=s.maxHealth;n&&(s.maxHealth+=1),s.health=i0(s.health+h0,0,s.maxHealth),y(n?"Ranger Became Stronger.":"Health restored."),O(),k.pickup();break}case"arrows":o.alive=!1,s.ammo=Math.min(60,s.ammo+w0),O(),y(`Arrows +${w0}`),k.pickup();break;default:o.onHit&&o.onHit(o,t);break}}function Yt(){for(let t of E)if(!(!t.alive||Math.hypot(t.x-s.x,t.y-s.y)>=.6))switch(t.type){case"key":t.alive=!1,s.hasBlueKey=!0,k.door(),y("Keycard found! Find the exit!"),Xt();break;case"food":t.alive=!1,s.health>=s.maxHealth?(y("Ranger Became Stronger"),s.maxHealth+=1,s.health=i0(s.health+h0,0,s.maxHealth)):(s.health=i0(s.health+h0,0,s.maxHealth),y(`Health +${h0}`)),O(),k.pickup();break;case"arrows":t.alive=!1,s.ammo=Math.min(60,s.ammo+w0),O(),k.pickup(),y(`Arrows +${w0}`);break;default:t.onTouch&&t.onTouch(t);break}}function Lt(){if(j0)return;let t=s.x|0,e=s.y|0;u.MAP[e][t]===5&&(k.portal(),y(`Floor ${z} cleared.`),X0(z+1),j0=!0,setTimeout(()=>{Fe(!0),j0=!1},100))}function Ee(t){let o=document.getElementById("view").width>>1|0,n=j[o]||1e9,i=null,r=1e9;for(let a of E){if(!a.alive)continue;let c=F0(a,t);c&&(M>0&&c.depth>M||o>=c.drawStartX&&o<c.drawEndX&&c.depth<n+.1&&c.depth<r&&(i=a,r=c.depth))}return i}function Ae(t,e,o){for(let n of E){if(!n.alive)continue;Math.hypot(n.x-t,n.y-e)<o&&(n.alive=!1)}}function y0(t=2){let e=0;for(;e++<200;){let o=(Math.random()*(u.MAP_W-2)|0)+1,n=(Math.random()*(u.MAP_H-2)|0)+1;if(u.MAP[n][o]!==0)continue;let i=o+.5-s.x,r=n+.5-s.y;if(!(Math.hypot(i,r)<t))return{x:o,y:n}}return{x:9,y:9}}function Xt(){let t=u.MAP_W,e=u.MAP_H;for(let o=0;o<e;o++)for(let n=0;n<t;n++)u.MAP[o][n]===7&&(u.MAP[o][n]=0)}function Wt(){let t=X.x,e=X.y;for(let o=e-1;o<=e+1;o++)for(let n=t-1;n<=t+1;n++)n===t&&o===e||(u.MAP[o][n]=7)}function Nt(t){let{barrel:e,enchantedKey:o,food:n,arrowQuiver:i}=t;if(E.length=0,C(100)<50)for(let l=0;l<C(2)*(u.MAP_H/20|0);l++){let f=y0(1);E.push({x:f.x+.5,y:f.y+.5,img:e,type:"barrel",alive:!0,dist:0,ground:!0,scale:.5,floorBias:5})}let r=y0(4);E.push({x:r.x+.5,y:r.y+.5,img:o,type:"key",alive:!0,dist:0,ground:!0,scale:.25,floorBias:35});let a=y0(3);E.push({x:a.x+.5,y:a.y+.5,img:n,type:"food",alive:!0,dist:0,ground:!0,scale:.25,floorBias:35});for(let l=0;l<1+(z/3|0)*(u.MAP_H/20|0);l++)if(l<=1&&C(100)<50||l<1&&s.ammo<=0&&C(100)<80||C(100)<25){let f=y0(3);E.push({x:f.x+.5,y:f.y+.5,img:i,type:"arrows",alive:!0,dist:0,ground:!0,scale:.25,floorBias:35})}let c=Math.min((2+(z-1)*2)*(u.MAP_H/20|0),8);for(let l=0;l<c;l++){let f=y0(3.5);E.push(kt(a0.entity,{x:f.x+.5,y:f.y+.5}))}}function O(){wt.style.width=`${s.health/s.maxHealth*100}%`,ht.style.width=`${s.ammo/60*100}%`,pt.textContent=Math.max(0,s.health),Gt.textContent=s.ammo}var Q0=0,J0=0,Z0=!1,Ht=!1;function y(t){let e=document.getElementById("gameLog"),o=e?.querySelector(".log-items");if(!o)return;let n=document.createElement("div");n.textContent=t,o.prepend(n),e.classList.contains("collapsed")||requestAnimationFrame(()=>{o.scrollTop=0})}function qt(t){Q0>0&&(Q0-=t,Q0<=0&&(bt.textContent=s.hasBlueKey?"Find the exit.":"Find the enchanted key."))}function It(){Z0||s.health<=0&&(Z0=!0,s.speed=0,s.rotSpeed=0,J0=2,y("YOU DIED! Soul disconnecting from the node..."))}function Vt(t){Z0&&(J0-=t,J0<=0&&Ce())}function Ce(){if(Ht)return;Ht=!0;let t=document.getElementById("game");if(t){let e=document.createElement("div");e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100vw",e.style.height="100vh",e.style.background="#ff0000",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.zIndex="999999",e.style.fontFamily='"Courier New", monospace',e.style.opacity="0",e.style.transition="opacity 2s ease-in",e.innerHTML=`
      <div style="
        background: #000;
        border: 3px solid #04650d;
        color: #20b2db;
        width: 600px;
        max-width: 90vw;
        box-shadow: 0 0 20px #04650d;
        font-family: 'Courier New', monospace;
      ">
        <div style="
          background:#000;
          color: #04650d;
          padding: 8px 15px;
          display: flex;
          justify-content: space-between;
          font-weight: bold;
          font-size: 12px;
        ">
          <span style ="color: #FFFFFF; border: 1px solid #04650d;">Death...</span>
        </div>
        <div style="padding: 20px; min-height: 200px;">
          <div style="margin-bottom: 30px;">
            <div style="text-align: center; color: #FFFFFF; font-size: 32px; margin: 8px 0;">YOU HAVE DIED</div>
          </div>
          <div style="text-align: center; margin-top: 20px;">
            <button id="returnBtn" style="
              background: #000;
              border: 2px solid #04650d;
              color: #04650d;
              padding: 12px 24px;
              font-family: 'Courier New', monospace;
              font-size: 14px;
              font-weight: bold;
              cursor: pointer;
              text-transform: uppercase;
              letter-spacing: 1px;
            ">RETURN TO TERMINAL</button>
          </div>
        </div>
      </div>
    `,document.body.appendChild(e);let o=e.querySelector("#returnBtn");if(o){let n=!1;o.addEventListener("click",i=>{i.preventDefault(),!n&&(n=!0,setTimeout(()=>{window.location.href="../index.html"},100))})}setTimeout(()=>{e.style.opacity="1"},50),t.classList.add("game-paused"),I.clear()}}function tt(t=!1){t&&l0(),s.x=U.x,s.y=U.y,s.a=0,s.hasBlueKey=!1,u.MAP[X.y][X.x]=5,Wt(),Nt({barrel:I0,enchantedKey:R0,food:k0,arrowQuiver:T0}),O(),y(`Floor ${z}: Find the keycard.`)}function Fe(t=!1){t&&($0>=b0.length-1?l0():($0+=1,l0($0))),s.x=U.x,s.y=U.y,s.a=0,s.hasBlueKey=!1,u.MAP[X.y][X.x]=5,Wt(),Nt({barrel:I0,enchantedKey:R0,food:k0,arrowQuiver:T0}),O(),y(`Floor ${z}: Find the keycard.`)}function ve(){X0(1),l0(0),tt()}function zt(t){for(let e of E)e.alive&&e.ai&&e.ai(e,t)}var et=performance.now(),$t=new Map;function Dt(t,e){let o=et,n=$t.get(t)??0;return o<n?!1:($t.set(t,o+e),!0)}_t(N);var H0=0;function Te(t){let e=`FPS: ${Math.round(t)}`;w.save(),w.font="12px monospace",w.textAlign="right",w.textBaseline="top";let o=A-8,n=6,i=w.measureText(e).width+8,r=16;w.fillStyle="rgba(10, 15, 25, 0.6)",w.fillRect(o-i,n-2,i,r),w.strokeStyle="rgba(60, 80, 130, 0.9)",w.strokeRect(o-i+.5,n-2+.5,i-1,r-1),w.fillStyle="#dfe6ff",w.fillText(e,o,n),w.restore()}function l0(t=-1){let e;if(t!==-1){let o=b0[t];o&&(e=o)}else e=Ft(b0);X.x=e.exitPos.x,X.y=e.exitPos.y,U.x=e.startPos.x,U.y=e.startPos.y,s.health=s.maxHealth,u.cielingColorFront=e.cielingColorFront||"#6495ED",u.floorColorFront=e.floorColorFront||"#054213",u.cielingColorBack=e.cielingColorBack||"#6495ED",u.floorColorBack=e.floorColorBack||"#03210A",u.MAP=e.mapLayout,u.MAP_W=u.MAP[0].length,u.MAP_H=u.MAP.length,s.x=s.x=e.startPos.x,s.y=e.startPos.y}async function Re(){await At(),await St(),l0(0),tt(),s.maxHealth=6+C(6),s.health=s.maxHealth,s.ammo=5+C(5),O(),requestAnimationFrame(Kt)}function ke(t){let e=C0();Et(t,e,u.MAP,u.MAP_W,u.MAP_H),Ie(),E.sort((o,n)=>n.dist-o.dist),w.imageSmoothingEnabled=!1,De(e),_e()}function Ie(){for(let t of E){let e=t.x-s.x,o=t.y-s.y;t.dist=e*e+o*o}}function De(t){for(let e of E){if(!e.alive)continue;let o=F0(e,t);if(!o||M>0&&o.depth>M)continue;let n=Pe(o);He(e,o,n)}}function Pe(t){let e=1/(1+t.depth*.3);if(M>0&&t.depth>M*s0){let i=M*s0,r=Math.min(1,Math.max(0,(t.depth-i)/Math.max(1e-6,M-i)));e*=1-r*.6}let o=[1,.85,.7,.55,.4];return{quantizedShade:o.reduce((i,r)=>Math.abs(r-e)<Math.abs(i-e)?r:i,o[0])}}function He(t,e,o){w.save(),o.quantizedShade<.999&&(w.filter=`brightness(${o.quantizedShade})`);let n=Math.max(1,(e.width??e.drawEndX-e.drawStartX)|0),i=e.drawStartY,r=e.drawEndY-e.drawStartY,a=f=>(f-e.drawStartX)*t.img.width/n|0,c=-1,l=0;for(let f=e.drawStartX;f<=e.drawEndX;f++){let d=f>=0&&f<A&&f<e.drawEndX&&e.depth<=j[f];if(d&&c===-1&&(c=f,l=a(f)),(!d||f===e.drawEndX)&&c!==-1){let m=f,b=m-c,g=a(m);g<=l&&(g=l+1);let h=Math.min(t.img.width-l,g-l);b>0&&h>0&&r>0&&w.drawImage(t.img,l,0,h,t.img.height,c,i,b,r),c=-1}}w.restore()}function _e(){let t=Math.round(A*.42),e=Math.round(t*(c0.height/c0.width)),o=Math.max(8,A*.02|0),n=A*.8-t-o,i=B-e-o+20;w.drawImage(c0,n,i,t,e)}function Kt(t){let e=Math.min(.05,(t-et)/1e3);et=t;let o=e>0?1/e:0;H0=H0?H0*.9+o*.1:o,Ot(e),zt(e),Yt(),ke(t/1e3),_.classList.contains("visible")&&Ct(E),Lt(),qt(e),Vt(e),Te(H0),requestAnimationFrame(Kt)}await Re().catch(console.error);export{l0 as ChangeMapLevel,Dt as tryCooldown};
