import{a as e0,b as Rt,c as u}from"../chunks/chunk-75YVQ3JR.js";var y0=document.getElementById("view");y0.width=480;y0.height=270;var S=480,A=270,N0=new OffscreenCanvas(S,A),m=N0.getContext("2d");m.imageSmoothingEnabled=!1;var W0=y0.getContext("2d");W0.imageSmoothingEnabled=!1;var Y=document.getElementById("mini"),v=Y.getContext("2d");v.imageSmoothingEnabled=!1;var kt=document.getElementById("hpBar"),Pt=document.getElementById("ammoBar"),_t=document.getElementById("hpText"),Ht=document.getElementById("ammoText"),Lt=document.getElementById("msg"),Bt=document.getElementById("btnReset"),Xt=document.getElementById("btnToggleMap");var Ne=90*Math.PI/180,z0=Ne*.5,G0=.01,$0=.01,Yt=15;var l0=.6,q="#101b2e";var Nt=10,Wt=3.33,zt=2.5,Gt=20,$t=.75,M0=20;var r={x:3.5,y:3.5,velX:0,velY:0,a:0,accel:10,rotSpeed:2.6,health:6,maxHealth:20,ammo:1,hasBlueKey:!1,isMoving:!1,weaponAnim:-1,tenacity:20,maxTenacity:20,height:.75,sightDist:15,calculatePlayerHeight:()=>r.height<.01?.01:r.height*1},V0=.2,o0=1,Vt=1,We=99;function q0(t){o0=Math.max(Vt,Math.min(We,t|0||Vt))}function b0(){let t=Math.cos(r.a),e=Math.sin(r.a),o=-e*Math.tan(z0),n=t*Math.tan(z0),i=1/(o*e-t*n);return{dirX:t,dirY:e,planeX:o,planeY:n,invDet:i}}function ze(t=64,e=64){return new OffscreenCanvas(t,e)}var N=new Array(8).fill(null);function qt(t){let o=t.getContext("2d").getImageData(0,0,t.width,t.height),n=[];for(let i=0;i<t.width;i++){let a=new Uint8ClampedArray(t.height*4);for(let s=0;s<t.height;s++){let l=(s*t.width+i)*4,f=s*4;a[f]=o.data[l],a[f+1]=o.data[l+1],a[f+2]=o.data[l+2],a[f+3]=o.data[l+3]}n.push({data:a,h:t.height})}return{cols:n,w:t.width,h:t.height}}var x0=N.map(t=>t?qt(t):null);function Ge(){x0.length=0,N.forEach(t=>{x0.push(t?qt(t):null)})}var F0=Array.from({length:82},(t,e)=>e*.0125),T0={};function $e(){for(let t=1;t<N.length;t++)if(N[t]){T0[t]={};for(let e of F0){let o=new OffscreenCanvas(N[t].width,N[t].height),n=o.getContext("2d");n.drawImage(N[t],0,0);let i=e*255|0;n.globalCompositeOperation="multiply",n.fillStyle=`rgb(${i},${i},${i})`,n.fillRect(0,0,o.width,o.height),T0[t][e]=o}}}async function Ve(t){let e=`../assets/gfx/${t}`;return new Promise((o,n)=>{let i=new Image;i.onload=()=>{let a=ze(64,64),s=a.getContext("2d",{willReadFrequently:!0});s.imageSmoothingEnabled=!1,s.drawImage(i,0,0,64,64),o(a)},i.onerror=()=>n(new Error(`Failed to load texture: ${e}`)),i.src=e})}async function Ut(){try{await qe([{index:1,image:"OfficeWall.png"},{index:2,image:"Panel.png"},{index:3,image:"Hedge.png"},{index:4,image:"OfficeDoor.png"},{index:5,image:"Portal.png"},{index:6,image:"OfficeDoorBlue.png"},{index:7,image:"Field.png"}]),Ge(),$e()}catch(t){console.warn("Failed to init backrooms wallpaper:",t)}}async function qe(t){if(!Array.isArray(t)){console.warn("Expected an array of { index, image } objects. In loadImagesToReplaceTextures");return}let e=t.map(async(o,n)=>{let{index:i,image:a}=o||{};try{let s=await Ve(a);return i&&i>=0&&(N[i]=s),s}catch(s){return console.warn(`Failed to load texture "${a}" for index ${i} and dont support replacing with cool gmod missing texture:`,s),null}});await Promise.all(e)}function v0(t){if(!Array.isArray(t)||t.length===0)throw new Error("Array must be non-empty.");let e=B(t.length)-1;return t[e]}function B(t){if(t<=0)throw new Error("The maximum value must be greater than 0.");return Math.floor(Math.random()*t)+1}function O0(t,e,o){return t+(e-t)*o}function Zt(t,e){let o=t?t.length:0;if(o===0)return-1;if(e<=t[0])return 0;if(e>=t[o-1])return o-1;let n=0,i=o-1;for(;n<=i;){let a=n+i>>1,s=t[a];if(s===e)return a;s<e?n=a+1:i=a-1}return e-t[i]<=t[n]-e?i:n}function Kt(t){let e=t.charCodeAt(0)===35?t.slice(1):t,o=parseInt(e.length===3?e.split("").map(n=>n+n).join(""):e,16);return[o>>16&255,o>>8&255,o&255]}var G={x:10,y:8},U={x:3.5,y:3.5};var c={MAP:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,2,6,2,0,0,0,0,0,0,0,2,6,2,0,0,1],[1,0,0,0,2,0,2,0,0,0,0,0,0,0,2,0,2,0,0,1],[1,0,0,0,2,2,2,0,0,0,0,0,0,0,2,2,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,5,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,3,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,3,3,1,3,3,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,0,0,0,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,2,2,2,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,1,0,2,0,2,0,1,0,3,0,0,0,1],[1,0,0,0,0,0,0,0,0,2,6,2,0,0,0,0,0,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],MAP_W:-1,MAP_H:-1,cielingColorFront:"",floorColorFront:"",cielingColorBack:"",floorColorBack:"",dontPersist:!1,sightDist:15,zones:[{color:"#101b2e",x:0,y:0,w:1,h:1}]},w0=[{name:"Village",mapLayout:[[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,1,2,3,4,5,6,7,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,1,1,1,1,1,6,1,1,6,1,1,1,1,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3]],exitPos:{x:10,y:12},startPos:{x:9.5,y:1.5},zones:[{color:"#101b2e",x:0,y:0,w:1,h:1,cielingColorFront:"#271810",cielingColorBack:"#271810",floorColorBack:"#101b2e",fogColor:"#101b2e"},{color:"#8b8000",x:3,y:5,w:14,h:12,cielingColorFront:"#8b8000",cielingColorBack:"#000000",floorColorBack:"#000000",fogColor:"#000000"},{color:"#054213",x:1,y:0,w:18,h:19,cielingColorFront:"#6495ed",cielingColorBack:"#6495ed",floorColorBack:"#03210a",fogColor:"#101b2e"}]},{name:"TowerFloor1",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,1,1,1,1,1,0,0,1,1,1,1,1,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,3,3,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,3,3,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,6,1,1,1,1,0,0,1,6,1,1,1,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,1,1,1,1,1,1,6,1,1,1,1,1,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,1,1,1,1,1,1,0,0,0,1,0,0,1],[1,0,0,1,1,1,1,1,0,0,0,0,1,1,1,1,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,4,4,1,1,1,1,1,1,1,1,1]],exitPos:{x:10,y:17},startPos:{x:5.5,y:4.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#000000",floorColorBack:"#000000",zones:[{color:"#101b2e",x:0,y:0,w:1,h:1}]},{name:"Gallery",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,4,4,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,0,0,0,3,1],[1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,3,1,0,0,0,0,0,1],[1,1,0,0,0,7,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,2,0,0,1],[1,1,1,7,1,1,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,6],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0,0,2,0,0,1],[1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,0,0,2,0,0,1],[1,1,0,0,0,3,0,0,0,0,0,3,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,3,0,0,0,0,0,3,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,3,0,0,0,0,0,3,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,3,0,0,0,0,0,3,0,0,0,1,0,0,2,0,0,1],[1,1,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,0,0,2,0,0,1],[1,0,2,2,2,2,2,2,2,2,2,0,1,0,1,0,1,0,1,0,0,2,0,0,1],[4,0,2,2,2,2,2,2,2,2,2,0,6,0,6,0,6,0,6,0,0,2,0,0,1],[1,0,2,2,2,2,2,2,2,2,2,0,1,0,1,0,1,0,1,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,3,0,0,0,3,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],exitPos:{x:3,y:3},startPos:{x:1.5,y:21.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#ECDE60",floorColorBack:"#000000",sightDist:10,zones:[{color:"#101b2e",x:0,y:0,w:1,h:1}]},{name:"LongHallways",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,1,0,0,0,0,0,0,3,3,3,3,3,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,1,0,0,0,0,0,3,3,3,3,3,3,3,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,3,3,3,0,0,0,3,3,3,0,0,0,0,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,3,3,3,3,0,4,0,3,3,3,3,0,0,0,1,1,1],[1,7,7,1,1,6,1,1,1,6,1,1,1,6,1,1,1,6,1,1,0,0,3,3,3,3,3,0,0,0,3,3,3,3,3,0,0,1,1,1],[1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,0,1],[1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,6,0,1],[1,7,7,1,1,6,1,1,1,1,1,1,1,1,1,1,1,6,1,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,0,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,2,2,0,2,2,2,2,6,2,2,2,2,0,2,2,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,3,0,0,0,0,0,3,2,0,0,0,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,0,3,3,3,3,3,0,3,3,3,3,3,0,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,1,0,0,0,0,3,3,3,3,0,3,3,3,3,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,2,3,0,0,0,0,0,3,2,0,0,0,1,0,0,0,0,0,3,3,3,0,3,3,3,0,0,0,0,0,1,1,1],[1,7,7,1,2,2,0,2,2,2,2,6,2,2,2,2,0,2,2,1,0,0,0,0,0,0,3,3,0,3,3,0,0,0,0,0,0,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,1,1,1,1,1,1,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1],[1,7,7,1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,1,1,1],[1,7,7,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1],[1,7,7,1,0,0,6,0,3,3,3,3,3,3,3,3,3,3,3,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,1,1,1],[1,7,7,1,0,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,3,3,3,3,3,3,3,3,3,3,3,0,4,0,0,1,1,1],[1,7,7,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1],[1,7,7,1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,1,1,1],[1,7,7,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7,0,0,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,1,1],[1,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],sightDist:10,exitPos:{x:1,y:1},startPos:{x:9.5,y:3.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#000000",floorColorBack:"#000000",zones:[{color:"#101b2e",x:0,y:0,w:1,h:1}]}],jt=new Map;function Jt(t){let e=c.zones,o=e&&e[t]?.color||q,n=jt.get(o);return n||(n=Kt(o),jt.set(o,n)),n}function n0(t,e,o){for(let n=0;n<o.length;n++){let i=o[n],a=Math.min(i.x,i.x+i.w),s=Math.max(i.x,i.x+i.w)-1,l=Math.min(i.y,i.y+i.h),f=Math.max(i.y,i.y+i.h)-1;if(t>=a&&t<=s&&e>=l&&e<=f)return n}return 0}var Z=new Float32Array(S),$=A>>1,D0=new Int16Array(S).fill($),U0=new Float32Array(A);function Ue(){let t=$;for(let e=0;e<A;e++){let o=e-$;U0[e]=o!==0?t/o*(2-r.calculatePlayerHeight()):1e-6}}Ue();var Z0=[],K0=[],j0=[],I0=[],J0=[];function te(){Z0.length=0,K0.length=0,j0.length=0,I0.length=0,Q0.clear()}function Ze(t,e,o,n,i,a,s,l,f,d){if(!i)return;let x=n-o;if(x<=0)return;let p=l||0,h=p<0?0:p>i.height?i.height:p,y=f||i.height,E=i.height-h,g=y<0?0:y>E?E:y,w=Zt(F0,s);t.drawImage(T0[d][F0[w]],a,h,1,g,e,o,1,x)}function ee(t){let e=r.x|0,o=r.y|0,n=n0(e,o,c.zones),i=Z0[n];if(!i){i=t.createLinearGradient(0,0,0,$);let a=c.zones[n].cielingColorFront,s=c.zones[n].cielingColorBack,l=c.zones[n].fogColor;i.addColorStop(0,a||c.cielingColorFront||"#6495ED"),c.cielingColorBack&&i.addColorStop(.5,s||c.cielingColorBack||"#6495ED"),i.addColorStop(.9,l||q),Z0[n]=i}t.fillStyle=i,t.fillRect(0,0,S,$)}var Q0=new Map;function Qt(t){let e=Q0.get(t);if(!e){let[o,n,i]=Jt(t);e=`rgb(${o|0},${n|0},${i|0})`,Q0.set(t,e)}return e}function oe(){J0.length=0;let t=c.zones,e=c.MAP_W,o=c.MAP_H;for(let n=0;n<o;n++)for(let i=0;i<e;i++)J0[n*e+i]=n0(i,n,t)}function ne(t,e,o,n=0){let{dirX:i,dirY:a,planeX:s,planeY:l}=e;n=D0[o]??0;let f=n<$?$:n;if(f>=A)return;let d=c.zones,x=2*(o+.5)/S-1,p=i+s*x,h=a+l*x,y=1/(i*p+a*h),E=U0[f],g=r.x+p*E*y,w=r.y+h*E*y,X=0,R=f,k=null;for(let T=f;T<A;T++){let D=g|0,F=w|0,M=0;if(f===$&&T===$?M=0:M=D>=0&&F>=0&&D<c.MAP_W&&F<c.MAP_H?J0[F*c.MAP_W+D]:0,M!==X){let u0=Qt(X);u0!==k&&(m.fillStyle=u0,k=u0),m.fillRect(o,R,1,T-R),X=M,R=T}let z=U0[T+1]??E,a0=z-E;g+=p*a0*y,w+=h*a0*y,E=z}let L=Qt(X);L!==k&&(m.fillStyle=L),m.fillRect(o,R,1,A-R)}function re(t){let e=j0[0];e||(e=t.createLinearGradient(0,0,0,A),e.addColorStop(0,"rgba(16,27,46,0.08)"),e.addColorStop(.5,"rgba(16,27,46,0.16)"),e.addColorStop(1,"rgba(16,27,46,0.20)"),j0[0]=e),t.fillStyle=e,t.fillRect(0,0,S,A)}function ie(t){let e=$-1,o=A-e,n=r.x|0,i=r.y|0,a=n0(n,i,c.zones),s=K0[a];if(!s){let l=c.zones[a].floorColorBack;s=t.createLinearGradient(0,e,0,A),s.addColorStop(.05,c.zones[a].fogColor||q),s.addColorStop(.15,l||c.floorColorBack||"#03210A"),s.addColorStop(1,"rgba(0,0,0,0)"),K0[a]=s}t.fillStyle=s,t.fillRect(0,e,S,o)}function ae(t,e,o,n,i){let{dirX:a,dirY:s,planeX:l,planeY:f}=e;for(let d=0;d<S;d++){let x=2*(d+.5)/S-1,p=a+l*x,h=s+f*x;if(p<1e-8&&p>-1e-8&&h<1e-8&&h>-1e-8){Z[d]=Number.POSITIVE_INFINITY,D0[d]=0;continue}let y=1/(p||1e-9),E=1/(h||1e-9),g=r.x|0,w=r.y|0,X=y<0?-y:y,R=E<0?-E:E,k,L,T,D;p<0?(k=-1,T=(r.x-g)*X):(k=1,T=(g+1-r.x)*X),h<0?(L=-1,D=(r.y-w)*R):(L=1,D=(w+1-r.y)*R);let F=0,M=1,z=!1,a0=0,u0=0;for(;!z&&a0++<256;){if(T<D?(T+=X,g+=k,F=0):(D+=R,w+=L,F=1),r.sightDist>0){let S0=Math.min(T,D);if(S0>r.sightDist){z=!1,M=0,u0=S0;break}}if(g<0||w<0||g>=n||w>=i){z=!0,M=1;break}let g0=o[w][g];if(g0>0){z=!0,M=g0;break}}if(M===0){Z[d]=Number.POSITIVE_INFINITY,D0[d]=0;continue}let I;F===0?I=T-X:I=D-R,I=G0>I?G0:I;let St=0,Re=F===0?k:0,ke=F===1?L:0,Mt=Math.abs(Re*a+ke*s)>=.9&&Math.abs(x)<=.9&&I<St?St:I,bt=r.x+Mt*p,Tt=r.y+Mt*h,J;F===0?J=Tt-(Tt|0):J=bt-(bt|0),J=J<0?0:J>.999999?.999999:J+1e-6;let Ft=x0[M]||x0[4],m0=N[M],C0=m0?m0.width|0:Ft.w|0,Q=J*C0|0;(F===0&&k>0||F===1&&L<0)&&(Q=C0-Q-1),Q=Q<0?0:Q>=C0?C0-1:Q;let Pe=I<$0?$0:I,h0=A/Pe|0,Y0=(A-h0*r.calculatePlayerHeight())/2|0,_e=Y0+h0,t0=Y0,s0=_e;t0<0&&(t0=0),s0>A&&(s0=A);let vt=s0-t0;if(D0[d]=s0,vt<=0){Z[d]=I;continue}let Ot=(m0?m0.height:Ft.h||N[M]?.height||64)|0,He=(t0-Y0)*(Ot/(h0>1?h0:1)),Le=vt*(Ot/Math.max(1,h0)),Dt=1/(1+I*.25)*(F?.5:1);if(M===7&&(Dt*=.8+.2*Math.sin(t*6+d*.05)),Ze(m,d,t0,s0,m0,Q,Dt,He,Le,M),r.sightDist>0&&I>r.sightDist*l0){let g0=r.sightDist*l0,S0=r.sightDist,It=Math.min(1,Math.max(0,(I-g0)/Math.max(1e-6,S0-g0)));if(It>0){let Be=r.x|0,Xe=r.y|0,Ye=n0(Be,Xe,c.zones);m.save(),m.globalAlpha=It*.85,m.fillStyle=c.zones[Ye].fogColor||q,m.fillRect(d,t0,1,s0-t0),m.restore()}}Z[d]=I}}function Ke(t){return A/t}function je(t,e,o){let{dirY:n,dirX:i,planeY:a,planeX:s,invDet:l}=o,f=l*(n*t-i*e),d=l*(-a*t+s*e);return{transX:f,transY:d}}function Je(t,e){return Math.round((S>>1)*(1+t/e))}function E0(t,e){let o=t.x-r.x,n=t.y-r.y,{transX:i,transY:a}=je(o,n,e);if(a<=.01)return null;let s=Je(i,a),l=t&&typeof t.scale=="number"?t.scale:t&&t.img&&typeof t.img.scale=="number"?t.img.scale:1,f=Ke(a)*l,d=typeof t._hR=="number"?t._hR:Math.round(f),x=.1,p=d;(f>d+x||f<d-x)&&(p=Math.round(f)),t._hR=p;let h=p,y=t.img,E=y&&y.width&&y.height?y.width/y.height:1,g=Math.max(1,Math.round(h*E)),w=A,X=r.calculatePlayerHeight(),R=A*.5,k,L;if(t.ground){let M=t.floorBiasFrac??.04,z=R+X*w/a-M*h,a0=z-h;k=Math.round(a0),L=Math.round(z)}else{let M=Math.round(R-h*.5);k=M,L=M+h}let T={startY:k,endY:L},D=Math.round(s-(g>>1)),F=D+g;return{drawStartX:D,drawEndX:F,drawStartY:T.startY,drawEndY:T.endY,depth:a,size:h,width:F-D}}async function V(t,e){return await Qe(t,e,1)}async function Qe(t,e=1,o=1){let n=`../assets/gfx/${t}`;return new Promise((i,a)=>{let s=new Image;s.onload=()=>{let l=new OffscreenCanvas(s.width*e,s.height*e),f=l.getContext("2d");f.imageSmoothingEnabled=!1,f.drawImage(s,0,0,l.width,l.height),l.baseline=o,l.scale=e,i(l)},s.onerror=()=>a(new Error(`Failed to load sprite: ${n}`)),s.src=n})}var R0,k0,P0,tt,et,ot,nt,rt,it,at;async function se(){ot=await V("noodles.png",3),R0=await V("bow.png",3),rt=await V("pitchfork.png",3),et=await V("keycard1.png",3),nt=await V("emp.png",3),k0=await V("aiDrone1.png",3),P0=await V("aiDrone2.png",3),tt=await V("aiDrone3.png",3),it=await V("Palantrash1.png",3),at=await V("sparkle.png",3)}var b=[];function le(t){v.clearRect(0,0,Y.width,Y.height);let e=6,o=20,n=2,i=Math.floor(o/2),a=Math.max(0,Math.min((r.x|0)-i,c.MAP_W-o)),s=Math.max(0,Math.min((r.y|0)-i,c.MAP_H-o));Y.width=n+o*e+n,Y.height=n+o*e+n;for(let p=0;p<o;p++)for(let h=0;h<o;h++){let y=s+p,E=a+h,g=c.MAP[y]?.[E]??0,w="#0c1220";g===1?w="#ECDE60":g===2?w="#707a88":g===3?w="#00e676":g===4?w="#996633":g===5?w="#FFE300":g===6?w=" #3561ff":g===7&&(w="#00FFFF"),v.fillStyle=w,v.fillRect(n+h*e,n+p*e,e-1,e-1)}for(let p of t){if(!p.alive)continue;let h=n+(p.x-a)*e,y=n+(p.y-s)*e;v.fillStyle=p.type===u.entity?"#ffeb9c":p.type===u.barrel?"#CD1C18":p.type===u.key?"#6aa2ff":p.type===u.food?"#7fffd4":"#ffffff",v.fillRect(h-2,y-2,4,4)}let l=n+(r.x-a)*e,f=n+(r.y-s)*e;v.fillStyle="#e7f3ff",v.beginPath(),v.arc(l,f,2.5,0,Rt),v.fill();let d=Math.cos(r.a),x=Math.sin(r.a);v.strokeStyle="#78f3d3",v.beginPath(),v.moveTo(l,f),v.lineTo(l+d*1.5*e,f+x*1.5*e),v.stroke()}var C=null,r0=null,_=null,st=null,ce=null;function ct(){C||(C=new(window.AudioContext||window.webkitAudioContext))}function P({freq:t=440,dur:e=.1,type:o="square",vol:n=.2,slide:i=0}){if(!C)return;let a=C.createOscillator(),s=C.createGain();a.type=o,a.frequency.value=t,s.gain.value=n,a.connect(s).connect(C.destination);let l=C.currentTime;i&&(a.frequency.setValueAtTime(t,l),a.frequency.linearRampToValueAtTime(t+i,l+e)),s.gain.setValueAtTime(n,l),s.gain.exponentialRampToValueAtTime(.001,l+e),a.start(l),a.stop(l+e)}function lt({dur:t=.2,vol:e=.2,lp:o=1200}){if(!C)return;let n=C.createBuffer(1,C.sampleRate*t,C.sampleRate),i=n.getChannelData(0);for(let d=0;d<i.length;d++)i[d]=Math.random()*2-1;let a=C.createBufferSource(),s=C.createGain(),l=C.createBiquadFilter();a.buffer=n,s.gain.value=e,l.type="lowpass",l.frequency.value=o,a.connect(l).connect(s).connect(C.destination);let f=C.currentTime;a.start(f),a.stop(f+t)}var W={shot:()=>{let t=B(50),e=-B(50);P({freq:220+t+e,dur:.05+B(3)/100,type:"square",vol:.25,slide:120}),lt({dur:.03+B(3)/100,vol:.15,lp:800})},pickup:()=>{P({freq:880,dur:.06,type:"triangle",vol:.2}),P({freq:1180,dur:.08,type:"triangle",vol:.18})},explode:()=>{lt({dur:1,vol:.3,lp:800}),P({freq:90,dur:.7,type:"sawtooth",vol:.12,slide:-60})},hurt:()=>{P({freq:140,dur:.12,type:"sawtooth",vol:.2,slide:-50})},killedEntity:()=>{let t=Math.random()*16-8;P({freq:320+t,dur:.26,type:"triangle",vol:.3,slide:-220}),P({freq:480+t,dur:.22,type:"sawtooth",vol:.1,slide:-260}),P({freq:90,dur:.08,type:"sine",vol:.18}),lt({dur:.05,vol:.1,lp:1e3}),setTimeout(()=>{P({freq:170+t,dur:.07,type:"triangle",vol:.16,slide:70})},90)},door:()=>{P({freq:420,dur:.12,type:"square",vol:.15})},portal:()=>{P({freq:600,dur:.5,type:"sawtooth",vol:.2}),P({freq:400,dur:.3,type:"sawtooth",vol:.2,slide:50}),P({freq:600,dur:.5,type:"sawtooth",vol:.2})}};async function to(t,{volume:e=.15}={}){if(C)try{if(!st||t!==ce){let n=await(await fetch(t,{cache:"force-cache"})).arrayBuffer();st=await C.decodeAudioData(n),ce=t}fe(),_=C.createBufferSource(),_.buffer=st,_.loop=!0,r0=C.createGain(),r0.gain.value=e,_.connect(r0).connect(C.destination),_.start()}catch(o){try{fe();let n=new Audio(t);n.loop=!0,n.volume=Math.max(0,Math.min(1,e)),await n.play(),_={stop:()=>n.pause(),disconnect:()=>{}},r0=null}catch(n){}}}function fe(){try{_&&_.stop(0)}catch(t){}if(_&&_.disconnect)try{_.disconnect()}catch(t){}if(r0)try{r0.disconnect()}catch(t){}_=null,r0=null}var de=!1;async function ft(){if(!C||_||de)return;de=!0,await to("../assets/sfx/HexenST02SLowed.ogg",{volume:.12})}function i0(t,e){if(t<0||e<0||t>=c.MAP_W||e>=c.MAP_H)return!0;let o=c.MAP[e|0][t|0];return o===0||o===5?!1:o===7?!r.hasBlueKey:o!==6}function c0(t,e,o){return!!(i0(t,e)||i0(t-o,e)||i0(t+o,e)||i0(t,e-o)||i0(t,e+o))}var f0={EXPLOSION:"explosion",SCREEN_FLASH:"screen_flash"},eo={[f0.EXPLOSION]:{lifetime:.5,startRadius:.1,endRadius:1,expansionTime:.4,startOpacity:1,endOpacity:0,primaryColor:{h:30,s:90,l:60},secondaryColor:{h:15,s:85,l:50},glowColor:{h:45,s:100,l:75},fillColor:{h:25,s:80,l:40},ringLineWidth:3,glowLineWidth:2,innerLineWidth:1,renderFunction:lo,ignoreBounds:!1},[f0.SCREEN_FLASH]:{lifetime:.15,startOpacity:.85,endOpacity:0,color:"#ffffff",renderFunction:co,ignoreBounds:!0}},A0=[];function pe(t,e,o,n,i={}){let a=eo[t];if(!a)return console.warn(`Unknown effect type: ${t}`),null;let s={ignoreBounds:!1,type:t,x:e,y:o,radius:n,maxRadius:n,age:0,lifetime:i.lifetime??a.lifetime,opacity:i.startOpacity??a.startOpacity,startOpacity:i.startOpacity??a.startOpacity,endOpacity:i.endOpacity??a.endOpacity,...a,...i};return A0.push(s),s}function ue(t,e,o,n={}){return pe(f0.EXPLOSION,t,e,o,n)}function me({color:t="#ffffff",duration:e=.15,alpha:o=.85}={}){pe(f0.SCREEN_FLASH,0,0,1,{lifetime:e,startOpacity:o,endOpacity:0,color:t,ignoreBounds:!0})}function he(t){for(let e=A0.length-1;e>=0;e--){let o=A0[e];o.age+=t;let n=Math.min(o.age/o.lifetime,1);oo(o,n),o.age>=o.lifetime&&A0.splice(e,1)}}function oo(t,e){switch(t.type){case f0.EXPLOSION:no(t,e);break;case f0.SCREEN_FLASH:ro(t,e);break}}function no(t,e){t.opacity=O0(t.startOpacity,t.endOpacity,e);let o=Math.min(e/t.expansionTime,1),n=O0(t.startRadius,t.endRadius,o);t.radius=t.maxRadius*n}function ro(t,e){let o=1-(1-e)*(1-e);t.opacity=O0(t.startOpacity,t.endOpacity,o)}function io(){return A0}function ge(t,e,o,n,i){let a=io();if(a.length!==0){t.save();for(let s of a)ao(t,s,e,o,n,i);t.restore()}}function ao(t,e,o,n,i,a){let s=so(e.x,e.y,o,n,i,a,e.ignoreBounds);!s&&!e.ignoreBounds||e.renderFunction(t,e,s)}function so(t,e,o,n,i,a,s=!1){let l=t-a.x,f=e-a.y,{dirY:d,dirX:x,planeY:p,planeX:h,invDet:y}=o,E=y*(d*l-x*f),g=y*(-p*l+h*f);return g<=.1&&!s?null:s?{x:n/2,y:i/2,radius:i,depth:g}:{x:n/2*(1+E/g),y:i/2+64,radius:i/g*.5,depth:g}}function lo(t,e,o){let n=o.radius*e.radius,i=performance.now()*.001,a=Math.sin(i*8)*12,s=Math.sin(i*12)*.15+1,l=o.y,f=o.x;t.globalAlpha=e.opacity*.3,t.fillStyle=`hsl(${e.fillColor.h+a*.5}, ${e.fillColor.s}%, ${e.fillColor.l}%)`,t.beginPath(),t.arc(f,l,n*.7,0,2*Math.PI),t.fill(),t.globalAlpha=e.opacity*.5,t.strokeStyle=`hsl(${e.glowColor.h+a}, ${e.glowColor.s}%, ${e.glowColor.l}%)`,t.lineWidth=e.glowLineWidth*1.5,t.beginPath(),t.arc(f,l,n*s,0,2*Math.PI),t.stroke(),t.globalAlpha=e.opacity*.85,t.strokeStyle=`hsl(${e.primaryColor.h+a*.8}, ${e.primaryColor.s}%, ${e.primaryColor.l}%)`,t.lineWidth=e.ringLineWidth,t.beginPath(),t.arc(f,l,n*.9,0,2*Math.PI),t.stroke(),t.globalAlpha=e.opacity*.6,t.strokeStyle=`hsl(${e.secondaryColor.h+a*1.3}, ${e.secondaryColor.s}%, ${e.secondaryColor.l}%)`,t.lineWidth=e.innerLineWidth,t.beginPath(),t.arc(f,l,n*.5,0,2*Math.PI),t.stroke()}function co(t,e){if(e.opacity<=0)return;let o=t.canvas.width,n=t.canvas.height;t.save(),t.globalAlpha=e.opacity,t.fillStyle=e.color||"#ffffff",t.fillRect(0,0,o,n),t.restore()}var _0={[u.entity]:{type:u.entity,ground:!0,scale:.66,floorBiasFrac:.2,animationTime:0,animationFrame:0},[u.ball]:{type:u.ball,ground:!1,scale:.75,floorBiasFrac:.2,spark1:null,spark2:null,spark3:null},[u.sparkle]:{type:u.sparkle,ground:!1,scale:.75,floorBiasFrac:.2},[u.barrel]:{type:u.barrel,ground:!0,scale:.66,floorBiasFrac:.04},[u.food]:{type:u.food,ground:!0,scale:.25,floorBiasFrac:.04},[u.key]:{type:u.key,ground:!0,scale:.25,floorBiasFrac:.04}};Object.freeze(_0);for(let t in _0)Object.freeze(_0[t]);var H0={[u.ball]:{},[u.sparkle]:{},[u.entity]:{ai(t,e){if(!t.alive)return;switch(t.animationTime+=e,t.animationTime>.2&&(t.animationTime-=.2,t.animationFrame+=1,t.animationFrame%=4),t.animationFrame){case 0:t.img=k0;break;case 1:t.img=P0;break;case 2:t.img=tt;break;case 3:t.img=P0;break}let o=r.x-t.x,n=r.y-t.y,i=Math.hypot(o,n);if(i>.3){let a=1.5*e,s=o/i,l=n/i,f=t.x+s*a,d=t.y+l*a;c0(f,t.y,.4)||(t.x=f),c0(t.x,d,.4)||(t.y=d)}i<.6&&t.hurtCD<=0&&(r.health=Math.max(0,r.health-Wt)|0,K(),O("Entity attacks!"),W.hurt(),t.hurtCD=.8,me({color:"	#740707",duration:.5}),xe()),t.hurtCD>0&&(t.hurtCD-=e)},onHit(t,e){e?(t.alive=!1,O(v0(["Entity murdered!","Entity destroyed!","Entity purged!"])),W.killedEntity()):O("No arrows.")},onTouch(t){pt(u.entity,1e4)&&O("You hear something like water nearby...")},onExplode(t){t.alive=!1,W.killedEntity(),O("The entity is blown to gibs.")}},[u.barrel]:{onHit(t,e){e?(t.alive=!1,ye(t.x,t.y,2.5),O("Kaboom!"),W.explode()):O("No arrows.")},onTouch(t){pt(u.barrel,1e4)&&O("Shooting this barrel may yield useful results...")},onExplode(t){t.alive=!1,ye(t.x,t.y,2.5)}},[u.food]:{onTouch(t){t.alive=!1;let e=r.health>=r.maxHealth;e&&(r.maxHealth+=1),r.health=e0(r.health+Nt,0,r.maxHealth),O(e?"Yummy!":"Health restored."),K(),W.pickup()}},[u.key]:{onTouch(t){t.alive=!1,r.hasBlueKey=!0,W.door(),O("Keycard found! Find the exit!"),dt()},onExplode(t){t.alive=!1,r.hasBlueKey=!0,W.door(),O("The forcefield protecting the exit has suddenly lifted!"),dt()}}};Object.freeze(H0);for(let t in H0)Object.freeze(H0[t]);var fo=0;function j(t,e={x:0,y:0},o=void 0){let n=_0[t],i=H0[t],a=Object.assign(Object.create(i),n);switch(a.id=fo++,a.x=e.x,a.y=e.y,a.dist=0,a.alive=!0,a.hurtCD=0,t){case u.entity:a.img=k0;break;case u.ball:a.img=it;break;case u.sparkle:a.img=at;break;case u.barrel:a.img=nt;break;case u.food:a.img=ot;break;case u.key:a.img=et;break}return o&&Object.assign(a,o),a}function ye(t,e,o){ue(t,e,o);for(let n of b){if(!n.alive)continue;Math.hypot(n.x-t,n.y-e)<o&&(n.onExplode?n.onExplode(n):n.alive=!1)}}var ut=0,H=new Set,mt=!1,ht=0,gt=!1;function Ae(t){window.addEventListener("keydown",e=>{H.add(e.code),ct(),ft(),e.code==="Space"&&(e.preventDefault(),we()),e.code==="KeyM"&&(e.preventDefault(),Y.classList.toggle("visible"))}),window.addEventListener("keyup",e=>H.delete(e.code)),t.addEventListener("mousedown",e=>{e.button===0&&we(),mt=!0,ht=e.clientX,ct(),ft()}),window.addEventListener("mouseup",()=>mt=!1),window.addEventListener("mousemove",e=>{if(mt){let o=e.clientX-ht;ht=e.clientX,r.a+=o*.0035}}),Bt.onclick=()=>go(),Xt.onclick=()=>Y.classList.toggle("visible")}function Ce(t){let e=H.has("ShiftLeft")||H.has("ShiftRight"),o=r.rotSpeed*t,n=r.accel*t,i=Math.cos(r.a),a=Math.sin(r.a),s=-a,l=i;r.weaponAnim>$t&&(r.weaponAnim=-1),r.weaponAnim>=0&&(r.weaponAnim+=t);let f=3;r.velX-=r.velX*f*t,r.velY-=r.velY*f*t,Math.abs(r.velX)<.002&&(r.velX=0),Math.abs(r.velY)<.002&&(r.velY=0),r.isMoving=!1;let d=0,x=0;H.has("ArrowLeft")&&(r.a-=o),H.has("ArrowRight")&&(r.a+=o),(H.has("ArrowUp")||H.has("KeyW"))&&(d+=i*n,x+=a*n,r.isMoving=!0),(H.has("ArrowDown")||H.has("KeyS"))&&(d-=i*n,x-=a*n,r.isMoving=!0),H.has("KeyA")&&(d-=s*n,x-=l*n,r.isMoving=!0),H.has("KeyD")&&(d+=s*n,x+=l*n,r.isMoving=!0),r.velX+=d,r.velY+=x;let p=Math.hypot(r.velX,r.velY);p>M0&&(r.velX*=M0/p,r.velY*=M0/p);let h=r.x+r.velX*t,y=r.y+r.velY*t;c0(h,r.y,V0)?r.velX=0:r.x=h,c0(r.x,y,V0)?r.velY=0:r.y=y}function we(){if(r.weaponAnim>=0)return;r.weaponAnim=0,K(),W.shot();let t=b0(),e=po(t);!e||E0(e,t).depth>zt||e.onHit&&e.onHit(e,!0)}function Se(){for(let t of b)!t.alive||Math.hypot(t.x-r.x,t.y-r.y)>=.6||t.onTouch&&t.onTouch(t)}function Me(){if(gt)return;let t=r.x|0,e=r.y|0;c.MAP[e][t]===5&&(W.portal(),O(`Floor ${o0} cleared.`),q0(o0+1),gt=!0,r.velX=0,r.velY=0,setTimeout(()=>{ho(!0),gt=!1},100))}function po(t){let o=document.getElementById("view").width>>1|0,n=Z[o]||1e9,i=null,a=1e9;for(let s of b){if(!s.alive)continue;let l=E0(s,t);l&&(r.sightDist>0&&l.depth>r.sightDist||o>=l.drawStartX&&o<l.drawEndX&&l.depth<n+.1&&l.depth<a&&(i=s,a=l.depth))}return i}function d0(t=2){let e=0;for(;e++<200;){let o=(Math.random()*(c.MAP_W-2)|0)+1,n=(Math.random()*(c.MAP_H-2)|0)+1;if(c.MAP[n][o]!==0)continue;let i=o+.5-r.x,a=n+.5-r.y;if(!(Math.hypot(i,a)<t))return{x:o,y:n}}return{x:9,y:9}}var xt=new Map;function be(){xt.clear();let{MAP_W:t,MAP_H:e,MAP:o,zones:n}=c;for(let i=0;i<n.length;i++){let a=n[i],s=Math.min(a.x,a.x+a.w),l=Math.max(a.x,a.x+a.w)-1,f=Math.min(a.y,a.y+a.h),d=Math.max(a.y,a.y+a.h)-1,x=e0(s,0,t-1),p=e0(l,0,t-1),h=e0(f,0,e-1),y=e0(d,0,e-1),E=[];for(let g=h;g<=y;g++)for(let w=x;w<=p;w++)i0(w,g)||E.push({x:w,y:g});xt.set(i,E)}}function uo(t){let e=xt.get(t);return!e||e.length===0?null:getRandomElementFromArray(e)}function dt(){let t=c.MAP_W,e=c.MAP_H;for(let o=0;o<e;o++)for(let n=0;n<t;n++)c.MAP[o][n]===7&&(c.MAP[o][n]=0)}function Te(){let t=G.x,e=G.y;for(let o=e-1;o<=e+1;o++)for(let n=t-1;n<=t+1;n++)n===t&&o===e||(c.MAP[o][n]=7)}function Fe(){if(b.length=0,B(100)<50)for(let o=0;o<B(2)*(c.MAP_H/20|0);o++){let n=d0(1);b.push(j(u.barrel,{x:n.x+.5,y:n.y+.5}))}let t=d0(4);b.push(j(u.key,{x:t.x+.5,y:t.y+.5})),t=d0(4),b.push(j(u.food,{x:t.x+.5,y:t.y+.5}));let e=Math.min((2+(o0-1)*2)*(c.MAP_H/20|0),8);for(let o=0;o<e;o++){let n=d0(3.5);b.push(j(u.entity,{x:n.x+.5,y:n.y+.5}))}t=d0(4),b.push(j(u.ball,{x:t.x+.5,y:t.y+.5})),t=d0(4),b.push(j(u.sparkle,{x:t.x+.5,y:t.y+.5})),c.zones.forEach((o,n)=>{let i=n;o.spawnRules?.forEach(s=>{let l=Math.max(0,s.amount|0);for(let f=0;f<l;f++){let d=uo(i);if(!d)break;b.push(j(s.entityType,{x:d.x+.5,y:d.y+.5}))}})})}function K(){kt.style.width=`${r.health/r.maxHealth*100}%`,Pt.style.width=`${r.ammo/60*100}%`,_t.textContent=Math.max(0,r.health),Ht.textContent=r.ammo}var yt=0,wt=0,Et=!1,Ee=!1;function O(t){let e=document.getElementById("gameLog"),o=e?.querySelector(".log-items");if(!o)return;let n=document.createElement("div");n.textContent=t,o.prepend(n),e.classList.contains("collapsed")||requestAnimationFrame(()=>{o.scrollTop=0})}function ve(t){yt>0&&(yt-=t,yt<=0&&(Lt.textContent=r.hasBlueKey?"Find the exit.":"Find the key card."))}function xe(){Et||r.health<=0&&(Et=!0,r.speed=0,r.rotSpeed=0,wt=2,O("YOU DIED! Soul disconnecting from the node..."))}function Oe(t){Et&&(wt-=t,wt<=0&&mo())}function mo(){if(Ee)return;Ee=!0;let t=document.getElementById("game");if(t){let e=document.createElement("div");e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100vw",e.style.height="100vh",e.style.background="#ff0000",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.zIndex="999999",e.style.fontFamily='"Courier New", monospace',e.style.opacity="0",e.style.transition="opacity 2s ease-in",e.innerHTML=`
      <div style="
        background: #000;
        border: 3px solid #04650d;
        color: #20b2db;
        width: 600px;
        max-width: 90vw;
        box-shadow: 0 0 20px #04650d;
        font-family: 'Courier New', monospace;
      ">
        <div style="
          background:#000;
          color: #04650d;
          padding: 8px 15px;
          display: flex;
          justify-content: space-between;
          font-weight: bold;
          font-size: 12px;
        ">
          <span style ="color: #FFFFFF; border: 1px solid #04650d;">Death...</span>
        </div>
        <div style="padding: 20px; min-height: 200px;">
          <div style="margin-bottom: 30px;">
            <div style="text-align: center; color: #FFFFFF; font-size: 32px; margin: 8px 0;">YOU HAVE DIED</div>
          </div>
          <div style="text-align: center; margin-top: 20px;">
            <button id="returnBtn" style="
              background: #000;
              border: 2px solid #04650d;
              color: #04650d;
              padding: 12px 24px;
              font-family: 'Courier New', monospace;
              font-size: 14px;
              font-weight: bold;
              cursor: pointer;
              text-transform: uppercase;
              letter-spacing: 1px;
            ">RETURN TO TERMINAL</button>
          </div>
        </div>
      </div>
    `,document.body.appendChild(e);let o=e.querySelector("#returnBtn");if(o){let n=!1;o.addEventListener("click",i=>{i.preventDefault(),!n&&(n=!0,setTimeout(()=>{window.location.href="../index.html"},100))})}setTimeout(()=>{e.style.opacity="1"},50),t.classList.add("game-paused"),H.clear()}}function At(t=!1){t&&p0(),r.x=U.x,r.y=U.y,r.a=0,r.hasBlueKey=!1,c.MAP[G.y][G.x]=5,Te(),Fe(),K(),O(`Floor ${o0}: Find the keycard.`)}function ho(t=!1){t&&(ut>=w0.length-1?p0():(ut+=1,p0(ut))),r.x=U.x,r.y=U.y,r.a=0,r.hasBlueKey=!1,c.MAP[G.y][G.x]=5,Te(),Fe(),K(),O(`Floor ${o0}: Find the keycard.`)}function go(){q0(1),p0(0),At()}function De(t){for(let e of b)e.alive&&e.ai&&e.ai(e,t)}var X0=performance.now(),B0=new Map;function pt(t,e=0){if(e===0)return!(X0<B0.get(t));let o=X0,n=B0.get(t)??0;return o<n?!1:(B0.set(t,o+e),!0)}function wr(t){B0.set(t,performance.now())}var Ct=A>>1;Ae(y0);var L0=0;function yo(t){let e=`FPS: ${Math.round(t)}`;m.save(),m.font="12px monospace",m.textAlign="right",m.textBaseline="top";let o=S-8,n=6,i=m.measureText(e).width+8,a=16;m.fillStyle="rgba(10, 15, 25, 0.6)",m.fillRect(o-i,n-2,i,a),m.strokeStyle="rgba(60, 80, 130, 0.9)",m.strokeRect(o-i+.5,n-2+.5,i-1,a-1),m.fillStyle="#dfe6ff",m.fillText(e,o,n),m.restore()}function p0(t=-1){let e;if(t!==-1){let o=w0[t];o&&(e=o.dontPersist?JSON.parse(JSON.stringify(o)):o)}else{let o=v0(w0);o&&(e=o.dontPersist?JSON.parse(JSON.stringify(o)):o)}G.x=e.exitPos.x,G.y=e.exitPos.y,U.x=e.startPos.x,U.y=e.startPos.y,r.sightDist=e.sightDist||Yt,c.cielingColorFront=e.cielingColorFront||"#6495ED",c.floorColorFront=e.floorColorFront||"#054213",c.cielingColorBack=e.cielingColorBack||"#6495ED",c.floorColorBack=e.floorColorBack||"#03210A",c.MAP=e.mapLayout,c.MAP_W=c.MAP[0].length,c.MAP_H=c.MAP.length,c.zones=e.zones,be(),te(),oe(),r.x=r.x=e.startPos.x,r.y=e.startPos.y}async function xo(){await se(),await Ut(),p0(0),At(),r.maxHealth=Gt+B(6),r.health=r.maxHealth,r.ammo=5+B(5),K(),requestAnimationFrame(Ie)}function wo(t){let e=b0();if(ee(m),c.zones.length<=2){let o=r.x|0,n=r.y|0,i=n0(o,n,c.zones),a=I0[i];if(!a){let s=c.zones[i].fogColor;a=m.createLinearGradient(0,A,0,Ct),a.addColorStop(0,c.floorColorFront||"#054213"),a.addColorStop(.85,c.floorColorBack||"#03210A"),a.addColorStop(.95,s||q),I0[i]=a}m.fillStyle=a,m.fillRect(0,Ct,S,Ct)}else{for(let o=0;o<S;o++)ne(t,e,o,0);ie(m)}re(m),ae(t,e,c.MAP,c.MAP_W,c.MAP_H),Eo(),b.sort((o,n)=>n.dist-o.dist),Ao(e),Mo(t),ge(m,e,S,A,r)}function Eo(){for(let t of b){let e=t.x-r.x,o=t.y-r.y;t.dist=e*e+o*o}}function Ao(t){m.save();for(let e of b){if(!e.alive)continue;let o=E0(e,t);if(!o||r.sightDist>0&&o.depth>r.sightDist)continue;let n=Co(o);So(e,o,n),m.filter="none"}m.restore()}function Co(t){let e=1/(1+t.depth*.3);if(r.sightDist>0&&t.depth>r.sightDist*l0){let i=r.sightDist*l0,a=Math.min(1,Math.max(0,(t.depth-i)/Math.max(1e-6,r.sightDist-i)));e*=1-a*.6}let o=[1,.85,.7,.55,.4];return{quantizedShade:o.reduce((i,a)=>Math.abs(a-e)<Math.abs(i-e)?a:i,o[0])}}function So(t,e,o){o.quantizedShade<.999&&(m.filter=`brightness(${o.quantizedShade})`);let n=Math.max(1,(e.width??e.drawEndX-e.drawStartX)|0),i=e.drawStartY,a=e.drawEndY-e.drawStartY,s=d=>(d-e.drawStartX)*t.img.width/n|0,l=-1,f=0;for(let d=e.drawStartX;d<=e.drawEndX;d++){let p=d>=0&&d<S&&d<e.drawEndX&&e.depth<=Z[d];if(p&&l===-1&&(l=d,f=s(d)),(!p||d===e.drawEndX)&&l!==-1){let h=d,y=h-l,E=s(h);E<=f&&(E=f+1);let g=Math.min(t.img.width-f,E-f);y>0&&g>0&&a>0&&m.drawImage(t.img,f,0,g,t.img.height,l,i,y,a),l=-1}}}function Mo(t){let e=Math.round(S*.42),o=Math.round(e*(R0.height/R0.width)),n=r.isMoving&&r.weaponAnim<0?10*Math.sin(t*5):0,i=Math.max(8,S*.02|0),a=S*.5-e/2-i/2+n,s=(r.weaponAnim+1)**10,l=s>7?7:s,f=r.weaponAnim>=0?100-l*20:0,d=r.isMoving&&r.weaponAnim<0?10*Math.sin(t*10):0,x=A-o-i+70+d+f;m.drawImage(rt,a,x,e,o)}function Ie(t){let e=Math.min(.05,(t-X0)/1e3);X0=t;let o=e>0?1/e:0;L0=L0?L0*.9+o*.1:o,Ce(e),De(e),he(e),Se(),wo(t/1e3),Y.classList.contains("visible")&&le(b),Me(),ve(e),Oe(e),yo(L0),W0.drawImage(N0,0,0),requestAnimationFrame(Ie)}await xo().catch(console.error);export{p0 as ChangeMapLevel,wr as resetCooldown,pt as tryCooldown};
