import{a as i0,b as ht}from"../chunks/chunk-B3G4DJQ2.js";var ne=90*Math.PI/180,R0=ne*.5,ut=.01,F0=.01,v=15;var h0=.95,s0=.6,E0="#101b2e",u0=5,m0=10,mt=3.33;var wt=0,pt=0;var z=document.getElementById("view"),p=z.getContext("2d");p.imageSmoothingEnabled=!1;h0&&h0!==1&&(z.width=Math.max(1,Math.round(z.width*h0)),z.height=Math.max(1,Math.round(z.height*h0)));var y=z.width,C=z.height,V=document.getElementById("mini"),R=V.getContext("2d");R.imageSmoothingEnabled=!1;var Gt=document.getElementById("hpBar"),gt=document.getElementById("ammoBar"),bt=document.getElementById("hpText"),xt=document.getElementById("ammoText"),yt=document.getElementById("msg"),St=document.getElementById("btnReset"),Mt=document.getElementById("btnToggleMap");var c={x:3.5,y:3.5,a:0,speed:2,rotSpeed:2.6,health:6,maxHealth:6,ammo:1,hasBlueKey:!1,tenacity:20,maxTenacity:20},k0=.2,U=1,Et=1,re=99;function I0(e){U=Math.max(Et,Math.min(re,e|0||Et))}function B0(){let e=Math.cos(c.a),t=Math.sin(c.a),o=-t*Math.tan(R0),n=e*Math.tan(R0),r=1/(o*t-e*n);return{dirX:e,dirY:t,planeX:o,planeY:n,invDet:r}}function r0(e=64,t=64){let o=document.createElement("canvas");return o.width=e,o.height=t,o}function Q(e,t){let o=parseInt(e.slice(1),16),n=o>>16&255,r=o>>8&255,a=o&255,i=s=>i0(((s/255)**2.2+t)*255,0,255)|0;return`#${(i(n)<<16|i(r)<<8|i(a)).toString(16).padStart(6,"0")}`}function p0(e,t,o,n){let r=(o*e.width+t)*4,a=parseInt(n.slice(1),16);e.data[r]=a>>16&255,e.data[r+1]=a>>8&255,e.data[r+2]=a&255,e.data[r+3]=255}function ae(){let e=r0(),t=e.getContext("2d"),o=e.width,n=e.height,r=t.createImageData(o,n),a=["#7a7a7a","#8a8a8a","#9a9a9a","#6a6a6a"];for(let i=0;i<n;i++)for(let s=0;s<o;s++){let f=i%16===15||s%16===15,l=(Math.sin(s*.18)+Math.cos(i*.12))*.06,u=f?"#222222":a[((s/16|0)+(i/16|0))%a.length];p0(r,s,i,Q(u,l))}return t.putImageData(r,0,0),e}function ie(){let e=r0(),t=e.getContext("2d"),o=e.width,n=e.height,r=t.createImageData(o,n);for(let a=0;a<n;a++)for(let i=0;i<o;i++){let s=i%32===0||a%16===0,f=(Math.sin(i*.12)+Math.cos(a*.17))*.07+(((i^a)&7)/128-.03),u=Q(s?"#2a2a2a":"#6a6f73",f);(i*13+a*7)%97===0&&(u=Q(u,-.25)),p0(r,i,a,u)}return t.putImageData(r,0,0),e}function se(){let e=r0(),t=e.getContext("2d"),o=e.width,n=e.height,r=t.createImageData(o,n);for(let a=0;a<n;a++)for(let i=0;i<o;i++){let s=Math.sin((i+a)*.18)*.1+Math.cos((i-a)*.14)*.08,f=((i^a<<1)&15)/255-.02,l=Q("#2e6a2e",s+f);((i+a*2)%13===0||(i*3-a)%29===0)&&(l=Q(l,-.18)),(i*5+a*7)%101===0&&(l=Q(l,.18)),p0(r,i,a,l)}return t.putImageData(r,0,0),e}function Bt(e="#5b4b2a"){let t=r0(),o=t.getContext("2d"),n=t.width,r=t.height,a=o.createImageData(n,r);for(let i=0;i<r;i++)for(let s=0;s<n;s++){let f=Math.sin(s*.22+Math.cos(i*.05)*.4)*.08+Math.sin(i*.07)*.02;p0(a,s,i,Q(e,f))}o.putImageData(a,0,0),o.fillStyle="#3a3a3a",o.fillRect(0,18,n,4),o.fillRect(0,42,n,4),o.fillStyle="#6a6a6a";for(let i=6;i<n;i+=12)o.fillRect(i,19,2,2),o.fillRect(i,43,2,2);return o.strokeStyle="#444",o.lineWidth=2,o.beginPath(),o.arc(46,32,4,0,Math.PI*2),o.stroke(),t}function ce(){let e=r0(),t=e.getContext("2d"),o=e.width,n=e.height;t.fillStyle="#1f1f24",t.fillRect(0,0,o,n);let r=o/2,a=n/2,i=t.createRadialGradient(r,a,4,r,a,28);i.addColorStop(0,"#74CCEA"),i.addColorStop(.5,"#20B2DB"),i.addColorStop(1,"#FFE300"),t.fillStyle=i,t.beginPath(),t.arc(r,a,26,0,Math.PI*2),t.fill(),t.strokeStyle="rgba(255,255,255,0.25)";for(let s=0;s<6;s++){t.beginPath();let f=8+s*3;t.arc(r,a,f,s*.6,s*.6+Math.PI*1.2),t.stroke()}return t.strokeStyle="#3a3a3a",t.lineWidth=4,t.beginPath(),t.arc(r,a,28,0,Math.PI*2),t.stroke(),e}function le(){let e=Bt("#6a4a2a"),t=e.getContext("2d");t.fillStyle="#103b5f",t.fillRect(28,8,8,48),t.fillStyle="#74c8ff";for(let o=12;o<52;o+=8)t.fillRect(30,o,4,2);return e}function fe(){let e=r0(),t=e.getContext("2d"),o=e.width,n=e.height,r=t.createImageData(o,n),a=(d,h,m)=>{let G=parseInt(d.slice(1),16),g=parseInt(h.slice(1),16),x=G>>16&255,B=G>>8&255,b=G&255,E=g>>16&255,A=g>>8&255,X=g&255,T=x+(E-x)*m|0,N=B+(A-B)*m|0,_=b+(X-b)*m|0;return`#${(T<<16|N<<8|_).toString(16).padStart(6,"0")}`},i=1337,s=()=>(i=i*1664525+1013904223>>>0)/4294967295,f=[];for(let d=0;d<7;d++)f.push({x:6+s()*(o-12),y:6+s()*(n-12),r:5+s()*9});let l=[];for(let d=0;d<4;d++){let h=s()*o,m=s()*n,G=s()*Math.PI*2,g=20+s()*28,x=h+Math.cos(G)*g,B=m+Math.sin(G)*g,b=2+s()*2.5;l.push({sx:h,sy:m,ex:x,ey:B,rad:b})}let u=(d,h,m,G,g,x)=>{let B=g-m,b=x-G,E=d-m,A=h-G,X=B*B+b*b||1,T=(E*B+A*b)/X;T=T<0?0:T>1?1:T;let N=m+T*B-d,_=G+T*b-h;return Math.sqrt(N*N+_*_)};for(let d=0;d<n;d++)for(let h=0;h<o;h++){let m=Math.sin(h*.23)*.07+Math.cos(d*.19)*.06,G=Math.sin((h+d)*.09)*.05+Math.cos((h-d)*.08)*.04,g=Math.sin(h*.6+d*.15)*.02+Math.cos(h*.2-d*.5)*.015,x=((h*31^d*17)&31)/255-.03,B=m+G+g,b="#FE6660",E=0;for(let M=0;M<f.length;M++){let D=h-f[M].x,P=d-f[M].y,t0=Math.sqrt(D*D+P*P);t0<f[M].r&&(E=Math.max(E,1-t0/f[M].r))}E>0&&(b=a(b,"#f3e08a",Math.min(.45,E*.6)));let A=0;for(let M=0;M<l.length;M++){let D=u(h,d,l[M].sx,l[M].sy,l[M].ex,l[M].ey),P=1-Math.min(1,D/l[M].rad);P>0&&(A=Math.max(A,P))}A>0&&(b=a(b,"#f3d37a",Math.min(.5,A*.8)));let T=(h*13+d*29)%211===0||(h+d*5&63)===7?-.3:0,N=(h*7-d*11)%197===0?.16:0,_=B+x+T+N;p0(r,h,d,Q(b,_))}t.putImageData(r,0,0),t.globalAlpha=.5,t.strokeStyle="#9F0000",t.lineWidth=1;for(let d=0;d<10;d++){t.beginPath();let h=2+d*8;t.moveTo(2,h);for(let m=2;m<o-2;m+=8){let G=h+Math.sin((m+d*7)*.4)*3+(d%2?2:-2);t.lineTo(m,G)}t.stroke()}return t.globalAlpha=1,t.strokeStyle="#7E1A09",t.lineWidth=2,t.strokeRect(1,1,o-2,n-2),e}var de=[null,ae(),ie(),se(),Bt(),ce(),le(),fe()],j=[...de];function At(e){let o=e.getContext("2d").getImageData(0,0,e.width,e.height),n=[];for(let r=0;r<e.width;r++){let a=new Uint8ClampedArray(e.height*4);for(let i=0;i<e.height;i++){let s=(i*e.width+r)*4,f=i*4;a[f]=o.data[s],a[f+1]=o.data[s+1],a[f+2]=o.data[s+2],a[f+3]=o.data[s+3]}n.push({data:a,h:e.height})}return{cols:n,w:e.width,h:e.height}}var w0=j.map(e=>e?At(e):null);function he(){w0.length=0,j.forEach(e=>{w0.push(e?At(e):null)})}async function ue(e){let t=`../assets/gfx/${e}`;return new Promise((o,n)=>{let r=new Image;r.onload=()=>{let a=r0(64,64),i=a.getContext("2d");i.imageSmoothingEnabled=!1,i.drawImage(r,0,0,64,64),o(a)},r.onerror=()=>n(new Error(`Failed to load texture: ${t}`)),r.src=t})}async function vt(){try{await me([{index:1,image:"OfficeWall.png"}]),he()}catch(e){console.warn("Failed to init backrooms wallpaper:",e)}}async function me(e){if(!Array.isArray(e)){console.warn("Expected an array of { index, image } objects. In loadImagesToReplaceTextures");return}let t=e.map(async(o,n)=>{let{index:r,image:a}=o||{};try{let i=await ue(a);r&&r>=0&&r<j.length?j[r]=i:j.push(i)}catch(i){console.warn(`Failed to load texture "${a}" for index ${r} and dont support replacing with cool gmod missing texture:`,i)}});await Promise.all(t)}var q={x:10,y:8},J={x:3.5,y:3.5},w={MAP:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,2,6,2,0,0,0,0,0,0,0,2,6,2,0,0,1],[1,0,0,0,2,0,2,0,0,0,0,0,0,0,2,0,2,0,0,1],[1,0,0,0,2,2,2,0,0,0,0,0,0,0,2,2,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,5,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,3,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,3,3,1,3,3,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,0,0,0,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,2,2,2,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,1,0,2,0,2,0,1,0,3,0,0,0,1],[1,0,0,0,0,0,0,0,0,2,6,2,0,0,0,0,0,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],MAP_W:-1,MAP_H:-1,cielingColorFront:"",floorColorFront:"",cielingColorBack:"",floorColorBack:""},G0=[{name:"Village",mapLayout:[[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,1,1,1,1,1,1,6,6,1,1,1,1,1,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3]],exitPos:{x:10,y:12},startPos:{x:9.5,y:1.5}},{name:"TowerFloor1",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,1,1,1,1,1,0,0,1,1,1,1,1,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,3,3,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,3,3,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,1,6,6,1,1,0,0,1,1,6,6,1,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,1,1,1,1,1,6,6,1,1,1,1,1,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,1,1,1,1,1,1,0,0,0,1,0,0,1],[1,0,0,1,1,1,1,1,0,0,0,0,1,1,1,1,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,4,4,1,1,1,1,1,1,1,1,1]],exitPos:{x:10,y:17},startPos:{x:5.5,y:4.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#000000",floorColorBack:"#000000"},{name:"Gallery",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,4,4,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,0,0,0,3,1],[1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,3,1,0,0,0,0,0,1],[1,1,0,0,0,7,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,2,0,0,1],[1,1,1,7,1,1,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0,0,2,0,0,1],[1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,0,0,2,0,0,1],[1,1,0,0,0,3,0,0,0,0,0,3,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,3,0,0,0,0,0,3,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,3,0,0,0,0,0,3,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,3,0,0,0,0,0,3,0,0,0,1,0,0,2,0,0,1],[1,1,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,0,0,2,0,0,1],[1,0,2,2,2,2,2,2,2,2,2,0,1,0,1,0,1,0,1,0,0,2,0,0,1],[4,0,2,2,2,2,2,2,2,2,2,0,6,0,6,0,6,0,6,0,0,2,0,0,1],[1,0,2,2,2,2,2,2,2,2,2,0,1,0,1,0,1,0,1,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,3,0,0,0,3,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],exitPos:{x:3,y:3},startPos:{x:1.5,y:21.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#ECDE60",floorColorBack:"#000000"},{name:"LongHallways",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,1,0,0,0,0,0,0,3,3,3,3,3,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,1,0,0,0,0,0,3,3,3,3,3,3,3,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,3,3,3,0,0,0,3,3,3,0,0,0,0,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,3,3,3,3,0,4,0,3,3,3,3,0,0,0,1,1,1],[1,7,7,1,1,6,1,1,1,6,1,1,1,6,1,1,1,6,1,1,0,0,3,3,3,3,3,0,0,0,3,3,3,3,3,0,0,1,1,1],[1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,0,1],[1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,6,0,1],[1,7,7,1,1,6,1,1,1,1,1,1,1,1,1,1,1,6,1,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,0,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,2,2,0,2,2,2,2,6,2,2,2,2,0,2,2,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,3,0,0,0,0,0,3,2,0,0,0,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,0,3,3,3,3,3,0,3,3,3,3,3,0,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,1,0,0,0,0,3,3,3,3,0,3,3,3,3,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,2,3,0,0,0,0,0,3,2,0,0,0,1,0,0,0,0,0,3,3,3,0,3,3,3,0,0,0,0,0,1,1,1],[1,7,7,1,2,2,0,2,2,2,2,6,2,2,2,2,0,2,2,1,0,0,0,0,0,0,3,3,0,3,3,0,0,0,0,0,0,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,1,1,1,1,1,1,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1],[1,7,7,1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,1,1,1],[1,7,7,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1],[1,7,7,1,0,0,6,0,3,3,3,3,3,3,3,3,3,3,3,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,1,1,1],[1,7,7,1,0,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,3,3,3,3,3,3,3,3,3,3,3,0,4,0,0,1,1,1],[1,7,7,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1],[1,7,7,1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,1,1,1],[1,7,7,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7,0,0,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,1,1],[1,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],exitPos:{x:1,y:1},startPos:{x:9.5,y:3.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#000000",floorColorBack:"#000000"}];var K=new Float32Array(y);function we(e,t,o,n,r,a,i,s,f){let l=n-o;if(l<=0)return;e.save(),e.imageSmoothingEnabled=!1;let u=s||0,d=u<0?0:u>r.height?r.height:u,h=f||r.height,m=r.height-d,G=h<0?0:h>m?m:h;if(e.drawImage(r,a,d,1,G,t,o,1,l),i<.999){let x=(i<0?0:i)*255|0;e.globalCompositeOperation="multiply",e.fillStyle=`rgb(${x},${x},${x})`,e.fillRect(t,o,1,l)}e.restore()}var g0=C>>1;function Ct(e,t,o,n,r){let{dirX:a,dirY:i,planeX:s,planeY:f}=t,l=p.createLinearGradient(0,0,0,g0);l.addColorStop(0,w.cielingColorFront||"#6495ED"),w.cielingColorBack&&l.addColorStop(.5,w.cielingColorBack||"#6495ED"),l.addColorStop(.9,E0),p.fillStyle=l,p.fillRect(0,0,y,g0);let u=p.createLinearGradient(0,C,0,g0);u.addColorStop(0,w.floorColorFront||"#054213"),u.addColorStop(.85,w.floorColorBack||"#03210A"),u.addColorStop(.95,E0),p.fillStyle=u,p.fillRect(0,g0,y,g0);let d=p.createLinearGradient(0,0,0,C);d.addColorStop(0,"rgba(16,27,46,0.08)"),d.addColorStop(.5,"rgba(16,27,46,0.16)"),d.addColorStop(1,"rgba(16,27,46,0.20)"),p.save(),p.fillStyle=d,p.fillRect(0,0,y,C),p.restore();for(let h=0;h<y;h++){let m=2*(h+.5)/y-1,G=a+s*m,g=i+f*m;if(G<1e-8&&G>-1e-8&&g<1e-8&&g>-1e-8){K[h]=Number.POSITIVE_INFINITY;continue}let x=1/(G||1e-9),B=1/(g||1e-9),b=c.x|0,E=c.y|0,A=x<0?-x:x,X=B<0?-B:B,T,N,_,M;G<0?(T=-1,_=(c.x-b)*A):(T=1,_=(b+1-c.x)*A),g<0?(N=-1,M=(c.y-E)*X):(N=1,M=(E+1-c.y)*X);let D=0,P=1,t0=!1,Ut=0,Qt=0;for(;!t0&&Ut++<256;){if(_<M?(_+=A,b+=T,D=0):(M+=X,E+=N,D=1),v>0){let M0=Math.min(_,M);if(M0>v){t0=!1,P=0,Qt=M0;break}}if(b<0||E<0||b>=n||E>=r){t0=!0,P=1;break}let d0=o[E][b];if(d0>0){t0=!0,P=d0;break}}if(P===0){K[h]=Number.POSITIVE_INFINITY;continue}let H;D===0?H=_-A:H=M-X,H=Math.max(ut,H);let nt=0,jt=D===0?T:0,Jt=D===1?N:0,rt=Math.abs(jt*a+Jt*i)>=.9&&Math.abs(m)<=.9&&H<nt?nt:H,at=c.x+rt*G,it=c.y+rt*g,e0;D===0?e0=it-(it|0):e0=at-(at|0),e0=e0<0?0:e0>.999999?.999999:e0+1e-6;let st=w0[P]||w0[4],l0=j[P],y0=l0?l0.width|0:st.w|0,o0=e0*y0|0;(D===0&&T>0||D===1&&N<0)&&(o0=y0-o0-1),o0=o0<0?0:o0>=y0?y0-1:o0;let Zt=H<F0?F0:H,S0=C/Zt|0,T0=(C-S0)/2|0,te=T0+S0,n0=T0,f0=te;n0<0&&(n0=0),f0>C&&(f0=C);let ct=f0-n0;if(ct<=0){K[h]=H;continue}let lt=(l0?l0.height:st.h||j[P]?.height||64)|0,ee=(n0-T0)*(lt/Math.max(1,S0)),oe=ct*(lt/Math.max(1,S0)),ft=1/(1+H*.25)*(D?.5:1);if(P===7&&(ft*=.8+.2*Math.sin(e*6+h*.05)),we(p,h,n0,f0,l0,o0,ft,ee,oe),v>0&&H>v*s0){let d0=v*s0,M0=v,dt=Math.min(1,Math.max(0,(H-d0)/Math.max(1e-6,M0-d0)));dt>0&&(p.save(),p.globalAlpha=dt*.85,p.fillStyle=E0,p.fillRect(h,n0,1,f0-n0),p.restore())}K[h]=H}}function pe(e){return C/e}function Ge(e,t,o){let{dirY:n,dirX:r,planeY:a,planeX:i,invDet:s}=o,f=s*(n*e-r*t),l=s*(-a*e+i*t);return{transX:f,transY:l}}function ge(e,t){return Math.round((y>>1)*(1+e/t))}function be(e,t=0,o=.5){let n=t*100,i=(C>>1)+(e>>1)+(n|0),s=i-e;return s<0&&(s=0),{startY:s,endY:i}}function xe(e){let o=(C>>1)-(e>>1);o<0&&(o=0);let n=o+e;return{startY:o,endY:n}}function A0(e,t){let o=e.x-c.x,n=e.y-c.y,{transX:r,transY:a}=Ge(o,n,t);if(a<=.01)return null;let i=ge(r,a),s=e&&typeof e.scale=="number"?e.scale:e&&e.img&&typeof e.img.scale=="number"?e.img.scale:1,f=pe(a)*s,l=typeof e._hR=="number"?e._hR:Math.round(f),u=.1,d=l;(f>l+u||f<l-u)&&(d=Math.round(f)),e._hR=d;let h=d,m=e.img,G=m&&m.width&&m.height?m.width/m.height:1,g=Math.max(1,Math.round(h*G)),x=h/C,B=(e.floorBias??0)*s*x,b=Math.min(.9,Math.max(.2,s)),E=e.ground?be(h,B,b):xe(h),A=Math.round(i-(g>>1)),X=A+g;return{drawStartX:A,drawEndX:X,drawStartY:E.startY,drawEndY:E.endY,depth:a,size:h,width:X-A}}function b0(e,t,o=1){let n=e.trim().split(`
`).map(d=>d.replace(/\s+/g,"")),r=n.length-1;for(;r>=0&&n[r].split("").every(d=>d===".");)r--;r>=0&&r<n.length-1&&(n=n.slice(0,r+1));let a=n.length,i=n[0].length,s=1,f=document.createElement("canvas");f.width=i,f.height=a;let l=f.getContext("2d");l.imageSmoothingEnabled=!1;let u=l.createImageData(i,a);for(let d=0;d<a;d++)for(let h=0;h<i;h++){let m=n[d][h],G=(d*i+h)*4;if(m==="."){u.data[G+3]=0;continue}let g=t[m]||"#ffffff",x=parseInt(g.slice(1),16);u.data[G]=x>>16&255,u.data[G+1]=x>>8&255,u.data[G+2]=x&255,u.data[G+3]=255}if(l.putImageData(u,0,0),o!==1){let d=document.createElement("canvas");d.width=i*o,d.height=a*o;let h=d.getContext("2d");return h.imageSmoothingEnabled=!1,h.drawImage(f,0,0,d.width,d.height),d.baseline=s,d.scale=o,d}return f.baseline=s,f.scale=1,f}async function ye(e,t){return await Se(e,t,1)}async function Se(e,t=1,o=1){let n=`../assets/gfx/${e}`;return new Promise((r,a)=>{let i=new Image;i.onload=()=>{let s=document.createElement("canvas"),f=i.width,l=i.height;s.width=f*t,s.height=l*t;let u=s.getContext("2d");u.imageSmoothingEnabled=!1,u.drawImage(i,0,0,s.width,s.height),s.baseline=o,s.scale=t,r(s)},i.onerror=()=>a(new Error(`Failed to load sprite: ${n}`)),i.src=n})}var Me={B:"#2c1810",b:"#5c3d2e",g:"#7a6b5c",G:"#a89080",k:"#080508",w:"#e8e0d5",W:"#f5f0e8",r:"#8b4513",y:"#ffeb9c"},D0=b0(`
  ................................
  ..............BB..BB............
  .............BbbbbbbB...........
  ...........BbbbGGGGbbbB.........
  ..........BbbbGGGGGGbbbB........
  .........BbbGGGGGGGGGGbbB.......
  ........BbbGGGgGGGGgGGbbB.......
  ........BbbGGgGyyGgGGGbbB.......
  .......BbbGGGGGGGGGGGGbbB.......
  .......BbbGGGGGGGGGGGGbbB.......
  ......BbbGGGGGGGGGGGGGGbbB......
  ......BbbGGGGgGGGGgGGGGbbB......
  ......BbbGGGGwwwwwwGGGGbbB......
  .....BbbGGGwwwWWkWWwwwGGbbB.....
  .....BbbGGGwwwwkkwwwwGGbbB......
  .....BbbGGGwwwwrwwwwGGGbbB......
  .....BbbGGGwwwwwwwwwGGGbbB......
  .....BbbGGGGwwwwwwwGGGGbbB......
  .....BbbGGGGGGGGGGGGGGGbbB......
  .....BbbGGGGGGGGGGGGGGGbbB......
  ......BbbGGGGGGGGGGGGGbbB.......
  ......BbbGGGGGGGGGGGGGbbB.......
  .......BBbbbgggGGGGgggbbBB......
  ........BBBbbbbbbbbbbbbBBB......
  ................................
  `,Me,4),Ee={k:"#0a0f10",g:"#1b5c3a",G:"#2e874f",s:"#7fffd4",b:"#0e1620"},P0=b0(`
  ............
  ....bbbb....
  ..bbGGGGbb..
  .bGGGGGGGGb.
  .bGGgGGgGGb.
  .bGGGGGGGGb.
  .bGgGGGGgGb.
  .bGGGGGGGGb.
  .bGGgGGgGGb.
  .bGGGGGGGGb.
  .bGgGGGGgGb.
  .bGGGGGGGGb.
  .bGGgGGgGGb.
  .bGGGGGGGGb.
  .bGGgGGgGGb.
  .bGGGGGGGGb.
  ..bbGGGGbb..
  ....bbbb....
  ............
  ............
  `,Ee,3),_0=await ye("apple.png",3),Be={k:"#5a4500",g:"#FFD700",G:"#FFA500",s:"#FFF5CC",b:"#4169E1",B:"#87CEEB"},H0=b0(`
  ................
  .....B....B.....
  ....BBBBBBBB....
  ...BBbBBbBBB....
  ...BBbgBgbBB....
  ....BBgggBB.....
  .....kGGGk......
  ....kGGsGGk.....
  ...kGGGGGGGk....
  ...kGGGGGGGk....
  ....kGGGGGk.....
  .....kGGGk......
  .......GG.......
  .......GG.......
  .....GGGGGG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GGggGG.....
  `,Be,4),Ae={b:"#100904",d:"#8f715b",f:"#5a3b1a",r:"#DC143C",s:"#000000",w:"#4d260a"},L0=b0(`
  ............r...
  ............rr..
  ...........w..r.
  .......sb.w...rr
  .......bdw...w..
  .......sfd..w...
  ......sfffdw....
  .....sfffffdb...
  ....sfbffffss...
  ...sfbfbffs.....
  ..sfbfbfbs......
  .sfbfbfbs.......
  .sffbfbs........
  ..sffbs.........
  ...sss..........
  ................
  `,Ae,3),ve={b:"#5a3b1a",f:"#B8860B",r:"#DC143C",s:"#C0C0C0",w:"#8B4513"},v0=b0(`
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ........................................................w.......
  ......................................................sww.......
  ..................................................wwwwws........
  ...............................................wwwwwwww.s.......
  ..............................................wwwwww....s.......
  ...........................................wwwwwww......s.......
  ...........................................wwwww........s.......
  ..........................................wwwww..........s......
  .........................................wwwww...........s......
  ........................................wwwwww...........s......
  ........................................wwwww............s......
  .......................................wwwww.............s......
  .......................................wwwww.............s......
  .......................................wwww...............s.....
  ......................................wwwww...............s.....
  ......................................wwww................s.....
  .....................................wwwww................s.....
  .....................................wwwww................s.....
  .....................................wwww.................s.....
  .....................................wwww.................s.....
  ....................................wwwww.................s.....
  ....................................wwww..................s.....
  ....................................wwww..................s.....
  ..............................ssss.wwwww..................s.....
  ..............................sss..wwww...................s.....
  ..............................s.bb.wwww....................s....
  ..............................s..bbwwww....................s....
  ..................................bwwww....................s....
  ..................................bbwww....................s....
  ...................................bbww....................s....
  ..................................wwbbww...................s....
  ..................................wwwbbb....................s...
  ..................................wwwwwbb...................s...
  ...................................wwwwwbb..................s...
  ....................................wwww.bb.................s...
  ....................................wwww..bbb...............s...
  ....................................wwww....bb..............s...
  ....................................wwww.....bb..............s..
  ....................................wwww......bb.............s..
  ...................................wwwww.......bb............s..
  ..................................wwwwww........bbb..........s..
  ..................................wwwwww.........bbb.........ss.
  ..................................wwwwww...........bbrrrrr....s.
  ..................................wwwwww...........fbbbrrrr...s.
  ...................................wwwww...........ffffbbrrr..s.
  ...................................wwwwww...........ffffbbrrr.s.
  ...................................wwwwww...........ffffffbb.ss.
  ...................................wwwwww.............ffff.bbbs.
  ...................................wwwwwww..............ff...bs.
  `,ve,3),F=[];function Tt(e){R.clearRect(0,0,V.width,V.height);let t=8;V.width=2+w.MAP_W*t+2,V.height=2+w.MAP_H*t+2;for(let r=0;r<w.MAP_H;r++)for(let a=0;a<w.MAP_W;a++){let i=w.MAP[r][a],s="#0c1220";i===1?s="#ECDE60":i===2?s="#707a88":i===3?s="#00e676":i===4?s="#996633":i===5?s="#FFE300":i===6?s=" #3561ff":i===7&&(s="#FE6660"),R.fillStyle=s,R.fillRect(2+a*t,2+r*t,t-1,t-1)}for(let r of e)r.alive&&(R.fillStyle=r.type==="demon"?"#ff6a6a":r.type==="barrel"?"#57d694":r.type==="key"?"#6aa2ff":r.type==="med"?"#f5f1c9":r.type==="ammo"?"#9cf58d":"#ffffff",R.fillRect(2+r.x*t-2,2+r.y*t-2,4,4));R.fillStyle="#e7f3ff",R.beginPath(),R.arc(2+c.x*t,2+c.y*t,2.5,0,ht),R.fill();let o=Math.cos(c.a),n=Math.sin(c.a);R.strokeStyle="#78f3d3",R.beginPath(),R.moveTo(2+c.x*t,2+c.y*t),R.lineTo(2+(c.x+o*1.5)*t,2+(c.y+n*1.5)*t),R.stroke()}function Rt(e){if(!Array.isArray(e)||e.length===0)throw new Error("Array must be non-empty.");let t=I(e.length)-1;return e[t]}function I(e){if(e<=0)throw new Error("The maximum value must be greater than 0.");return Math.floor(Math.random()*e)+1}var S=null,a0=null,O=null,O0=null,Ft=null;function X0(){S||(S=new(window.AudioContext||window.webkitAudioContext))}function L({freq:e=440,dur:t=.1,type:o="square",vol:n=.2,slide:r=0}){if(!S)return;let a=S.createOscillator(),i=S.createGain();a.type=o,a.frequency.value=e,i.gain.value=n,a.connect(i).connect(S.destination);let s=S.currentTime;r&&(a.frequency.setValueAtTime(e,s),a.frequency.linearRampToValueAtTime(e+r,s+t)),i.gain.setValueAtTime(n,s),i.gain.exponentialRampToValueAtTime(.001,s+t),a.start(s),a.stop(s+t)}function Y0({dur:e=.2,vol:t=.2,lp:o=1200}){if(!S)return;let n=S.createBuffer(1,S.sampleRate*e,S.sampleRate),r=n.getChannelData(0);for(let l=0;l<r.length;l++)r[l]=Math.random()*2-1;let a=S.createBufferSource(),i=S.createGain(),s=S.createBiquadFilter();a.buffer=n,i.gain.value=t,s.type="lowpass",s.frequency.value=o,a.connect(s).connect(i).connect(S.destination);let f=S.currentTime;a.start(f),a.stop(f+e)}var W={shot:()=>{let e=I(50),t=-I(50);L({freq:220+e+t,dur:.05+I(3)/100,type:"square",vol:.25,slide:120}),Y0({dur:.03+I(3)/100,vol:.15,lp:800})},pickup:()=>{L({freq:880,dur:.06,type:"triangle",vol:.2}),L({freq:1180,dur:.08,type:"triangle",vol:.18})},explode:()=>{Y0({dur:1,vol:.3,lp:800}),L({freq:90,dur:.7,type:"sawtooth",vol:.12,slide:-60})},hurt:()=>{L({freq:140,dur:.12,type:"sawtooth",vol:.2,slide:-50})},killedDrone:()=>{let e=Math.random()*16-8;L({freq:320+e,dur:.26,type:"triangle",vol:.3,slide:-220}),L({freq:480+e,dur:.22,type:"sawtooth",vol:.1,slide:-260}),L({freq:90,dur:.08,type:"sine",vol:.18}),Y0({dur:.05,vol:.1,lp:1e3}),setTimeout(()=>{L({freq:170+e,dur:.07,type:"triangle",vol:.16,slide:70})},90)},door:()=>{L({freq:420,dur:.12,type:"square",vol:.15})},portal:()=>{L({freq:600,dur:.5,type:"sawtooth",vol:.2}),L({freq:400,dur:.3,type:"sawtooth",vol:.2,slide:50}),L({freq:600,dur:.5,type:"sawtooth",vol:.2})}};async function Ce(e,{volume:t=.15}={}){if(S)try{if(!O0||e!==Ft){let n=await(await fetch(e,{cache:"force-cache"})).arrayBuffer();O0=await S.decodeAudioData(n),Ft=e}kt(),O=S.createBufferSource(),O.buffer=O0,O.loop=!0,a0=S.createGain(),a0.gain.value=t,O.connect(a0).connect(S.destination),O.start()}catch(o){try{kt();let n=new Audio(e);n.loop=!0,n.volume=Math.max(0,Math.min(1,t)),await n.play(),O={stop:()=>n.pause(),disconnect:()=>{}},a0=null}catch(n){}}}function kt(){try{O&&O.stop(0)}catch(e){}if(O&&O.disconnect)try{O.disconnect()}catch(e){}if(a0)try{a0.disconnect()}catch(e){}O=null,a0=null}var It=!1;async function N0(){if(!S||O||It)return;It=!0,await Ce("../assets/sfx/HexenST02SLowed.ogg",{volume:.12})}function Z(e,t){if(e<0||t<0||e>=w.MAP_W||t>=w.MAP_H)return!0;let o=w.MAP[t|0][e|0];return o===0||o===5?!1:o===7?!c.hasBlueKey:o!==6}function W0(e,t,o){return!!(Z(e,t)||Z(e-o,t)||Z(e+o,t)||Z(e,t-o)||Z(e,t+o))}var V0=0,Y=new Set,q0=!1,$0=0,z0=!1;function _t(e){window.addEventListener("keydown",t=>{Y.add(t.code),X0(),N0(),t.code==="Space"&&(t.preventDefault(),Dt()),t.code==="KeyM"&&(t.preventDefault(),V.classList.toggle("visible"))}),window.addEventListener("keyup",t=>Y.delete(t.code)),e.addEventListener("mousedown",t=>{t.button===0&&Dt(),q0=!0,$0=t.clientX,X0(),N0()}),window.addEventListener("mouseup",()=>q0=!1),window.addEventListener("mousemove",t=>{if(q0){let o=t.clientX-$0;$0=t.clientX,c.a+=o*.0035}}),St.onclick=()=>De(),Mt.onclick=()=>V.classList.toggle("visible")}function Ht(e){let t=Y.has("ShiftLeft")||Y.has("ShiftRight"),o=c.speed*(t?2:1)*e,n=c.rotSpeed*e,r=Math.cos(c.a),a=Math.sin(c.a),i=-a,s=r,f=0,l=0;Y.has("ArrowLeft")&&(c.a-=n),Y.has("ArrowRight")&&(c.a+=n),Y.has("ArrowUp")&&(f+=r*o,l+=a*o),Y.has("ArrowDown")&&(f-=r*o,l-=a*o),Y.has("KeyW")&&(f+=r*o,l+=a*o),Y.has("KeyS")&&(f-=r*o,l-=a*o),Y.has("KeyA")&&(f-=i*o,l-=s*o),Y.has("KeyD")&&(f+=i*o,l+=s*o);let u=c.x+f,d=c.y+l;W0(u,c.y,k0)||(c.x=u),W0(c.x,d,k0)||(c.y=d)}function Dt(){let e=!1;c.ammo>0&&(c.ammo--,$(),W.shot(),e=!0);let t=B0(),o=Te(t);if(!o){e||k("No arrows. Look for quivers.");return}switch(o.type){case"drone":e?(o.alive=!1,k("Drone Squashed!"),W.killedDrone()):k("No arrows.");break;case"barrel":e&&(o.alive=!1,Re(o.x,o.y,2.5),k("Kaboom!"),W.explode());break;case"key":o.alive=!1,c.hasBlueKey=!0,W.door(),k("Realmchild Growths Destroyed! Find the exit!"),Yt();break;case"food":{o.alive=!1;let n=c.health>=c.maxHealth;n&&(c.maxHealth+=1),c.health=i0(c.health+m0,0,c.maxHealth),k(n?"Became Stronger.":"Health restored."),$(),W.pickup();break}case"arrows":o.alive=!1,c.ammo=Math.min(60,c.ammo+u0),$(),k(`Arrows +${u0}`),W.pickup();break;default:break}}function Lt(){for(let e of F)if(!(!e.alive||Math.hypot(e.x-c.x,e.y-c.y)>=.6))switch(e.type){case"key":e.alive=!1,c.hasBlueKey=!0,W.door(),k("Realmchild Growths Destroyed! Find the exit!"),Yt();break;case"food":e.alive=!1,c.health>=c.maxHealth?(k("Became Stronger"),c.maxHealth+=1,c.health=i0(c.health+m0,0,c.maxHealth)):(c.health=i0(c.health+m0,0,c.maxHealth),k(`Health +${m0}`)),$(),W.pickup();break;case"arrows":e.alive=!1,c.ammo=Math.min(60,c.ammo+u0),$(),W.pickup(),k(`Arrows +${u0}`);break;default:break}}function Ot(){if(z0)return;let e=c.x|0,t=c.y|0;w.MAP[t][e]===5&&(W.portal(),k(`You escaped! Wave ${U} cleared.`),I0(U+1),z0=!0,setTimeout(()=>{Ie(!0),z0=!1},100))}function Te(e){let o=document.getElementById("view").width>>1|0,n=K[o]||1e9,r=null,a=1e9;for(let i of F){if(!i.alive)continue;let s=A0(i,e);s&&(v>0&&s.depth>v||o>=s.drawStartX&&o<s.drawEndX&&s.depth<n+.1&&s.depth<a&&(r=i,a=s.depth))}return r}function Re(e,t,o){for(let n of F){if(!n.alive)continue;Math.hypot(n.x-e,n.y-t)<o&&(n.alive=!1)}}function x0(e=2){let t=0;for(;t++<200;){let o=(Math.random()*(w.MAP_W-2)|0)+1,n=(Math.random()*(w.MAP_H-2)|0)+1;if(w.MAP[n][o]!==0)continue;let r=o+.5-c.x,a=n+.5-c.y;if(!(Math.hypot(r,a)<e))return{x:o,y:n}}return{x:9,y:9}}function Yt(){let e=w.MAP_W,t=w.MAP_H;for(let o=0;o<t;o++)for(let n=0;n<e;n++)w.MAP[o][n]===7&&(w.MAP[o][n]=0)}function Xt(){let e=q.x,t=q.y;for(let o=t-1;o<=t+1;o++)for(let n=e-1;n<=e+1;n++)n===e&&o===t||(w.MAP[o][n]=7)}function Nt(e){let{barrel:t,enchantedKey:o,food:n,arrowQuiver:r,wolfIdle:a}=e;if(F.length=0,I(100)<50)for(let l=0;l<I(2)*(w.MAP_H/20|0);l++){let u=x0(1);F.push({x:u.x+.5,y:u.y+.5,img:t,type:"barrel",alive:!0,dist:0,ground:!0,scale:.5,floorBias:5})}let i=x0(4);F.push({x:i.x+.5,y:i.y+.5,img:o,type:"key",alive:!0,dist:0,ground:!0,scale:.25,floorBias:35});let s=x0(3);F.push({x:s.x+.5,y:s.y+.5,img:n,type:"food",alive:!0,dist:0,ground:!0,scale:.25,floorBias:35});for(let l=0;l<1+(U/3|0)*(w.MAP_H/20|0);l++)if(l<=1&&I(100)<50||l<1&&c.ammo<=0&&I(100)<80||I(100)<25){let u=x0(3);F.push({x:u.x+.5,y:u.y+.5,img:r,type:"arrows",alive:!0,dist:0,ground:!0,scale:.25,floorBias:35})}let f=Math.min((2+(U-1)*2)*(w.MAP_H/20|0),8);for(let l=0;l<f;l++){let u=x0(3.5);F.push({x:u.x+.5,y:u.y+.5,img:a,type:"drone",alive:!0,dist:0,vx:0,vy:0,hurtCD:0,ground:!0,scale:.5,floorBias:5})}}function $(){Gt.style.width=`${c.health/c.maxHealth*100}%`,gt.style.width=`${c.ammo/60*100}%`,bt.textContent=Math.max(0,c.health),xt.textContent=c.ammo}var K0=0,U0=0,Q0=!1,Pt=!1;function k(e){let t=document.getElementById("gameLog"),o=t?.querySelector(".log-items");if(!o)return;let n=document.createElement("div");n.textContent=e,o.prepend(n),t.classList.contains("collapsed")||requestAnimationFrame(()=>{o.scrollTop=0})}function Wt(e){K0>0&&(K0-=e,K0<=0&&(yt.textContent=c.hasBlueKey?"Find the exit.":"Find the enchanted key."))}function Fe(){Q0||c.health<=0&&(Q0=!0,c.speed=0,c.rotSpeed=0,U0=2,k("YOU DIED! Soul disconnecting from the node..."))}function Vt(e){Q0&&(U0-=e,U0<=0&&ke())}function ke(){if(Pt)return;Pt=!0;let e=document.getElementById("game");if(e){let t=document.createElement("div");t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100vw",t.style.height="100vh",t.style.background="#ff0000",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.zIndex="999999",t.style.fontFamily='"Courier New", monospace',t.style.opacity="0",t.style.transition="opacity 2s ease-in",t.innerHTML=`
      <div style="
        background: #000;
        border: 3px solid #04650d;
        color: #20b2db;
        width: 600px;
        max-width: 90vw;
        box-shadow: 0 0 20px #04650d;
        font-family: 'Courier New', monospace;
      ">
        <div style="
          background:#000;
          color: #04650d;
          padding: 8px 15px;
          display: flex;
          justify-content: space-between;
          font-weight: bold;
          font-size: 12px;
        ">
          <span style ="color: #FFFFFF; border: 1px solid #04650d;">Death...</span>
        </div>
        <div style="padding: 20px; min-height: 200px;">
          <div style="margin-bottom: 30px;">
            <div style="text-align: center; color: #FFFFFF; font-size: 32px; margin: 8px 0;">YOU HAVE DIED</div>
          </div>
          <div style="text-align: center; margin-top: 20px;">
            <button id="returnBtn" style="
              background: #000;
              border: 2px solid #04650d;
              color: #04650d;
              padding: 12px 24px;
              font-family: 'Courier New', monospace;
              font-size: 14px;
              font-weight: bold;
              cursor: pointer;
              text-transform: uppercase;
              letter-spacing: 1px;
            ">RETURN TO TERMINAL</button>
          </div>
        </div>
      </div>
    `,document.body.appendChild(t);let o=t.querySelector("#returnBtn");if(o){let n=!1;o.addEventListener("click",r=>{r.preventDefault(),!n&&(n=!0,setTimeout(()=>{window.location.href="../index.html"},100))})}setTimeout(()=>{t.style.opacity="1"},50),e.classList.add("game-paused"),Y.clear()}}function j0(e=!1){e&&c0(),c.x=J.x,c.y=J.y,c.a=0,c.hasBlueKey=!1,w.MAP[q.y][q.x]=5,Xt(),Nt({wolfIdle:D0,barrel:P0,enchantedKey:H0,food:_0,arrowQuiver:L0}),$(),k(`Wave ${U}: Find the enchanted key.`)}function Ie(e=!1){e&&(V0>=G0.length-1?c0():(V0+=1,c0(V0))),c.x=J.x,c.y=J.y,c.a=0,c.hasBlueKey=!1,w.MAP[q.y][q.x]=5,Xt(),Nt({wolfIdle:D0,barrel:P0,enchantedKey:H0,food:_0,arrowQuiver:L0}),$(),k(`Wave ${U}: Find the enchanted key.`)}function De(){I0(1),c0(0),j0()}function qt(e){for(let t of F)if(t.alive)switch(t.type){case"drone":let o=c.x-t.x,n=c.y-t.y,r=Math.hypot(o,n);if(r>.3){let a=.9*e,i=o/r,s=n/r,f=t.x+i*a,l=t.y+s*a;Z(f,t.y)||(t.x=f),Z(t.x,l)||(t.y=l)}r<.6&&t.hurtCD<=0&&(c.health=Math.max(0,c.health-mt)|0,$(),k("Drone bite!"),W.hurt(),t.hurtCD=.8,Fe()),t.hurtCD>0&&(t.hurtCD-=e);break;default:break}}vt();_t(z);var et=null,ot=null,J0=0,Z0=0;function Pe(){let e=y|0,t=C|0,o=document.createElement("canvas");o.width=e,o.height=t;let n=o.getContext("2d");n.imageSmoothingEnabled=!1;let r=e*.5,a=t*.5,i=Math.min(r,a)*0,s=Math.hypot(r,a),f=n.createRadialGradient(r,a,i,r,a,s);f.addColorStop(0,"rgba(0,0,0,0)"),f.addColorStop(.5,"rgba(0,0,0,1)"),n.fillStyle=f,n.fillRect(0,0,e,t);let l=document.createElement("canvas");l.width=e,l.height=t;let u=l.getContext("2d");u.imageSmoothingEnabled=!1;let d=u.createLinearGradient(0,0,e*.5,0);d.addColorStop(.35,"rgba(0,0,0,1)"),d.addColorStop(1,"rgba(0,0,0,0)"),u.fillStyle=d,u.fillRect(0,0,e*.5,t),et=l;let h=document.createElement("canvas");h.width=e,h.height=t;let m=h.getContext("2d");m.imageSmoothingEnabled=!1;let G=m.createLinearGradient(e,0,e*.5,0);G.addColorStop(.35,"rgba(0,0,0,1)"),G.addColorStop(1,"rgba(0,0,0,0)"),m.fillStyle=G,m.fillRect(e*.5,0,e*.5,t),ot=h}Pe();var C0=0;function _e(e){let t=`FPS: ${Math.round(e)}`;p.save(),p.font="12px monospace",p.textAlign="right",p.textBaseline="top";let o=y-8,n=6,r=p.measureText(t).width+8,a=16;p.fillStyle="rgba(10, 15, 25, 0.6)",p.fillRect(o-r,n-2,r,a),p.strokeStyle="rgba(60, 80, 130, 0.9)",p.strokeRect(o-r+.5,n-2+.5,r-1,a-1),p.fillStyle="#dfe6ff",p.fillText(t,o,n),p.restore()}function c0(e=-1){let t;if(e!==-1){let o=G0[e];o&&(t=o)}else t=Rt(G0);q.x=t.exitPos.x,q.y=t.exitPos.y,J.x=t.startPos.x,J.y=t.startPos.y,c.health=c.maxHealth,w.cielingColorFront=t.cielingColorFront||"#6495ED",w.floorColorFront=t.floorColorFront||"#054213",w.cielingColorBack=t.cielingColorBack||"#6495ED",w.floorColorBack=t.floorColorBack||"#03210A",w.MAP=t.mapLayout,w.MAP_W=w.MAP[0].length,w.MAP_H=w.MAP.length,c.x=c.x=t.startPos.x,c.y=t.startPos.y}function He(){c0(0),j0(),c.maxHealth=6+I(6),c.health=c.maxHealth,c.ammo=5+I(5),$(),requestAnimationFrame(Kt)}function Le(e){let t=B0();Ct(e,t,w.MAP,w.MAP_W,w.MAP_H),Oe(),F.sort((o,n)=>n.dist-o.dist),p.imageSmoothingEnabled=!1,Ye(t),We(),Ve()}function Oe(){for(let e of F){let t=e.x-c.x,o=e.y-c.y;e.dist=t*t+o*o}}function Ye(e){for(let t of F){if(!t.alive)continue;let o=A0(t,e);if(!o||v>0&&o.depth>v)continue;let n=Xe(o);Ne(t,o,n)}}function Xe(e){let t=1/(1+e.depth*.3);if(v>0&&e.depth>v*s0){let r=v*s0,a=Math.min(1,Math.max(0,(e.depth-r)/Math.max(1e-6,v-r)));t*=1-a*.6}let o=[1,.85,.7,.55,.4];return{quantizedShade:o.reduce((r,a)=>Math.abs(a-t)<Math.abs(r-t)?a:r,o[0])}}function Ne(e,t,o){p.save(),o.quantizedShade<.999&&(p.filter=`brightness(${o.quantizedShade})`);let n=Math.max(1,(t.width??t.drawEndX-t.drawStartX)|0),r=t.drawStartY,a=t.drawEndY-t.drawStartY,i=l=>(l-t.drawStartX)*e.img.width/n|0,s=-1,f=0;for(let l=t.drawStartX;l<=t.drawEndX;l++){let d=l>=0&&l<y&&l<t.drawEndX&&t.depth<=K[l];if(d&&s===-1&&(s=l,f=i(l)),(!d||l===t.drawEndX)&&s!==-1){let h=l,m=h-s,G=i(h);G<=f&&(G=f+1);let g=Math.min(e.img.width-f,G-f);m>0&&g>0&&a>0&&p.drawImage(e.img,f,0,g,e.img.height,s,r,m,a),s=-1}}p.restore()}function We(){let e=Math.round(y*.42),t=Math.round(e*(v0.height/v0.width)),o=Math.max(8,y*.02|0),n=y*.8-e-o,r=C-t-o+20;p.drawImage(v0,n,r,e,t)}function Ve(){if(!et||!ot)return;let e=qe(),t={center:tt(e.center),left:tt(e.left),right:tt(e.right)},o=$e(t);J0=J0*.85+o.left*.15,Z0=Z0*.85+o.right*.15,$t(et,J0),$t(ot,Z0)}function qe(){let t=Math.max(6,y*.28|0),o=Math.max(8,y*.3|0),n=y-o>>1|0,r=n+o,a=0,i=Math.min(y,t),s=Math.max(0,y-t),f=y,l=(u,d)=>{let h=Number.POSITIVE_INFINITY;for(let m=u;m<d;m++){let G=K[m];G<h&&(h=G)}return h};return{center:l(n,r),left:l(a,i),right:l(s,f)}}function tt(e){let t=Math.max(pt,1e-6),o=Math.max(t+1e-6,wt);if(!isFinite(e))return 0;let n=(e-t)/(o-t);return Math.max(0,Math.min(1,1-n))}function $e(e){let{center:t,left:o,right:n}=e,r=0,a=0,i=Math.min(o,n),s=Math.max(o,n),f=.05;return i>.5?(r=i,a=i):o>n+f?(r=s,a=0):n>o+f?(a=s,r=0):(r=s,a=s),{left:r,right:a}}function $t(e,t){e&&t>.001&&(p.save(),p.globalAlpha=Math.min(1,t),p.drawImage(e,0,0),p.restore())}var zt=performance.now();function Kt(e){let t=Math.min(.05,(e-zt)/1e3);zt=e;let o=t>0?1/t:0;C0=C0?C0*.9+o*.1:o,Ht(t),qt(t),Lt(),Le(e/1e3),V.classList.contains("visible")&&Tt(F),Ot(),Wt(t),Vt(t),_e(C0),requestAnimationFrame(Kt)}He();export{c0 as ChangeMapLevel};
