import{a as bt,b as wt}from"../chunks/chunk-B3G4DJQ2.js";var l0=document.getElementById("view");l0.width=480;l0.height=270;var S=480,E=270,D0=new OffscreenCanvas(S,E),m=D0.getContext("2d");m.imageSmoothingEnabled=!1;var _0=l0.getContext("2d");_0.imageSmoothingEnabled=!1;var D=document.getElementById("mini"),C=D.getContext("2d");C.imageSmoothingEnabled=!1;var Gt=document.getElementById("hpBar"),Et=document.getElementById("ammoBar"),At=document.getElementById("hpText"),St=document.getElementById("ammoText"),Mt=document.getElementById("msg"),vt=document.getElementById("btnReset"),Ct=document.getElementById("btnToggleMap");var xe=90*Math.PI/180,L0=xe*.5,H0=.01,X0=.01,M=15;var t0=.6,G0="#101b2e",c0=5,Tt=10,Ft=3.33,Bt=2.5,Ot=20,It=.75,E0=20;var r={x:3.5,y:3.5,velX:0,velY:0,a:0,accel:10,rotSpeed:2.6,health:6,maxHealth:20,ammo:1,hasBlueKey:!1,isMoving:!1,weaponAnim:-1,tenacity:20,maxTenacity:20,height:.75,calculatePlayerHeight:()=>r.height<.01?.01:r.height*1},Y0=.2,$=1,Rt=1,be=99;function W0(t){$=Math.max(Rt,Math.min(be,t|0||Rt))}function A0(){let t=Math.cos(r.a),e=Math.sin(r.a),o=-e*Math.tan(L0),n=t*Math.tan(L0),a=1/(o*e-t*n);return{dirX:t,dirY:e,planeX:o,planeY:n,invDet:a}}function we(t=64,e=64){return new OffscreenCanvas(t,e)}var _=new Array(8).fill(null);function Pt(t){let o=t.getContext("2d").getImageData(0,0,t.width,t.height),n=[];for(let a=0;a<t.width;a++){let i=new Uint8ClampedArray(t.height*4);for(let s=0;s<t.height;s++){let l=(s*t.width+a)*4,c=s*4;i[c]=o.data[l],i[c+1]=o.data[l+1],i[c+2]=o.data[l+2],i[c+3]=o.data[l+3]}n.push({data:i,h:t.height})}return{cols:n,w:t.width,h:t.height}}var f0=_.map(t=>t?Pt(t):null);function Ge(){f0.length=0,_.forEach(t=>{f0.push(t?Pt(t):null)})}var M0=Array.from({length:82},(t,e)=>e*.0125),S0={};function Ee(){for(let t=1;t<_.length;t++)if(_[t]){S0[t]={};for(let e of M0){let o=new OffscreenCanvas(_[t].width,_[t].height),n=o.getContext("2d");n.drawImage(_[t],0,0);let a=e*255|0;n.globalCompositeOperation="multiply",n.fillStyle=`rgb(${a},${a},${a})`,n.fillRect(0,0,o.width,o.height),S0[t][e]=o}}}async function Ae(t){let e=`../assets/gfx/${t}`;return new Promise((o,n)=>{let a=new Image;a.onload=()=>{let i=we(64,64),s=i.getContext("2d",{willReadFrequently:!0});s.imageSmoothingEnabled=!1,s.drawImage(a,0,0,64,64),o(i)},a.onerror=()=>n(new Error(`Failed to load texture: ${e}`)),a.src=e})}async function kt(){try{await Se([{index:1,image:"OfficeWall.png"},{index:2,image:"Panel.png"},{index:3,image:"Hedge.png"},{index:4,image:"OfficeDoor.png"},{index:5,image:"Portal.png"},{index:6,image:"OfficeDoorBlue.png"},{index:7,image:"Field.png"}]),Ge(),Ee()}catch(t){console.warn("Failed to init backrooms wallpaper:",t)}}async function Se(t){if(!Array.isArray(t)){console.warn("Expected an array of { index, image } objects. In loadImagesToReplaceTextures");return}let e=t.map(async(o,n)=>{let{index:a,image:i}=o||{};try{let s=await Ae(i);return a&&a>=0&&(_[a]=s),s}catch(s){return console.warn(`Failed to load texture "${i}" for index ${a} and dont support replacing with cool gmod missing texture:`,s),null}});await Promise.all(e)}var H={x:10,y:8},q={x:3.5,y:3.5},p={MAP:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,2,6,2,0,0,0,0,0,0,0,2,6,2,0,0,1],[1,0,0,0,2,0,2,0,0,0,0,0,0,0,2,0,2,0,0,1],[1,0,0,0,2,2,2,0,0,0,0,0,0,0,2,2,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,5,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,3,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,3,3,1,3,3,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,0,0,0,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,2,2,2,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,1,0,2,0,2,0,1,0,3,0,0,0,1],[1,0,0,0,0,0,0,0,0,2,6,2,0,0,0,0,0,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],MAP_W:-1,MAP_H:-1,cielingColorFront:"",floorColorFront:"",cielingColorBack:"",floorColorBack:""},d0=[{name:"Village",mapLayout:[[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,1,2,3,4,5,6,7,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,1,1,1,1,1,6,1,1,6,1,1,1,1,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3]],exitPos:{x:10,y:12},startPos:{x:9.5,y:1.5}},{name:"TowerFloor1",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,1,1,1,1,1,0,0,1,1,1,1,1,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,3,3,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,3,3,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,6,1,1,1,1,0,0,1,6,1,1,1,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,1,1,1,1,1,1,6,1,1,1,1,1,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,1,1,1,1,1,1,0,0,0,1,0,0,1],[1,0,0,1,1,1,1,1,0,0,0,0,1,1,1,1,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,4,4,1,1,1,1,1,1,1,1,1]],exitPos:{x:10,y:17},startPos:{x:5.5,y:4.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#000000",floorColorBack:"#000000"},{name:"Gallery",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,4,4,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,0,0,0,3,1],[1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,3,1,0,0,0,0,0,1],[1,1,0,0,0,7,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,2,0,0,1],[1,1,1,7,1,1,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,6],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0,0,2,0,0,1],[1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,0,0,2,0,0,1],[1,1,0,0,0,3,0,0,0,0,0,3,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,3,0,0,0,0,0,3,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,3,0,0,0,0,0,3,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,3,0,0,0,0,0,3,0,0,0,1,0,0,2,0,0,1],[1,1,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,0,0,2,0,0,1],[1,0,2,2,2,2,2,2,2,2,2,0,1,0,1,0,1,0,1,0,0,2,0,0,1],[4,0,2,2,2,2,2,2,2,2,2,0,6,0,6,0,6,0,6,0,0,2,0,0,1],[1,0,2,2,2,2,2,2,2,2,2,0,1,0,1,0,1,0,1,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,3,0,0,0,3,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],exitPos:{x:3,y:3},startPos:{x:1.5,y:21.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#ECDE60",floorColorBack:"#000000"},{name:"LongHallways",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,1,0,0,0,0,0,0,3,3,3,3,3,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,1,0,0,0,0,0,3,3,3,3,3,3,3,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,3,3,3,0,0,0,3,3,3,0,0,0,0,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,3,3,3,3,0,4,0,3,3,3,3,0,0,0,1,1,1],[1,7,7,1,1,6,1,1,1,6,1,1,1,6,1,1,1,6,1,1,0,0,3,3,3,3,3,0,0,0,3,3,3,3,3,0,0,1,1,1],[1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,0,1],[1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,6,0,1],[1,7,7,1,1,6,1,1,1,1,1,1,1,1,1,1,1,6,1,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,0,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,2,2,0,2,2,2,2,6,2,2,2,2,0,2,2,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,3,0,0,0,0,0,3,2,0,0,0,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,0,3,3,3,3,3,0,3,3,3,3,3,0,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,1,0,0,0,0,3,3,3,3,0,3,3,3,3,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,2,3,0,0,0,0,0,3,2,0,0,0,1,0,0,0,0,0,3,3,3,0,3,3,3,0,0,0,0,0,1,1,1],[1,7,7,1,2,2,0,2,2,2,2,6,2,2,2,2,0,2,2,1,0,0,0,0,0,0,3,3,0,3,3,0,0,0,0,0,0,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,1,1,1,1,1,1,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1],[1,7,7,1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,1,1,1],[1,7,7,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1],[1,7,7,1,0,0,6,0,3,3,3,3,3,3,3,3,3,3,3,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,1,1,1],[1,7,7,1,0,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,3,3,3,3,3,3,3,3,3,3,3,0,4,0,0,1,1,1],[1,7,7,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1],[1,7,7,1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,1,1,1],[1,7,7,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7,0,0,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,1,1],[1,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],exitPos:{x:1,y:1},startPos:{x:9.5,y:3.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#000000",floorColorBack:"#000000"}];function v0(t){if(!Array.isArray(t)||t.length===0)throw new Error("Array must be non-empty.");let e=T(t.length)-1;return t[e]}function T(t){if(t<=0)throw new Error("The maximum value must be greater than 0.");return Math.floor(Math.random()*t)+1}function C0(t,e,o){return t+(e-t)*o}function Dt(t,e){let o=t?t.length:0;if(o===0)return-1;if(e<=t[0])return 0;if(e>=t[o-1])return o-1;let n=0,a=o-1;for(;n<=a;){let i=n+a>>1,s=t[i];if(s===e)return i;s<e?n=i+1:a=i-1}return e-t[a]<=t[n]-e?a:n}var z=new Float32Array(S);function Me(t,e,o,n,a,i,s,l,c,f){if(!a)return;let g=n-o;if(g<=0)return;let d=l||0,u=d<0?0:d>a.height?a.height:d,y=c||a.height,b=a.height-u,h=y<0?0:y>b?b:y,w=Dt(M0,s);t.drawImage(S0[f][M0[w]],i,u,1,h,e,o,1,g)}var p0=E>>1;function _t(t){let e=t.createLinearGradient(0,0,0,p0);e.addColorStop(0,p.cielingColorFront||"#6495ED"),p.cielingColorBack&&e.addColorStop(.5,p.cielingColorBack||"#6495ED"),e.addColorStop(.9,G0),t.fillStyle=e,t.fillRect(0,0,S,p0)}function Lt(t){let e=t.createLinearGradient(0,E,0,p0);e.addColorStop(0,p.floorColorFront||"#054213"),e.addColorStop(.85,p.floorColorBack||"#03210A"),e.addColorStop(.95,G0),t.fillStyle=e,t.fillRect(0,p0,S,p0)}function Ht(t){let e=t.createLinearGradient(0,0,0,E);e.addColorStop(0,"rgba(16,27,46,0.08)"),e.addColorStop(.5,"rgba(16,27,46,0.16)"),e.addColorStop(1,"rgba(16,27,46,0.20)"),t.fillStyle=e,t.fillRect(0,0,S,E)}function Xt(t,e,o,n,a){let{dirX:i,dirY:s,planeX:l,planeY:c}=e;for(let f=0;f<S;f++){let g=2*(f+.5)/S-1,d=i+l*g,u=s+c*g;if(d<1e-8&&d>-1e-8&&u<1e-8&&u>-1e-8){z[f]=Number.POSITIVE_INFINITY;continue}let y=1/(d||1e-9),b=1/(u||1e-9),h=r.x|0,w=r.y|0,J=y<0?-y:y,Z=b<0?-b:b,V,Y,L,W;d<0?(V=-1,L=(r.x-h)*J):(V=1,L=(h+1-r.x)*J),u<0?(Y=-1,W=(r.y-w)*Z):(Y=1,W=(w+1-r.y)*Z);let B=0,k=1,N=!1,x0=0,P0=0;for(;!N&&x0++<256;){if(L<W?(L+=J,h+=V,B=0):(W+=Z,w+=Y,B=1),M>0){let w0=Math.min(L,W);if(w0>M){N=!1,k=0,P0=w0;break}}if(h<0||w<0||h>=n||w>=a){N=!0,k=1;break}let s0=o[w][h];if(s0>0){N=!0,k=s0;break}}if(k===0){z[f]=Number.POSITIVE_INFINITY;continue}let F;B===0?F=L-J:F=W-Z,F=H0>F?H0:F;let ft=0,pe=B===0?V:0,ue=B===1?Y:0,dt=Math.abs(pe*i+ue*s)>=.9&&Math.abs(g)<=.9&&F<ft?ft:F,pt=r.x+dt*d,ut=r.y+dt*u,U;B===0?U=ut-(ut|0):U=pt-(pt|0),U=U<0?0:U>.999999?.999999:U+1e-6;let mt=f0[k]||f0[4],r0=_[k],b0=r0?r0.width|0:mt.w|0,K=U*b0|0;(B===0&&V>0||B===1&&Y<0)&&(K=b0-K-1),K=K<0?0:K>=b0?b0-1:K;let me=F<X0?X0:F,i0=E/me|0,k0=(E-i0*r.calculatePlayerHeight())/2|0,he=k0+i0,j=k0,a0=he;j<0&&(j=0),a0>E&&(a0=E);let ht=a0-j;if(ht<=0){z[f]=F;continue}let gt=(r0?r0.height:mt.h||_[k]?.height||64)|0,ge=(j-k0)*(gt/(i0>1?i0:1)),ye=ht*(gt/Math.max(1,i0)),yt=1/(1+F*.25)*(B?.5:1);if(k===7&&(yt*=.8+.2*Math.sin(t*6+f*.05)),Me(m,f,j,a0,r0,K,yt,ge,ye,k),M>0&&F>M*t0){let s0=M*t0,w0=M,xt=Math.min(1,Math.max(0,(F-s0)/Math.max(1e-6,w0-s0)));xt>0&&(m.save(),m.globalAlpha=xt*.85,m.fillStyle=G0,m.fillRect(f,j,1,a0-j),m.restore())}z[f]=F}}function ve(t){return E/t}function Ce(t,e,o){let{dirY:n,dirX:a,planeY:i,planeX:s,invDet:l}=o,c=l*(n*t-a*e),f=l*(-i*t+s*e);return{transX:c,transY:f}}function Te(t,e){return Math.round((S>>1)*(1+t/e))}function u0(t,e){let o=t.x-r.x,n=t.y-r.y,{transX:a,transY:i}=Ce(o,n,e);if(i<=.01)return null;let s=Te(a,i),l=t&&typeof t.scale=="number"?t.scale:t&&t.img&&typeof t.img.scale=="number"?t.img.scale:1,c=ve(i)*l,f=typeof t._hR=="number"?t._hR:Math.round(c),g=.1,d=f;(c>f+g||c<f-g)&&(d=Math.round(c)),t._hR=d;let u=d,y=t.img,b=y&&y.width&&y.height?y.width/y.height:1,h=Math.max(1,Math.round(u*b)),w=u/E,J=E,Z=r.calculatePlayerHeight(),V=E*.5,Y,L;if(t.ground){let N=t.floorBiasFrac??.04,x0=V+Z*J/i-N*u,P0=x0-u;Y=Math.round(P0),L=Math.round(x0)}else{let N=Math.round(V-u*.5);Y=Math.max(0,N),L=Math.min(E,N+u)}let W={startY:Y,endY:L},B=Math.round(s-(h>>1)),k=B+h;return{drawStartX:B,drawEndX:k,drawStartY:W.startY,drawEndY:W.endY,depth:i,size:u,width:k-B}}function N0(t,e,o=1){let n=t.trim().split(`
`).map(d=>d.replace(/\s+/g,"")),a=n.length-1;for(;a>=0&&n[a].split("").every(d=>d===".");)a--;a>=0&&a<n.length-1&&(n=n.slice(0,a+1));let i=n.length,s=n[0].length,l=1,c=new OffscreenCanvas(s,i),f=c.getContext("2d");f.imageSmoothingEnabled=!1;let g=f.createImageData(s,i);for(let d=0;d<i;d++)for(let u=0;u<s;u++){let y=n[d][u],b=(d*s+u)*4;if(y==="."){g.data[b+3]=0;continue}let h=e[y]||"#ffffff",w=parseInt(h.slice(1),16);g.data[b]=w>>16&255,g.data[b+1]=w>>8&255,g.data[b+2]=w&255,g.data[b+3]=255}if(f.putImageData(g,0,0),o!==1){let d=new OffscreenCanvas(s*o,i*o),u=d.getContext("2d");return u.imageSmoothingEnabled=!1,u.drawImage(c,0,0,d.width,d.height),d.baseline=l,d.scale=o,d}return c.baseline=l,c.scale=1,c}async function T0(t,e){return await Fe(t,e,1)}async function Fe(t,e=1,o=1){let n=`../assets/gfx/${t}`;return new Promise((a,i)=>{let s=new Image;s.onload=()=>{let l=new OffscreenCanvas(s.width*e,s.height*e),c=l.getContext("2d");c.imageSmoothingEnabled=!1,c.drawImage(s,0,0,l.width,l.height),l.baseline=o,l.scale=e,a(l)},s.onerror=()=>i(new Error(`Failed to load sprite: ${n}`)),s.src=n})}var F0,V0,B0,$0,q0,z0,U0;async function Yt(){V0=N0(`
  ................................
  ..............BB..BB............
  .............BbbbbbbB...........
  ...........BbbbGGGGbbbB.........
  ..........BbbbGGGGGGbbbB........
  .........BbbGGGGGGGGGGbbB.......
  ........BbbGGGgGGGGgGGbbB.......
  ........BbbGGgGyyGgGGGbbB.......
  .......BbbGGGGGGGGGGGGbbB.......
  .......BbbGGGGGGGGGGGGbbB.......
  ......BbbGGGGGGGGGGGGGGbbB......
  ......BbbGGGGgGGGGgGGGGbbB......
  ......BbbGGGGwwwwwwGGGGbbB......
  .....BbbGGGwwwWWkWWwwwGGbbB.....
  .....BbbGGGwwwwkkwwwwGGbbB......
  .....BbbGGGwwwwrwwwwGGGbbB......
  .....BbbGGGwwwwwwwwwGGGbbB......
  .....BbbGGGGwwwwwwwGGGGbbB......
  .....BbbGGGGGGGGGGGGGGGbbB......
  .....BbbGGGGGGGGGGGGGGGbbB......
  ......BbbGGGGGGGGGGGGGbbB.......
  ......BbbGGGGGGGGGGGGGbbB.......
  .......BBbbbgggGGGGgggbbBB......
  ........BBBbbbbbbbbbbbbBBB......
  ................................
  `,{B:"#2c1810",b:"#5c3d2e",g:"#7a6b5c",G:"#a89080",k:"#080508",w:"#e8e0d5",W:"#f5f0e8",r:"#8b4513",y:"#ffeb9c"},4),z0=N0(`
  ............
  ....bbbb....
  ..bbGGGGbb..
  .bssssssssb.
  .bGGgGGgGGb.
  .bssssssssb.
  .bGgGGGGgGb.
  .bssssssssb.
  .bGGgGGgGGb.
  .bssssssssb.
  .bGgGGGGgGb.
  .bssssssssb.
  .bGGgGGgGGb.
  .bssssssssb.
  .bGGgGGgGGb.
  .bssssssssb.
  ..bbGGGGbb..
  ....bbbb....
  ............
  ............
  `,{k:"#0a0f10",g:"#FA5053",G:"#CD1C18",s:"#950606",b:"#0e1620"},3),B0=N0(`
  ............r...
  ............rr..
  ...........w..r.
  .......sb.w...rr
  .......bdw...w..
  .......sfd..w...
  ......sfffdw....
  .....sfffffdb...
  ....sfbffffss...
  ...sfbfbffs.....
  ..sfbfbfbs......
  .sfbfbfbs.......
  .sffbfbs........
  ..sffbs.........
  ...sss..........
  ................
  `,{b:"#100904",d:"#8f715b",f:"#5a3b1a",r:"#DC143C",s:"#000000",w:"#4d260a"},3),q0=await T0("noodles.png",3),F0=await T0("bow.png",3),U0=await T0("pitchfork.png",3),$0=await T0("keycard1.png",3)}var v=[];function m0(t,e){if(t<0||e<0||t>=p.MAP_W||e>=p.MAP_H)return!0;let o=p.MAP[e|0][t|0];return o===0||o===5?!1:o===7?!r.hasBlueKey:o!==6}function e0(t,e,o){return!!(m0(t,e)||m0(t-o,e)||m0(t+o,e)||m0(t,e-o)||m0(t,e+o))}var G=null,Q=null,I=null,K0=null,Wt=null;function Q0(){G||(G=new(window.AudioContext||window.webkitAudioContext))}function O({freq:t=440,dur:e=.1,type:o="square",vol:n=.2,slide:a=0}){if(!G)return;let i=G.createOscillator(),s=G.createGain();i.type=o,i.frequency.value=t,s.gain.value=n,i.connect(s).connect(G.destination);let l=G.currentTime;a&&(i.frequency.setValueAtTime(t,l),i.frequency.linearRampToValueAtTime(t+a,l+e)),s.gain.setValueAtTime(n,l),s.gain.exponentialRampToValueAtTime(.001,l+e),i.start(l),i.stop(l+e)}function j0({dur:t=.2,vol:e=.2,lp:o=1200}){if(!G)return;let n=G.createBuffer(1,G.sampleRate*t,G.sampleRate),a=n.getChannelData(0);for(let f=0;f<a.length;f++)a[f]=Math.random()*2-1;let i=G.createBufferSource(),s=G.createGain(),l=G.createBiquadFilter();i.buffer=n,s.gain.value=e,l.type="lowpass",l.frequency.value=o,i.connect(l).connect(s).connect(G.destination);let c=G.currentTime;i.start(c),i.stop(c+t)}var R={shot:()=>{let t=T(50),e=-T(50);O({freq:220+t+e,dur:.05+T(3)/100,type:"square",vol:.25,slide:120}),j0({dur:.03+T(3)/100,vol:.15,lp:800})},pickup:()=>{O({freq:880,dur:.06,type:"triangle",vol:.2}),O({freq:1180,dur:.08,type:"triangle",vol:.18})},explode:()=>{j0({dur:1,vol:.3,lp:800}),O({freq:90,dur:.7,type:"sawtooth",vol:.12,slide:-60})},hurt:()=>{O({freq:140,dur:.12,type:"sawtooth",vol:.2,slide:-50})},killedEntity:()=>{let t=Math.random()*16-8;O({freq:320+t,dur:.26,type:"triangle",vol:.3,slide:-220}),O({freq:480+t,dur:.22,type:"sawtooth",vol:.1,slide:-260}),O({freq:90,dur:.08,type:"sine",vol:.18}),j0({dur:.05,vol:.1,lp:1e3}),setTimeout(()=>{O({freq:170+t,dur:.07,type:"triangle",vol:.16,slide:70})},90)},door:()=>{O({freq:420,dur:.12,type:"square",vol:.15})},portal:()=>{O({freq:600,dur:.5,type:"sawtooth",vol:.2}),O({freq:400,dur:.3,type:"sawtooth",vol:.2,slide:50}),O({freq:600,dur:.5,type:"sawtooth",vol:.2})}};async function Be(t,{volume:e=.15}={}){if(G)try{if(!K0||t!==Wt){let n=await(await fetch(t,{cache:"force-cache"})).arrayBuffer();K0=await G.decodeAudioData(n),Wt=t}Nt(),I=G.createBufferSource(),I.buffer=K0,I.loop=!0,Q=G.createGain(),Q.gain.value=e,I.connect(Q).connect(G.destination),I.start()}catch(o){try{Nt();let n=new Audio(t);n.loop=!0,n.volume=Math.max(0,Math.min(1,e)),await n.play(),I={stop:()=>n.pause(),disconnect:()=>{}},Q=null}catch(n){}}}function Nt(){try{I&&I.stop(0)}catch(t){}if(I&&I.disconnect)try{I.disconnect()}catch(t){}if(Q)try{Q.disconnect()}catch(t){}I=null,Q=null}var Vt=!1;async function J0(){if(!G||I||Vt)return;Vt=!0,await Be("../assets/sfx/HexenST02SLowed.ogg",{volume:.12})}var Z0=0,P=new Set,tt=!1,et=0,ot=!1;function zt(t){window.addEventListener("keydown",e=>{P.add(e.code),Q0(),J0(),e.code==="Space"&&(e.preventDefault(),$t()),e.code==="KeyM"&&(e.preventDefault(),D.classList.toggle("visible"))}),window.addEventListener("keyup",e=>P.delete(e.code)),t.addEventListener("mousedown",e=>{e.button===0&&$t(),tt=!0,et=e.clientX,Q0(),J0()}),window.addEventListener("mouseup",()=>tt=!1),window.addEventListener("mousemove",e=>{if(tt){let o=e.clientX-et;et=e.clientX,r.a+=o*.0035}}),vt.onclick=()=>Pe(),Ct.onclick=()=>D.classList.toggle("visible")}function Ut(t){let e=P.has("ShiftLeft")||P.has("ShiftRight"),o=r.rotSpeed*t,n=r.accel*t,a=Math.cos(r.a),i=Math.sin(r.a),s=-i,l=a;r.weaponAnim>It&&(r.weaponAnim=-1),r.weaponAnim>=0&&(r.weaponAnim+=t);let c=4;r.velX-=r.velX*c*t,r.velY-=r.velY*c*t,Math.abs(r.velX)<.002&&(r.velX=0),Math.abs(r.velY)<.002&&(r.velY=0),r.isMoving=!1;let f=0,g=0;P.has("ArrowLeft")&&(r.a-=o),P.has("ArrowRight")&&(r.a+=o),(P.has("ArrowUp")||P.has("KeyW"))&&(f+=a*n,g+=i*n,r.isMoving=!0),(P.has("ArrowDown")||P.has("KeyS"))&&(f-=a*n,g-=i*n,r.isMoving=!0),P.has("KeyA")&&(f-=s*n,g-=l*n,r.isMoving=!0),P.has("KeyD")&&(f+=s*n,g+=l*n,r.isMoving=!0),r.velX+=f,r.velY+=g;let d=Math.hypot(r.velX,r.velY);d>E0&&(r.velX*=E0/d,r.velY*=E0/d);let u=r.x+r.velX*t,y=r.y+r.velY*t;e0(u,r.y,Y0)?r.velX=0:r.x=u,e0(r.x,y,Y0)?r.velY=0:r.y=y}function $t(){if(r.weaponAnim>=0)return;r.weaponAnim=0,X(),R.shot();let t=A0(),e=Oe(t);if(!(!e||u0(e,t).depth>Bt))switch(e.type){case"arrows":e.alive=!1,r.ammo=Math.min(60,r.ammo+c0),X(),A(`Arrows +${c0}`),R.pickup();break;default:e.onHit&&e.onHit(e,!0);break}}function Kt(){for(let t of v)if(!(!t.alive||Math.hypot(t.x-r.x,t.y-r.y)>=.6))switch(t.type){case"arrows":t.alive=!1,r.ammo=Math.min(60,r.ammo+c0),X(),R.pickup(),A(`Arrows +${c0}`);break;default:t.onTouch&&t.onTouch(t);break}}function jt(){if(ot)return;let t=r.x|0,e=r.y|0;p.MAP[e][t]===5&&(R.portal(),A(`Floor ${$} cleared.`),W0($+1),ot=!0,r.velX=0,r.velY=0,setTimeout(()=>{Re(!0),ot=!1},100))}function Oe(t){let o=document.getElementById("view").width>>1|0,n=z[o]||1e9,a=null,i=1e9;for(let s of v){if(!s.alive)continue;let l=u0(s,t);l&&(M>0&&l.depth>M||o>=l.drawStartX&&o<l.drawEndX&&l.depth<n+.1&&l.depth<i&&(a=s,i=l.depth))}return a}function h0(t=2){let e=0;for(;e++<200;){let o=(Math.random()*(p.MAP_W-2)|0)+1,n=(Math.random()*(p.MAP_H-2)|0)+1;if(p.MAP[n][o]!==0)continue;let a=o+.5-r.x,i=n+.5-r.y;if(!(Math.hypot(a,i)<t))return{x:o,y:n}}return{x:9,y:9}}function at(){let t=p.MAP_W,e=p.MAP_H;for(let o=0;o<e;o++)for(let n=0;n<t;n++)p.MAP[o][n]===7&&(p.MAP[o][n]=0)}function Qt(){let t=H.x,e=H.y;for(let o=e-1;o<=e+1;o++)for(let n=t-1;n<=t+1;n++)n===t&&o===e||(p.MAP[o][n]=7)}function Jt(t){let{arrowQuiver:e}=t;if(v.length=0,T(100)<50)for(let a=0;a<T(2)*(p.MAP_H/20|0);a++){let i=h0(1);v.push(g0(x.barrel,{x:i.x+.5,y:i.y+.5}))}let o=h0(4);v.push(g0(x.key,{x:o.x+.5,y:o.y+.5})),o=h0(4),v.push(g0(x.food,{x:o.x+.5,y:o.y+.5}));for(let a=0;a<1+($/3|0)*(p.MAP_H/20|0);a++)if(a<=1&&T(100)<50||a<1&&r.ammo<=0&&T(100)<80||T(100)<25){let i=h0(3);v.push({x:i.x+.5,y:i.y+.5,img:e,type:"arrows",alive:!0,dist:0,ground:!0,scale:.25,floorBiasFrac:.04})}let n=Math.min((2+($-1)*2)*(p.MAP_H/20|0),8);for(let a=0;a<n;a++){let i=h0(3.5);v.push(g0(x.entity,{x:i.x+.5,y:i.y+.5}))}}function X(){Gt.style.width=`${r.health/r.maxHealth*100}%`,Et.style.width=`${r.ammo/60*100}%`,At.textContent=Math.max(0,r.health),St.textContent=r.ammo}var nt=0,rt=0,it=!1,qt=!1;function A(t){let e=document.getElementById("gameLog"),o=e?.querySelector(".log-items");if(!o)return;let n=document.createElement("div");n.textContent=t,o.prepend(n),e.classList.contains("collapsed")||requestAnimationFrame(()=>{o.scrollTop=0})}function Zt(t){nt>0&&(nt-=t,nt<=0&&(Mt.textContent=r.hasBlueKey?"Find the exit.":"Find the key card."))}function te(){it||r.health<=0&&(it=!0,r.speed=0,r.rotSpeed=0,rt=2,A("YOU DIED! Soul disconnecting from the node..."))}function ee(t){it&&(rt-=t,rt<=0&&Ie())}function Ie(){if(qt)return;qt=!0;let t=document.getElementById("game");if(t){let e=document.createElement("div");e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100vw",e.style.height="100vh",e.style.background="#ff0000",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.zIndex="999999",e.style.fontFamily='"Courier New", monospace',e.style.opacity="0",e.style.transition="opacity 2s ease-in",e.innerHTML=`
      <div style="
        background: #000;
        border: 3px solid #04650d;
        color: #20b2db;
        width: 600px;
        max-width: 90vw;
        box-shadow: 0 0 20px #04650d;
        font-family: 'Courier New', monospace;
      ">
        <div style="
          background:#000;
          color: #04650d;
          padding: 8px 15px;
          display: flex;
          justify-content: space-between;
          font-weight: bold;
          font-size: 12px;
        ">
          <span style ="color: #FFFFFF; border: 1px solid #04650d;">Death...</span>
        </div>
        <div style="padding: 20px; min-height: 200px;">
          <div style="margin-bottom: 30px;">
            <div style="text-align: center; color: #FFFFFF; font-size: 32px; margin: 8px 0;">YOU HAVE DIED</div>
          </div>
          <div style="text-align: center; margin-top: 20px;">
            <button id="returnBtn" style="
              background: #000;
              border: 2px solid #04650d;
              color: #04650d;
              padding: 12px 24px;
              font-family: 'Courier New', monospace;
              font-size: 14px;
              font-weight: bold;
              cursor: pointer;
              text-transform: uppercase;
              letter-spacing: 1px;
            ">RETURN TO TERMINAL</button>
          </div>
        </div>
      </div>
    `,document.body.appendChild(e);let o=e.querySelector("#returnBtn");if(o){let n=!1;o.addEventListener("click",a=>{a.preventDefault(),!n&&(n=!0,setTimeout(()=>{window.location.href="../index.html"},100))})}setTimeout(()=>{e.style.opacity="1"},50),t.classList.add("game-paused"),P.clear()}}function st(t=!1){t&&o0(),r.x=q.x,r.y=q.y,r.a=0,r.hasBlueKey=!1,p.MAP[H.y][H.x]=5,Qt(),Jt({arrowQuiver:B0}),X(),A(`Floor ${$}: Find the keycard.`)}function Re(t=!1){t&&(Z0>=d0.length-1?o0():(Z0+=1,o0(Z0))),r.x=q.x,r.y=q.y,r.a=0,r.hasBlueKey=!1,p.MAP[H.y][H.x]=5,Qt(),Jt({arrowQuiver:B0}),X(),A(`Floor ${$}: Find the keycard.`)}function Pe(){W0(1),o0(0),st()}function oe(t){for(let e of v)e.alive&&e.ai&&e.ai(e,t)}var n0={EXPLOSION:"explosion",SCREEN_FLASH:"screen_flash"},ke={[n0.EXPLOSION]:{lifetime:.5,startRadius:.1,endRadius:1,expansionTime:.4,startOpacity:1,endOpacity:0,primaryColor:{h:30,s:90,l:60},secondaryColor:{h:15,s:85,l:50},glowColor:{h:45,s:100,l:75},fillColor:{h:25,s:80,l:40},ringLineWidth:3,glowLineWidth:2,innerLineWidth:1,renderFunction:We,ignoreBounds:!1},[n0.SCREEN_FLASH]:{lifetime:.15,startOpacity:.85,endOpacity:0,color:"#ffffff",renderFunction:Ne,ignoreBounds:!0}},y0=[];function ne(t,e,o,n,a={}){let i=ke[t];if(!i)return console.warn(`Unknown effect type: ${t}`),null;let s={ignoreBounds:!1,type:t,x:e,y:o,radius:n,maxRadius:n,age:0,lifetime:a.lifetime??i.lifetime,opacity:a.startOpacity??i.startOpacity,startOpacity:a.startOpacity??i.startOpacity,endOpacity:a.endOpacity??i.endOpacity,...i,...a};return y0.push(s),s}function re(t,e,o,n={}){return ne(n0.EXPLOSION,t,e,o,n)}function ie({color:t="#ffffff",duration:e=.15,alpha:o=.85}={}){ne(n0.SCREEN_FLASH,0,0,1,{lifetime:e,startOpacity:o,endOpacity:0,color:t,ignoreBounds:!0})}function ae(t){for(let e=y0.length-1;e>=0;e--){let o=y0[e];o.age+=t;let n=Math.min(o.age/o.lifetime,1);De(o,n),o.age>=o.lifetime&&y0.splice(e,1)}}function De(t,e){switch(t.type){case n0.EXPLOSION:_e(t,e);break;case n0.SCREEN_FLASH:Le(t,e);break}}function _e(t,e){t.opacity=C0(t.startOpacity,t.endOpacity,e);let o=Math.min(e/t.expansionTime,1),n=C0(t.startRadius,t.endRadius,o);t.radius=t.maxRadius*n}function Le(t,e){let o=1-(1-e)*(1-e);t.opacity=C0(t.startOpacity,t.endOpacity,o)}function He(){return y0}function se(t,e,o,n,a){let i=He();if(i.length!==0){t.save();for(let s of i)Xe(t,s,e,o,n,a);t.restore()}}function Xe(t,e,o,n,a,i){let s=Ye(e.x,e.y,o,n,a,i,e.ignoreBounds);!s&&!e.ignoreBounds||e.renderFunction(t,e,s)}function Ye(t,e,o,n,a,i,s=!1){let l=t-i.x,c=e-i.y,{dirY:f,dirX:g,planeY:d,planeX:u,invDet:y}=o,b=y*(f*l-g*c),h=y*(-d*l+u*c);return h<=.1&&!s?null:s?{x:n/2,y:a/2,radius:a,depth:h}:{x:n/2*(1+b/h),y:a/2+64,radius:a/h*.5,depth:h}}function We(t,e,o){let n=o.radius*e.radius,a=performance.now()*.001,i=Math.sin(a*8)*12,s=Math.sin(a*12)*.15+1,l=o.y,c=o.x;t.globalAlpha=e.opacity*.3,t.fillStyle=`hsl(${e.fillColor.h+i*.5}, ${e.fillColor.s}%, ${e.fillColor.l}%)`,t.beginPath(),t.arc(c,l,n*.7,0,2*Math.PI),t.fill(),t.globalAlpha=e.opacity*.5,t.strokeStyle=`hsl(${e.glowColor.h+i}, ${e.glowColor.s}%, ${e.glowColor.l}%)`,t.lineWidth=e.glowLineWidth*1.5,t.beginPath(),t.arc(c,l,n*s,0,2*Math.PI),t.stroke(),t.globalAlpha=e.opacity*.85,t.strokeStyle=`hsl(${e.primaryColor.h+i*.8}, ${e.primaryColor.s}%, ${e.primaryColor.l}%)`,t.lineWidth=e.ringLineWidth,t.beginPath(),t.arc(c,l,n*.9,0,2*Math.PI),t.stroke(),t.globalAlpha=e.opacity*.6,t.strokeStyle=`hsl(${e.secondaryColor.h+i*1.3}, ${e.secondaryColor.s}%, ${e.secondaryColor.l}%)`,t.lineWidth=e.innerLineWidth,t.beginPath(),t.arc(c,l,n*.5,0,2*Math.PI),t.stroke()}function Ne(t,e){if(e.opacity<=0)return;let o=t.canvas.width,n=t.canvas.height;t.save(),t.globalAlpha=e.opacity,t.fillStyle=e.color||"#ffffff",t.fillRect(0,0,o,n),t.restore()}var x=Object.freeze({entity:"entity",barrel:"barrel",food:"food",key:"key"}),O0={[x.entity]:{type:x.entity,ground:!0,scale:.66,floorBiasFrac:.2},[x.barrel]:{type:x.barrel,ground:!0,scale:.66,floorBiasFrac:.04},[x.food]:{type:x.food,ground:!0,scale:.25,floorBiasFrac:.04},[x.key]:{type:x.key,ground:!0,scale:.25,floorBiasFrac:.04}};Object.freeze(O0);for(let t in O0)Object.freeze(O0[t]);var I0={[x.entity]:{ai(t,e){if(!t.alive)return;let o=r.x-t.x,n=r.y-t.y,a=Math.hypot(o,n);if(a>.3){let i=1.25*e,s=o/a,l=n/a,c=t.x+s*i,f=t.y+l*i;e0(c,t.y,.4)||(t.x=c),e0(t.x,f,.4)||(t.y=f)}a<.6&&t.hurtCD<=0&&(r.health=Math.max(0,r.health-Ft)|0,X(),A("Entity attacks!"),R.hurt(),t.hurtCD=.8,ie({color:"	#740707",duration:.5}),te()),t.hurtCD>0&&(t.hurtCD-=e)},onHit(t,e){e?(t.alive=!1,A(v0(["Entity murdered!","Entity destroyed!","Entity purged!"])),R.killedEntity()):A("No arrows.")},onTouch(t){lt(x.entity,1e4)&&A("You hear something like water nearby...")},onExplode(t){t.alive=!1,R.killedEntity(),A("The entity is blown to gibs.")}},[x.barrel]:{onHit(t,e){e?(t.alive=!1,le(t.x,t.y,2.5),A("Kaboom!"),R.explode()):A("No arrows.")},onTouch(t){lt(x.barrel,1e4)&&A("Shooting this barrel may yield useful results...")},onExplode(t){t.alive=!1,le(t.x,t.y,2.5)}},[x.food]:{onTouch(t){t.alive=!1;let e=r.health>=r.maxHealth;e&&(r.maxHealth+=1),r.health=bt(r.health+Tt,0,r.maxHealth),A(e?"Yummy!":"Health restored."),X(),R.pickup()}},[x.key]:{onTouch(t){t.alive=!1,r.hasBlueKey=!0,R.door(),A("Keycard found! Find the exit!"),at()},onExplode(t){t.alive=!1,r.hasBlueKey=!0,R.door(),A("The forcefield protecting the exit has suddenly lifted!"),at()}}};Object.freeze(I0);for(let t in I0)Object.freeze(I0[t]);var Ve=0;function g0(t,e={x:0,y:0},o=void 0){let n=O0[t],a=I0[t],i=Object.assign(Object.create(a),n);switch(i.id=Ve++,i.x=e.x,i.y=e.y,i.dist=0,i.alive=!0,i.hurtCD=0,t){case x.entity:i.img=V0;break;case x.barrel:i.img=z0;break;case x.food:i.img=q0;break;case x.key:i.img=$0;break}return o&&Object.assign(i,o),i}function le(t,e,o){re(t,e,o);for(let n of v){if(!n.alive)continue;Math.hypot(n.x-t,n.y-e)<o&&(n.onExplode?n.onExplode(n):n.alive=!1)}}function ce(t){C.clearRect(0,0,D.width,D.height);let e=6,o=20,n=2,a=Math.floor(o/2),i=Math.max(0,Math.min((r.x|0)-a,p.MAP_W-o)),s=Math.max(0,Math.min((r.y|0)-a,p.MAP_H-o));D.width=n+o*e+n,D.height=n+o*e+n;for(let d=0;d<o;d++)for(let u=0;u<o;u++){let y=s+d,b=i+u,h=p.MAP[y]?.[b]??0,w="#0c1220";h===1?w="#ECDE60":h===2?w="#707a88":h===3?w="#00e676":h===4?w="#996633":h===5?w="#FFE300":h===6?w=" #3561ff":h===7&&(w="#00FFFF"),C.fillStyle=w,C.fillRect(n+u*e,n+d*e,e-1,e-1)}for(let d of t){if(!d.alive)continue;let u=n+(d.x-i)*e,y=n+(d.y-s)*e;C.fillStyle=d.type===x.entity?"#ffeb9c":d.type===x.barrel?"#CD1C18":d.type===x.key?"#6aa2ff":d.type===x.food?"#7fffd4":(d.type==="arrows","#ffffff"),C.fillRect(u-2,y-2,4,4)}let l=n+(r.x-i)*e,c=n+(r.y-s)*e;C.fillStyle="#e7f3ff",C.beginPath(),C.arc(l,c,2.5,0,wt),C.fill();let f=Math.cos(r.a),g=Math.sin(r.a);C.strokeStyle="#78f3d3",C.beginPath(),C.moveTo(l,c),C.lineTo(l+f*1.5*e,c+g*1.5*e),C.stroke()}var ct=performance.now(),fe=new Map;function lt(t,e){let o=ct,n=fe.get(t)??0;return o<n?!1:(fe.set(t,o+e),!0)}zt(l0);var R0=0;function $e(t){let e=`FPS: ${Math.round(t)}`;m.save(),m.font="12px monospace",m.textAlign="right",m.textBaseline="top";let o=S-8,n=6,a=m.measureText(e).width+8,i=16;m.fillStyle="rgba(10, 15, 25, 0.6)",m.fillRect(o-a,n-2,a,i),m.strokeStyle="rgba(60, 80, 130, 0.9)",m.strokeRect(o-a+.5,n-2+.5,a-1,i-1),m.fillStyle="#dfe6ff",m.fillText(e,o,n),m.restore()}function o0(t=-1){let e;if(t!==-1){let o=d0[t];o&&(e=o)}else e=v0(d0);H.x=e.exitPos.x,H.y=e.exitPos.y,q.x=e.startPos.x,q.y=e.startPos.y,r.health=r.maxHealth,p.cielingColorFront=e.cielingColorFront||"#6495ED",p.floorColorFront=e.floorColorFront||"#054213",p.cielingColorBack=e.cielingColorBack||"#6495ED",p.floorColorBack=e.floorColorBack||"#03210A",p.MAP=e.mapLayout,p.MAP_W=p.MAP[0].length,p.MAP_H=p.MAP.length,r.x=r.x=e.startPos.x,r.y=e.startPos.y}async function qe(){await Yt(),await kt(),o0(0),st(),r.maxHealth=Ot+T(6),r.health=r.maxHealth,r.ammo=5+T(5),X(),requestAnimationFrame(de)}function ze(t){let e=A0();_t(m),Lt(m),Ht(m),Xt(t,e,p.MAP,p.MAP_W,p.MAP_H),Ue(),v.sort((o,n)=>n.dist-o.dist),Ke(e),Je(t),se(m,e,S,E,r)}function Ue(){for(let t of v){let e=t.x-r.x,o=t.y-r.y;t.dist=e*e+o*o}}function Ke(t){m.save();for(let e of v){if(!e.alive)continue;let o=u0(e,t);if(!o||M>0&&o.depth>M)continue;let n=je(o);Qe(e,o,n),m.filter="none"}m.restore()}function je(t){let e=1/(1+t.depth*.3);if(M>0&&t.depth>M*t0){let a=M*t0,i=Math.min(1,Math.max(0,(t.depth-a)/Math.max(1e-6,M-a)));e*=1-i*.6}let o=[1,.85,.7,.55,.4];return{quantizedShade:o.reduce((a,i)=>Math.abs(i-e)<Math.abs(a-e)?i:a,o[0])}}function Qe(t,e,o){o.quantizedShade<.999&&(m.filter=`brightness(${o.quantizedShade})`);let n=Math.max(1,(e.width??e.drawEndX-e.drawStartX)|0),a=e.drawStartY,i=e.drawEndY-e.drawStartY,s=f=>(f-e.drawStartX)*t.img.width/n|0,l=-1,c=0;for(let f=e.drawStartX;f<=e.drawEndX;f++){let d=f>=0&&f<S&&f<e.drawEndX&&e.depth<=z[f];if(d&&l===-1&&(l=f,c=s(f)),(!d||f===e.drawEndX)&&l!==-1){let u=f,y=u-l,b=s(u);b<=c&&(b=c+1);let h=Math.min(t.img.width-c,b-c);y>0&&h>0&&i>0&&m.drawImage(t.img,c,0,h,t.img.height,l,a,y,i),l=-1}}}function Je(t){let e=Math.round(S*.42),o=Math.round(e*(F0.height/F0.width)),n=r.isMoving&&r.weaponAnim<0?10*Math.sin(t*5):0,a=Math.max(8,S*.02|0),i=S*.5-e/2-a/2+n,s=(r.weaponAnim+1)**10,l=s>7?7:s,c=r.weaponAnim>=0?100-l*20:0,f=r.isMoving&&r.weaponAnim<0?10*Math.sin(t*10):0,g=E-o-a+70+f+c;m.drawImage(U0,i,g,e,o)}function de(t){let e=Math.min(.05,(t-ct)/1e3);ct=t;let o=e>0?1/e:0;R0=R0?R0*.9+o*.1:o,Ut(e),oe(e),ae(e),Kt(),ze(t/1e3),D.classList.contains("visible")&&ce(v),jt(),Zt(e),ee(e),$e(R0),_0.drawImage(D0,0,0),requestAnimationFrame(de)}await qe().catch(console.error);export{o0 as ChangeMapLevel,lt as tryCooldown};
