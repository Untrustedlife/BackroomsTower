import{a as St,b as Mt}from"../chunks/chunk-B3G4DJQ2.js";var p0=document.getElementById("view");p0.width=480;p0.height=270;var C=480,G=270,_0=new OffscreenCanvas(C,G),m=_0.getContext("2d");m.imageSmoothingEnabled=!1;var P0=p0.getContext("2d");P0.imageSmoothingEnabled=!1;var Y=document.getElementById("mini"),F=Y.getContext("2d");F.imageSmoothingEnabled=!1;var vt=document.getElementById("hpBar"),Tt=document.getElementById("ammoBar"),Ft=document.getElementById("hpText"),Bt=document.getElementById("ammoText"),Ot=document.getElementById("msg"),Dt=document.getElementById("btnReset"),It=document.getElementById("btnToggleMap");var ke=90*Math.PI/180,L0=ke*.5,H0=.01,X0=.01,Rt=15;var n0=.6,q="#101b2e",u0=5,kt=10,_t=3.33,Pt=2.5,Lt=20,Ht=.75,C0=20;var r={x:3.5,y:3.5,velX:0,velY:0,a:0,accel:10,rotSpeed:2.6,health:6,maxHealth:20,ammo:1,hasBlueKey:!1,isMoving:!1,weaponAnim:-1,tenacity:20,maxTenacity:20,height:.75,sightDist:15,calculatePlayerHeight:()=>r.height<.01?.01:r.height*1},Y0=.2,U=1,Xt=1,_e=99;function N0(t){U=Math.max(Xt,Math.min(_e,t|0||Xt))}function A0(){let t=Math.cos(r.a),e=Math.sin(r.a),o=-e*Math.tan(L0),n=t*Math.tan(L0),i=1/(o*e-t*n);return{dirX:t,dirY:e,planeX:o,planeY:n,invDet:i}}function Pe(t=64,e=64){return new OffscreenCanvas(t,e)}var N=new Array(8).fill(null);function Yt(t){let o=t.getContext("2d").getImageData(0,0,t.width,t.height),n=[];for(let i=0;i<t.width;i++){let a=new Uint8ClampedArray(t.height*4);for(let s=0;s<t.height;s++){let l=(s*t.width+i)*4,c=s*4;a[c]=o.data[l],a[c+1]=o.data[l+1],a[c+2]=o.data[l+2],a[c+3]=o.data[l+3]}n.push({data:a,h:t.height})}return{cols:n,w:t.width,h:t.height}}var m0=N.map(t=>t?Yt(t):null);function Le(){m0.length=0,N.forEach(t=>{m0.push(t?Yt(t):null)})}var M0=Array.from({length:82},(t,e)=>e*.0125),S0={};function He(){for(let t=1;t<N.length;t++)if(N[t]){S0[t]={};for(let e of M0){let o=new OffscreenCanvas(N[t].width,N[t].height),n=o.getContext("2d");n.drawImage(N[t],0,0);let i=e*255|0;n.globalCompositeOperation="multiply",n.fillStyle=`rgb(${i},${i},${i})`,n.fillRect(0,0,o.width,o.height),S0[t][e]=o}}}async function Xe(t){let e=`../assets/gfx/${t}`;return new Promise((o,n)=>{let i=new Image;i.onload=()=>{let a=Pe(64,64),s=a.getContext("2d",{willReadFrequently:!0});s.imageSmoothingEnabled=!1,s.drawImage(i,0,0,64,64),o(a)},i.onerror=()=>n(new Error(`Failed to load texture: ${e}`)),i.src=e})}async function Nt(){try{await Ye([{index:1,image:"OfficeWall.png"},{index:2,image:"Panel.png"},{index:3,image:"Hedge.png"},{index:4,image:"OfficeDoor.png"},{index:5,image:"Portal.png"},{index:6,image:"OfficeDoorBlue.png"},{index:7,image:"Field.png"}]),Le(),He()}catch(t){console.warn("Failed to init backrooms wallpaper:",t)}}async function Ye(t){if(!Array.isArray(t)){console.warn("Expected an array of { index, image } objects. In loadImagesToReplaceTextures");return}let e=t.map(async(o,n)=>{let{index:i,image:a}=o||{};try{let s=await Xe(a);return i&&i>=0&&(N[i]=s),s}catch(s){return console.warn(`Failed to load texture "${a}" for index ${i} and dont support replacing with cool gmod missing texture:`,s),null}});await Promise.all(e)}function Wt(t){if(!Array.isArray(t)||t.length===0)throw new Error("Array must be non-empty.");let e=B(t.length)-1;return t[e]}function B(t){if(t<=0)throw new Error("The maximum value must be greater than 0.");return Math.floor(Math.random()*t)+1}function v0(t,e,o){return t+(e-t)*o}function zt(t,e){let o=t?t.length:0;if(o===0)return-1;if(e<=t[0])return 0;if(e>=t[o-1])return o-1;let n=0,i=o-1;for(;n<=i;){let a=n+i>>1,s=t[a];if(s===e)return a;s<e?n=a+1:i=a-1}return e-t[i]<=t[n]-e?i:n}function $t(t){let e=t.charCodeAt(0)===35?t.slice(1):t,o=parseInt(e.length===3?e.split("").map(n=>n+n).join(""):e,16);return[o>>16&255,o>>8&255,o&255]}var z={x:10,y:8},K={x:3.5,y:3.5};var f={MAP:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,2,6,2,0,0,0,0,0,0,0,2,6,2,0,0,1],[1,0,0,0,2,0,2,0,0,0,0,0,0,0,2,0,2,0,0,1],[1,0,0,0,2,2,2,0,0,0,0,0,0,0,2,2,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,5,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,3,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,3,3,1,3,3,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,0,0,0,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,2,2,2,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,1,0,2,0,2,0,1,0,3,0,0,0,1],[1,0,0,0,0,0,0,0,0,2,6,2,0,0,0,0,0,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],MAP_W:-1,MAP_H:-1,cielingColorFront:"",floorColorFront:"",cielingColorBack:"",floorColorBack:"",sightDist:15,zones:[{color:"#101b2e",x:0,y:0,w:1,h:1}]},h0=[{name:"Village",mapLayout:[[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,1,2,3,4,5,6,7,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,1,1,1,1,1,6,1,1,6,1,1,1,1,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3]],exitPos:{x:10,y:12},startPos:{x:9.5,y:1.5},zones:[{color:"#101b2e",x:0,y:0,w:1,h:1,cielingColorFront:"#271810",cielingColorBack:"#271810",floorColorBack:"#101b2e",fogColor:"#101b2e"},{color:"#8b8000",x:3,y:5,w:14,h:12,cielingColorFront:"#8b8000",cielingColorBack:"#000000",floorColorBack:"#000000",fogColor:"#000000"},{color:"#054213",x:1,y:0,w:18,h:19,cielingColorFront:"#6495ed",cielingColorBack:"#6495ed",floorColorBack:"#03210a",fogColor:"#101b2e"}]},{name:"TowerFloor1",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,1,1,1,1,1,0,0,1,1,1,1,1,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,3,3,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,3,3,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,6,1,1,1,1,0,0,1,6,1,1,1,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,1,1,1,1,1,1,6,1,1,1,1,1,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,1,1,1,1,1,1,0,0,0,1,0,0,1],[1,0,0,1,1,1,1,1,0,0,0,0,1,1,1,1,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,4,4,1,1,1,1,1,1,1,1,1]],exitPos:{x:10,y:17},startPos:{x:5.5,y:4.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#000000",floorColorBack:"#000000",zones:[{color:"#101b2e",x:0,y:0,w:1,h:1}]},{name:"Gallery",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,4,4,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,0,0,0,3,1],[1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,3,1,0,0,0,0,0,1],[1,1,0,0,0,7,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,2,0,0,1],[1,1,1,7,1,1,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,6],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0,0,2,0,0,1],[1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,0,0,2,0,0,1],[1,1,0,0,0,3,0,0,0,0,0,3,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,3,0,0,0,0,0,3,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,3,0,0,0,0,0,3,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,3,0,0,0,0,0,3,0,0,0,1,0,0,2,0,0,1],[1,1,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,0,0,2,0,0,1],[1,0,2,2,2,2,2,2,2,2,2,0,1,0,1,0,1,0,1,0,0,2,0,0,1],[4,0,2,2,2,2,2,2,2,2,2,0,6,0,6,0,6,0,6,0,0,2,0,0,1],[1,0,2,2,2,2,2,2,2,2,2,0,1,0,1,0,1,0,1,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,3,0,0,0,3,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],exitPos:{x:3,y:3},startPos:{x:1.5,y:21.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#ECDE60",floorColorBack:"#000000",sightDist:10,zones:[{color:"#101b2e",x:0,y:0,w:1,h:1}]},{name:"LongHallways",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,1,0,0,0,0,0,0,3,3,3,3,3,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,1,0,0,0,0,0,3,3,3,3,3,3,3,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,3,3,3,0,0,0,3,3,3,0,0,0,0,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,3,3,3,3,0,4,0,3,3,3,3,0,0,0,1,1,1],[1,7,7,1,1,6,1,1,1,6,1,1,1,6,1,1,1,6,1,1,0,0,3,3,3,3,3,0,0,0,3,3,3,3,3,0,0,1,1,1],[1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,0,1],[1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,6,0,1],[1,7,7,1,1,6,1,1,1,1,1,1,1,1,1,1,1,6,1,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,0,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,2,2,0,2,2,2,2,6,2,2,2,2,0,2,2,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,3,0,0,0,0,0,3,2,0,0,0,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,0,3,3,3,3,3,0,3,3,3,3,3,0,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,1,0,0,0,0,3,3,3,3,0,3,3,3,3,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,2,3,0,0,0,0,0,3,2,0,0,0,1,0,0,0,0,0,3,3,3,0,3,3,3,0,0,0,0,0,1,1,1],[1,7,7,1,2,2,0,2,2,2,2,6,2,2,2,2,0,2,2,1,0,0,0,0,0,0,3,3,0,3,3,0,0,0,0,0,0,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,1,1,1,1,1,1,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1],[1,7,7,1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,1,1,1],[1,7,7,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1],[1,7,7,1,0,0,6,0,3,3,3,3,3,3,3,3,3,3,3,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,1,1,1],[1,7,7,1,0,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,3,3,3,3,3,3,3,3,3,3,3,0,4,0,0,1,1,1],[1,7,7,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1],[1,7,7,1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,1,1,1],[1,7,7,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7,0,0,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,1,1],[1,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],sightDist:10,exitPos:{x:1,y:1},startPos:{x:9.5,y:3.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#000000",floorColorBack:"#000000",zones:[{color:"#101b2e",x:0,y:0,w:1,h:1}]}],Vt=new Map;function qt(t){let e=f.zones,o=e&&e[t]?.color||q,n=Vt.get(o);return n||(n=$t(o),Vt.set(o,n)),n}function t0(t,e,o){for(let n=0;n<o.length;n++){let i=o[n],a=Math.min(i.x,i.x+i.w),s=Math.max(i.x,i.x+i.w)-1,l=Math.min(i.y,i.y+i.h),c=Math.max(i.y,i.y+i.h)-1;if(t>=a&&t<=s&&e>=l&&e<=c)return n}return 0}var j=new Float32Array(C),V=G>>1,W0=new Float32Array(G);function Ne(){let t=V;for(let e=0;e<G;e++){let o=e-V;W0[e]=o!==0?t/o*(2-r.calculatePlayerHeight()):1e-6}}Ne();var z0=[],$0=[],V0=[],T0=[];function Kt(){z0.length=0,$0.length=0,V0.length=0,T0.length=0,q0.clear()}function We(t,e,o,n,i,a,s,l,c,p){if(!i)return;let y=n-o;if(y<=0)return;let d=l||0,u=d<0?0:d>i.height?i.height:d,h=c||i.height,x=i.height-u,g=h<0?0:h>x?x:h,w=zt(M0,s);t.drawImage(S0[p][M0[w]],a,u,1,g,e,o,1,y)}function jt(t){let e=r.x|0,o=r.y|0,n=t0(e,o,f.zones),i=z0[n];if(!i){i=t.createLinearGradient(0,0,0,V);let a=f.zones[n].cielingColorFront,s=f.zones[n].cielingColorBack,l=f.zones[n].fogColor;i.addColorStop(0,a||f.cielingColorFront||"#6495ED"),f.cielingColorBack&&i.addColorStop(.5,s||f.cielingColorBack||"#6495ED"),i.addColorStop(.9,l||q),z0[n]=i}t.fillStyle=i,t.fillRect(0,0,C,V)}var q0=new Map;function Ut(t){let e=q0.get(t);if(!e){let[o,n,i]=qt(t);e=`rgb(${o|0},${n|0},${i|0})`,q0.set(t,e)}return e}function Zt(t,e,o,n=0){let{dirX:i,dirY:a,planeX:s,planeY:l}=e,c=n<V?V:n;if(c>=G)return;let p=f.zones,y=2*(o+.5)/C-1,d=i+s*y,u=a+l*y,h=1/(i*d+a*u),x=W0[c],g=r.x+d*x*h,w=r.y+u*x*h,X=0,I=c,R=null;for(let v=c;v<G;v++){let O=g|0,T=w|0,A=0;if(c===V&&v===V?A=0:A=O>=0&&T>=0&&O<f.MAP_W&&T<f.MAP_H?t0(O,T,p):0,A!==X){let s0=Ut(X);s0!==R&&(m.fillStyle=s0,R=s0),m.fillRect(o,I,1,v-I),X=A,I=v}let W=W0[v+1]??x,o0=W-x;g+=d*o0*h,w+=u*o0*h,x=W}let H=Ut(X);H!==R&&(m.fillStyle=H),m.fillRect(o,I,1,G-I)}function Jt(t){let e=V0[0];e||(e=t.createLinearGradient(0,0,0,G),e.addColorStop(0,"rgba(16,27,46,0.08)"),e.addColorStop(.5,"rgba(16,27,46,0.16)"),e.addColorStop(1,"rgba(16,27,46,0.20)"),V0[0]=e),t.fillStyle=e,t.fillRect(0,0,C,G)}function Qt(t){let e=V-1,o=G-e,n=r.x|0,i=r.y|0,a=t0(n,i,f.zones),s=$0[a];if(!s){let l=f.zones[a].floorColorBack;s=t.createLinearGradient(0,e,0,G),s.addColorStop(.05,f.zones[a].fogColor||q),s.addColorStop(.15,l||f.floorColorBack||"#03210A"),s.addColorStop(1,"rgba(0,0,0,0)"),$0[a]=s}t.fillStyle=s,t.fillRect(0,e,C,o)}function te(t,e,o,n,i){let{dirX:a,dirY:s,planeX:l,planeY:c}=e;for(let p=0;p<C;p++){let y=2*(p+.5)/C-1,d=a+l*y,u=s+c*y;if(d<1e-8&&d>-1e-8&&u<1e-8&&u>-1e-8){j[p]=Number.POSITIVE_INFINITY;continue}let h=1/(d||1e-9),x=1/(u||1e-9),g=r.x|0,w=r.y|0,X=h<0?-h:h,I=x<0?-x:x,R,H,v,O;d<0?(R=-1,v=(r.x-g)*X):(R=1,v=(g+1-r.x)*X),u<0?(H=-1,O=(r.y-w)*I):(H=1,O=(w+1-r.y)*I);let T=0,A=1,W=!1,o0=0,s0=0;for(;!W&&o0++<256;){if(v<O?(v+=X,g+=R,T=0):(O+=I,w+=H,T=1),r.sightDist>0){let E0=Math.min(v,O);if(E0>r.sightDist){W=!1,A=0,s0=E0;break}}if(g<0||w<0||g>=n||w>=i){W=!0,A=1;break}let d0=o[w][g];if(d0>0){W=!0,A=d0;break}}if(A===0){j[p]=Number.POSITIVE_INFINITY;continue}let D;T===0?D=v-X:D=O-I,D=H0>D?H0:D;let gt=0,Me=T===0?R:0,ve=T===1?H:0,yt=Math.abs(Me*a+ve*s)>=.9&&Math.abs(y)<=.9&&D<gt?gt:D,xt=r.x+yt*d,bt=r.y+yt*u,Z;T===0?Z=bt-(bt|0):Z=xt-(xt|0),Z=Z<0?0:Z>.999999?.999999:Z+1e-6;let wt=m0[A]||m0[4],l0=N[A],G0=l0?l0.width|0:wt.w|0,J=Z*G0|0;(T===0&&R>0||T===1&&H<0)&&(J=G0-J-1),J=J<0?0:J>=G0?G0-1:J;let Te=D<X0?X0:D,c0=G/Te|0,k0=(G-c0*r.calculatePlayerHeight())/2|0,Fe=k0+c0,Q=k0,f0=Fe;Q<0&&(Q=0),f0>G&&(f0=G);let Gt=f0-Q;if(Gt<=0){j[p]=D;continue}let Et=(l0?l0.height:wt.h||N[A]?.height||64)|0,Be=(Q-k0)*(Et/(c0>1?c0:1)),Oe=Gt*(Et/Math.max(1,c0)),Ct=1/(1+D*.25)*(T?.5:1);if(A===7&&(Ct*=.8+.2*Math.sin(t*6+p*.05)),We(m,p,Q,f0,l0,J,Ct,Be,Oe,A),r.sightDist>0&&D>r.sightDist*n0){let d0=r.sightDist*n0,E0=r.sightDist,At=Math.min(1,Math.max(0,(D-d0)/Math.max(1e-6,E0-d0)));if(At>0){let De=r.x|0,Ie=r.y|0,Re=t0(De,Ie,f.zones);m.save(),m.globalAlpha=At*.85,m.fillStyle=f.zones[Re].fogColor||q,m.fillRect(p,Q,1,f0-Q),m.restore()}}j[p]=D}}function ze(t){return G/t}function $e(t,e,o){let{dirY:n,dirX:i,planeY:a,planeX:s,invDet:l}=o,c=l*(n*t-i*e),p=l*(-a*t+s*e);return{transX:c,transY:p}}function Ve(t,e){return Math.round((C>>1)*(1+t/e))}function g0(t,e){let o=t.x-r.x,n=t.y-r.y,{transX:i,transY:a}=$e(o,n,e);if(a<=.01)return null;let s=Ve(i,a),l=t&&typeof t.scale=="number"?t.scale:t&&t.img&&typeof t.img.scale=="number"?t.img.scale:1,c=ze(a)*l,p=typeof t._hR=="number"?t._hR:Math.round(c),y=.1,d=p;(c>p+y||c<p-y)&&(d=Math.round(c)),t._hR=d;let u=d,h=t.img,x=h&&h.width&&h.height?h.width/h.height:1,g=Math.max(1,Math.round(u*x)),w=G,X=r.calculatePlayerHeight(),I=G*.5,R,H;if(t.ground){let A=t.floorBiasFrac??.04,W=I+X*w/a-A*u,o0=W-u;R=Math.round(o0),H=Math.round(W)}else{let A=Math.round(I-u*.5);R=Math.max(0,A),H=Math.min(G,A+u)}let v={startY:R,endY:H},O=Math.round(s-(g>>1)),T=O+g;return{drawStartX:O,drawEndX:T,drawStartY:v.startY,drawEndY:v.endY,depth:a,size:u,width:T-O}}function U0(t,e,o=1){let n=t.trim().split(`
`).map(d=>d.replace(/\s+/g,"")),i=n.length-1;for(;i>=0&&n[i].split("").every(d=>d===".");)i--;i>=0&&i<n.length-1&&(n=n.slice(0,i+1));let a=n.length,s=n[0].length,l=1,c=new OffscreenCanvas(s,a),p=c.getContext("2d");p.imageSmoothingEnabled=!1;let y=p.createImageData(s,a);for(let d=0;d<a;d++)for(let u=0;u<s;u++){let h=n[d][u],x=(d*s+u)*4;if(h==="."){y.data[x+3]=0;continue}let g=e[h]||"#ffffff",w=parseInt(g.slice(1),16);y.data[x]=w>>16&255,y.data[x+1]=w>>8&255,y.data[x+2]=w&255,y.data[x+3]=255}if(p.putImageData(y,0,0),o!==1){let d=new OffscreenCanvas(s*o,a*o),u=d.getContext("2d");return u.imageSmoothingEnabled=!1,u.drawImage(c,0,0,d.width,d.height),d.baseline=l,d.scale=o,d}return c.baseline=l,c.scale=1,c}async function F0(t,e){return await qe(t,e,1)}async function qe(t,e=1,o=1){let n=`../assets/gfx/${t}`;return new Promise((i,a)=>{let s=new Image;s.onload=()=>{let l=new OffscreenCanvas(s.width*e,s.height*e),c=l.getContext("2d");c.imageSmoothingEnabled=!1,c.drawImage(s,0,0,l.width,l.height),l.baseline=o,l.scale=e,i(l)},s.onerror=()=>a(new Error(`Failed to load sprite: ${n}`)),s.src=n})}var B0,K0,O0,j0,Z0,J0,Q0;async function ee(){K0=U0(`
  ................................
  ..............BB..BB............
  .............BbbbbbbB...........
  ...........BbbbGGGGbbbB.........
  ..........BbbbGGGGGGbbbB........
  .........BbbGGGGGGGGGGbbB.......
  ........BbbGGGgGGGGgGGbbB.......
  ........BbbGGgGyyGgGGGbbB.......
  .......BbbGGGGGGGGGGGGbbB.......
  .......BbbGGGGGGGGGGGGbbB.......
  ......BbbGGGGGGGGGGGGGGbbB......
  ......BbbGGGGgGGGGgGGGGbbB......
  ......BbbGGGGwwwwwwGGGGbbB......
  .....BbbGGGwwwWWkWWwwwGGbbB.....
  .....BbbGGGwwwwkkwwwwGGbbB......
  .....BbbGGGwwwwrwwwwGGGbbB......
  .....BbbGGGwwwwwwwwwGGGbbB......
  .....BbbGGGGwwwwwwwGGGGbbB......
  .....BbbGGGGGGGGGGGGGGGbbB......
  .....BbbGGGGGGGGGGGGGGGbbB......
  ......BbbGGGGGGGGGGGGGbbB.......
  ......BbbGGGGGGGGGGGGGbbB.......
  .......BBbbbgggGGGGgggbbBB......
  ........BBBbbbbbbbbbbbbBBB......
  ................................
  `,{B:"#2c1810",b:"#5c3d2e",g:"#7a6b5c",G:"#a89080",k:"#080508",w:"#e8e0d5",W:"#f5f0e8",r:"#8b4513",y:"#ffeb9c"},4),J0=U0(`
  ............
  ....bbbb....
  ..bbGGGGbb..
  .bssssssssb.
  .bGGgGGgGGb.
  .bssssssssb.
  .bGgGGGGgGb.
  .bssssssssb.
  .bGGgGGgGGb.
  .bssssssssb.
  .bGgGGGGgGb.
  .bssssssssb.
  .bGGgGGgGGb.
  .bssssssssb.
  .bGGgGGgGGb.
  .bssssssssb.
  ..bbGGGGbb..
  ....bbbb....
  ............
  ............
  `,{k:"#0a0f10",g:"#FA5053",G:"#CD1C18",s:"#950606",b:"#0e1620"},3),O0=U0(`
  ............r...
  ............rr..
  ...........w..r.
  .......sb.w...rr
  .......bdw...w..
  .......sfd..w...
  ......sfffdw....
  .....sfffffdb...
  ....sfbffffss...
  ...sfbfbffs.....
  ..sfbfbfbs......
  .sfbfbfbs.......
  .sffbfbs........
  ..sffbs.........
  ...sss..........
  ................
  `,{b:"#100904",d:"#8f715b",f:"#5a3b1a",r:"#DC143C",s:"#000000",w:"#4d260a"},3),Z0=await F0("noodles.png",3),B0=await F0("bow.png",3),Q0=await F0("pitchfork.png",3),j0=await F0("keycard1.png",3)}var M=[];function y0(t,e){if(t<0||e<0||t>=f.MAP_W||e>=f.MAP_H)return!0;let o=f.MAP[e|0][t|0];return o===0||o===5?!1:o===7?!r.hasBlueKey:o!==6}function r0(t,e,o){return!!(y0(t,e)||y0(t-o,e)||y0(t+o,e)||y0(t,e-o)||y0(t,e+o))}var E=null,e0=null,_=null,tt=null,oe=null;function ot(){E||(E=new(window.AudioContext||window.webkitAudioContext))}function k({freq:t=440,dur:e=.1,type:o="square",vol:n=.2,slide:i=0}){if(!E)return;let a=E.createOscillator(),s=E.createGain();a.type=o,a.frequency.value=t,s.gain.value=n,a.connect(s).connect(E.destination);let l=E.currentTime;i&&(a.frequency.setValueAtTime(t,l),a.frequency.linearRampToValueAtTime(t+i,l+e)),s.gain.setValueAtTime(n,l),s.gain.exponentialRampToValueAtTime(.001,l+e),a.start(l),a.stop(l+e)}function et({dur:t=.2,vol:e=.2,lp:o=1200}){if(!E)return;let n=E.createBuffer(1,E.sampleRate*t,E.sampleRate),i=n.getChannelData(0);for(let p=0;p<i.length;p++)i[p]=Math.random()*2-1;let a=E.createBufferSource(),s=E.createGain(),l=E.createBiquadFilter();a.buffer=n,s.gain.value=e,l.type="lowpass",l.frequency.value=o,a.connect(l).connect(s).connect(E.destination);let c=E.currentTime;a.start(c),a.stop(c+t)}var P={shot:()=>{let t=B(50),e=-B(50);k({freq:220+t+e,dur:.05+B(3)/100,type:"square",vol:.25,slide:120}),et({dur:.03+B(3)/100,vol:.15,lp:800})},pickup:()=>{k({freq:880,dur:.06,type:"triangle",vol:.2}),k({freq:1180,dur:.08,type:"triangle",vol:.18})},explode:()=>{et({dur:1,vol:.3,lp:800}),k({freq:90,dur:.7,type:"sawtooth",vol:.12,slide:-60})},hurt:()=>{k({freq:140,dur:.12,type:"sawtooth",vol:.2,slide:-50})},killedEntity:()=>{let t=Math.random()*16-8;k({freq:320+t,dur:.26,type:"triangle",vol:.3,slide:-220}),k({freq:480+t,dur:.22,type:"sawtooth",vol:.1,slide:-260}),k({freq:90,dur:.08,type:"sine",vol:.18}),et({dur:.05,vol:.1,lp:1e3}),setTimeout(()=>{k({freq:170+t,dur:.07,type:"triangle",vol:.16,slide:70})},90)},door:()=>{k({freq:420,dur:.12,type:"square",vol:.15})},portal:()=>{k({freq:600,dur:.5,type:"sawtooth",vol:.2}),k({freq:400,dur:.3,type:"sawtooth",vol:.2,slide:50}),k({freq:600,dur:.5,type:"sawtooth",vol:.2})}};async function Ue(t,{volume:e=.15}={}){if(E)try{if(!tt||t!==oe){let n=await(await fetch(t,{cache:"force-cache"})).arrayBuffer();tt=await E.decodeAudioData(n),oe=t}ne(),_=E.createBufferSource(),_.buffer=tt,_.loop=!0,e0=E.createGain(),e0.gain.value=e,_.connect(e0).connect(E.destination),_.start()}catch(o){try{ne();let n=new Audio(t);n.loop=!0,n.volume=Math.max(0,Math.min(1,e)),await n.play(),_={stop:()=>n.pause(),disconnect:()=>{}},e0=null}catch(n){}}}function ne(){try{_&&_.stop(0)}catch(t){}if(_&&_.disconnect)try{_.disconnect()}catch(t){}if(e0)try{e0.disconnect()}catch(t){}_=null,e0=null}var re=!1;async function nt(){if(!E||_||re)return;re=!0,await Ue("../assets/sfx/HexenST02SLowed.ogg",{volume:.12})}var rt=0,L=new Set,it=!1,at=0,st=!1;function se(t){window.addEventListener("keydown",e=>{L.add(e.code),ot(),nt(),e.code==="Space"&&(e.preventDefault(),ie()),e.code==="KeyM"&&(e.preventDefault(),Y.classList.toggle("visible"))}),window.addEventListener("keyup",e=>L.delete(e.code)),t.addEventListener("mousedown",e=>{e.button===0&&ie(),it=!0,at=e.clientX,ot(),nt()}),window.addEventListener("mouseup",()=>it=!1),window.addEventListener("mousemove",e=>{if(it){let o=e.clientX-at;at=e.clientX,r.a+=o*.0035}}),Dt.onclick=()=>Je(),It.onclick=()=>Y.classList.toggle("visible")}function le(t){let e=L.has("ShiftLeft")||L.has("ShiftRight"),o=r.rotSpeed*t,n=r.accel*t,i=Math.cos(r.a),a=Math.sin(r.a),s=-a,l=i;r.weaponAnim>Ht&&(r.weaponAnim=-1),r.weaponAnim>=0&&(r.weaponAnim+=t);let c=3;r.velX-=r.velX*c*t,r.velY-=r.velY*c*t,Math.abs(r.velX)<.002&&(r.velX=0),Math.abs(r.velY)<.002&&(r.velY=0),r.isMoving=!1;let p=0,y=0;L.has("ArrowLeft")&&(r.a-=o),L.has("ArrowRight")&&(r.a+=o),(L.has("ArrowUp")||L.has("KeyW"))&&(p+=i*n,y+=a*n,r.isMoving=!0),(L.has("ArrowDown")||L.has("KeyS"))&&(p-=i*n,y-=a*n,r.isMoving=!0),L.has("KeyA")&&(p-=s*n,y-=l*n,r.isMoving=!0),L.has("KeyD")&&(p+=s*n,y+=l*n,r.isMoving=!0),r.velX+=p,r.velY+=y;let d=Math.hypot(r.velX,r.velY);d>C0&&(r.velX*=C0/d,r.velY*=C0/d);let u=r.x+r.velX*t,h=r.y+r.velY*t;r0(u,r.y,Y0)?r.velX=0:r.x=u,r0(r.x,h,Y0)?r.velY=0:r.y=h}function ie(){if(r.weaponAnim>=0)return;r.weaponAnim=0,$(),P.shot();let t=A0(),e=Ke(t);if(!(!e||g0(e,t).depth>Pt))switch(e.type){case"arrows":e.alive=!1,r.ammo=Math.min(60,r.ammo+u0),$(),S(`Arrows +${u0}`),P.pickup();break;default:e.onHit&&e.onHit(e,!0);break}}function ce(){for(let t of M)if(!(!t.alive||Math.hypot(t.x-r.x,t.y-r.y)>=.6))switch(t.type){case"arrows":t.alive=!1,r.ammo=Math.min(60,r.ammo+u0),$(),P.pickup(),S(`Arrows +${u0}`);break;default:t.onTouch&&t.onTouch(t);break}}function fe(){if(st)return;let t=r.x|0,e=r.y|0;f.MAP[e][t]===5&&(P.portal(),S(`Floor ${U} cleared.`),N0(U+1),st=!0,r.velX=0,r.velY=0,setTimeout(()=>{Ze(!0),st=!1},100))}function Ke(t){let o=document.getElementById("view").width>>1|0,n=j[o]||1e9,i=null,a=1e9;for(let s of M){if(!s.alive)continue;let l=g0(s,t);l&&(r.sightDist>0&&l.depth>r.sightDist||o>=l.drawStartX&&o<l.drawEndX&&l.depth<n+.1&&l.depth<a&&(i=s,a=l.depth))}return i}function x0(t=2){let e=0;for(;e++<200;){let o=(Math.random()*(f.MAP_W-2)|0)+1,n=(Math.random()*(f.MAP_H-2)|0)+1;if(f.MAP[n][o]!==0)continue;let i=o+.5-r.x,a=n+.5-r.y;if(!(Math.hypot(i,a)<t))return{x:o,y:n}}return{x:9,y:9}}function dt(){let t=f.MAP_W,e=f.MAP_H;for(let o=0;o<e;o++)for(let n=0;n<t;n++)f.MAP[o][n]===7&&(f.MAP[o][n]=0)}function de(){let t=z.x,e=z.y;for(let o=e-1;o<=e+1;o++)for(let n=t-1;n<=t+1;n++)n===t&&o===e||(f.MAP[o][n]=7)}function pe(t){let{arrowQuiver:e}=t;if(M.length=0,B(100)<50)for(let i=0;i<B(2)*(f.MAP_H/20|0);i++){let a=x0(1);M.push(b0(b.barrel,{x:a.x+.5,y:a.y+.5}))}let o=x0(4);M.push(b0(b.key,{x:o.x+.5,y:o.y+.5})),o=x0(4),M.push(b0(b.food,{x:o.x+.5,y:o.y+.5}));for(let i=0;i<1+(U/3|0)*(f.MAP_H/20|0);i++)if(i<=1&&B(100)<50||i<1&&r.ammo<=0&&B(100)<80||B(100)<25){let a=x0(3);M.push({x:a.x+.5,y:a.y+.5,img:e,type:"arrows",alive:!0,dist:0,ground:!0,scale:.25,floorBiasFrac:.04})}let n=Math.min((2+(U-1)*2)*(f.MAP_H/20|0),8);for(let i=0;i<n;i++){let a=x0(3.5);M.push(b0(b.entity,{x:a.x+.5,y:a.y+.5}))}}function $(){vt.style.width=`${r.health/r.maxHealth*100}%`,Tt.style.width=`${r.ammo/60*100}%`,Ft.textContent=Math.max(0,r.health),Bt.textContent=r.ammo}var lt=0,ct=0,ft=!1,ae=!1;function S(t){let e=document.getElementById("gameLog"),o=e?.querySelector(".log-items");if(!o)return;let n=document.createElement("div");n.textContent=t,o.prepend(n),e.classList.contains("collapsed")||requestAnimationFrame(()=>{o.scrollTop=0})}function ue(t){lt>0&&(lt-=t,lt<=0&&(Ot.textContent=r.hasBlueKey?"Find the exit.":"Find the key card."))}function me(){ft||r.health<=0&&(ft=!0,r.speed=0,r.rotSpeed=0,ct=2,S("YOU DIED! Soul disconnecting from the node..."))}function he(t){ft&&(ct-=t,ct<=0&&je())}function je(){if(ae)return;ae=!0;let t=document.getElementById("game");if(t){let e=document.createElement("div");e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100vw",e.style.height="100vh",e.style.background="#ff0000",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.zIndex="999999",e.style.fontFamily='"Courier New", monospace',e.style.opacity="0",e.style.transition="opacity 2s ease-in",e.innerHTML=`
      <div style="
        background: #000;
        border: 3px solid #04650d;
        color: #20b2db;
        width: 600px;
        max-width: 90vw;
        box-shadow: 0 0 20px #04650d;
        font-family: 'Courier New', monospace;
      ">
        <div style="
          background:#000;
          color: #04650d;
          padding: 8px 15px;
          display: flex;
          justify-content: space-between;
          font-weight: bold;
          font-size: 12px;
        ">
          <span style ="color: #FFFFFF; border: 1px solid #04650d;">Death...</span>
        </div>
        <div style="padding: 20px; min-height: 200px;">
          <div style="margin-bottom: 30px;">
            <div style="text-align: center; color: #FFFFFF; font-size: 32px; margin: 8px 0;">YOU HAVE DIED</div>
          </div>
          <div style="text-align: center; margin-top: 20px;">
            <button id="returnBtn" style="
              background: #000;
              border: 2px solid #04650d;
              color: #04650d;
              padding: 12px 24px;
              font-family: 'Courier New', monospace;
              font-size: 14px;
              font-weight: bold;
              cursor: pointer;
              text-transform: uppercase;
              letter-spacing: 1px;
            ">RETURN TO TERMINAL</button>
          </div>
        </div>
      </div>
    `,document.body.appendChild(e);let o=e.querySelector("#returnBtn");if(o){let n=!1;o.addEventListener("click",i=>{i.preventDefault(),!n&&(n=!0,setTimeout(()=>{window.location.href="../index.html"},100))})}setTimeout(()=>{e.style.opacity="1"},50),t.classList.add("game-paused"),L.clear()}}function pt(t=!1){t&&i0(),r.x=K.x,r.y=K.y,r.a=0,r.hasBlueKey=!1,f.MAP[z.y][z.x]=5,de(),pe({arrowQuiver:O0}),$(),S(`Floor ${U}: Find the keycard.`)}function Ze(t=!1){t&&(rt>=h0.length-1?i0():(rt+=1,i0(rt))),r.x=K.x,r.y=K.y,r.a=0,r.hasBlueKey=!1,f.MAP[z.y][z.x]=5,de(),pe({arrowQuiver:O0}),$(),S(`Floor ${U}: Find the keycard.`)}function Je(){N0(1),i0(0),pt()}function ge(t){for(let e of M)e.alive&&e.ai&&e.ai(e,t)}var a0={EXPLOSION:"explosion",SCREEN_FLASH:"screen_flash"},Qe={[a0.EXPLOSION]:{lifetime:.5,startRadius:.1,endRadius:1,expansionTime:.4,startOpacity:1,endOpacity:0,primaryColor:{h:30,s:90,l:60},secondaryColor:{h:15,s:85,l:50},glowColor:{h:45,s:100,l:75},fillColor:{h:25,s:80,l:40},ringLineWidth:3,glowLineWidth:2,innerLineWidth:1,renderFunction:ao,ignoreBounds:!1},[a0.SCREEN_FLASH]:{lifetime:.15,startOpacity:.85,endOpacity:0,color:"#ffffff",renderFunction:so,ignoreBounds:!0}},w0=[];function ye(t,e,o,n,i={}){let a=Qe[t];if(!a)return console.warn(`Unknown effect type: ${t}`),null;let s={ignoreBounds:!1,type:t,x:e,y:o,radius:n,maxRadius:n,age:0,lifetime:i.lifetime??a.lifetime,opacity:i.startOpacity??a.startOpacity,startOpacity:i.startOpacity??a.startOpacity,endOpacity:i.endOpacity??a.endOpacity,...a,...i};return w0.push(s),s}function xe(t,e,o,n={}){return ye(a0.EXPLOSION,t,e,o,n)}function be({color:t="#ffffff",duration:e=.15,alpha:o=.85}={}){ye(a0.SCREEN_FLASH,0,0,1,{lifetime:e,startOpacity:o,endOpacity:0,color:t,ignoreBounds:!0})}function we(t){for(let e=w0.length-1;e>=0;e--){let o=w0[e];o.age+=t;let n=Math.min(o.age/o.lifetime,1);to(o,n),o.age>=o.lifetime&&w0.splice(e,1)}}function to(t,e){switch(t.type){case a0.EXPLOSION:eo(t,e);break;case a0.SCREEN_FLASH:oo(t,e);break}}function eo(t,e){t.opacity=v0(t.startOpacity,t.endOpacity,e);let o=Math.min(e/t.expansionTime,1),n=v0(t.startRadius,t.endRadius,o);t.radius=t.maxRadius*n}function oo(t,e){let o=1-(1-e)*(1-e);t.opacity=v0(t.startOpacity,t.endOpacity,o)}function no(){return w0}function Ge(t,e,o,n,i){let a=no();if(a.length!==0){t.save();for(let s of a)ro(t,s,e,o,n,i);t.restore()}}function ro(t,e,o,n,i,a){let s=io(e.x,e.y,o,n,i,a,e.ignoreBounds);!s&&!e.ignoreBounds||e.renderFunction(t,e,s)}function io(t,e,o,n,i,a,s=!1){let l=t-a.x,c=e-a.y,{dirY:p,dirX:y,planeY:d,planeX:u,invDet:h}=o,x=h*(p*l-y*c),g=h*(-d*l+u*c);return g<=.1&&!s?null:s?{x:n/2,y:i/2,radius:i,depth:g}:{x:n/2*(1+x/g),y:i/2+64,radius:i/g*.5,depth:g}}function ao(t,e,o){let n=o.radius*e.radius,i=performance.now()*.001,a=Math.sin(i*8)*12,s=Math.sin(i*12)*.15+1,l=o.y,c=o.x;t.globalAlpha=e.opacity*.3,t.fillStyle=`hsl(${e.fillColor.h+a*.5}, ${e.fillColor.s}%, ${e.fillColor.l}%)`,t.beginPath(),t.arc(c,l,n*.7,0,2*Math.PI),t.fill(),t.globalAlpha=e.opacity*.5,t.strokeStyle=`hsl(${e.glowColor.h+a}, ${e.glowColor.s}%, ${e.glowColor.l}%)`,t.lineWidth=e.glowLineWidth*1.5,t.beginPath(),t.arc(c,l,n*s,0,2*Math.PI),t.stroke(),t.globalAlpha=e.opacity*.85,t.strokeStyle=`hsl(${e.primaryColor.h+a*.8}, ${e.primaryColor.s}%, ${e.primaryColor.l}%)`,t.lineWidth=e.ringLineWidth,t.beginPath(),t.arc(c,l,n*.9,0,2*Math.PI),t.stroke(),t.globalAlpha=e.opacity*.6,t.strokeStyle=`hsl(${e.secondaryColor.h+a*1.3}, ${e.secondaryColor.s}%, ${e.secondaryColor.l}%)`,t.lineWidth=e.innerLineWidth,t.beginPath(),t.arc(c,l,n*.5,0,2*Math.PI),t.stroke()}function so(t,e){if(e.opacity<=0)return;let o=t.canvas.width,n=t.canvas.height;t.save(),t.globalAlpha=e.opacity,t.fillStyle=e.color||"#ffffff",t.fillRect(0,0,o,n),t.restore()}var b=Object.freeze({entity:"entity",barrel:"barrel",food:"food",key:"key"}),D0={[b.entity]:{type:b.entity,ground:!0,scale:.66,floorBiasFrac:.2},[b.barrel]:{type:b.barrel,ground:!0,scale:.66,floorBiasFrac:.04},[b.food]:{type:b.food,ground:!0,scale:.25,floorBiasFrac:.04},[b.key]:{type:b.key,ground:!0,scale:.25,floorBiasFrac:.04}};Object.freeze(D0);for(let t in D0)Object.freeze(D0[t]);var I0={[b.entity]:{ai(t,e){if(!t.alive)return;let o=r.x-t.x,n=r.y-t.y,i=Math.hypot(o,n);if(i>.3){let a=1.25*e,s=o/i,l=n/i,c=t.x+s*a,p=t.y+l*a;r0(c,t.y,.4)||(t.x=c),r0(t.x,p,.4)||(t.y=p)}i<.6&&t.hurtCD<=0&&(r.health=Math.max(0,r.health-_t)|0,$(),S("Entity attacks!"),P.hurt(),t.hurtCD=.8,be({color:"	#740707",duration:.5}),me()),t.hurtCD>0&&(t.hurtCD-=e)},onHit(t,e){e?(t.alive=!1,S(Wt(["Entity murdered!","Entity destroyed!","Entity purged!"])),P.killedEntity()):S("No arrows.")},onTouch(t){ut(b.entity,1e4)&&S("You hear something like water nearby...")},onExplode(t){t.alive=!1,P.killedEntity(),S("The entity is blown to gibs.")}},[b.barrel]:{onHit(t,e){e?(t.alive=!1,Ee(t.x,t.y,2.5),S("Kaboom!"),P.explode()):S("No arrows.")},onTouch(t){ut(b.barrel,1e4)&&S("Shooting this barrel may yield useful results...")},onExplode(t){t.alive=!1,Ee(t.x,t.y,2.5)}},[b.food]:{onTouch(t){t.alive=!1;let e=r.health>=r.maxHealth;e&&(r.maxHealth+=1),r.health=St(r.health+kt,0,r.maxHealth),S(e?"Yummy!":"Health restored."),$(),P.pickup()}},[b.key]:{onTouch(t){t.alive=!1,r.hasBlueKey=!0,P.door(),S("Keycard found! Find the exit!"),dt()},onExplode(t){t.alive=!1,r.hasBlueKey=!0,P.door(),S("The forcefield protecting the exit has suddenly lifted!"),dt()}}};Object.freeze(I0);for(let t in I0)Object.freeze(I0[t]);var lo=0;function b0(t,e={x:0,y:0},o=void 0){let n=D0[t],i=I0[t],a=Object.assign(Object.create(i),n);switch(a.id=lo++,a.x=e.x,a.y=e.y,a.dist=0,a.alive=!0,a.hurtCD=0,t){case b.entity:a.img=K0;break;case b.barrel:a.img=J0;break;case b.food:a.img=Z0;break;case b.key:a.img=j0;break}return o&&Object.assign(a,o),a}function Ee(t,e,o){xe(t,e,o);for(let n of M){if(!n.alive)continue;Math.hypot(n.x-t,n.y-e)<o&&(n.onExplode?n.onExplode(n):n.alive=!1)}}function Ce(t){F.clearRect(0,0,Y.width,Y.height);let e=6,o=20,n=2,i=Math.floor(o/2),a=Math.max(0,Math.min((r.x|0)-i,f.MAP_W-o)),s=Math.max(0,Math.min((r.y|0)-i,f.MAP_H-o));Y.width=n+o*e+n,Y.height=n+o*e+n;for(let d=0;d<o;d++)for(let u=0;u<o;u++){let h=s+d,x=a+u,g=f.MAP[h]?.[x]??0,w="#0c1220";g===1?w="#ECDE60":g===2?w="#707a88":g===3?w="#00e676":g===4?w="#996633":g===5?w="#FFE300":g===6?w=" #3561ff":g===7&&(w="#00FFFF"),F.fillStyle=w,F.fillRect(n+u*e,n+d*e,e-1,e-1)}for(let d of t){if(!d.alive)continue;let u=n+(d.x-a)*e,h=n+(d.y-s)*e;F.fillStyle=d.type===b.entity?"#ffeb9c":d.type===b.barrel?"#CD1C18":d.type===b.key?"#6aa2ff":d.type===b.food?"#7fffd4":(d.type==="arrows","#ffffff"),F.fillRect(u-2,h-2,4,4)}let l=n+(r.x-a)*e,c=n+(r.y-s)*e;F.fillStyle="#e7f3ff",F.beginPath(),F.arc(l,c,2.5,0,Mt),F.fill();let p=Math.cos(r.a),y=Math.sin(r.a);F.strokeStyle="#78f3d3",F.beginPath(),F.moveTo(l,c),F.lineTo(l+p*1.5*e,c+y*1.5*e),F.stroke()}var ht=performance.now(),Ae=new Map;function ut(t,e){let o=ht,n=Ae.get(t)??0;return o<n?!1:(Ae.set(t,o+e),!0)}var mt=G>>1;se(p0);var R0=0;function co(t){let e=`FPS: ${Math.round(t)}`;m.save(),m.font="12px monospace",m.textAlign="right",m.textBaseline="top";let o=C-8,n=6,i=m.measureText(e).width+8,a=16;m.fillStyle="rgba(10, 15, 25, 0.6)",m.fillRect(o-i,n-2,i,a),m.strokeStyle="rgba(60, 80, 130, 0.9)",m.strokeRect(o-i+.5,n-2+.5,i-1,a-1),m.fillStyle="#dfe6ff",m.fillText(e,o,n),m.restore()}function i0(t=-1){let e;if(t!==-1){let o=h0[t];o&&(e=o.dontPersist?JSON.parse(JSON.stringify(o)):o)}else{let o=getRandomElementFromArray(h0);o&&(e=o.dontPersist?JSON.parse(JSON.stringify(o)):o)}z.x=e.exitPos.x,z.y=e.exitPos.y,K.x=e.startPos.x,K.y=e.startPos.y,r.sightDist=e.sightDist||Rt,f.cielingColorFront=e.cielingColorFront||"#6495ED",f.floorColorFront=e.floorColorFront||"#054213",f.cielingColorBack=e.cielingColorBack||"#6495ED",f.floorColorBack=e.floorColorBack||"#03210A",Kt(),f.MAP=e.mapLayout,f.MAP_W=f.MAP[0].length,f.MAP_H=f.MAP.length,f.zones=e.zones,r.x=r.x=e.startPos.x,r.y=e.startPos.y}async function fo(){await ee(),await Nt(),i0(0),pt(),r.maxHealth=Lt+B(6),r.health=r.maxHealth,r.ammo=5+B(5),$(),requestAnimationFrame(Se)}function po(t){let e=A0();if(jt(m),f.zones.length<=2){let o=r.x|0,n=r.y|0,i=t0(o,n,f.zones),a=T0[i];if(!a){let s=f.zones[i].fogColor;a=m.createLinearGradient(0,G,0,mt),a.addColorStop(0,f.floorColorFront||"#054213"),a.addColorStop(.85,f.floorColorBack||"#03210A"),a.addColorStop(.95,s||q),T0[i]=a}m.fillStyle=a,m.fillRect(0,mt,C,mt)}else{for(let o=0;o<C;o++)Zt(t,e,o,0);Qt(m)}Jt(m),te(t,e,f.MAP,f.MAP_W,f.MAP_H),uo(),M.sort((o,n)=>n.dist-o.dist),mo(e),yo(t),Ge(m,e,C,G,r)}function uo(){for(let t of M){let e=t.x-r.x,o=t.y-r.y;t.dist=e*e+o*o}}function mo(t){m.save();for(let e of M){if(!e.alive)continue;let o=g0(e,t);if(!o||r.sightDist>0&&o.depth>r.sightDist)continue;let n=ho(o);go(e,o,n),m.filter="none"}m.restore()}function ho(t){let e=1/(1+t.depth*.3);if(r.sightDist>0&&t.depth>r.sightDist*n0){let i=r.sightDist*n0,a=Math.min(1,Math.max(0,(t.depth-i)/Math.max(1e-6,r.sightDist-i)));e*=1-a*.6}let o=[1,.85,.7,.55,.4];return{quantizedShade:o.reduce((i,a)=>Math.abs(a-e)<Math.abs(i-e)?a:i,o[0])}}function go(t,e,o){o.quantizedShade<.999&&(m.filter=`brightness(${o.quantizedShade})`);let n=Math.max(1,(e.width??e.drawEndX-e.drawStartX)|0),i=e.drawStartY,a=e.drawEndY-e.drawStartY,s=p=>(p-e.drawStartX)*t.img.width/n|0,l=-1,c=0;for(let p=e.drawStartX;p<=e.drawEndX;p++){let d=p>=0&&p<C&&p<e.drawEndX&&e.depth<=j[p];if(d&&l===-1&&(l=p,c=s(p)),(!d||p===e.drawEndX)&&l!==-1){let u=p,h=u-l,x=s(u);x<=c&&(x=c+1);let g=Math.min(t.img.width-c,x-c);h>0&&g>0&&a>0&&m.drawImage(t.img,c,0,g,t.img.height,l,i,h,a),l=-1}}}function yo(t){let e=Math.round(C*.42),o=Math.round(e*(B0.height/B0.width)),n=r.isMoving&&r.weaponAnim<0?10*Math.sin(t*5):0,i=Math.max(8,C*.02|0),a=C*.5-e/2-i/2+n,s=(r.weaponAnim+1)**10,l=s>7?7:s,c=r.weaponAnim>=0?100-l*20:0,p=r.isMoving&&r.weaponAnim<0?10*Math.sin(t*10):0,y=G-o-i+70+p+c;m.drawImage(Q0,a,y,e,o)}function Se(t){let e=Math.min(.05,(t-ht)/1e3);ht=t;let o=e>0?1/e:0;R0=R0?R0*.9+o*.1:o,le(e),ge(e),we(e),ce(),po(t/1e3),Y.classList.contains("visible")&&Ce(M),fe(),ue(e),he(e),co(R0),P0.drawImage(_0,0,0),requestAnimationFrame(Se)}await fo().catch(console.error);export{i0 as ChangeMapLevel,ut as tryCooldown};
