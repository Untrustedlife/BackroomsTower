import{a as ht,b as gt}from"../chunks/chunk-B3G4DJQ2.js";var ge=90*Math.PI/180,D0=ge*.5,O0=.01,_0=.01,E=15;var l0=1,b0=.75,e0=.6,w0="#101b2e",c0=5,yt=10,xt=3.33,bt=1.5,wt=20;var N=document.getElementById("view"),m=N.getContext("2d");l0&&l0!==1&&(N.width=Math.max(1,Math.round(N.width*l0)),N.height=Math.max(1,Math.round(N.height*l0)));var T=N.width,S=N.height,k=document.getElementById("mini"),C=k.getContext("2d");C.imageSmoothingEnabled=!1;var Gt=document.getElementById("hpBar"),Et=document.getElementById("ammoBar"),St=document.getElementById("hpText"),At=document.getElementById("ammoText"),Mt=document.getElementById("msg"),Tt=document.getElementById("btnReset"),Ct=document.getElementById("btnToggleMap");var a={x:3.5,y:3.5,a:0,speed:2,rotSpeed:2.6,health:6,maxHealth:20,ammo:1,hasBlueKey:!1,tenacity:20,maxTenacity:20},H0=.2,V=1,Bt=1,ye=99;function L0(t){V=Math.max(Bt,Math.min(ye,t|0||Bt))}function G0(){let t=Math.cos(a.a),e=Math.sin(a.a),o=-e*Math.tan(D0),n=t*Math.tan(D0),i=1/(o*e-t*n);return{dirX:t,dirY:e,planeX:o,planeY:n,invDet:i}}function xe(t=64,e=64){let o=document.createElement("canvas");return o.width=t,o.height=e,o}var D=new Array(8).fill(null);function Ft(t){let o=t.getContext("2d").getImageData(0,0,t.width,t.height),n=[];for(let i=0;i<t.width;i++){let r=new Uint8ClampedArray(t.height*4);for(let s=0;s<t.height;s++){let l=(s*t.width+i)*4,c=s*4;r[c]=o.data[l],r[c+1]=o.data[l+1],r[c+2]=o.data[l+2],r[c+3]=o.data[l+3]}n.push({data:r,h:t.height})}return{cols:n,w:t.width,h:t.height}}var f0=D.map(t=>t?Ft(t):null);function be(){f0.length=0,D.forEach(t=>{f0.push(t?Ft(t):null)})}var S0=Array.from({length:82},(t,e)=>e*.0125),E0={};function we(){for(let t=1;t<D.length;t++)if(D[t]){E0[t]={};for(let e of S0){let o=document.createElement("canvas");o.width=D[t].width,o.height=D[t].height;let n=o.getContext("2d");n.drawImage(D[t],0,0);let i=e*255|0;n.globalCompositeOperation="multiply",n.fillStyle=`rgb(${i},${i},${i})`,n.fillRect(0,0,o.width,o.height),E0[t][e]=o}}}async function Ge(t){let e=`../assets/gfx/${t}`;return new Promise((o,n)=>{let i=new Image;i.onload=()=>{let r=xe(64,64),s=r.getContext("2d",{willReadFrequently:!0});s.imageSmoothingEnabled=!1,s.drawImage(i,0,0,64,64),o(r)},i.onerror=()=>n(new Error(`Failed to load texture: ${e}`)),i.src=e})}async function vt(){try{await Ee([{index:1,image:"OfficeWall.png"},{index:2,image:"Panel.png"},{index:3,image:"Hedge.png"},{index:4,image:"OfficeDoor.png"},{index:5,image:"Portal.png"},{index:6,image:"OfficeDoorBlue.png"},{index:7,image:"Field.png"}]),be(),we()}catch(t){console.warn("Failed to init backrooms wallpaper:",t)}}async function Ee(t){if(!Array.isArray(t)){console.warn("Expected an array of { index, image } objects. In loadImagesToReplaceTextures");return}let e=t.map(async(o,n)=>{let{index:i,image:r}=o||{};try{let s=await Ge(r);return i&&i>=0&&(D[i]=s),s}catch(s){return console.warn(`Failed to load texture "${r}" for index ${i} and dont support replacing with cool gmod missing texture:`,s),null}});await Promise.all(e)}var O={x:10,y:8},$={x:3.5,y:3.5},u={MAP:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,2,6,2,0,0,0,0,0,0,0,2,6,2,0,0,1],[1,0,0,0,2,0,2,0,0,0,0,0,0,0,2,0,2,0,0,1],[1,0,0,0,2,2,2,0,0,0,0,0,0,0,2,2,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,5,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,3,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,3,3,1,3,3,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,0,0,0,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,2,2,2,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,1,0,2,0,2,0,1,0,3,0,0,0,1],[1,0,0,0,0,0,0,0,0,2,6,2,0,0,0,0,0,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],MAP_W:-1,MAP_H:-1,cielingColorFront:"",floorColorFront:"",cielingColorBack:"",floorColorBack:""},d0=[{name:"Village",mapLayout:[[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,1,2,3,4,5,6,7,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,1,1,1,1,1,6,1,1,6,1,1,1,1,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3]],exitPos:{x:10,y:12},startPos:{x:9.5,y:1.5}},{name:"TowerFloor1",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,1,1,1,1,1,0,0,1,1,1,1,1,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,3,3,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,3,3,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,6,1,1,1,1,0,0,1,6,1,1,1,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,1,1,1,1,1,1,6,1,1,1,1,1,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,1,1,1,1,1,1,0,0,0,1,0,0,1],[1,0,0,1,1,1,1,1,0,0,0,0,1,1,1,1,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,4,4,1,1,1,1,1,1,1,1,1]],exitPos:{x:10,y:17},startPos:{x:5.5,y:4.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#000000",floorColorBack:"#000000"},{name:"Gallery",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,4,4,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,0,0,0,3,1],[1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,3,1,0,0,0,0,0,1],[1,1,0,0,0,7,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,2,0,0,1],[1,1,1,7,1,1,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,6],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0,0,2,0,0,1],[1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,0,0,2,0,0,1],[1,1,0,0,0,3,0,0,0,0,0,3,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,3,0,0,0,0,0,3,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,3,0,0,0,0,0,3,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,3,0,0,0,0,0,3,0,0,0,1,0,0,2,0,0,1],[1,1,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,0,0,2,0,0,1],[1,0,2,2,2,2,2,2,2,2,2,0,1,0,1,0,1,0,1,0,0,2,0,0,1],[4,0,2,2,2,2,2,2,2,2,2,0,6,0,6,0,6,0,6,0,0,2,0,0,1],[1,0,2,2,2,2,2,2,2,2,2,0,1,0,1,0,1,0,1,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,3,0,0,0,3,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],exitPos:{x:3,y:3},startPos:{x:1.5,y:21.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#ECDE60",floorColorBack:"#000000"},{name:"LongHallways",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,1,0,0,0,0,0,0,3,3,3,3,3,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,1,0,0,0,0,0,3,3,3,3,3,3,3,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,3,3,3,0,0,0,3,3,3,0,0,0,0,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,3,3,3,3,0,4,0,3,3,3,3,0,0,0,1,1,1],[1,7,7,1,1,6,1,1,1,6,1,1,1,6,1,1,1,6,1,1,0,0,3,3,3,3,3,0,0,0,3,3,3,3,3,0,0,1,1,1],[1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,0,1],[1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,6,0,1],[1,7,7,1,1,6,1,1,1,1,1,1,1,1,1,1,1,6,1,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,0,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,2,2,0,2,2,2,2,6,2,2,2,2,0,2,2,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,3,0,0,0,0,0,3,2,0,0,0,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,0,3,3,3,3,3,0,3,3,3,3,3,0,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,1,0,0,0,0,3,3,3,3,0,3,3,3,3,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,2,3,0,0,0,0,0,3,2,0,0,0,1,0,0,0,0,0,3,3,3,0,3,3,3,0,0,0,0,0,1,1,1],[1,7,7,1,2,2,0,2,2,2,2,6,2,2,2,2,0,2,2,1,0,0,0,0,0,0,3,3,0,3,3,0,0,0,0,0,0,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,1,1,1,1,1,1,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1],[1,7,7,1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,1,1,1],[1,7,7,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1],[1,7,7,1,0,0,6,0,3,3,3,3,3,3,3,3,3,3,3,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,1,1,1],[1,7,7,1,0,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,3,3,3,3,3,3,3,3,3,3,3,0,4,0,0,1,1,1],[1,7,7,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1],[1,7,7,1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,1,1,1],[1,7,7,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7,0,0,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,1,1],[1,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],exitPos:{x:1,y:1},startPos:{x:9.5,y:3.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#000000",floorColorBack:"#000000"}];function A0(t){if(!Array.isArray(t)||t.length===0)throw new Error("Array must be non-empty.");let e=B(t.length)-1;return t[e]}function B(t){if(t<=0)throw new Error("The maximum value must be greater than 0.");return Math.floor(Math.random()*t)+1}function M0(t,e,o){return t+(e-t)*o}function Rt(t,e){let o=t?t.length:0;if(o===0)return-1;if(e<=t[0])return 0;if(e>=t[o-1])return o-1;let n=0,i=o-1;for(;n<=i;){let r=n+i>>1,s=t[r];if(s===e)return r;s<e?n=r+1:i=r-1}return e-t[i]<=t[n]-e?i:n}var q=new Float32Array(T);function Se(t,e,o,n,i,r,s,l,c,f){if(!i)return;let g=n-o;if(g<=0)return;let d=l||0,p=d<0?0:d>i.height?i.height:d,y=c||i.height,b=i.height-p,h=y<0?0:y>b?b:y,x=Rt(S0,s);t.drawImage(E0[f][S0[x]],r,p,1,h,e,o,1,g)}var u0=S>>1;function It(t){let e=t.createLinearGradient(0,0,0,u0);e.addColorStop(0,u.cielingColorFront||"#6495ED"),u.cielingColorBack&&e.addColorStop(.5,u.cielingColorBack||"#6495ED"),e.addColorStop(.9,w0),t.fillStyle=e,t.fillRect(0,0,T,u0)}function Pt(t){let e=t.createLinearGradient(0,S,0,u0);e.addColorStop(0,u.floorColorFront||"#054213"),e.addColorStop(.85,u.floorColorBack||"#03210A"),e.addColorStop(.95,w0),t.fillStyle=e,t.fillRect(0,u0,T,u0)}function kt(t){let e=t.createLinearGradient(0,0,0,S);e.addColorStop(0,"rgba(16,27,46,0.08)"),e.addColorStop(.5,"rgba(16,27,46,0.16)"),e.addColorStop(1,"rgba(16,27,46,0.20)"),t.fillStyle=e,t.fillRect(0,0,T,S)}function Dt(t,e,o,n,i){let{dirX:r,dirY:s,planeX:l,planeY:c}=e;for(let f=0;f<T;f++){let g=2*(f+.5)/T-1,d=r+l*g,p=s+c*g;if(d<1e-8&&d>-1e-8&&p<1e-8&&p>-1e-8){q[f]=Number.POSITIVE_INFINITY;continue}let y=1/(d||1e-9),b=1/(p||1e-9),h=a.x|0,x=a.y|0,J=y<0?-y:y,Z=b<0?-b:b,W,H,L,t0;d<0?(W=-1,L=(a.x-h)*J):(W=1,L=(h+1-a.x)*J),p<0?(H=-1,t0=(a.y-x)*Z):(H=1,t0=(x+1-a.y)*Z);let Y=0,X=1,g0=!1,le=0,ce=0;for(;!g0&&le++<256;){if(L<t0?(L+=J,h+=W,Y=0):(t0+=Z,x+=H,Y=1),E>0){let x0=Math.min(L,t0);if(x0>E){g0=!1,X=0,ce=x0;break}}if(h<0||x<0||h>=n||x>=i){g0=!0,X=1;break}let s0=o[x][h];if(s0>0){g0=!0,X=s0;break}}if(X===0){q[f]=Number.POSITIVE_INFINITY;continue}let F;Y===0?F=L-J:F=t0-Z,F=O0>F?O0:F;let at=0,fe=Y===0?W:0,de=Y===1?H:0,st=Math.abs(fe*r+de*s)>=.9&&Math.abs(g)<=.9&&F<at?at:F,lt=a.x+st*d,ct=a.y+st*p,K;Y===0?K=ct-(ct|0):K=lt-(lt|0),K=K<0?0:K>.999999?.999999:K+1e-6;let ft=f0[X]||f0[4],r0=D[X],y0=r0?r0.width|0:ft.w|0,U=K*y0|0;(Y===0&&W>0||Y===1&&H<0)&&(U=y0-U-1),U=U<0?0:U>=y0?y0-1:U;let ue=F<_0?_0:F,i0=S/ue|0,k0=(S-i0*b0)/2|0,pe=k0+i0,j=k0,a0=pe;j<0&&(j=0),a0>S&&(a0=S);let dt=a0-j;if(dt<=0){q[f]=F;continue}let ut=(r0?r0.height:ft.h||D[X]?.height||64)|0,me=(j-k0)*(ut/(i0>1?i0:1)),he=dt*(ut/Math.max(1,i0)),pt=1/(1+F*.25)*(Y?.5:1);if(X===7&&(pt*=.8+.2*Math.sin(t*6+f*.05)),Se(m,f,j,a0,r0,U,pt,me,he,X),E>0&&F>E*e0){let s0=E*e0,x0=E,mt=Math.min(1,Math.max(0,(F-s0)/Math.max(1e-6,x0-s0)));mt>0&&(m.save(),m.globalAlpha=mt*.85,m.fillStyle=w0,m.fillRect(f,j,1,a0-j),m.restore())}q[f]=F}}function Ae(t){return S/t}function Me(t,e,o){let{dirY:n,dirX:i,planeY:r,planeX:s,invDet:l}=o,c=l*(n*t-i*e),f=l*(-r*t+s*e);return{transX:c,transY:f}}function Te(t,e){return Math.round((T>>1)*(1+t/e))}function Ce(t,e=0,o=.5){let n=e*100,s=(S>>1)+(t>>1)+(n|0),l=s-t;return l<0&&(l=0),{startY:l,endY:s}}function Be(t){let o=(S>>1)-(t>>1);o<0&&(o=0);let n=o+t;return{startY:o,endY:n}}function p0(t,e){let o=t.x-a.x,n=t.y-a.y,{transX:i,transY:r}=Me(o,n,e);if(r<=.01)return null;let s=Te(i,r),l=t&&typeof t.scale=="number"?t.scale:t&&t.img&&typeof t.img.scale=="number"?t.img.scale:1,c=Ae(r)*l,f=typeof t._hR=="number"?t._hR:Math.round(c),g=.1,d=f;(c>f+g||c<f-g)&&(d=Math.round(c)),t._hR=d;let p=d,y=t.img,b=y&&y.width&&y.height?y.width/y.height:1,h=Math.max(1,Math.round(p*b)),x=p/S,J=(t.floorBias??0)*l*x*(2-b0),Z=Math.min(.9,Math.max(.2,l)),W=t.ground?Ce(p,J,Z):Be(p),H=Math.round(s-(h>>1)),L=H+h;return{drawStartX:H,drawEndX:L,drawStartY:W.startY,drawEndY:W.endY,depth:r,size:p,width:L-H}}function Y0(t,e,o=1){let n=t.trim().split(`
`).map(d=>d.replace(/\s+/g,"")),i=n.length-1;for(;i>=0&&n[i].split("").every(d=>d===".");)i--;i>=0&&i<n.length-1&&(n=n.slice(0,i+1));let r=n.length,s=n[0].length,l=1,c=document.createElement("canvas");c.width=s,c.height=r;let f=c.getContext("2d");f.imageSmoothingEnabled=!1;let g=f.createImageData(s,r);for(let d=0;d<r;d++)for(let p=0;p<s;p++){let y=n[d][p],b=(d*s+p)*4;if(y==="."){g.data[b+3]=0;continue}let h=e[y]||"#ffffff",x=parseInt(h.slice(1),16);g.data[b]=x>>16&255,g.data[b+1]=x>>8&255,g.data[b+2]=x&255,g.data[b+3]=255}if(f.putImageData(g,0,0),o!==1){let d=document.createElement("canvas");d.width=s*o,d.height=r*o;let p=d.getContext("2d");return p.imageSmoothingEnabled=!1,p.drawImage(c,0,0,d.width,d.height),d.baseline=l,d.scale=o,d}return c.baseline=l,c.scale=1,c}async function T0(t,e){return await Fe(t,e,1)}async function Fe(t,e=1,o=1){let n=`../assets/gfx/${t}`;return new Promise((i,r)=>{let s=new Image;s.onload=()=>{let l=document.createElement("canvas"),c=s.width,f=s.height;l.width=c*e,l.height=f*e;let g=l.getContext("2d");g.imageSmoothingEnabled=!1,g.drawImage(s,0,0,l.width,l.height),l.baseline=o,l.scale=e,i(l)},s.onerror=()=>r(new Error(`Failed to load sprite: ${n}`)),s.src=n})}var C0,X0,B0,F0,N0,W0,V0;async function Ot(){X0=Y0(`
  ................................
  ..............BB..BB............
  .............BbbbbbbB...........
  ...........BbbbGGGGbbbB.........
  ..........BbbbGGGGGGbbbB........
  .........BbbGGGGGGGGGGbbB.......
  ........BbbGGGgGGGGgGGbbB.......
  ........BbbGGgGyyGgGGGbbB.......
  .......BbbGGGGGGGGGGGGbbB.......
  .......BbbGGGGGGGGGGGGbbB.......
  ......BbbGGGGGGGGGGGGGGbbB......
  ......BbbGGGGgGGGGgGGGGbbB......
  ......BbbGGGGwwwwwwGGGGbbB......
  .....BbbGGGwwwWWkWWwwwGGbbB.....
  .....BbbGGGwwwwkkwwwwGGbbB......
  .....BbbGGGwwwwrwwwwGGGbbB......
  .....BbbGGGwwwwwwwwwGGGbbB......
  .....BbbGGGGwwwwwwwGGGGbbB......
  .....BbbGGGGGGGGGGGGGGGbbB......
  .....BbbGGGGGGGGGGGGGGGbbB......
  ......BbbGGGGGGGGGGGGGbbB.......
  ......BbbGGGGGGGGGGGGGbbB.......
  .......BBbbbgggGGGGgggbbBB......
  ........BBBbbbbbbbbbbbbBBB......
  ................................
  `,{B:"#2c1810",b:"#5c3d2e",g:"#7a6b5c",G:"#a89080",k:"#080508",w:"#e8e0d5",W:"#f5f0e8",r:"#8b4513",y:"#ffeb9c"},4),W0=Y0(`
  ............
  ....bbbb....
  ..bbGGGGbb..
  .bssssssssb.
  .bGGgGGgGGb.
  .bssssssssb.
  .bGgGGGGgGb.
  .bssssssssb.
  .bGGgGGgGGb.
  .bssssssssb.
  .bGgGGGGgGb.
  .bssssssssb.
  .bGGgGGgGGb.
  .bssssssssb.
  .bGGgGGgGGb.
  .bssssssssb.
  ..bbGGGGbb..
  ....bbbb....
  ............
  ............
  `,{k:"#0a0f10",g:"#FA5053",G:"#CD1C18",s:"#950606",b:"#0e1620"},3),B0=Y0(`
  ............r...
  ............rr..
  ...........w..r.
  .......sb.w...rr
  .......bdw...w..
  .......sfd..w...
  ......sfffdw....
  .....sfffffdb...
  ....sfbffffss...
  ...sfbfbffs.....
  ..sfbfbfbs......
  .sfbfbfbs.......
  .sffbfbs........
  ..sffbs.........
  ...sss..........
  ................
  `,{b:"#100904",d:"#8f715b",f:"#5a3b1a",r:"#DC143C",s:"#000000",w:"#4d260a"},3),N0=await T0("noodles.png",3),C0=await T0("bow.png",3),V0=await T0("pitchfork.png",3),F0=await T0("keycard1.png",3)}var A=[];function z(t,e){if(t<0||e<0||t>=u.MAP_W||e>=u.MAP_H)return!0;let o=u.MAP[e|0][t|0];return o===0||o===5?!1:o===7?!a.hasBlueKey:o!==6}function $0(t,e,o){return!!(z(t,e)||z(t-o,e)||z(t+o,e)||z(t,e-o)||z(t,e+o))}var w=null,Q=null,R=null,q0=null,_t=null;function K0(){w||(w=new(window.AudioContext||window.webkitAudioContext))}function v({freq:t=440,dur:e=.1,type:o="square",vol:n=.2,slide:i=0}){if(!w)return;let r=w.createOscillator(),s=w.createGain();r.type=o,r.frequency.value=t,s.gain.value=n,r.connect(s).connect(w.destination);let l=w.currentTime;i&&(r.frequency.setValueAtTime(t,l),r.frequency.linearRampToValueAtTime(t+i,l+e)),s.gain.setValueAtTime(n,l),s.gain.exponentialRampToValueAtTime(.001,l+e),r.start(l),r.stop(l+e)}function z0({dur:t=.2,vol:e=.2,lp:o=1200}){if(!w)return;let n=w.createBuffer(1,w.sampleRate*t,w.sampleRate),i=n.getChannelData(0);for(let f=0;f<i.length;f++)i[f]=Math.random()*2-1;let r=w.createBufferSource(),s=w.createGain(),l=w.createBiquadFilter();r.buffer=n,s.gain.value=e,l.type="lowpass",l.frequency.value=o,r.connect(l).connect(s).connect(w.destination);let c=w.currentTime;r.start(c),r.stop(c+t)}var P={shot:()=>{let t=B(50),e=-B(50);v({freq:220+t+e,dur:.05+B(3)/100,type:"square",vol:.25,slide:120}),z0({dur:.03+B(3)/100,vol:.15,lp:800})},pickup:()=>{v({freq:880,dur:.06,type:"triangle",vol:.2}),v({freq:1180,dur:.08,type:"triangle",vol:.18})},explode:()=>{z0({dur:1,vol:.3,lp:800}),v({freq:90,dur:.7,type:"sawtooth",vol:.12,slide:-60})},hurt:()=>{v({freq:140,dur:.12,type:"sawtooth",vol:.2,slide:-50})},killedEntity:()=>{let t=Math.random()*16-8;v({freq:320+t,dur:.26,type:"triangle",vol:.3,slide:-220}),v({freq:480+t,dur:.22,type:"sawtooth",vol:.1,slide:-260}),v({freq:90,dur:.08,type:"sine",vol:.18}),z0({dur:.05,vol:.1,lp:1e3}),setTimeout(()=>{v({freq:170+t,dur:.07,type:"triangle",vol:.16,slide:70})},90)},door:()=>{v({freq:420,dur:.12,type:"square",vol:.15})},portal:()=>{v({freq:600,dur:.5,type:"sawtooth",vol:.2}),v({freq:400,dur:.3,type:"sawtooth",vol:.2,slide:50}),v({freq:600,dur:.5,type:"sawtooth",vol:.2})}};async function ve(t,{volume:e=.15}={}){if(w)try{if(!q0||t!==_t){let n=await(await fetch(t,{cache:"force-cache"})).arrayBuffer();q0=await w.decodeAudioData(n),_t=t}Ht(),R=w.createBufferSource(),R.buffer=q0,R.loop=!0,Q=w.createGain(),Q.gain.value=e,R.connect(Q).connect(w.destination),R.start()}catch(o){try{Ht();let n=new Audio(t);n.loop=!0,n.volume=Math.max(0,Math.min(1,e)),await n.play(),R={stop:()=>n.pause(),disconnect:()=>{}},Q=null}catch(n){}}}function Ht(){try{R&&R.stop(0)}catch(t){}if(R&&R.disconnect)try{R.disconnect()}catch(t){}if(Q)try{Q.disconnect()}catch(t){}R=null,Q=null}var Lt=!1;async function U0(){if(!w||R||Lt)return;Lt=!0,await ve("../assets/sfx/HexenST02SLowed.ogg",{volume:.12})}var j0=0,I=new Set,Q0=!1,J0=0,Z0=!1;function Nt(t){window.addEventListener("keydown",e=>{I.add(e.code),K0(),U0(),e.code==="Space"&&(e.preventDefault(),Yt()),e.code==="KeyM"&&(e.preventDefault(),k.classList.toggle("visible"))}),window.addEventListener("keyup",e=>I.delete(e.code)),t.addEventListener("mousedown",e=>{e.button===0&&Yt(),Q0=!0,J0=e.clientX,K0(),U0()}),window.addEventListener("mouseup",()=>Q0=!1),window.addEventListener("mousemove",e=>{if(Q0){let o=e.clientX-J0;J0=e.clientX,a.a+=o*.0035}}),Tt.onclick=()=>ke(),Ct.onclick=()=>k.classList.toggle("visible")}function Wt(t){let e=I.has("ShiftLeft")||I.has("ShiftRight"),o=a.speed*(e?2:1)*t,n=a.rotSpeed*t,i=Math.cos(a.a),r=Math.sin(a.a),s=-r,l=i,c=0,f=0;I.has("ArrowLeft")&&(a.a-=n),I.has("ArrowRight")&&(a.a+=n),(I.has("ArrowUp")||I.has("KeyW"))&&(c+=i*o,f+=r*o),(I.has("ArrowDown")||I.has("KeyS"))&&(c-=i*o,f-=r*o),I.has("KeyA")&&(c-=s*o,f-=l*o),I.has("KeyD")&&(c+=s*o,f+=l*o);let g=a.x+c,d=a.y+f;$0(g,a.y,H0)||(a.x=g),$0(a.x,d,H0)||(a.y=d)}function Yt(){let t=!1;_(),P.shot(),t=!0;let e=G0(),o=Re(e);if(!(!o||p0(o,e).depth>bt))switch(o.type){case"key":o.alive=!1,a.hasBlueKey=!0,P.door(),M("Keycard found! Find the exit!"),qt();break;case"arrows":o.alive=!1,a.ammo=Math.min(60,a.ammo+c0),_(),M(`Arrows +${c0}`),P.pickup();break;default:o.onHit&&o.onHit(o,t);break}}function Vt(){for(let t of A)if(!(!t.alive||Math.hypot(t.x-a.x,t.y-a.y)>=.6))switch(t.type){case"key":t.alive=!1,a.hasBlueKey=!0,P.door(),M("Keycard found! Find the exit!"),qt();break;case"arrows":t.alive=!1,a.ammo=Math.min(60,a.ammo+c0),_(),P.pickup(),M(`Arrows +${c0}`);break;default:t.onTouch&&t.onTouch(t);break}}function $t(){if(Z0)return;let t=a.x|0,e=a.y|0;u.MAP[e][t]===5&&(P.portal(),M(`Floor ${V} cleared.`),L0(V+1),Z0=!0,setTimeout(()=>{Pe(!0),Z0=!1},100))}function Re(t){let o=document.getElementById("view").width>>1|0,n=q[o]||1e9,i=null,r=1e9;for(let s of A){if(!s.alive)continue;let l=p0(s,t);l&&(E>0&&l.depth>E||o>=l.drawStartX&&o<l.drawEndX&&l.depth<n+.1&&l.depth<r&&(i=s,r=l.depth))}return i}function m0(t=2){let e=0;for(;e++<200;){let o=(Math.random()*(u.MAP_W-2)|0)+1,n=(Math.random()*(u.MAP_H-2)|0)+1;if(u.MAP[n][o]!==0)continue;let i=o+.5-a.x,r=n+.5-a.y;if(!(Math.hypot(i,r)<t))return{x:o,y:n}}return{x:9,y:9}}function qt(){let t=u.MAP_W,e=u.MAP_H;for(let o=0;o<e;o++)for(let n=0;n<t;n++)u.MAP[o][n]===7&&(u.MAP[o][n]=0)}function zt(){let t=O.x,e=O.y;for(let o=e-1;o<=e+1;o++)for(let n=t-1;n<=t+1;n++)n===t&&o===e||(u.MAP[o][n]=7)}function Kt(t){let{keycard1:e,arrowQuiver:o}=t;if(A.length=0,B(100)<50)for(let r=0;r<B(2)*(u.MAP_H/20|0);r++){let s=m0(1);A.push(v0(G.barrel,{x:s.x+.5,y:s.y+.5}))}let n=m0(4);A.push({x:n.x+.5,y:n.y+.5,img:e,type:"key",alive:!0,dist:0,ground:!0,scale:.25,floorBias:35}),n=m0(4),A.push(v0(G.food,{x:n.x+.5,y:n.y+.5}));for(let r=0;r<1+(V/3|0)*(u.MAP_H/20|0);r++)if(r<=1&&B(100)<50||r<1&&a.ammo<=0&&B(100)<80||B(100)<25){let s=m0(3);A.push({x:s.x+.5,y:s.y+.5,img:o,type:"arrows",alive:!0,dist:0,ground:!0,scale:.25,floorBias:35})}let i=Math.min((2+(V-1)*2)*(u.MAP_H/20|0),8);for(let r=0;r<i;r++){let s=m0(3.5);A.push(v0(G.entity,{x:s.x+.5,y:s.y+.5}))}}function _(){Gt.style.width=`${a.health/a.maxHealth*100}%`,Et.style.width=`${a.ammo/60*100}%`,St.textContent=Math.max(0,a.health),At.textContent=a.ammo}var tt=0,et=0,ot=!1,Xt=!1;function M(t){let e=document.getElementById("gameLog"),o=e?.querySelector(".log-items");if(!o)return;let n=document.createElement("div");n.textContent=t,o.prepend(n),e.classList.contains("collapsed")||requestAnimationFrame(()=>{o.scrollTop=0})}function Ut(t){tt>0&&(tt-=t,tt<=0&&(Mt.textContent=a.hasBlueKey?"Find the exit.":"Find the key card."))}function jt(){ot||a.health<=0&&(ot=!0,a.speed=0,a.rotSpeed=0,et=2,M("YOU DIED! Soul disconnecting from the node..."))}function Qt(t){ot&&(et-=t,et<=0&&Ie())}function Ie(){if(Xt)return;Xt=!0;let t=document.getElementById("game");if(t){let e=document.createElement("div");e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100vw",e.style.height="100vh",e.style.background="#ff0000",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.zIndex="999999",e.style.fontFamily='"Courier New", monospace',e.style.opacity="0",e.style.transition="opacity 2s ease-in",e.innerHTML=`
      <div style="
        background: #000;
        border: 3px solid #04650d;
        color: #20b2db;
        width: 600px;
        max-width: 90vw;
        box-shadow: 0 0 20px #04650d;
        font-family: 'Courier New', monospace;
      ">
        <div style="
          background:#000;
          color: #04650d;
          padding: 8px 15px;
          display: flex;
          justify-content: space-between;
          font-weight: bold;
          font-size: 12px;
        ">
          <span style ="color: #FFFFFF; border: 1px solid #04650d;">Death...</span>
        </div>
        <div style="padding: 20px; min-height: 200px;">
          <div style="margin-bottom: 30px;">
            <div style="text-align: center; color: #FFFFFF; font-size: 32px; margin: 8px 0;">YOU HAVE DIED</div>
          </div>
          <div style="text-align: center; margin-top: 20px;">
            <button id="returnBtn" style="
              background: #000;
              border: 2px solid #04650d;
              color: #04650d;
              padding: 12px 24px;
              font-family: 'Courier New', monospace;
              font-size: 14px;
              font-weight: bold;
              cursor: pointer;
              text-transform: uppercase;
              letter-spacing: 1px;
            ">RETURN TO TERMINAL</button>
          </div>
        </div>
      </div>
    `,document.body.appendChild(e);let o=e.querySelector("#returnBtn");if(o){let n=!1;o.addEventListener("click",i=>{i.preventDefault(),!n&&(n=!0,setTimeout(()=>{window.location.href="../index.html"},100))})}setTimeout(()=>{e.style.opacity="1"},50),t.classList.add("game-paused"),I.clear()}}function nt(t=!1){t&&o0(),a.x=$.x,a.y=$.y,a.a=0,a.hasBlueKey=!1,u.MAP[O.y][O.x]=5,zt(),Kt({keycard1:F0,arrowQuiver:B0}),_(),M(`Floor ${V}: Find the keycard.`)}function Pe(t=!1){t&&(j0>=d0.length-1?o0():(j0+=1,o0(j0))),a.x=$.x,a.y=$.y,a.a=0,a.hasBlueKey=!1,u.MAP[O.y][O.x]=5,zt(),Kt({keycard1:F0,arrowQuiver:B0}),_(),M(`Floor ${V}: Find the keycard.`)}function ke(){L0(1),o0(0),nt()}function Jt(t){for(let e of A)e.alive&&e.ai&&e.ai(e,t)}var n0={EXPLOSION:"explosion",SCREEN_FLASH:"screen_flash"},De={[n0.EXPLOSION]:{lifetime:.5,startRadius:.1,endRadius:1,expansionTime:.4,startOpacity:1,endOpacity:0,primaryColor:{h:30,s:90,l:60},secondaryColor:{h:15,s:85,l:50},glowColor:{h:45,s:100,l:75},fillColor:{h:25,s:80,l:40},ringLineWidth:3,glowLineWidth:2,innerLineWidth:1,renderFunction:Ne,ignoreBounds:!1},[n0.SCREEN_FLASH]:{lifetime:.15,startOpacity:.85,endOpacity:0,color:"#ffffff",renderFunction:We,ignoreBounds:!0}},h0=[];function Zt(t,e,o,n,i={}){let r=De[t];if(!r)return console.warn(`Unknown effect type: ${t}`),null;let s={ignoreBounds:!1,type:t,x:e,y:o,radius:n,maxRadius:n,age:0,lifetime:i.lifetime??r.lifetime,opacity:i.startOpacity??r.startOpacity,startOpacity:i.startOpacity??r.startOpacity,endOpacity:i.endOpacity??r.endOpacity,...r,...i};return h0.push(s),s}function te(t,e,o,n={}){return Zt(n0.EXPLOSION,t,e,o,n)}function ee({color:t="#ffffff",duration:e=.15,alpha:o=.85}={}){Zt(n0.SCREEN_FLASH,0,0,1,{lifetime:e,startOpacity:o,endOpacity:0,color:t,ignoreBounds:!0})}function oe(t){for(let e=h0.length-1;e>=0;e--){let o=h0[e];o.age+=t;let n=Math.min(o.age/o.lifetime,1);Oe(o,n),o.age>=o.lifetime&&h0.splice(e,1)}}function Oe(t,e){switch(t.type){case n0.EXPLOSION:_e(t,e);break;case n0.SCREEN_FLASH:He(t,e);break}}function _e(t,e){t.opacity=M0(t.startOpacity,t.endOpacity,e);let o=Math.min(e/t.expansionTime,1),n=M0(t.startRadius,t.endRadius,o);t.radius=t.maxRadius*n}function He(t,e){let o=1-(1-e)*(1-e);t.opacity=M0(t.startOpacity,t.endOpacity,o)}function Le(){return h0}function ne(t,e,o,n,i){let r=Le();if(r.length!==0){t.save();for(let s of r)Ye(t,s,e,o,n,i);t.restore()}}function Ye(t,e,o,n,i,r){let s=Xe(e.x,e.y,o,n,i,r,e.ignoreBounds);!s&&!e.ignoreBounds||e.renderFunction(t,e,s)}function Xe(t,e,o,n,i,r,s=!1){let l=t-r.x,c=e-r.y,{dirY:f,dirX:g,planeY:d,planeX:p,invDet:y}=o,b=y*(f*l-g*c),h=y*(-d*l+p*c);return h<=.1&&!s?null:s?{x:n/2,y:i/2,radius:i,depth:h}:{x:n/2*(1+b/h),y:i/2+64,radius:i/h*.5,depth:h}}function Ne(t,e,o){let n=o.radius*e.radius,i=performance.now()*.001,r=Math.sin(i*8)*12,s=Math.sin(i*12)*.15+1,l=o.y,c=o.x;t.globalAlpha=e.opacity*.3,t.fillStyle=`hsl(${e.fillColor.h+r*.5}, ${e.fillColor.s}%, ${e.fillColor.l}%)`,t.beginPath(),t.arc(c,l,n*.7,0,2*Math.PI),t.fill(),t.globalAlpha=e.opacity*.5,t.strokeStyle=`hsl(${e.glowColor.h+r}, ${e.glowColor.s}%, ${e.glowColor.l}%)`,t.lineWidth=e.glowLineWidth*1.5,t.beginPath(),t.arc(c,l,n*s,0,2*Math.PI),t.stroke(),t.globalAlpha=e.opacity*.85,t.strokeStyle=`hsl(${e.primaryColor.h+r*.8}, ${e.primaryColor.s}%, ${e.primaryColor.l}%)`,t.lineWidth=e.ringLineWidth,t.beginPath(),t.arc(c,l,n*.9,0,2*Math.PI),t.stroke(),t.globalAlpha=e.opacity*.6,t.strokeStyle=`hsl(${e.secondaryColor.h+r*1.3}, ${e.secondaryColor.s}%, ${e.secondaryColor.l}%)`,t.lineWidth=e.innerLineWidth,t.beginPath(),t.arc(c,l,n*.5,0,2*Math.PI),t.stroke()}function We(t,e){if(e.opacity<=0)return;let o=t.canvas.width,n=t.canvas.height;t.save(),t.globalAlpha=e.opacity,t.fillStyle=e.color||"#ffffff",t.fillRect(0,0,o,n),t.restore()}var G=Object.freeze({entity:"entity",barrel:"barrel",food:"food"}),R0={[G.entity]:{type:G.entity,ground:!0,scale:.66,floorBias:3},[G.barrel]:{type:G.barrel,ground:!0,scale:.5,floorBias:5},[G.food]:{type:G.food,ground:!0,scale:.25,floorBias:35}};Object.freeze(R0);for(let t in R0)Object.freeze(R0[t]);var I0={[G.entity]:{ai(t,e){if(!t.alive)return;let o=a.x-t.x,n=a.y-t.y,i=Math.hypot(o,n);if(i>.3){let r=.9*e,s=o/i,l=n/i,c=t.x+s*r,f=t.y+l*r;z(c,t.y)||(t.x=c),z(t.x,f)||(t.y=f)}i<.6&&t.hurtCD<=0&&(a.health=Math.max(0,a.health-xt)|0,_(),M("Entity attacks!"),P.hurt(),t.hurtCD=.8,ee({color:"	#740707",duration:.5}),jt()),t.hurtCD>0&&(t.hurtCD-=e)},onHit(t,e){e?(t.alive=!1,M(A0(["Entity murdered!","Entity destroyed!","Entity purged!"])),P.killedEntity()):M("No arrows.")},onTouch(t){rt(G.entity,1e4)&&M("You hear something like water nearby...")}},[G.barrel]:{onHit(t,e){e?(t.alive=!1,re(t.x,t.y,2.5),M("Kaboom!"),P.explode()):M("No arrows.")},onTouch(t){rt(G.barrel,1e4)&&M("Shooting this barrel may yield useful results...")}},[G.food]:{onTouch(t){t.alive=!1;let e=a.health>=a.maxHealth;e&&(a.maxHealth+=1),a.health=ht(a.health+yt,0,a.maxHealth),M(e?"Yummy!":"Health restored."),_(),P.pickup()}}};Object.freeze(I0);for(let t in I0)Object.freeze(I0[t]);var Ve=0;function v0(t,e={x:0,y:0},o=void 0){let n=R0[t],i=I0[t],r=Object.assign(Object.create(i),n);switch(r.id=Ve++,r.x=e.x,r.y=e.y,r.dist=0,r.alive=!0,r.hurtCD=0,t){case G.entity:r.img=X0;break;case G.barrel:r.img=W0;break;case G.food:r.img=N0;break}return o&&Object.assign(r,o),r}function re(t,e,o){te(t,e,o);for(let n of A){if(!n.alive)continue;Math.hypot(n.x-t,n.y-e)<o&&(n.type===itemTypes.barrel&&(n.alive=!1,re(n.x,n.y,2.5)),n.alive=!1)}}function ie(t){C.clearRect(0,0,k.width,k.height);let e=6,o=20,n=2,i=Math.floor(o/2),r=Math.max(0,Math.min((a.x|0)-i,u.MAP_W-o)),s=Math.max(0,Math.min((a.y|0)-i,u.MAP_H-o));k.width=n+o*e+n,k.height=n+o*e+n;for(let d=0;d<o;d++)for(let p=0;p<o;p++){let y=s+d,b=r+p,h=u.MAP[y]?.[b]??0,x="#0c1220";h===1?x="#ECDE60":h===2?x="#707a88":h===3?x="#00e676":h===4?x="#996633":h===5?x="#FFE300":h===6?x=" #3561ff":h===7&&(x="#00FFFF"),C.fillStyle=x,C.fillRect(n+p*e,n+d*e,e-1,e-1)}for(let d of t){if(!d.alive)continue;let p=n+(d.x-r)*e,y=n+(d.y-s)*e;C.fillStyle=d.type===G.entity?"#ffeb9c":d.type===G.barrel?"#CD1C18":d.type==="key"?"#6aa2ff":d.type===G.food?"#7fffd4":(d.type==="arrows","#ffffff"),C.fillRect(p-2,y-2,4,4)}let l=n+(a.x-r)*e,c=n+(a.y-s)*e;C.fillStyle="#e7f3ff",C.beginPath(),C.arc(l,c,2.5,0,gt),C.fill();let f=Math.cos(a.a),g=Math.sin(a.a);C.strokeStyle="#78f3d3",C.beginPath(),C.moveTo(l,c),C.lineTo(l+f*1.5*e,c+g*1.5*e),C.stroke()}var it=performance.now(),ae=new Map;function rt(t,e){let o=it,n=ae.get(t)??0;return o<n?!1:(ae.set(t,o+e),!0)}Nt(N);var P0=0;function $e(t){let e=`FPS: ${Math.round(t)}`;m.save(),m.font="12px monospace",m.textAlign="right",m.textBaseline="top";let o=T-8,n=6,i=m.measureText(e).width+8,r=16;m.fillStyle="rgba(10, 15, 25, 0.6)",m.fillRect(o-i,n-2,i,r),m.strokeStyle="rgba(60, 80, 130, 0.9)",m.strokeRect(o-i+.5,n-2+.5,i-1,r-1),m.fillStyle="#dfe6ff",m.fillText(e,o,n),m.restore()}function o0(t=-1){let e;if(t!==-1){let o=d0[t];o&&(e=o)}else e=A0(d0);O.x=e.exitPos.x,O.y=e.exitPos.y,$.x=e.startPos.x,$.y=e.startPos.y,a.health=a.maxHealth,u.cielingColorFront=e.cielingColorFront||"#6495ED",u.floorColorFront=e.floorColorFront||"#054213",u.cielingColorBack=e.cielingColorBack||"#6495ED",u.floorColorBack=e.floorColorBack||"#03210A",u.MAP=e.mapLayout,u.MAP_W=u.MAP[0].length,u.MAP_H=u.MAP.length,a.x=a.x=e.startPos.x,a.y=e.startPos.y}async function qe(){await Ot(),await vt(),o0(0),nt(),a.maxHealth=wt+B(6),a.health=a.maxHealth,a.ammo=5+B(5),_(),requestAnimationFrame(se)}function ze(t){let e=G0();m.imageSmoothingEnabled=!1,It(m),Pt(m),kt(m),Dt(t,e,u.MAP,u.MAP_W,u.MAP_H),Ke(),A.sort((o,n)=>n.dist-o.dist),Ue(e),Je(),ne(m,e,T,S,a)}function Ke(){for(let t of A){let e=t.x-a.x,o=t.y-a.y;t.dist=e*e+o*o}}function Ue(t){m.save();for(let e of A){if(!e.alive)continue;let o=p0(e,t);if(!o||E>0&&o.depth>E)continue;let n=je(o);Qe(e,o,n),m.filter="none"}m.restore()}function je(t){let e=1/(1+t.depth*.3);if(E>0&&t.depth>E*e0){let i=E*e0,r=Math.min(1,Math.max(0,(t.depth-i)/Math.max(1e-6,E-i)));e*=1-r*.6}let o=[1,.85,.7,.55,.4];return{quantizedShade:o.reduce((i,r)=>Math.abs(r-e)<Math.abs(i-e)?r:i,o[0])}}function Qe(t,e,o){o.quantizedShade<.999&&(m.filter=`brightness(${o.quantizedShade})`);let n=Math.max(1,(e.width??e.drawEndX-e.drawStartX)|0),i=e.drawStartY,r=e.drawEndY-e.drawStartY,s=f=>(f-e.drawStartX)*t.img.width/n|0,l=-1,c=0;for(let f=e.drawStartX;f<=e.drawEndX;f++){let d=f>=0&&f<T&&f<e.drawEndX&&e.depth<=q[f];if(d&&l===-1&&(l=f,c=s(f)),(!d||f===e.drawEndX)&&l!==-1){let p=f,y=p-l,b=s(p);b<=c&&(b=c+1);let h=Math.min(t.img.width-c,b-c);y>0&&h>0&&r>0&&m.drawImage(t.img,c,0,h,t.img.height,l,i,y,r),l=-1}}}function Je(){let t=Math.round(T*.42),e=Math.round(t*(C0.height/C0.width)),o=Math.max(8,T*.02|0),n=T*.8-t-o,i=S-e-o+20;m.drawImage(V0,n,i,t,e)}function se(t){let e=Math.min(.05,(t-it)/1e3);it=t;let o=e>0?1/e:0;P0=P0?P0*.9+o*.1:o,Wt(e),Jt(e),oe(e),Vt(),ze(t/1e3),k.classList.contains("visible")&&ie(A),$t(),Ut(e),Qt(e),$e(P0),requestAnimationFrame(se)}await qe().catch(console.error);export{o0 as ChangeMapLevel,rt as tryCooldown};
