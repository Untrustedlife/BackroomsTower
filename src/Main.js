import{a as i0,b as st}from"../chunks/chunk-B3G4DJQ2.js";var Ut=90*Math.PI/180,k0=Ut*.5,ct=.01,R0=.01,v=15;var u0=.95,s0=.6,S0="#101b2e",h0=5,w0=10,lt=3.33;var z=document.getElementById("view"),m=z.getContext("2d");m.imageSmoothingEnabled=!1;u0&&u0!==1&&(z.width=Math.max(1,Math.round(z.width*u0)),z.height=Math.max(1,Math.round(z.height*u0)));var T=z.width,C=z.height,N=document.getElementById("mini"),F=N.getContext("2d");F.imageSmoothingEnabled=!1;var ft=document.getElementById("hpBar"),dt=document.getElementById("ammoBar"),ut=document.getElementById("hpText"),ht=document.getElementById("ammoText"),wt=document.getElementById("msg"),mt=document.getElementById("btnReset"),pt=document.getElementById("btnToggleMap");var c={x:3.5,y:3.5,a:0,speed:2,rotSpeed:2.6,health:6,maxHealth:6,ammo:1,hasBlueKey:!1,tenacity:20,maxTenacity:20},T0=.2,K=1,Gt=1,Qt=99;function I0(e){K=Math.max(Gt,Math.min(Qt,e|0||Gt))}function E0(){let e=Math.cos(c.a),t=Math.sin(c.a),o=-t*Math.tan(k0),n=e*Math.tan(k0),r=1/(o*t-e*n);return{dirX:e,dirY:t,planeX:o,planeY:n,invDet:r}}function r0(e=64,t=64){let o=document.createElement("canvas");return o.width=e,o.height=t,o}function U(e,t){let o=parseInt(e.slice(1),16),n=o>>16&255,r=o>>8&255,i=o&255,a=s=>i0(((s/255)**2.2+t)*255,0,255)|0;return`#${(a(n)<<16|a(r)<<8|a(i)).toString(16).padStart(6,"0")}`}function p0(e,t,o,n){let r=(o*e.width+t)*4,i=parseInt(n.slice(1),16);e.data[r]=i>>16&255,e.data[r+1]=i>>8&255,e.data[r+2]=i&255,e.data[r+3]=255}function jt(){let e=r0(),t=e.getContext("2d",{willReadFrequently:!0}),o=e.width,n=e.height,r=t.createImageData(o,n),i=["#7a7a7a","#8a8a8a","#9a9a9a","#6a6a6a"];for(let a=0;a<n;a++)for(let s=0;s<o;s++){let d=a%16===15||s%16===15,l=(Math.sin(s*.18)+Math.cos(a*.12))*.06,w=d?"#222222":i[((s/16|0)+(a/16|0))%i.length];p0(r,s,a,U(w,l))}return t.putImageData(r,0,0),e}function Jt(){let e=r0(),t=e.getContext("2d",{willReadFrequently:!0}),o=e.width,n=e.height,r=t.createImageData(o,n);for(let i=0;i<n;i++)for(let a=0;a<o;a++){let s=a%32===0||i%16===0,d=(Math.sin(a*.12)+Math.cos(i*.17))*.07+(((a^i)&7)/128-.03),w=U(s?"#2a2a2a":"#6a6f73",d);(a*13+i*7)%97===0&&(w=U(w,-.25)),p0(r,a,i,w)}return t.putImageData(r,0,0),e}function Zt(){let e=r0(),t=e.getContext("2d",{willReadFrequently:!0}),o=e.width,n=e.height,r=t.createImageData(o,n);for(let i=0;i<n;i++)for(let a=0;a<o;a++){let s=Math.sin((a+i)*.18)*.1+Math.cos((a-i)*.14)*.08,d=((a^i<<1)&15)/255-.02,l=U("#2e6a2e",s+d);((a+i*2)%13===0||(a*3-i)%29===0)&&(l=U(l,-.18)),(a*5+i*7)%101===0&&(l=U(l,.18)),p0(r,a,i,l)}return t.putImageData(r,0,0),e}function bt(e="#5b4b2a"){let t=r0(),o=t.getContext("2d",{willReadFrequently:!0}),n=t.width,r=t.height,i=o.createImageData(n,r);for(let a=0;a<r;a++)for(let s=0;s<n;s++){let d=Math.sin(s*.22+Math.cos(a*.05)*.4)*.08+Math.sin(a*.07)*.02;p0(i,s,a,U(e,d))}o.putImageData(i,0,0),o.fillStyle="#3a3a3a",o.fillRect(0,18,n,4),o.fillRect(0,42,n,4),o.fillStyle="#6a6a6a";for(let a=6;a<n;a+=12)o.fillRect(a,19,2,2),o.fillRect(a,43,2,2);return o.strokeStyle="#444",o.lineWidth=2,o.beginPath(),o.arc(46,32,4,0,Math.PI*2),o.stroke(),t}function te(){let e=r0(),t=e.getContext("2d",{willReadFrequently:!0}),o=e.width,n=e.height;t.fillStyle="#1f1f24",t.fillRect(0,0,o,n);let r=o/2,i=n/2,a=t.createRadialGradient(r,i,4,r,i,28);a.addColorStop(0,"#74CCEA"),a.addColorStop(.5,"#20B2DB"),a.addColorStop(1,"#FFE300"),t.fillStyle=a,t.beginPath(),t.arc(r,i,26,0,Math.PI*2),t.fill(),t.strokeStyle="rgba(255,255,255,0.25)";for(let s=0;s<6;s++){t.beginPath();let d=8+s*3;t.arc(r,i,d,s*.6,s*.6+Math.PI*1.2),t.stroke()}return t.strokeStyle="#3a3a3a",t.lineWidth=4,t.beginPath(),t.arc(r,i,28,0,Math.PI*2),t.stroke(),e}function ee(){let e=bt("#6a4a2a"),t=e.getContext("2d",{willReadFrequently:!0});t.fillStyle="#103b5f",t.fillRect(28,8,8,48),t.fillStyle="#74c8ff";for(let o=12;o<52;o+=8)t.fillRect(30,o,4,2);return e}function oe(){let e=r0(),t=e.getContext("2d",{willReadFrequently:!0}),o=e.width,n=e.height,r=t.createImageData(o,n),i=(f,u,p)=>{let G=parseInt(f.slice(1),16),b=parseInt(u.slice(1),16),x=G>>16&255,S=G>>8&255,g=G&255,B=b>>16&255,E=b>>8&255,X=b&255,A=x+(B-x)*p|0,W=S+(E-S)*p|0,H=g+(X-g)*p|0;return`#${(A<<16|W<<8|H).toString(16).padStart(6,"0")}`},a=1337,s=()=>(a=a*1664525+1013904223>>>0)/4294967295,d=[];for(let f=0;f<7;f++)d.push({x:6+s()*(o-12),y:6+s()*(n-12),r:5+s()*9});let l=[];for(let f=0;f<4;f++){let u=s()*o,p=s()*n,G=s()*Math.PI*2,b=20+s()*28,x=u+Math.cos(G)*b,S=p+Math.sin(G)*b,g=2+s()*2.5;l.push({sx:u,sy:p,ex:x,ey:S,rad:g})}let w=(f,u,p,G,b,x)=>{let S=b-p,g=x-G,B=f-p,E=u-G,X=S*S+g*g||1,A=(B*S+E*g)/X;A=A<0?0:A>1?1:A;let W=p+A*S-f,H=G+A*g-u;return Math.sqrt(W*W+H*H)};for(let f=0;f<n;f++)for(let u=0;u<o;u++){let p=Math.sin(u*.23)*.07+Math.cos(f*.19)*.06,G=Math.sin((u+f)*.09)*.05+Math.cos((u-f)*.08)*.04,b=Math.sin(u*.6+f*.15)*.02+Math.cos(u*.2-f*.5)*.015,x=((u*31^f*17)&31)/255-.03,S=p+G+b,g="#FE6660",B=0;for(let M=0;M<d.length;M++){let P=u-d[M].x,D=f-d[M].y,t0=Math.sqrt(P*P+D*D);t0<d[M].r&&(B=Math.max(B,1-t0/d[M].r))}B>0&&(g=i(g,"#f3e08a",Math.min(.45,B*.6)));let E=0;for(let M=0;M<l.length;M++){let P=w(u,f,l[M].sx,l[M].sy,l[M].ex,l[M].ey),D=1-Math.min(1,P/l[M].rad);D>0&&(E=Math.max(E,D))}E>0&&(g=i(g,"#f3d37a",Math.min(.5,E*.8)));let A=(u*13+f*29)%211===0||(u+f*5&63)===7?-.3:0,W=(u*7-f*11)%197===0?.16:0,H=S+x+A+W;p0(r,u,f,U(g,H))}t.putImageData(r,0,0),t.globalAlpha=.5,t.strokeStyle="#9F0000",t.lineWidth=1;for(let f=0;f<10;f++){t.beginPath();let u=2+f*8;t.moveTo(2,u);for(let p=2;p<o-2;p+=8){let G=u+Math.sin((p+f*7)*.4)*3+(f%2?2:-2);t.lineTo(p,G)}t.stroke()}return t.globalAlpha=1,t.strokeStyle="#7E1A09",t.lineWidth=2,t.strokeRect(1,1,o-2,n-2),e}var ne=[null,jt(),Jt(),Zt(),bt(),te(),ee(),oe()],Q=[...ne];function gt(e){let o=e.getContext("2d").getImageData(0,0,e.width,e.height),n=[];for(let r=0;r<e.width;r++){let i=new Uint8ClampedArray(e.height*4);for(let a=0;a<e.height;a++){let s=(a*e.width+r)*4,d=a*4;i[d]=o.data[s],i[d+1]=o.data[s+1],i[d+2]=o.data[s+2],i[d+3]=o.data[s+3]}n.push({data:i,h:e.height})}return{cols:n,w:e.width,h:e.height}}var m0=Q.map(e=>e?gt(e):null);function re(){m0.length=0,Q.forEach(e=>{m0.push(e?gt(e):null)})}async function ae(e){let t=`../assets/gfx/${e}`;return new Promise((o,n)=>{let r=new Image;r.onload=()=>{let i=r0(64,64),a=i.getContext("2d",{willReadFrequently:!0});a.imageSmoothingEnabled=!1,a.drawImage(r,0,0,64,64),o(i)},r.onerror=()=>n(new Error(`Failed to load texture: ${t}`)),r.src=t})}async function xt(){try{await ie([{index:1,image:"OfficeWall.png"}]),re()}catch(e){console.warn("Failed to init backrooms wallpaper:",e)}}async function ie(e){if(!Array.isArray(e)){console.warn("Expected an array of { index, image } objects. In loadImagesToReplaceTextures");return}let t=e.map(async(o,n)=>{let{index:r,image:i}=o||{};try{let a=await ae(i);r&&r>=0&&r<Q.length?Q[r]=a:Q.push(a)}catch(a){console.warn(`Failed to load texture "${i}" for index ${r} and dont support replacing with cool gmod missing texture:`,a)}});await Promise.all(t)}var V={x:10,y:8},j={x:3.5,y:3.5},h={MAP:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,2,6,2,0,0,0,0,0,0,0,2,6,2,0,0,1],[1,0,0,0,2,0,2,0,0,0,0,0,0,0,2,0,2,0,0,1],[1,0,0,0,2,2,2,0,0,0,0,0,0,0,2,2,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,5,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,3,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,3,3,1,3,3,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,0,0,0,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,2,2,2,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,1,0,2,0,2,0,1,0,3,0,0,0,1],[1,0,0,0,0,0,0,0,0,2,6,2,0,0,0,0,0,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],MAP_W:-1,MAP_H:-1,cielingColorFront:"",floorColorFront:"",cielingColorBack:"",floorColorBack:""},G0=[{name:"Village",mapLayout:[[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,1,1,1,1,1,1,6,6,1,1,1,1,1,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3]],exitPos:{x:10,y:12},startPos:{x:9.5,y:1.5}},{name:"TowerFloor1",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,1,1,1,1,1,0,0,1,1,1,1,1,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,3,3,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,3,3,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,1,6,6,1,1,0,0,1,1,6,6,1,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,1,1,1,1,1,6,6,1,1,1,1,1,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,1,1,1,1,1,1,0,0,0,1,0,0,1],[1,0,0,1,1,1,1,1,0,0,0,0,1,1,1,1,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,4,4,1,1,1,1,1,1,1,1,1]],exitPos:{x:10,y:17},startPos:{x:5.5,y:4.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#000000",floorColorBack:"#000000"},{name:"Gallery",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,4,4,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,0,0,0,3,1],[1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,3,1,0,0,0,0,0,1],[1,1,0,0,0,7,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,2,0,0,1],[1,1,1,7,1,1,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0,0,2,0,0,1],[1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,0,0,2,0,0,1],[1,1,0,0,0,3,0,0,0,0,0,3,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,3,0,0,0,0,0,3,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,3,0,0,0,0,0,3,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,3,0,0,0,0,0,3,0,0,0,1,0,0,2,0,0,1],[1,1,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,0,0,2,0,0,1],[1,0,2,2,2,2,2,2,2,2,2,0,1,0,1,0,1,0,1,0,0,2,0,0,1],[4,0,2,2,2,2,2,2,2,2,2,0,6,0,6,0,6,0,6,0,0,2,0,0,1],[1,0,2,2,2,2,2,2,2,2,2,0,1,0,1,0,1,0,1,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,3,0,0,0,3,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],exitPos:{x:3,y:3},startPos:{x:1.5,y:21.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#ECDE60",floorColorBack:"#000000"},{name:"LongHallways",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,1,0,0,0,0,0,0,3,3,3,3,3,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,1,0,0,0,0,0,3,3,3,3,3,3,3,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,3,3,3,0,0,0,3,3,3,0,0,0,0,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,3,3,3,3,0,4,0,3,3,3,3,0,0,0,1,1,1],[1,7,7,1,1,6,1,1,1,6,1,1,1,6,1,1,1,6,1,1,0,0,3,3,3,3,3,0,0,0,3,3,3,3,3,0,0,1,1,1],[1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,0,1],[1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,6,0,1],[1,7,7,1,1,6,1,1,1,1,1,1,1,1,1,1,1,6,1,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,0,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,2,2,0,2,2,2,2,6,2,2,2,2,0,2,2,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,3,0,0,0,0,0,3,2,0,0,0,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,0,3,3,3,3,3,0,3,3,3,3,3,0,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,1,0,0,0,0,3,3,3,3,0,3,3,3,3,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,2,3,0,0,0,0,0,3,2,0,0,0,1,0,0,0,0,0,3,3,3,0,3,3,3,0,0,0,0,0,1,1,1],[1,7,7,1,2,2,0,2,2,2,2,6,2,2,2,2,0,2,2,1,0,0,0,0,0,0,3,3,0,3,3,0,0,0,0,0,0,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,1,1,1,1,1,1,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1],[1,7,7,1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,1,1,1],[1,7,7,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1],[1,7,7,1,0,0,6,0,3,3,3,3,3,3,3,3,3,3,3,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,1,1,1],[1,7,7,1,0,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,3,3,3,3,3,3,3,3,3,3,3,0,4,0,0,1,1,1],[1,7,7,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1],[1,7,7,1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,1,1,1],[1,7,7,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7,0,0,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,1,1],[1,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],exitPos:{x:1,y:1},startPos:{x:9.5,y:3.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#000000",floorColorBack:"#000000"}];var J=new Float32Array(T);function se(e,t,o,n,r,i,a,s,d){let l=n-o;if(l<=0)return;e.save(),e.imageSmoothingEnabled=!1;let w=s||0,f=w<0?0:w>r.height?r.height:w,u=d||r.height,p=r.height-f,G=u<0?0:u>p?p:u;if(e.drawImage(r,i,f,1,G,t,o,1,l),a<.999){let x=(a<0?0:a)*255|0;e.globalCompositeOperation="multiply",e.fillStyle=`rgb(${x},${x},${x})`,e.fillRect(t,o,1,l)}e.restore()}var b0=C>>1;function yt(e,t,o,n,r){let{dirX:i,dirY:a,planeX:s,planeY:d}=t,l=m.createLinearGradient(0,0,0,b0);l.addColorStop(0,h.cielingColorFront||"#6495ED"),h.cielingColorBack&&l.addColorStop(.5,h.cielingColorBack||"#6495ED"),l.addColorStop(.9,S0),m.fillStyle=l,m.fillRect(0,0,T,b0);let w=m.createLinearGradient(0,C,0,b0);w.addColorStop(0,h.floorColorFront||"#054213"),w.addColorStop(.85,h.floorColorBack||"#03210A"),w.addColorStop(.95,S0),m.fillStyle=w,m.fillRect(0,b0,T,b0);let f=m.createLinearGradient(0,0,0,C);f.addColorStop(0,"rgba(16,27,46,0.08)"),f.addColorStop(.5,"rgba(16,27,46,0.16)"),f.addColorStop(1,"rgba(16,27,46,0.20)"),m.save(),m.fillStyle=f,m.fillRect(0,0,T,C),m.restore();for(let u=0;u<T;u++){let p=2*(u+.5)/T-1,G=i+s*p,b=a+d*p;if(G<1e-8&&G>-1e-8&&b<1e-8&&b>-1e-8){J[u]=Number.POSITIVE_INFINITY;continue}let x=1/(G||1e-9),S=1/(b||1e-9),g=c.x|0,B=c.y|0,E=x<0?-x:x,X=S<0?-S:S,A,W,H,M;G<0?(A=-1,H=(c.x-g)*E):(A=1,H=(g+1-c.x)*E),b<0?(W=-1,M=(c.y-B)*X):(W=1,M=(B+1-c.y)*X);let P=0,D=1,t0=!1,Xt=0,Wt=0;for(;!t0&&Xt++<256;){if(H<M?(H+=E,g+=A,P=0):(M+=X,B+=W,P=1),v>0){let B0=Math.min(H,M);if(B0>v){t0=!1,D=0,Wt=B0;break}}if(g<0||B<0||g>=n||B>=r){t0=!0,D=1;break}let d0=o[B][g];if(d0>0){t0=!0,D=d0;break}}if(D===0){J[u]=Number.POSITIVE_INFINITY;continue}let _;P===0?_=H-E:_=M-X,_=Math.max(ct,_);let J0=0,qt=P===0?A:0,Nt=P===1?W:0,Z0=Math.abs(qt*i+Nt*a)>=.9&&Math.abs(p)<=.9&&_<J0?J0:_,tt=c.x+Z0*G,et=c.y+Z0*b,e0;P===0?e0=et-(et|0):e0=tt-(tt|0),e0=e0<0?0:e0>.999999?.999999:e0+1e-6;let ot=m0[D]||m0[4],l0=Q[D],y0=l0?l0.width|0:ot.w|0,o0=e0*y0|0;(P===0&&A>0||P===1&&W<0)&&(o0=y0-o0-1),o0=o0<0?0:o0>=y0?y0-1:o0;let Vt=_<R0?R0:_,M0=C/Vt|0,F0=(C-M0)/2|0,$t=F0+M0,n0=F0,f0=$t;n0<0&&(n0=0),f0>C&&(f0=C);let nt=f0-n0;if(nt<=0){J[u]=_;continue}let rt=(l0?l0.height:ot.h||Q[D]?.height||64)|0,zt=(n0-F0)*(rt/Math.max(1,M0)),Kt=nt*(rt/Math.max(1,M0)),at=1/(1+_*.25)*(P?.5:1);if(D===7&&(at*=.8+.2*Math.sin(e*6+u*.05)),se(m,u,n0,f0,l0,o0,at,zt,Kt),v>0&&_>v*s0){let d0=v*s0,B0=v,it=Math.min(1,Math.max(0,(_-d0)/Math.max(1e-6,B0-d0)));it>0&&(m.save(),m.globalAlpha=it*.85,m.fillStyle=S0,m.fillRect(u,n0,1,f0-n0),m.restore())}J[u]=_}}function ce(e){return C/e}function le(e,t,o){let{dirY:n,dirX:r,planeY:i,planeX:a,invDet:s}=o,d=s*(n*e-r*t),l=s*(-i*e+a*t);return{transX:d,transY:l}}function fe(e,t){return Math.round((T>>1)*(1+e/t))}function de(e,t=0,o=.5){let n=t*100,a=(C>>1)+(e>>1)+(n|0),s=a-e;return s<0&&(s=0),{startY:s,endY:a}}function ue(e){let o=(C>>1)-(e>>1);o<0&&(o=0);let n=o+e;return{startY:o,endY:n}}function v0(e,t){let o=e.x-c.x,n=e.y-c.y,{transX:r,transY:i}=le(o,n,t);if(i<=.01)return null;let a=fe(r,i),s=e&&typeof e.scale=="number"?e.scale:e&&e.img&&typeof e.img.scale=="number"?e.img.scale:1,d=ce(i)*s,l=typeof e._hR=="number"?e._hR:Math.round(d),w=.1,f=l;(d>l+w||d<l-w)&&(f=Math.round(d)),e._hR=f;let u=f,p=e.img,G=p&&p.width&&p.height?p.width/p.height:1,b=Math.max(1,Math.round(u*G)),x=u/C,S=(e.floorBias??0)*s*x,g=Math.min(.9,Math.max(.2,s)),B=e.ground?de(u,S,g):ue(u),E=Math.round(a-(b>>1)),X=E+b;return{drawStartX:E,drawEndX:X,drawStartY:B.startY,drawEndY:B.endY,depth:i,size:u,width:X-E}}function g0(e,t,o=1){let n=e.trim().split(`
`).map(f=>f.replace(/\s+/g,"")),r=n.length-1;for(;r>=0&&n[r].split("").every(f=>f===".");)r--;r>=0&&r<n.length-1&&(n=n.slice(0,r+1));let i=n.length,a=n[0].length,s=1,d=document.createElement("canvas");d.width=a,d.height=i;let l=d.getContext("2d");l.imageSmoothingEnabled=!1;let w=l.createImageData(a,i);for(let f=0;f<i;f++)for(let u=0;u<a;u++){let p=n[f][u],G=(f*a+u)*4;if(p==="."){w.data[G+3]=0;continue}let b=t[p]||"#ffffff",x=parseInt(b.slice(1),16);w.data[G]=x>>16&255,w.data[G+1]=x>>8&255,w.data[G+2]=x&255,w.data[G+3]=255}if(l.putImageData(w,0,0),o!==1){let f=document.createElement("canvas");f.width=a*o,f.height=i*o;let u=f.getContext("2d");return u.imageSmoothingEnabled=!1,u.drawImage(d,0,0,f.width,f.height),f.baseline=s,f.scale=o,f}return d.baseline=s,d.scale=1,d}async function he(e,t){return await we(e,t,1)}async function we(e,t=1,o=1){let n=`../assets/gfx/${e}`;return new Promise((r,i)=>{let a=new Image;a.onload=()=>{let s=document.createElement("canvas"),d=a.width,l=a.height;s.width=d*t,s.height=l*t;let w=s.getContext("2d");w.imageSmoothingEnabled=!1,w.drawImage(a,0,0,s.width,s.height),s.baseline=o,s.scale=t,r(s)},a.onerror=()=>i(new Error(`Failed to load sprite: ${n}`)),a.src=n})}var me={B:"#2c1810",b:"#5c3d2e",g:"#7a6b5c",G:"#a89080",k:"#080508",w:"#e8e0d5",W:"#f5f0e8",r:"#8b4513",y:"#ffeb9c"},P0=g0(`
  ................................
  ..............BB..BB............
  .............BbbbbbbB...........
  ...........BbbbGGGGbbbB.........
  ..........BbbbGGGGGGbbbB........
  .........BbbGGGGGGGGGGbbB.......
  ........BbbGGGgGGGGgGGbbB.......
  ........BbbGGgGyyGgGGGbbB.......
  .......BbbGGGGGGGGGGGGbbB.......
  .......BbbGGGGGGGGGGGGbbB.......
  ......BbbGGGGGGGGGGGGGGbbB......
  ......BbbGGGGgGGGGgGGGGbbB......
  ......BbbGGGGwwwwwwGGGGbbB......
  .....BbbGGGwwwWWkWWwwwGGbbB.....
  .....BbbGGGwwwwkkwwwwGGbbB......
  .....BbbGGGwwwwrwwwwGGGbbB......
  .....BbbGGGwwwwwwwwwGGGbbB......
  .....BbbGGGGwwwwwwwGGGGbbB......
  .....BbbGGGGGGGGGGGGGGGbbB......
  .....BbbGGGGGGGGGGGGGGGbbB......
  ......BbbGGGGGGGGGGGGGbbB.......
  ......BbbGGGGGGGGGGGGGbbB.......
  .......BBbbbgggGGGGgggbbBB......
  ........BBBbbbbbbbbbbbbBBB......
  ................................
  `,me,4),pe={k:"#0a0f10",g:"#1b5c3a",G:"#2e874f",s:"#7fffd4",b:"#0e1620"},D0=g0(`
  ............
  ....bbbb....
  ..bbGGGGbb..
  .bGGGGGGGGb.
  .bGGgGGgGGb.
  .bGGGGGGGGb.
  .bGgGGGGgGb.
  .bGGGGGGGGb.
  .bGGgGGgGGb.
  .bGGGGGGGGb.
  .bGgGGGGgGb.
  .bGGGGGGGGb.
  .bGGgGGgGGb.
  .bGGGGGGGGb.
  .bGGgGGgGGb.
  .bGGGGGGGGb.
  ..bbGGGGbb..
  ....bbbb....
  ............
  ............
  `,pe,3),H0=await he("apple.png",3),Ge={k:"#5a4500",g:"#FFD700",G:"#FFA500",s:"#FFF5CC",b:"#4169E1",B:"#87CEEB"},_0=g0(`
  ................
  .....B....B.....
  ....BBBBBBBB....
  ...BBbBBbBBB....
  ...BBbgBgbBB....
  ....BBgggBB.....
  .....kGGGk......
  ....kGGsGGk.....
  ...kGGGGGGGk....
  ...kGGGGGGGk....
  ....kGGGGGk.....
  .....kGGGk......
  .......GG.......
  .......GG.......
  .....GGGGGG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GGggGG.....
  `,Ge,4),be={b:"#100904",d:"#8f715b",f:"#5a3b1a",r:"#DC143C",s:"#000000",w:"#4d260a"},L0=g0(`
  ............r...
  ............rr..
  ...........w..r.
  .......sb.w...rr
  .......bdw...w..
  .......sfd..w...
  ......sfffdw....
  .....sfffffdb...
  ....sfbffffss...
  ...sfbfbffs.....
  ..sfbfbfbs......
  .sfbfbfbs.......
  .sffbfbs........
  ..sffbs.........
  ...sss..........
  ................
  `,be,3),ge={b:"#5a3b1a",f:"#B8860B",r:"#DC143C",s:"#C0C0C0",w:"#8B4513"},A0=g0(`
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ........................................................w.......
  ......................................................sww.......
  ..................................................wwwwws........
  ...............................................wwwwwwww.s.......
  ..............................................wwwwww....s.......
  ...........................................wwwwwww......s.......
  ...........................................wwwww........s.......
  ..........................................wwwww..........s......
  .........................................wwwww...........s......
  ........................................wwwwww...........s......
  ........................................wwwww............s......
  .......................................wwwww.............s......
  .......................................wwwww.............s......
  .......................................wwww...............s.....
  ......................................wwwww...............s.....
  ......................................wwww................s.....
  .....................................wwwww................s.....
  .....................................wwwww................s.....
  .....................................wwww.................s.....
  .....................................wwww.................s.....
  ....................................wwwww.................s.....
  ....................................wwww..................s.....
  ....................................wwww..................s.....
  ..............................ssss.wwwww..................s.....
  ..............................sss..wwww...................s.....
  ..............................s.bb.wwww....................s....
  ..............................s..bbwwww....................s....
  ..................................bwwww....................s....
  ..................................bbwww....................s....
  ...................................bbww....................s....
  ..................................wwbbww...................s....
  ..................................wwwbbb....................s...
  ..................................wwwwwbb...................s...
  ...................................wwwwwbb..................s...
  ....................................wwww.bb.................s...
  ....................................wwww..bbb...............s...
  ....................................wwww....bb..............s...
  ....................................wwww.....bb..............s..
  ....................................wwww......bb.............s..
  ...................................wwwww.......bb............s..
  ..................................wwwwww........bbb..........s..
  ..................................wwwwww.........bbb.........ss.
  ..................................wwwwww...........bbrrrrr....s.
  ..................................wwwwww...........fbbbrrrr...s.
  ...................................wwwww...........ffffbbrrr..s.
  ...................................wwwwww...........ffffbbrrr.s.
  ...................................wwwwww...........ffffffbb.ss.
  ...................................wwwwww.............ffff.bbbs.
  ...................................wwwwwww..............ff...bs.
  `,ge,3),k=[];function Mt(e){F.clearRect(0,0,N.width,N.height);let t=8;N.width=2+h.MAP_W*t+2,N.height=2+h.MAP_H*t+2;for(let r=0;r<h.MAP_H;r++)for(let i=0;i<h.MAP_W;i++){let a=h.MAP[r][i],s="#0c1220";a===1?s="#ECDE60":a===2?s="#707a88":a===3?s="#00e676":a===4?s="#996633":a===5?s="#FFE300":a===6?s=" #3561ff":a===7&&(s="#FE6660"),F.fillStyle=s,F.fillRect(2+i*t,2+r*t,t-1,t-1)}for(let r of e)r.alive&&(F.fillStyle=r.type==="demon"?"#ff6a6a":r.type==="barrel"?"#57d694":r.type==="key"?"#6aa2ff":r.type==="med"?"#f5f1c9":r.type==="ammo"?"#9cf58d":"#ffffff",F.fillRect(2+r.x*t-2,2+r.y*t-2,4,4));F.fillStyle="#e7f3ff",F.beginPath(),F.arc(2+c.x*t,2+c.y*t,2.5,0,st),F.fill();let o=Math.cos(c.a),n=Math.sin(c.a);F.strokeStyle="#78f3d3",F.beginPath(),F.moveTo(2+c.x*t,2+c.y*t),F.lineTo(2+(c.x+o*1.5)*t,2+(c.y+n*1.5)*t),F.stroke()}function Bt(e){if(!Array.isArray(e)||e.length===0)throw new Error("Array must be non-empty.");let t=I(e.length)-1;return e[t]}function I(e){if(e<=0)throw new Error("The maximum value must be greater than 0.");return Math.floor(Math.random()*e)+1}var y=null,a0=null,O=null,O0=null,St=null;function X0(){y||(y=new(window.AudioContext||window.webkitAudioContext))}function L({freq:e=440,dur:t=.1,type:o="square",vol:n=.2,slide:r=0}){if(!y)return;let i=y.createOscillator(),a=y.createGain();i.type=o,i.frequency.value=e,a.gain.value=n,i.connect(a).connect(y.destination);let s=y.currentTime;r&&(i.frequency.setValueAtTime(e,s),i.frequency.linearRampToValueAtTime(e+r,s+t)),a.gain.setValueAtTime(n,s),a.gain.exponentialRampToValueAtTime(.001,s+t),i.start(s),i.stop(s+t)}function Y0({dur:e=.2,vol:t=.2,lp:o=1200}){if(!y)return;let n=y.createBuffer(1,y.sampleRate*e,y.sampleRate),r=n.getChannelData(0);for(let l=0;l<r.length;l++)r[l]=Math.random()*2-1;let i=y.createBufferSource(),a=y.createGain(),s=y.createBiquadFilter();i.buffer=n,a.gain.value=t,s.type="lowpass",s.frequency.value=o,i.connect(s).connect(a).connect(y.destination);let d=y.currentTime;i.start(d),i.stop(d+e)}var q={shot:()=>{let e=I(50),t=-I(50);L({freq:220+e+t,dur:.05+I(3)/100,type:"square",vol:.25,slide:120}),Y0({dur:.03+I(3)/100,vol:.15,lp:800})},pickup:()=>{L({freq:880,dur:.06,type:"triangle",vol:.2}),L({freq:1180,dur:.08,type:"triangle",vol:.18})},explode:()=>{Y0({dur:1,vol:.3,lp:800}),L({freq:90,dur:.7,type:"sawtooth",vol:.12,slide:-60})},hurt:()=>{L({freq:140,dur:.12,type:"sawtooth",vol:.2,slide:-50})},killedDrone:()=>{let e=Math.random()*16-8;L({freq:320+e,dur:.26,type:"triangle",vol:.3,slide:-220}),L({freq:480+e,dur:.22,type:"sawtooth",vol:.1,slide:-260}),L({freq:90,dur:.08,type:"sine",vol:.18}),Y0({dur:.05,vol:.1,lp:1e3}),setTimeout(()=>{L({freq:170+e,dur:.07,type:"triangle",vol:.16,slide:70})},90)},door:()=>{L({freq:420,dur:.12,type:"square",vol:.15})},portal:()=>{L({freq:600,dur:.5,type:"sawtooth",vol:.2}),L({freq:400,dur:.3,type:"sawtooth",vol:.2,slide:50}),L({freq:600,dur:.5,type:"sawtooth",vol:.2})}};async function xe(e,{volume:t=.15}={}){if(y)try{if(!O0||e!==St){let n=await(await fetch(e,{cache:"force-cache"})).arrayBuffer();O0=await y.decodeAudioData(n),St=e}Et(),O=y.createBufferSource(),O.buffer=O0,O.loop=!0,a0=y.createGain(),a0.gain.value=t,O.connect(a0).connect(y.destination),O.start()}catch(o){try{Et();let n=new Audio(e);n.loop=!0,n.volume=Math.max(0,Math.min(1,t)),await n.play(),O={stop:()=>n.pause(),disconnect:()=>{}},a0=null}catch(n){}}}function Et(){try{O&&O.stop(0)}catch(e){}if(O&&O.disconnect)try{O.disconnect()}catch(e){}if(a0)try{a0.disconnect()}catch(e){}O=null,a0=null}var vt=!1;async function W0(){if(!y||O||vt)return;vt=!0,await xe("../assets/sfx/HexenST02SLowed.ogg",{volume:.12})}function Z(e,t){if(e<0||t<0||e>=h.MAP_W||t>=h.MAP_H)return!0;let o=h.MAP[t|0][e|0];return o===0||o===5?!1:o===7?!c.hasBlueKey:o!==6}function q0(e,t,o){return!!(Z(e,t)||Z(e-o,t)||Z(e+o,t)||Z(e,t-o)||Z(e,t+o))}var N0=0,Y=new Set,V0=!1,$0=0,z0=!1;function Ft(e){window.addEventListener("keydown",t=>{Y.add(t.code),X0(),W0(),t.code==="Space"&&(t.preventDefault(),At()),t.code==="KeyM"&&(t.preventDefault(),N.classList.toggle("visible"))}),window.addEventListener("keyup",t=>Y.delete(t.code)),e.addEventListener("mousedown",t=>{t.button===0&&At(),V0=!0,$0=t.clientX,X0(),W0()}),window.addEventListener("mouseup",()=>V0=!1),window.addEventListener("mousemove",t=>{if(V0){let o=t.clientX-$0;$0=t.clientX,c.a+=o*.0035}}),mt.onclick=()=>ve(),pt.onclick=()=>N.classList.toggle("visible")}function kt(e){let t=Y.has("ShiftLeft")||Y.has("ShiftRight"),o=c.speed*(t?2:1)*e,n=c.rotSpeed*e,r=Math.cos(c.a),i=Math.sin(c.a),a=-i,s=r,d=0,l=0;Y.has("ArrowLeft")&&(c.a-=n),Y.has("ArrowRight")&&(c.a+=n),Y.has("ArrowUp")&&(d+=r*o,l+=i*o),Y.has("ArrowDown")&&(d-=r*o,l-=i*o),Y.has("KeyW")&&(d+=r*o,l+=i*o),Y.has("KeyS")&&(d-=r*o,l-=i*o),Y.has("KeyA")&&(d-=a*o,l-=s*o),Y.has("KeyD")&&(d+=a*o,l+=s*o);let w=c.x+d,f=c.y+l;q0(w,c.y,T0)||(c.x=w),q0(c.x,f,T0)||(c.y=f)}function At(){let e=!1;c.ammo>0&&(c.ammo--,$(),q.shot(),e=!0);let t=E0(),o=ye(t);if(!o){e||R("No arrows. Look for quivers.");return}switch(o.type){case"drone":e?(o.alive=!1,R("Drone Squashed!"),q.killedDrone()):R("No arrows.");break;case"barrel":e&&(o.alive=!1,Me(o.x,o.y,2.5),R("Kaboom!"),q.explode());break;case"key":o.alive=!1,c.hasBlueKey=!0,q.door(),R("Realmchild Growths Destroyed! Find the exit!"),It();break;case"food":{o.alive=!1;let n=c.health>=c.maxHealth;n&&(c.maxHealth+=1),c.health=i0(c.health+w0,0,c.maxHealth),R(n?"Became Stronger.":"Health restored."),$(),q.pickup();break}case"arrows":o.alive=!1,c.ammo=Math.min(60,c.ammo+h0),$(),R(`Arrows +${h0}`),q.pickup();break;default:break}}function Rt(){for(let e of k)if(!(!e.alive||Math.hypot(e.x-c.x,e.y-c.y)>=.6))switch(e.type){case"key":e.alive=!1,c.hasBlueKey=!0,q.door(),R("Realmchild Growths Destroyed! Find the exit!"),It();break;case"food":e.alive=!1,c.health>=c.maxHealth?(R("Became Stronger"),c.maxHealth+=1,c.health=i0(c.health+w0,0,c.maxHealth)):(c.health=i0(c.health+w0,0,c.maxHealth),R(`Health +${w0}`)),$(),q.pickup();break;case"arrows":e.alive=!1,c.ammo=Math.min(60,c.ammo+h0),$(),q.pickup(),R(`Arrows +${h0}`);break;default:break}}function Tt(){if(z0)return;let e=c.x|0,t=c.y|0;h.MAP[t][e]===5&&(q.portal(),R(`You escaped! Wave ${K} cleared.`),I0(K+1),z0=!0,setTimeout(()=>{Ee(!0),z0=!1},100))}function ye(e){let o=document.getElementById("view").width>>1|0,n=J[o]||1e9,r=null,i=1e9;for(let a of k){if(!a.alive)continue;let s=v0(a,e);s&&(v>0&&s.depth>v||o>=s.drawStartX&&o<s.drawEndX&&s.depth<n+.1&&s.depth<i&&(r=a,i=s.depth))}return r}function Me(e,t,o){for(let n of k){if(!n.alive)continue;Math.hypot(n.x-e,n.y-t)<o&&(n.alive=!1)}}function x0(e=2){let t=0;for(;t++<200;){let o=(Math.random()*(h.MAP_W-2)|0)+1,n=(Math.random()*(h.MAP_H-2)|0)+1;if(h.MAP[n][o]!==0)continue;let r=o+.5-c.x,i=n+.5-c.y;if(!(Math.hypot(r,i)<e))return{x:o,y:n}}return{x:9,y:9}}function It(){let e=h.MAP_W,t=h.MAP_H;for(let o=0;o<t;o++)for(let n=0;n<e;n++)h.MAP[o][n]===7&&(h.MAP[o][n]=0)}function Pt(){let e=V.x,t=V.y;for(let o=t-1;o<=t+1;o++)for(let n=e-1;n<=e+1;n++)n===e&&o===t||(h.MAP[o][n]=7)}function Dt(e){let{barrel:t,enchantedKey:o,food:n,arrowQuiver:r,wolfIdle:i}=e;if(k.length=0,I(100)<50)for(let l=0;l<I(2)*(h.MAP_H/20|0);l++){let w=x0(1);k.push({x:w.x+.5,y:w.y+.5,img:t,type:"barrel",alive:!0,dist:0,ground:!0,scale:.5,floorBias:5})}let a=x0(4);k.push({x:a.x+.5,y:a.y+.5,img:o,type:"key",alive:!0,dist:0,ground:!0,scale:.25,floorBias:35});let s=x0(3);k.push({x:s.x+.5,y:s.y+.5,img:n,type:"food",alive:!0,dist:0,ground:!0,scale:.25,floorBias:35});for(let l=0;l<1+(K/3|0)*(h.MAP_H/20|0);l++)if(l<=1&&I(100)<50||l<1&&c.ammo<=0&&I(100)<80||I(100)<25){let w=x0(3);k.push({x:w.x+.5,y:w.y+.5,img:r,type:"arrows",alive:!0,dist:0,ground:!0,scale:.25,floorBias:35})}let d=Math.min((2+(K-1)*2)*(h.MAP_H/20|0),8);for(let l=0;l<d;l++){let w=x0(3.5);k.push({x:w.x+.5,y:w.y+.5,img:i,type:"drone",alive:!0,dist:0,vx:0,vy:0,hurtCD:0,ground:!0,scale:.5,floorBias:5})}}function $(){ft.style.width=`${c.health/c.maxHealth*100}%`,dt.style.width=`${c.ammo/60*100}%`,ut.textContent=Math.max(0,c.health),ht.textContent=c.ammo}var K0=0,U0=0,Q0=!1,Ct=!1;function R(e){let t=document.getElementById("gameLog"),o=t?.querySelector(".log-items");if(!o)return;let n=document.createElement("div");n.textContent=e,o.prepend(n),t.classList.contains("collapsed")||requestAnimationFrame(()=>{o.scrollTop=0})}function Ht(e){K0>0&&(K0-=e,K0<=0&&(wt.textContent=c.hasBlueKey?"Find the exit.":"Find the enchanted key."))}function Be(){Q0||c.health<=0&&(Q0=!0,c.speed=0,c.rotSpeed=0,U0=2,R("YOU DIED! Soul disconnecting from the node..."))}function _t(e){Q0&&(U0-=e,U0<=0&&Se())}function Se(){if(Ct)return;Ct=!0;let e=document.getElementById("game");if(e){let t=document.createElement("div");t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100vw",t.style.height="100vh",t.style.background="#ff0000",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.zIndex="999999",t.style.fontFamily='"Courier New", monospace',t.style.opacity="0",t.style.transition="opacity 2s ease-in",t.innerHTML=`
      <div style="
        background: #000;
        border: 3px solid #04650d;
        color: #20b2db;
        width: 600px;
        max-width: 90vw;
        box-shadow: 0 0 20px #04650d;
        font-family: 'Courier New', monospace;
      ">
        <div style="
          background:#000;
          color: #04650d;
          padding: 8px 15px;
          display: flex;
          justify-content: space-between;
          font-weight: bold;
          font-size: 12px;
        ">
          <span style ="color: #FFFFFF; border: 1px solid #04650d;">Death...</span>
        </div>
        <div style="padding: 20px; min-height: 200px;">
          <div style="margin-bottom: 30px;">
            <div style="text-align: center; color: #FFFFFF; font-size: 32px; margin: 8px 0;">YOU HAVE DIED</div>
          </div>
          <div style="text-align: center; margin-top: 20px;">
            <button id="returnBtn" style="
              background: #000;
              border: 2px solid #04650d;
              color: #04650d;
              padding: 12px 24px;
              font-family: 'Courier New', monospace;
              font-size: 14px;
              font-weight: bold;
              cursor: pointer;
              text-transform: uppercase;
              letter-spacing: 1px;
            ">RETURN TO TERMINAL</button>
          </div>
        </div>
      </div>
    `,document.body.appendChild(t);let o=t.querySelector("#returnBtn");if(o){let n=!1;o.addEventListener("click",r=>{r.preventDefault(),!n&&(n=!0,setTimeout(()=>{window.location.href="../index.html"},100))})}setTimeout(()=>{t.style.opacity="1"},50),e.classList.add("game-paused"),Y.clear()}}function j0(e=!1){e&&c0(),c.x=j.x,c.y=j.y,c.a=0,c.hasBlueKey=!1,h.MAP[V.y][V.x]=5,Pt(),Dt({wolfIdle:P0,barrel:D0,enchantedKey:_0,food:H0,arrowQuiver:L0}),$(),R(`Wave ${K}: Find the enchanted key.`)}function Ee(e=!1){e&&(N0>=G0.length-1?c0():(N0+=1,c0(N0))),c.x=j.x,c.y=j.y,c.a=0,c.hasBlueKey=!1,h.MAP[V.y][V.x]=5,Pt(),Dt({wolfIdle:P0,barrel:D0,enchantedKey:_0,food:H0,arrowQuiver:L0}),$(),R(`Wave ${K}: Find the enchanted key.`)}function ve(){I0(1),c0(0),j0()}function Lt(e){for(let t of k)if(t.alive)switch(t.type){case"drone":let o=c.x-t.x,n=c.y-t.y,r=Math.hypot(o,n);if(r>.3){let i=.9*e,a=o/r,s=n/r,d=t.x+a*i,l=t.y+s*i;Z(d,t.y)||(t.x=d),Z(t.x,l)||(t.y=l)}r<.6&&t.hurtCD<=0&&(c.health=Math.max(0,c.health-lt)|0,$(),R("Drone bite!"),q.hurt(),t.hurtCD=.8,Be()),t.hurtCD>0&&(t.hurtCD-=e);break;default:break}}xt();Ft(z);var C0=0;function Ae(e){let t=`FPS: ${Math.round(e)}`;m.save(),m.font="12px monospace",m.textAlign="right",m.textBaseline="top";let o=T-8,n=6,r=m.measureText(t).width+8,i=16;m.fillStyle="rgba(10, 15, 25, 0.6)",m.fillRect(o-r,n-2,r,i),m.strokeStyle="rgba(60, 80, 130, 0.9)",m.strokeRect(o-r+.5,n-2+.5,r-1,i-1),m.fillStyle="#dfe6ff",m.fillText(t,o,n),m.restore()}function c0(e=-1){let t;if(e!==-1){let o=G0[e];o&&(t=o)}else t=Bt(G0);V.x=t.exitPos.x,V.y=t.exitPos.y,j.x=t.startPos.x,j.y=t.startPos.y,c.health=c.maxHealth,h.cielingColorFront=t.cielingColorFront||"#6495ED",h.floorColorFront=t.floorColorFront||"#054213",h.cielingColorBack=t.cielingColorBack||"#6495ED",h.floorColorBack=t.floorColorBack||"#03210A",h.MAP=t.mapLayout,h.MAP_W=h.MAP[0].length,h.MAP_H=h.MAP.length,c.x=c.x=t.startPos.x,c.y=t.startPos.y}function Ce(){c0(0),j0(),c.maxHealth=6+I(6),c.health=c.maxHealth,c.ammo=5+I(5),$(),requestAnimationFrame(Yt)}function Fe(e){let t=E0();yt(e,t,h.MAP,h.MAP_W,h.MAP_H),ke(),k.sort((o,n)=>n.dist-o.dist),m.imageSmoothingEnabled=!1,Re(t),Pe()}function ke(){for(let e of k){let t=e.x-c.x,o=e.y-c.y;e.dist=t*t+o*o}}function Re(e){for(let t of k){if(!t.alive)continue;let o=v0(t,e);if(!o||v>0&&o.depth>v)continue;let n=Te(o);Ie(t,o,n)}}function Te(e){let t=1/(1+e.depth*.3);if(v>0&&e.depth>v*s0){let r=v*s0,i=Math.min(1,Math.max(0,(e.depth-r)/Math.max(1e-6,v-r)));t*=1-i*.6}let o=[1,.85,.7,.55,.4];return{quantizedShade:o.reduce((r,i)=>Math.abs(i-t)<Math.abs(r-t)?i:r,o[0])}}function Ie(e,t,o){m.save(),o.quantizedShade<.999&&(m.filter=`brightness(${o.quantizedShade})`);let n=Math.max(1,(t.width??t.drawEndX-t.drawStartX)|0),r=t.drawStartY,i=t.drawEndY-t.drawStartY,a=l=>(l-t.drawStartX)*e.img.width/n|0,s=-1,d=0;for(let l=t.drawStartX;l<=t.drawEndX;l++){let f=l>=0&&l<T&&l<t.drawEndX&&t.depth<=J[l];if(f&&s===-1&&(s=l,d=a(l)),(!f||l===t.drawEndX)&&s!==-1){let u=l,p=u-s,G=a(u);G<=d&&(G=d+1);let b=Math.min(e.img.width-d,G-d);p>0&&b>0&&i>0&&m.drawImage(e.img,d,0,b,e.img.height,s,r,p,i),s=-1}}m.restore()}function Pe(){let e=Math.round(T*.42),t=Math.round(e*(A0.height/A0.width)),o=Math.max(8,T*.02|0),n=T*.8-e-o,r=C-t-o+20;m.drawImage(A0,n,r,e,t)}var Ot=performance.now();function Yt(e){let t=Math.min(.05,(e-Ot)/1e3);Ot=e;let o=t>0?1/t:0;C0=C0?C0*.9+o*.1:o,kt(t),Lt(t),Rt(),Fe(e/1e3),N.classList.contains("visible")&&Mt(k),Tt(),Ht(t),_t(t),Ae(C0),requestAnimationFrame(Yt)}Ce();export{c0 as ChangeMapLevel};
