import{a as a0,b as ct}from"../chunks/chunk-B3G4DJQ2.js";var Qt=90*Math.PI/180,H0=Qt*.5,lt=.01,_0=.01,y=15;var u0=.95,i0=.6,A0="#101b2e",w0=5,h0=10,ft=3.33;var N=document.getElementById("view"),m=N.getContext("2d");m.imageSmoothingEnabled=!1;u0&&u0!==1&&(N.width=Math.max(1,Math.round(N.width*u0)),N.height=Math.max(1,Math.round(N.height*u0)));var A=N.width,M=N.height,_=document.getElementById("mini"),B=_.getContext("2d");B.imageSmoothingEnabled=!1;var dt=document.getElementById("hpBar"),ut=document.getElementById("ammoBar"),wt=document.getElementById("hpText"),ht=document.getElementById("ammoText"),mt=document.getElementById("msg"),pt=document.getElementById("btnReset"),Gt=document.getElementById("btnToggleMap");var s={x:3.5,y:3.5,a:0,speed:2,rotSpeed:2.6,health:6,maxHealth:6,ammo:1,hasBlueKey:!1,tenacity:20,maxTenacity:20},L0=.2,$=1,bt=1,jt=99;function Y0(e){$=Math.max(bt,Math.min(jt,e|0||bt))}function C0(){let e=Math.cos(s.a),t=Math.sin(s.a),o=-t*Math.tan(H0),n=e*Math.tan(H0),i=1/(o*t-e*n);return{dirX:e,dirY:t,planeX:o,planeY:n,invDet:i}}function n0(e=64,t=64){let o=document.createElement("canvas");return o.width=e,o.height=t,o}function z(e,t){let o=parseInt(e.slice(1),16),n=o>>16&255,i=o>>8&255,a=o&255,r=c=>a0(((c/255)**2.2+t)*255,0,255)|0;return`#${(r(n)<<16|r(i)<<8|r(a)).toString(16).padStart(6,"0")}`}function p0(e,t,o,n){let i=(o*e.width+t)*4,a=parseInt(n.slice(1),16);e.data[i]=a>>16&255,e.data[i+1]=a>>8&255,e.data[i+2]=a&255,e.data[i+3]=255}function Jt(){let e=n0(),t=e.getContext("2d",{willReadFrequently:!0}),o=e.width,n=e.height,i=t.createImageData(o,n),a=["#7a7a7a","#8a8a8a","#9a9a9a","#6a6a6a"];for(let r=0;r<n;r++)for(let c=0;c<o;c++){let f=r%16===15||c%16===15,l=(Math.sin(c*.18)+Math.cos(r*.12))*.06,u=f?"#222222":a[((c/16|0)+(r/16|0))%a.length];p0(i,c,r,z(u,l))}return t.putImageData(i,0,0),e}function Zt(){let e=n0(),t=e.getContext("2d",{willReadFrequently:!0}),o=e.width,n=e.height,i=t.createImageData(o,n);for(let a=0;a<n;a++)for(let r=0;r<o;r++){let c=r%32===0||a%16===0,f=(Math.sin(r*.12)+Math.cos(a*.17))*.07+(((r^a)&7)/128-.03),u=z(c?"#2a2a2a":"#6a6f73",f);(r*13+a*7)%97===0&&(u=z(u,-.25)),p0(i,r,a,u)}return t.putImageData(i,0,0),e}function te(){let e=n0(),t=e.getContext("2d",{willReadFrequently:!0}),o=e.width,n=e.height,i=t.createImageData(o,n);for(let a=0;a<n;a++)for(let r=0;r<o;r++){let c=Math.sin((r+a)*.18)*.1+Math.cos((r-a)*.14)*.08,f=((r^a<<1)&15)/255-.02,l=z("#2e6a2e",c+f);((r+a*2)%13===0||(r*3-a)%29===0)&&(l=z(l,-.18)),(r*5+a*7)%101===0&&(l=z(l,.18)),p0(i,r,a,l)}return t.putImageData(i,0,0),e}function gt(e="#5b4b2a"){let t=n0(),o=t.getContext("2d",{willReadFrequently:!0}),n=t.width,i=t.height,a=o.createImageData(n,i);for(let r=0;r<i;r++)for(let c=0;c<n;c++){let f=Math.sin(c*.22+Math.cos(r*.05)*.4)*.08+Math.sin(r*.07)*.02;p0(a,c,r,z(e,f))}o.putImageData(a,0,0),o.fillStyle="#3a3a3a",o.fillRect(0,18,n,4),o.fillRect(0,42,n,4),o.fillStyle="#6a6a6a";for(let r=6;r<n;r+=12)o.fillRect(r,19,2,2),o.fillRect(r,43,2,2);return o.strokeStyle="#444",o.lineWidth=2,o.beginPath(),o.arc(46,32,4,0,Math.PI*2),o.stroke(),t}function ee(){let e=n0(),t=e.getContext("2d",{willReadFrequently:!0}),o=e.width,n=e.height;t.fillStyle="#1f1f24",t.fillRect(0,0,o,n);let i=o/2,a=n/2,r=t.createRadialGradient(i,a,4,i,a,28);r.addColorStop(0,"#74CCEA"),r.addColorStop(.5,"#20B2DB"),r.addColorStop(1,"#FFE300"),t.fillStyle=r,t.beginPath(),t.arc(i,a,26,0,Math.PI*2),t.fill(),t.strokeStyle="rgba(255,255,255,0.25)";for(let c=0;c<6;c++){t.beginPath();let f=8+c*3;t.arc(i,a,f,c*.6,c*.6+Math.PI*1.2),t.stroke()}return t.strokeStyle="#3a3a3a",t.lineWidth=4,t.beginPath(),t.arc(i,a,28,0,Math.PI*2),t.stroke(),e}function oe(){let e=gt("#6a4a2a"),t=e.getContext("2d",{willReadFrequently:!0});t.fillStyle="#103b5f",t.fillRect(28,8,8,48),t.fillStyle="#74c8ff";for(let o=12;o<52;o+=8)t.fillRect(30,o,4,2);return e}function ne(){let e=n0(),t=e.getContext("2d",{willReadFrequently:!0}),o=e.width,n=e.height,i=t.createImageData(o,n),a="#00D9FF",r=5,c=.6,f=.1,l=.04,u=.5,d=.8660254,h=o*.5,b=n*.5,g=Math.min(o,n);for(let p=0;p<n;p++)for(let G=0;G<o;G++){let F=G/r,I=(G*u+p*d)/r,D=(G*u-p*d)/r,L=1-Math.abs(Math.sin(Math.PI*F)),W=1-Math.abs(Math.sin(Math.PI*I)),J=1-Math.abs(Math.sin(Math.PI*D)),Z=(L+W+J)/3,Y=1-Math.min(G,p,o-1-G,n-1-p)/(g*.5);Y<0&&(Y=0);let q=(G*13+p*17)%23/23-.5,H=Z*c+Y*f+q*l;p0(i,G,p,z(a,H))}t.putImageData(i,0,0),t.globalAlpha=.35,t.strokeStyle="#6FEAFF",t.lineWidth=1;for(let p=0;p<9;p++){t.beginPath();let G=3+p*Math.floor(n/10);t.moveTo(2,G);for(let F=2;F<o-2;F+=6){let I=G+Math.sin((F+p*7)*.35)*2.5+Math.sin((F*.5-p*9)*.12)*1.5;t.lineTo(F,I)}t.stroke()}return e}var re=[null,Jt(),Zt(),te(),gt(),ee(),oe(),ne()],K=[...re];function xt(e){let o=e.getContext("2d").getImageData(0,0,e.width,e.height),n=[];for(let i=0;i<e.width;i++){let a=new Uint8ClampedArray(e.height*4);for(let r=0;r<e.height;r++){let c=(r*e.width+i)*4,f=r*4;a[f]=o.data[c],a[f+1]=o.data[c+1],a[f+2]=o.data[c+2],a[f+3]=o.data[c+3]}n.push({data:a,h:e.height})}return{cols:n,w:e.width,h:e.height}}var m0=K.map(e=>e?xt(e):null);function ae(){m0.length=0,K.forEach(e=>{m0.push(e?xt(e):null)})}async function ie(e){let t=`../assets/gfx/${e}`;return new Promise((o,n)=>{let i=new Image;i.onload=()=>{let a=n0(64,64),r=a.getContext("2d",{willReadFrequently:!0});r.imageSmoothingEnabled=!1,r.drawImage(i,0,0,64,64),o(a)},i.onerror=()=>n(new Error(`Failed to load texture: ${t}`)),i.src=t})}async function yt(){try{await se([{index:1,image:"OfficeWall.png"}]),ae()}catch(e){console.warn("Failed to init backrooms wallpaper:",e)}}async function se(e){if(!Array.isArray(e)){console.warn("Expected an array of { index, image } objects. In loadImagesToReplaceTextures");return}let t=e.map(async(o,n)=>{let{index:i,image:a}=o||{};try{let r=await ie(a);i&&i>=0&&i<K.length?K[i]=r:K.push(r)}catch(r){console.warn(`Failed to load texture "${a}" for index ${i} and dont support replacing with cool gmod missing texture:`,r)}});await Promise.all(t)}var O={x:10,y:8},U={x:3.5,y:3.5},w={MAP:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,2,6,2,0,0,0,0,0,0,0,2,6,2,0,0,1],[1,0,0,0,2,0,2,0,0,0,0,0,0,0,2,0,2,0,0,1],[1,0,0,0,2,2,2,0,0,0,0,0,0,0,2,2,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,5,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,3,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,3,3,1,3,3,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,0,0,0,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,2,2,2,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,1,0,2,0,2,0,1,0,3,0,0,0,1],[1,0,0,0,0,0,0,0,0,2,6,2,0,0,0,0,0,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],MAP_W:-1,MAP_H:-1,cielingColorFront:"",floorColorFront:"",cielingColorBack:"",floorColorBack:""},G0=[{name:"Village",mapLayout:[[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,1,1,1,1,1,1,6,6,1,1,1,1,1,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3]],exitPos:{x:10,y:12},startPos:{x:9.5,y:1.5}},{name:"TowerFloor1",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,1,1,1,1,1,0,0,1,1,1,1,1,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,3,3,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,3,3,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,1,6,6,1,1,0,0,1,1,6,6,1,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,1,1,1,1,1,6,6,1,1,1,1,1,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,1,1,1,1,1,1,0,0,0,1,0,0,1],[1,0,0,1,1,1,1,1,0,0,0,0,1,1,1,1,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,4,4,1,1,1,1,1,1,1,1,1]],exitPos:{x:10,y:17},startPos:{x:5.5,y:4.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#000000",floorColorBack:"#000000"},{name:"Gallery",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,4,4,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,0,0,0,3,1],[1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,3,1,0,0,0,0,0,1],[1,1,0,0,0,7,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,2,0,0,1],[1,1,1,7,1,1,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0,0,2,0,0,1],[1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,0,0,2,0,0,1],[1,1,0,0,0,3,0,0,0,0,0,3,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,3,0,0,0,0,0,3,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,3,0,0,0,0,0,3,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,3,0,0,0,0,0,3,0,0,0,1,0,0,2,0,0,1],[1,1,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,0,0,2,0,0,1],[1,0,2,2,2,2,2,2,2,2,2,0,1,0,1,0,1,0,1,0,0,2,0,0,1],[4,0,2,2,2,2,2,2,2,2,2,0,6,0,6,0,6,0,6,0,0,2,0,0,1],[1,0,2,2,2,2,2,2,2,2,2,0,1,0,1,0,1,0,1,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,3,0,0,0,3,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],exitPos:{x:3,y:3},startPos:{x:1.5,y:21.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#ECDE60",floorColorBack:"#000000"},{name:"LongHallways",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,1,0,0,0,0,0,0,3,3,3,3,3,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,1,0,0,0,0,0,3,3,3,3,3,3,3,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,3,3,3,0,0,0,3,3,3,0,0,0,0,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,3,3,3,3,0,4,0,3,3,3,3,0,0,0,1,1,1],[1,7,7,1,1,6,1,1,1,6,1,1,1,6,1,1,1,6,1,1,0,0,3,3,3,3,3,0,0,0,3,3,3,3,3,0,0,1,1,1],[1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,0,1],[1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,6,0,1],[1,7,7,1,1,6,1,1,1,1,1,1,1,1,1,1,1,6,1,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,0,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,2,2,0,2,2,2,2,6,2,2,2,2,0,2,2,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,3,0,0,0,0,0,3,2,0,0,0,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,0,3,3,3,3,3,0,3,3,3,3,3,0,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,1,0,0,0,0,3,3,3,3,0,3,3,3,3,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,2,3,0,0,0,0,0,3,2,0,0,0,1,0,0,0,0,0,3,3,3,0,3,3,3,0,0,0,0,0,1,1,1],[1,7,7,1,2,2,0,2,2,2,2,6,2,2,2,2,0,2,2,1,0,0,0,0,0,0,3,3,0,3,3,0,0,0,0,0,0,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,1,1,1,1,1,1,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1],[1,7,7,1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,1,1,1],[1,7,7,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1],[1,7,7,1,0,0,6,0,3,3,3,3,3,3,3,3,3,3,3,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,1,1,1],[1,7,7,1,0,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,3,3,3,3,3,3,3,3,3,3,3,0,4,0,0,1,1,1],[1,7,7,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1],[1,7,7,1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,1,1,1],[1,7,7,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7,0,0,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,1,1],[1,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],exitPos:{x:1,y:1},startPos:{x:9.5,y:3.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#000000",floorColorBack:"#000000"}];var Q=new Float32Array(A);function ce(e,t,o,n,i,a,r,c,f){let l=n-o;if(l<=0)return;e.save(),e.imageSmoothingEnabled=!1;let u=c||0,d=u<0?0:u>i.height?i.height:u,h=f||i.height,b=i.height-d,g=h<0?0:h>b?b:h;if(e.drawImage(i,a,d,1,g,t,o,1,l),r<.999){let G=(r<0?0:r)*255|0;e.globalCompositeOperation="multiply",e.fillStyle=`rgb(${G},${G},${G})`,e.fillRect(t,o,1,l)}e.restore()}var b0=M>>1;function Mt(e,t,o,n,i){let{dirX:a,dirY:r,planeX:c,planeY:f}=t,l=m.createLinearGradient(0,0,0,b0);l.addColorStop(0,w.cielingColorFront||"#6495ED"),w.cielingColorBack&&l.addColorStop(.5,w.cielingColorBack||"#6495ED"),l.addColorStop(.9,A0),m.fillStyle=l,m.fillRect(0,0,A,b0);let u=m.createLinearGradient(0,M,0,b0);u.addColorStop(0,w.floorColorFront||"#054213"),u.addColorStop(.85,w.floorColorBack||"#03210A"),u.addColorStop(.95,A0),m.fillStyle=u,m.fillRect(0,b0,A,b0);let d=m.createLinearGradient(0,0,0,M);d.addColorStop(0,"rgba(16,27,46,0.08)"),d.addColorStop(.5,"rgba(16,27,46,0.16)"),d.addColorStop(1,"rgba(16,27,46,0.20)"),m.save(),m.fillStyle=d,m.fillRect(0,0,A,M),m.restore();for(let h=0;h<A;h++){let b=2*(h+.5)/A-1,g=a+c*b,p=r+f*b;if(g<1e-8&&g>-1e-8&&p<1e-8&&p>-1e-8){Q[h]=Number.POSITIVE_INFINITY;continue}let G=1/(g||1e-9),F=1/(p||1e-9),I=s.x|0,D=s.y|0,L=G<0?-G:G,W=F<0?-F:F,J,Z,Y,q;g<0?(J=-1,Y=(s.x-I)*L):(J=1,Y=(I+1-s.x)*L),p<0?(Z=-1,q=(s.y-D)*W):(Z=1,q=(D+1-s.y)*W);let H=0,V=1,M0=!1,Wt=0,Nt=0;for(;!M0&&Wt++<256;){if(Y<q?(Y+=L,I+=J,H=0):(q+=W,D+=Z,H=1),y>0){let E0=Math.min(Y,q);if(E0>y){M0=!1,V=0,Nt=E0;break}}if(I<0||D<0||I>=n||D>=i){M0=!0,V=1;break}let d0=o[D][I];if(d0>0){M0=!0,V=d0;break}}if(V===0){Q[h]=Number.POSITIVE_INFINITY;continue}let v;H===0?v=Y-L:v=q-W,v=Math.max(lt,v);let Z0=0,qt=H===0?J:0,Vt=H===1?Z:0,tt=Math.abs(qt*a+Vt*r)>=.9&&Math.abs(b)<=.9&&v<Z0?Z0:v,et=s.x+tt*g,ot=s.y+tt*p,t0;H===0?t0=ot-(ot|0):t0=et-(et|0),t0=t0<0?0:t0>.999999?.999999:t0+1e-6;let nt=m0[V]||m0[4],l0=K[V],B0=l0?l0.width|0:nt.w|0,e0=t0*B0|0;(H===0&&J>0||H===1&&Z<0)&&(e0=B0-e0-1),e0=e0<0?0:e0>=B0?B0-1:e0;let $t=v<_0?_0:v,S0=M/$t|0,D0=(M-S0)/2|0,zt=D0+S0,o0=D0,f0=zt;o0<0&&(o0=0),f0>M&&(f0=M);let rt=f0-o0;if(rt<=0){Q[h]=v;continue}let at=(l0?l0.height:nt.h||K[V]?.height||64)|0,Kt=(o0-D0)*(at/Math.max(1,S0)),Ut=rt*(at/Math.max(1,S0)),it=1/(1+v*.25)*(H?.5:1);if(V===7&&(it*=.8+.2*Math.sin(e*6+h*.05)),ce(m,h,o0,f0,l0,e0,it,Kt,Ut),y>0&&v>y*i0){let d0=y*i0,E0=y,st=Math.min(1,Math.max(0,(v-d0)/Math.max(1e-6,E0-d0)));st>0&&(m.save(),m.globalAlpha=st*.85,m.fillStyle=A0,m.fillRect(h,o0,1,f0-o0),m.restore())}Q[h]=v}}function le(e){return M/e}function fe(e,t,o){let{dirY:n,dirX:i,planeY:a,planeX:r,invDet:c}=o,f=c*(n*e-i*t),l=c*(-a*e+r*t);return{transX:f,transY:l}}function de(e,t){return Math.round((A>>1)*(1+e/t))}function ue(e,t=0,o=.5){let n=t*100,r=(M>>1)+(e>>1)+(n|0),c=r-e;return c<0&&(c=0),{startY:c,endY:r}}function we(e){let o=(M>>1)-(e>>1);o<0&&(o=0);let n=o+e;return{startY:o,endY:n}}function F0(e,t){let o=e.x-s.x,n=e.y-s.y,{transX:i,transY:a}=fe(o,n,t);if(a<=.01)return null;let r=de(i,a),c=e&&typeof e.scale=="number"?e.scale:e&&e.img&&typeof e.img.scale=="number"?e.img.scale:1,f=le(a)*c,l=typeof e._hR=="number"?e._hR:Math.round(f),u=.1,d=l;(f>l+u||f<l-u)&&(d=Math.round(f)),e._hR=d;let h=d,b=e.img,g=b&&b.width&&b.height?b.width/b.height:1,p=Math.max(1,Math.round(h*g)),G=h/M,F=(e.floorBias??0)*c*G,I=Math.min(.9,Math.max(.2,c)),D=e.ground?ue(h,F,I):we(h),L=Math.round(r-(p>>1)),W=L+p;return{drawStartX:L,drawEndX:W,drawStartY:D.startY,drawEndY:D.endY,depth:a,size:h,width:W-L}}function g0(e,t,o=1){let n=e.trim().split(`
`).map(d=>d.replace(/\s+/g,"")),i=n.length-1;for(;i>=0&&n[i].split("").every(d=>d===".");)i--;i>=0&&i<n.length-1&&(n=n.slice(0,i+1));let a=n.length,r=n[0].length,c=1,f=document.createElement("canvas");f.width=r,f.height=a;let l=f.getContext("2d");l.imageSmoothingEnabled=!1;let u=l.createImageData(r,a);for(let d=0;d<a;d++)for(let h=0;h<r;h++){let b=n[d][h],g=(d*r+h)*4;if(b==="."){u.data[g+3]=0;continue}let p=t[b]||"#ffffff",G=parseInt(p.slice(1),16);u.data[g]=G>>16&255,u.data[g+1]=G>>8&255,u.data[g+2]=G&255,u.data[g+3]=255}if(l.putImageData(u,0,0),o!==1){let d=document.createElement("canvas");d.width=r*o,d.height=a*o;let h=d.getContext("2d");return h.imageSmoothingEnabled=!1,h.drawImage(f,0,0,d.width,d.height),d.baseline=c,d.scale=o,d}return f.baseline=c,f.scale=1,f}async function he(e,t){return await me(e,t,1)}async function me(e,t=1,o=1){let n=`../assets/gfx/${e}`;return new Promise((i,a)=>{let r=new Image;r.onload=()=>{let c=document.createElement("canvas"),f=r.width,l=r.height;c.width=f*t,c.height=l*t;let u=c.getContext("2d");u.imageSmoothingEnabled=!1,u.drawImage(r,0,0,c.width,c.height),c.baseline=o,c.scale=t,i(c)},r.onerror=()=>a(new Error(`Failed to load sprite: ${n}`)),r.src=n})}var s0,x0,v0,T0,R0,k0;async function Bt(){x0=x0=g0(`
  ................................
  ..............BB..BB............
  .............BbbbbbbB...........
  ...........BbbbGGGGbbbB.........
  ..........BbbbGGGGGGbbbB........
  .........BbbGGGGGGGGGGbbB.......
  ........BbbGGGgGGGGgGGbbB.......
  ........BbbGGgGyyGgGGGbbB.......
  .......BbbGGGGGGGGGGGGbbB.......
  .......BbbGGGGGGGGGGGGbbB.......
  ......BbbGGGGGGGGGGGGGGbbB......
  ......BbbGGGGgGGGGgGGGGbbB......
  ......BbbGGGGwwwwwwGGGGbbB......
  .....BbbGGGwwwWWkWWwwwGGbbB.....
  .....BbbGGGwwwwkkwwwwGGbbB......
  .....BbbGGGwwwwrwwwwGGGbbB......
  .....BbbGGGwwwwwwwwwGGGbbB......
  .....BbbGGGGwwwwwwwGGGGbbB......
  .....BbbGGGGGGGGGGGGGGGbbB......
  .....BbbGGGGGGGGGGGGGGGbbB......
  ......BbbGGGGGGGGGGGGGbbB.......
  ......BbbGGGGGGGGGGGGGbbB.......
  .......BBbbbgggGGGGgggbbBB......
  ........BBBbbbbbbbbbbbbBBB......
  ................................
  `,{B:"#2c1810",b:"#5c3d2e",g:"#7a6b5c",G:"#a89080",k:"#080508",w:"#e8e0d5",W:"#f5f0e8",r:"#8b4513",y:"#ffeb9c"},4),k0=g0(`
  ............
  ....bbbb....
  ..bbGGGGbb..
  .bGGGGGGGGb.
  .bGGgGGgGGb.
  .bGGGGGGGGb.
  .bGgGGGGgGb.
  .bGGGGGGGGb.
  .bGGgGGgGGb.
  .bGGGGGGGGb.
  .bGgGGGGgGb.
  .bGGGGGGGGb.
  .bGGgGGgGGb.
  .bGGGGGGGGb.
  .bGGgGGgGGb.
  .bGGGGGGGGb.
  ..bbGGGGbb..
  ....bbbb....
  ............
  ............
  `,{k:"#0a0f10",g:"#1b5c3a",G:"#2e874f",s:"#7fffd4",b:"#0e1620"},3),T0=g0(`
  ................
  .....B....B.....
  ....BBBBBBBB....
  ...BBbBBbBBB....
  ...BBbgBgbBB....
  ....BBgggBB.....
  .....kGGGk......
  ....kGGsGGk.....
  ...kGGGGGGGk....
  ...kGGGGGGGk....
  ....kGGGGGk.....
  .....kGGGk......
  .......GG.......
  .......GG.......
  .....GGGGGG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GGggGG.....
  `,{k:"#5a4500",g:"#FFD700",G:"#FFA500",s:"#FFF5CC",b:"#4169E1",B:"#87CEEB"},4),v0=g0(`
  ............r...
  ............rr..
  ...........w..r.
  .......sb.w...rr
  .......bdw...w..
  .......sfd..w...
  ......sfffdw....
  .....sfffffdb...
  ....sfbffffss...
  ...sfbfbffs.....
  ..sfbfbfbs......
  .sfbfbfbs.......
  .sffbfbs........
  ..sffbs.........
  ...sss..........
  ................
  `,{b:"#100904",d:"#8f715b",f:"#5a3b1a",r:"#DC143C",s:"#000000",w:"#4d260a"},3),s0=s0=g0(`
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ........................................................w.......
  ......................................................sww.......
  ..................................................wwwwws........
  ...............................................wwwwwwww.s.......
  ..............................................wwwwww....s.......
  ...........................................wwwwwww......s.......
  ...........................................wwwww........s.......
  ..........................................wwwww..........s......
  .........................................wwwww...........s......
  ........................................wwwwww...........s......
  ........................................wwwww............s......
  .......................................wwwww.............s......
  .......................................wwwww.............s......
  .......................................wwww...............s.....
  ......................................wwwww...............s.....
  ......................................wwww................s.....
  .....................................wwwww................s.....
  .....................................wwwww................s.....
  .....................................wwww.................s.....
  .....................................wwww.................s.....
  ....................................wwwww.................s.....
  ....................................wwww..................s.....
  ....................................wwww..................s.....
  ..............................ssss.wwwww..................s.....
  ..............................sss..wwww...................s.....
  ..............................s.bb.wwww....................s....
  ..............................s..bbwwww....................s....
  ..................................bwwww....................s....
  ..................................bbwww....................s....
  ...................................bbww....................s....
  ..................................wwbbww...................s....
  ..................................wwwbbb....................s...
  ..................................wwwwwbb...................s...
  ...................................wwwwwbb..................s...
  ....................................wwww.bb.................s...
  ....................................wwww..bbb...............s...
  ....................................wwww....bb..............s...
  ....................................wwww.....bb..............s..
  ....................................wwww......bb.............s..
  ...................................wwwww.......bb............s..
  ..................................wwwwww........bbb..........s..
  ..................................wwwwww.........bbb.........ss.
  ..................................wwwwww...........bbrrrrr....s.
  ..................................wwwwww...........fbbbrrrr...s.
  ...................................wwwww...........ffffbbrrr..s.
  ...................................wwwwww...........ffffbbrrr.s.
  ...................................wwwwww...........ffffffbb.ss.
  ...................................wwwwww.............ffff.bbbs.
  ...................................wwwwwww..............ff...bs.
  `,{b:"#5a3b1a",f:"#B8860B",r:"#DC143C",s:"#C0C0C0",w:"#8B4513"},3),R0=await he("apple.png",3)}var S=[];function St(e){B.clearRect(0,0,_.width,_.height);let t=6,o=20,n=2,i=Math.floor(o/2),a=Math.max(0,Math.min((s.x|0)-i,w.MAP_W-o)),r=Math.max(0,Math.min((s.y|0)-i,w.MAP_H-o));_.width=n+o*t+n,_.height=n+o*t+n;for(let d=0;d<o;d++)for(let h=0;h<o;h++){let b=r+d,g=a+h,p=w.MAP[b]?.[g]??0,G="#0c1220";p===1?G="#ECDE60":p===2?G="#707a88":p===3?G="#00e676":p===4?G="#996633":p===5?G="#FFE300":p===6?G=" #3561ff":p===7&&(G="#00FFFF"),B.fillStyle=G,B.fillRect(n+h*t,n+d*t,t-1,t-1)}for(let d of e){if(!d.alive)continue;let h=n+(d.x-a)*t,b=n+(d.y-r)*t;B.fillStyle=d.type==="entity"?"#ffeb9c":d.type==="barrel"?"#57d694":d.type==="key"?"#6aa2ff":d.type==="food"?"#7fffd4":d.type==="arrows"?"#DC143C":"#ffffff",B.fillRect(h-2,b-2,4,4)}let c=n+(s.x-a)*t,f=n+(s.y-r)*t;B.fillStyle="#e7f3ff",B.beginPath(),B.arc(c,f,2.5,0,ct),B.fill();let l=Math.cos(s.a),u=Math.sin(s.a);B.strokeStyle="#78f3d3",B.beginPath(),B.moveTo(c,f),B.lineTo(c+l*1.5*t,f+u*1.5*t),B.stroke()}function I0(e){if(!Array.isArray(e)||e.length===0)throw new Error("Array must be non-empty.");let t=C(e.length)-1;return e[t]}function C(e){if(e<=0)throw new Error("The maximum value must be greater than 0.");return Math.floor(Math.random()*e)+1}var x=null,r0=null,R=null,O0=null,Et=null;function W0(){x||(x=new(window.AudioContext||window.webkitAudioContext))}function T({freq:e=440,dur:t=.1,type:o="square",vol:n=.2,slide:i=0}){if(!x)return;let a=x.createOscillator(),r=x.createGain();a.type=o,a.frequency.value=e,r.gain.value=n,a.connect(r).connect(x.destination);let c=x.currentTime;i&&(a.frequency.setValueAtTime(e,c),a.frequency.linearRampToValueAtTime(e+i,c+t)),r.gain.setValueAtTime(n,c),r.gain.exponentialRampToValueAtTime(.001,c+t),a.start(c),a.stop(c+t)}function X0({dur:e=.2,vol:t=.2,lp:o=1200}){if(!x)return;let n=x.createBuffer(1,x.sampleRate*e,x.sampleRate),i=n.getChannelData(0);for(let l=0;l<i.length;l++)i[l]=Math.random()*2-1;let a=x.createBufferSource(),r=x.createGain(),c=x.createBiquadFilter();a.buffer=n,r.gain.value=t,c.type="lowpass",c.frequency.value=o,a.connect(c).connect(r).connect(x.destination);let f=x.currentTime;a.start(f),a.stop(f+e)}var P={shot:()=>{let e=C(50),t=-C(50);T({freq:220+e+t,dur:.05+C(3)/100,type:"square",vol:.25,slide:120}),X0({dur:.03+C(3)/100,vol:.15,lp:800})},pickup:()=>{T({freq:880,dur:.06,type:"triangle",vol:.2}),T({freq:1180,dur:.08,type:"triangle",vol:.18})},explode:()=>{X0({dur:1,vol:.3,lp:800}),T({freq:90,dur:.7,type:"sawtooth",vol:.12,slide:-60})},hurt:()=>{T({freq:140,dur:.12,type:"sawtooth",vol:.2,slide:-50})},killedEntity:()=>{let e=Math.random()*16-8;T({freq:320+e,dur:.26,type:"triangle",vol:.3,slide:-220}),T({freq:480+e,dur:.22,type:"sawtooth",vol:.1,slide:-260}),T({freq:90,dur:.08,type:"sine",vol:.18}),X0({dur:.05,vol:.1,lp:1e3}),setTimeout(()=>{T({freq:170+e,dur:.07,type:"triangle",vol:.16,slide:70})},90)},door:()=>{T({freq:420,dur:.12,type:"square",vol:.15})},portal:()=>{T({freq:600,dur:.5,type:"sawtooth",vol:.2}),T({freq:400,dur:.3,type:"sawtooth",vol:.2,slide:50}),T({freq:600,dur:.5,type:"sawtooth",vol:.2})}};async function pe(e,{volume:t=.15}={}){if(x)try{if(!O0||e!==Et){let n=await(await fetch(e,{cache:"force-cache"})).arrayBuffer();O0=await x.decodeAudioData(n),Et=e}At(),R=x.createBufferSource(),R.buffer=O0,R.loop=!0,r0=x.createGain(),r0.gain.value=t,R.connect(r0).connect(x.destination),R.start()}catch(o){try{At();let n=new Audio(e);n.loop=!0,n.volume=Math.max(0,Math.min(1,t)),await n.play(),R={stop:()=>n.pause(),disconnect:()=>{}},r0=null}catch(n){}}}function At(){try{R&&R.stop(0)}catch(e){}if(R&&R.disconnect)try{R.disconnect()}catch(e){}if(r0)try{r0.disconnect()}catch(e){}R=null,r0=null}var Ct=!1;async function N0(){if(!x||R||Ct)return;Ct=!0,await pe("../assets/sfx/HexenST02SLowed.ogg",{volume:.12})}function j(e,t){if(e<0||t<0||e>=w.MAP_W||t>=w.MAP_H)return!0;let o=w.MAP[t|0][e|0];return o===0||o===5?!1:o===7?!s.hasBlueKey:o!==6}function q0(e,t,o){return!!(j(e,t)||j(e-o,t)||j(e+o,t)||j(e,t-o)||j(e,t+o))}var V0=0,k=new Set,$0=!1,z0=0,K0=!1;function Tt(e){window.addEventListener("keydown",t=>{k.add(t.code),W0(),N0(),t.code==="Space"&&(t.preventDefault(),Ft()),t.code==="KeyM"&&(t.preventDefault(),_.classList.toggle("visible"))}),window.addEventListener("keyup",t=>k.delete(t.code)),e.addEventListener("mousedown",t=>{t.button===0&&Ft(),$0=!0,z0=t.clientX,W0(),N0()}),window.addEventListener("mouseup",()=>$0=!1),window.addEventListener("mousemove",t=>{if($0){let o=t.clientX-z0;z0=t.clientX,s.a+=o*.0035}}),pt.onclick=()=>Me(),Gt.onclick=()=>_.classList.toggle("visible")}function Rt(e){let t=k.has("ShiftLeft")||k.has("ShiftRight"),o=s.speed*(t?2:1)*e,n=s.rotSpeed*e,i=Math.cos(s.a),a=Math.sin(s.a),r=-a,c=i,f=0,l=0;k.has("ArrowLeft")&&(s.a-=n),k.has("ArrowRight")&&(s.a+=n),(k.has("ArrowUp")||k.has("KeyW"))&&(f+=i*o,l+=a*o),(k.has("ArrowDown")||k.has("KeyS"))&&(f-=i*o,l-=a*o),k.has("KeyA")&&(f-=r*o,l-=c*o),k.has("KeyD")&&(f+=r*o,l+=c*o);let u=s.x+f,d=s.y+l;q0(u,s.y,L0)||(s.x=u),q0(s.x,d,L0)||(s.y=d)}function Ft(){let e=!1;s.ammo>0&&(s.ammo--,X(),P.shot(),e=!0);let t=C0(),o=Ge(t);if(!o){e||E("No arrows. Look for quivers.");return}switch(o.type){case"entity":e?(o.alive=!1,E(I0(["Entity murdered!","Entity destroyed!","Entity purged!"])),P.killedEntity()):E("No arrows.");break;case"barrel":e&&(o.alive=!1,be(o.x,o.y,2.5),E("Kaboom!"),P.explode());break;case"key":o.alive=!1,s.hasBlueKey=!0,P.door(),E("Keycard found! Find the exit!"),Pt();break;case"food":{o.alive=!1;let n=s.health>=s.maxHealth;n&&(s.maxHealth+=1),s.health=a0(s.health+h0,0,s.maxHealth),E(n?"Ranger Became Stronger.":"Health restored."),X(),P.pickup();break}case"arrows":o.alive=!1,s.ammo=Math.min(60,s.ammo+w0),X(),E(`Arrows +${w0}`),P.pickup();break;default:break}}function kt(){for(let e of S)if(!(!e.alive||Math.hypot(e.x-s.x,e.y-s.y)>=.6))switch(e.type){case"key":e.alive=!1,s.hasBlueKey=!0,P.door(),E("Keycard found! Find the exit!"),Pt();break;case"food":e.alive=!1,s.health>=s.maxHealth?(E("Ranger Became Stronger"),s.maxHealth+=1,s.health=a0(s.health+h0,0,s.maxHealth)):(s.health=a0(s.health+h0,0,s.maxHealth),E(`Health +${h0}`)),X(),P.pickup();break;case"arrows":e.alive=!1,s.ammo=Math.min(60,s.ammo+w0),X(),P.pickup(),E(`Arrows +${w0}`);break;default:break}}function It(){if(K0)return;let e=s.x|0,t=s.y|0;w.MAP[t][e]===5&&(P.portal(),E(`Floor ${$} cleared.`),Y0($+1),K0=!0,setTimeout(()=>{ye(!0),K0=!1},100))}function Ge(e){let o=document.getElementById("view").width>>1|0,n=Q[o]||1e9,i=null,a=1e9;for(let r of S){if(!r.alive)continue;let c=F0(r,e);c&&(y>0&&c.depth>y||o>=c.drawStartX&&o<c.drawEndX&&c.depth<n+.1&&c.depth<a&&(i=r,a=c.depth))}return i}function be(e,t,o){for(let n of S){if(!n.alive)continue;Math.hypot(n.x-e,n.y-t)<o&&(n.alive=!1)}}function y0(e=2){let t=0;for(;t++<200;){let o=(Math.random()*(w.MAP_W-2)|0)+1,n=(Math.random()*(w.MAP_H-2)|0)+1;if(w.MAP[n][o]!==0)continue;let i=o+.5-s.x,a=n+.5-s.y;if(!(Math.hypot(i,a)<e))return{x:o,y:n}}return{x:9,y:9}}function Pt(){let e=w.MAP_W,t=w.MAP_H;for(let o=0;o<t;o++)for(let n=0;n<e;n++)w.MAP[o][n]===7&&(w.MAP[o][n]=0)}function Dt(){let e=O.x,t=O.y;for(let o=t-1;o<=t+1;o++)for(let n=e-1;n<=e+1;n++)n===e&&o===t||(w.MAP[o][n]=7)}function Ht(e){let{barrel:t,enchantedKey:o,food:n,arrowQuiver:i,wolfIdle:a}=e;if(S.length=0,C(100)<50)for(let l=0;l<C(2)*(w.MAP_H/20|0);l++){let u=y0(1);S.push({x:u.x+.5,y:u.y+.5,img:t,type:"barrel",alive:!0,dist:0,ground:!0,scale:.5,floorBias:5})}let r=y0(4);S.push({x:r.x+.5,y:r.y+.5,img:o,type:"key",alive:!0,dist:0,ground:!0,scale:.25,floorBias:35});let c=y0(3);S.push({x:c.x+.5,y:c.y+.5,img:n,type:"food",alive:!0,dist:0,ground:!0,scale:.25,floorBias:35});for(let l=0;l<1+($/3|0)*(w.MAP_H/20|0);l++)if(l<=1&&C(100)<50||l<1&&s.ammo<=0&&C(100)<80||C(100)<25){let u=y0(3);S.push({x:u.x+.5,y:u.y+.5,img:i,type:"arrows",alive:!0,dist:0,ground:!0,scale:.25,floorBias:35})}let f=Math.min((2+($-1)*2)*(w.MAP_H/20|0),8);for(let l=0;l<f;l++){let u=y0(3.5);S.push({x:u.x+.5,y:u.y+.5,img:a,type:"entity",alive:!0,dist:0,vx:0,vy:0,hurtCD:0,ground:!0,scale:.5,floorBias:5})}}function X(){dt.style.width=`${s.health/s.maxHealth*100}%`,ut.style.width=`${s.ammo/60*100}%`,wt.textContent=Math.max(0,s.health),ht.textContent=s.ammo}var U0=0,Q0=0,j0=!1,vt=!1;function E(e){let t=document.getElementById("gameLog"),o=t?.querySelector(".log-items");if(!o)return;let n=document.createElement("div");n.textContent=e,o.prepend(n),t.classList.contains("collapsed")||requestAnimationFrame(()=>{o.scrollTop=0})}function _t(e){U0>0&&(U0-=e,U0<=0&&(mt.textContent=s.hasBlueKey?"Find the exit.":"Find the enchanted key."))}function ge(){j0||s.health<=0&&(j0=!0,s.speed=0,s.rotSpeed=0,Q0=2,E("YOU DIED! Soul disconnecting from the node..."))}function Lt(e){j0&&(Q0-=e,Q0<=0&&xe())}function xe(){if(vt)return;vt=!0;let e=document.getElementById("game");if(e){let t=document.createElement("div");t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100vw",t.style.height="100vh",t.style.background="#ff0000",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.zIndex="999999",t.style.fontFamily='"Courier New", monospace',t.style.opacity="0",t.style.transition="opacity 2s ease-in",t.innerHTML=`
      <div style="
        background: #000;
        border: 3px solid #04650d;
        color: #20b2db;
        width: 600px;
        max-width: 90vw;
        box-shadow: 0 0 20px #04650d;
        font-family: 'Courier New', monospace;
      ">
        <div style="
          background:#000;
          color: #04650d;
          padding: 8px 15px;
          display: flex;
          justify-content: space-between;
          font-weight: bold;
          font-size: 12px;
        ">
          <span style ="color: #FFFFFF; border: 1px solid #04650d;">Death...</span>
        </div>
        <div style="padding: 20px; min-height: 200px;">
          <div style="margin-bottom: 30px;">
            <div style="text-align: center; color: #FFFFFF; font-size: 32px; margin: 8px 0;">YOU HAVE DIED</div>
          </div>
          <div style="text-align: center; margin-top: 20px;">
            <button id="returnBtn" style="
              background: #000;
              border: 2px solid #04650d;
              color: #04650d;
              padding: 12px 24px;
              font-family: 'Courier New', monospace;
              font-size: 14px;
              font-weight: bold;
              cursor: pointer;
              text-transform: uppercase;
              letter-spacing: 1px;
            ">RETURN TO TERMINAL</button>
          </div>
        </div>
      </div>
    `,document.body.appendChild(t);let o=t.querySelector("#returnBtn");if(o){let n=!1;o.addEventListener("click",i=>{i.preventDefault(),!n&&(n=!0,setTimeout(()=>{window.location.href="../index.html"},100))})}setTimeout(()=>{t.style.opacity="1"},50),e.classList.add("game-paused"),k.clear()}}function J0(e=!1){e&&c0(),s.x=U.x,s.y=U.y,s.a=0,s.hasBlueKey=!1,w.MAP[O.y][O.x]=5,Dt(),Ht({wolfIdle:x0,barrel:k0,enchantedKey:T0,food:R0,arrowQuiver:v0}),X(),E(`Floor ${$}: Find the keycard.`)}function ye(e=!1){e&&(V0>=G0.length-1?c0():(V0+=1,c0(V0))),s.x=U.x,s.y=U.y,s.a=0,s.hasBlueKey=!1,w.MAP[O.y][O.x]=5,Dt(),Ht({wolfIdle:x0,barrel:k0,enchantedKey:T0,food:R0,arrowQuiver:v0}),X(),E(`Floor ${$}: Find the keycard.`)}function Me(){Y0(1),c0(0),J0()}function Yt(e){for(let t of S)if(t.alive)switch(t.type){case"entity":let o=s.x-t.x,n=s.y-t.y,i=Math.hypot(o,n);if(i>.3){let a=.9*e,r=o/i,c=n/i,f=t.x+r*a,l=t.y+c*a;j(f,t.y)||(t.x=f),j(t.x,l)||(t.y=l)}i<.6&&t.hurtCD<=0&&(s.health=Math.max(0,s.health-ft)|0,X(),E("Entity attacks!"),P.hurt(),t.hurtCD=.8,ge()),t.hurtCD>0&&(t.hurtCD-=e);break;default:break}}var Ot=performance.now();Tt(N);var P0=0;function Be(e){let t=`FPS: ${Math.round(e)}`;m.save(),m.font="12px monospace",m.textAlign="right",m.textBaseline="top";let o=A-8,n=6,i=m.measureText(t).width+8,a=16;m.fillStyle="rgba(10, 15, 25, 0.6)",m.fillRect(o-i,n-2,i,a),m.strokeStyle="rgba(60, 80, 130, 0.9)",m.strokeRect(o-i+.5,n-2+.5,i-1,a-1),m.fillStyle="#dfe6ff",m.fillText(t,o,n),m.restore()}function c0(e=-1){let t;if(e!==-1){let o=G0[e];o&&(t=o)}else t=I0(G0);O.x=t.exitPos.x,O.y=t.exitPos.y,U.x=t.startPos.x,U.y=t.startPos.y,s.health=s.maxHealth,w.cielingColorFront=t.cielingColorFront||"#6495ED",w.floorColorFront=t.floorColorFront||"#054213",w.cielingColorBack=t.cielingColorBack||"#6495ED",w.floorColorBack=t.floorColorBack||"#03210A",w.MAP=t.mapLayout,w.MAP_W=w.MAP[0].length,w.MAP_H=w.MAP.length,s.x=s.x=t.startPos.x,s.y=t.startPos.y}async function Se(){await Bt(),await yt(),c0(0),J0(),s.maxHealth=6+C(6),s.health=s.maxHealth,s.ammo=5+C(5),X(),requestAnimationFrame(Xt)}function Ee(e){let t=C0();Mt(e,t,w.MAP,w.MAP_W,w.MAP_H),Ae(),S.sort((o,n)=>n.dist-o.dist),m.imageSmoothingEnabled=!1,Ce(t),Te()}function Ae(){for(let e of S){let t=e.x-s.x,o=e.y-s.y;e.dist=t*t+o*o}}function Ce(e){for(let t of S){if(!t.alive)continue;let o=F0(t,e);if(!o||y>0&&o.depth>y)continue;let n=Fe(o);ve(t,o,n)}}function Fe(e){let t=1/(1+e.depth*.3);if(y>0&&e.depth>y*i0){let i=y*i0,a=Math.min(1,Math.max(0,(e.depth-i)/Math.max(1e-6,y-i)));t*=1-a*.6}let o=[1,.85,.7,.55,.4];return{quantizedShade:o.reduce((i,a)=>Math.abs(a-t)<Math.abs(i-t)?a:i,o[0])}}function ve(e,t,o){m.save(),o.quantizedShade<.999&&(m.filter=`brightness(${o.quantizedShade})`);let n=Math.max(1,(t.width??t.drawEndX-t.drawStartX)|0),i=t.drawStartY,a=t.drawEndY-t.drawStartY,r=l=>(l-t.drawStartX)*e.img.width/n|0,c=-1,f=0;for(let l=t.drawStartX;l<=t.drawEndX;l++){let d=l>=0&&l<A&&l<t.drawEndX&&t.depth<=Q[l];if(d&&c===-1&&(c=l,f=r(l)),(!d||l===t.drawEndX)&&c!==-1){let h=l,b=h-c,g=r(h);g<=f&&(g=f+1);let p=Math.min(e.img.width-f,g-f);b>0&&p>0&&a>0&&m.drawImage(e.img,f,0,p,e.img.height,c,i,b,a),c=-1}}m.restore()}function Te(){let e=Math.round(A*.42),t=Math.round(e*(s0.height/s0.width)),o=Math.max(8,A*.02|0),n=A*.8-e-o,i=M-t-o+20;m.drawImage(s0,n,i,e,t)}function Xt(e){let t=Math.min(.05,(e-Ot)/1e3);Ot=e;let o=t>0?1/t:0;P0=P0?P0*.9+o*.1:o,Rt(t),Yt(t),kt(),Ee(e/1e3),_.classList.contains("visible")&&St(S),It(),_t(t),Lt(t),Be(P0),requestAnimationFrame(Xt)}await Se().catch(console.error);export{c0 as ChangeMapLevel};
