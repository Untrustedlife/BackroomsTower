import{a as i0,b as ht}from"../chunks/chunk-B3G4DJQ2.js";var ae=90*Math.PI/180,Y0=ae*.5,pt=.01,L0=.01,M=15;var m0=.95,A0=.75,s0=.6,C0="#101b2e",w0=5,h0=10,Gt=3.33;var q=document.getElementById("view"),w=q.getContext("2d");w.imageSmoothingEnabled=!1;m0&&m0!==1&&(q.width=Math.max(1,Math.round(q.width*m0)),q.height=Math.max(1,Math.round(q.height*m0)));var C=q.width,B=q.height,O=document.getElementById("mini"),S=O.getContext("2d");S.imageSmoothingEnabled=!1;var gt=document.getElementById("hpBar"),bt=document.getElementById("ammoBar"),xt=document.getElementById("hpText"),yt=document.getElementById("ammoText"),Mt=document.getElementById("msg"),Bt=document.getElementById("btnReset"),St=document.getElementById("btnToggleMap");var c={x:3.5,y:3.5,a:0,speed:2,rotSpeed:2.6,health:6,maxHealth:6,ammo:1,hasBlueKey:!1,tenacity:20,maxTenacity:20},X0=.2,$=1,Et=1,ie=99;function W0(t){$=Math.max(Et,Math.min(ie,t|0||Et))}function F0(){let t=Math.cos(c.a),e=Math.sin(c.a),o=-e*Math.tan(Y0),n=t*Math.tan(Y0),i=1/(o*e-t*n);return{dirX:t,dirY:e,planeX:o,planeY:n,invDet:i}}function r0(t=64,e=64){let o=document.createElement("canvas");return o.width=t,o.height=e,o}function K(t,e){let o=parseInt(t.slice(1),16),n=o>>16&255,i=o>>8&255,r=o&255,a=s=>i0(((s/255)**2.2+e)*255,0,255)|0;return`#${(a(n)<<16|a(i)<<8|a(r)).toString(16).padStart(6,"0")}`}function G0(t,e,o,n){let i=(o*t.width+e)*4,r=parseInt(n.slice(1),16);t.data[i]=r>>16&255,t.data[i+1]=r>>8&255,t.data[i+2]=r&255,t.data[i+3]=255}function se(){let t=r0(),e=t.getContext("2d",{willReadFrequently:!0}),o=t.width,n=t.height,i=e.createImageData(o,n),r=["#7a7a7a","#8a8a8a","#9a9a9a","#6a6a6a"];for(let a=0;a<n;a++)for(let s=0;s<o;s++){let l=a%16===15||s%16===15,f=(Math.sin(s*.18)+Math.cos(a*.12))*.06,p=l?"#222222":r[((s/16|0)+(a/16|0))%r.length];G0(i,s,a,K(p,f))}return e.putImageData(i,0,0),t}function ce(){let t=r0(),e=t.getContext("2d",{willReadFrequently:!0}),o=t.width,n=t.height,i=e.createImageData(o,n);for(let r=0;r<n;r++)for(let a=0;a<o;a++){let s=a%32===0||r%16===0,l=(Math.sin(a*.12)+Math.cos(r*.17))*.07+(((a^r)&7)/128-.03),p=K(s?"#2a2a2a":"#6a6f73",l);(a*13+r*7)%97===0&&(p=K(p,-.25)),G0(i,a,r,p)}return e.putImageData(i,0,0),t}function le(){let t=r0(),e=t.getContext("2d",{willReadFrequently:!0}),o=t.width,n=t.height,i=e.createImageData(o,n);for(let r=0;r<n;r++)for(let a=0;a<o;a++){let s=Math.sin((a+r)*.18)*.1+Math.cos((a-r)*.14)*.08,l=((a^r<<1)&15)/255-.02,f=K("#2e6a2e",s+l);((a+r*2)%13===0||(a*3-r)%29===0)&&(f=K(f,-.18)),(a*5+r*7)%101===0&&(f=K(f,.18)),G0(i,a,r,f)}return e.putImageData(i,0,0),t}function At(t="#5b4b2a"){let e=r0(),o=e.getContext("2d",{willReadFrequently:!0}),n=e.width,i=e.height,r=o.createImageData(n,i);for(let a=0;a<i;a++)for(let s=0;s<n;s++){let l=Math.sin(s*.22+Math.cos(a*.05)*.4)*.08+Math.sin(a*.07)*.02;G0(r,s,a,K(t,l))}o.putImageData(r,0,0),o.fillStyle="#3a3a3a",o.fillRect(0,18,n,4),o.fillRect(0,42,n,4),o.fillStyle="#6a6a6a";for(let a=6;a<n;a+=12)o.fillRect(a,19,2,2),o.fillRect(a,43,2,2);return o.strokeStyle="#444",o.lineWidth=2,o.beginPath(),o.arc(46,32,4,0,Math.PI*2),o.stroke(),e}function fe(){let t=r0(),e=t.getContext("2d",{willReadFrequently:!0}),o=t.width,n=t.height;e.fillStyle="#1f1f24",e.fillRect(0,0,o,n);let i=o/2,r=n/2,a=e.createRadialGradient(i,r,4,i,r,28);a.addColorStop(0,"#74CCEA"),a.addColorStop(.5,"#20B2DB"),a.addColorStop(1,"#FFE300"),e.fillStyle=a,e.beginPath(),e.arc(i,r,26,0,Math.PI*2),e.fill(),e.strokeStyle="rgba(255,255,255,0.25)";for(let s=0;s<6;s++){e.beginPath();let l=8+s*3;e.arc(i,r,l,s*.6,s*.6+Math.PI*1.2),e.stroke()}return e.strokeStyle="#3a3a3a",e.lineWidth=4,e.beginPath(),e.arc(i,r,28,0,Math.PI*2),e.stroke(),t}function de(){let t=At("#6a4a2a"),e=t.getContext("2d",{willReadFrequently:!0});e.fillStyle="#103b5f",e.fillRect(28,8,8,48),e.fillStyle="#74c8ff";for(let o=12;o<52;o+=8)e.fillRect(30,o,4,2);return t}function ue(){let t=r0(),e=t.getContext("2d",{willReadFrequently:!0}),o=t.width,n=t.height,i=e.createImageData(o,n),r="#00D9FF",a=5,s=.6,l=.1,f=.04,p=.5,d=.8660254,m=o*.5,g=n*.5,b=Math.min(o,n);for(let h=0;h<n;h++)for(let G=0;G<o;G++){let T=G/a,D=(G*p+h*d)/a,H=(G*p-h*d)/a,L=1-Math.abs(Math.sin(Math.PI*T)),N=1-Math.abs(Math.sin(Math.PI*D)),Z=1-Math.abs(Math.sin(Math.PI*H)),t0=(L+N+Z)/3,X=1-Math.min(G,h,o-1-G,n-1-h)/(b*.5);X<0&&(X=0);let V=(G*13+h*17)%23/23-.5,_=t0*s+X*l+V*f;G0(i,G,h,K(r,_))}e.putImageData(i,0,0),e.globalAlpha=.35,e.strokeStyle="#6FEAFF",e.lineWidth=1;for(let h=0;h<9;h++){e.beginPath();let G=3+h*Math.floor(n/10);e.moveTo(2,G);for(let T=2;T<o-2;T+=6){let D=G+Math.sin((T+h*7)*.35)*2.5+Math.sin((T*.5-h*9)*.12)*1.5;e.lineTo(T,D)}e.stroke()}return t}var me=[null,se(),ce(),le(),At(),fe(),de(),ue()],U=[...me];function Ct(t){let o=t.getContext("2d").getImageData(0,0,t.width,t.height),n=[];for(let i=0;i<t.width;i++){let r=new Uint8ClampedArray(t.height*4);for(let a=0;a<t.height;a++){let s=(a*t.width+i)*4,l=a*4;r[l]=o.data[s],r[l+1]=o.data[s+1],r[l+2]=o.data[s+2],r[l+3]=o.data[s+3]}n.push({data:r,h:t.height})}return{cols:n,w:t.width,h:t.height}}var p0=U.map(t=>t?Ct(t):null);function we(){p0.length=0,U.forEach(t=>{p0.push(t?Ct(t):null)})}async function he(t){let e=`../assets/gfx/${t}`;return new Promise((o,n)=>{let i=new Image;i.onload=()=>{let r=r0(64,64),a=r.getContext("2d",{willReadFrequently:!0});a.imageSmoothingEnabled=!1,a.drawImage(i,0,0,64,64),o(r)},i.onerror=()=>n(new Error(`Failed to load texture: ${e}`)),i.src=e})}async function Ft(){try{await pe([{index:1,image:"OfficeWall.png"},{index:2,image:"Panel.png"},{index:3,image:"Hedge.png"},{index:4,image:"OfficeDoor.png"},{index:5,image:"Portal.png"},{index:6,image:"OfficeDoorBlue.png"},{index:7,image:"Field.png"}]),we()}catch(t){console.warn("Failed to init backrooms wallpaper:",t)}}async function pe(t){if(!Array.isArray(t)){console.warn("Expected an array of { index, image } objects. In loadImagesToReplaceTextures");return}let e=t.map(async(o,n)=>{let{index:i,image:r}=o||{};try{let a=await he(r);i&&i>=0&&i<U.length?U[i]=a:U.push(a)}catch(a){console.warn(`Failed to load texture "${r}" for index ${i} and dont support replacing with cool gmod missing texture:`,a)}});await Promise.all(e)}var W={x:10,y:8},j={x:3.5,y:3.5},u={MAP:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,2,6,2,0,0,0,0,0,0,0,2,6,2,0,0,1],[1,0,0,0,2,0,2,0,0,0,0,0,0,0,2,0,2,0,0,1],[1,0,0,0,2,2,2,0,0,0,0,0,0,0,2,2,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,5,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,3,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,3,3,1,3,3,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,0,0,0,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,2,2,2,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,1,0,2,0,2,0,1,0,3,0,0,0,1],[1,0,0,0,0,0,0,0,0,2,6,2,0,0,0,0,0,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],MAP_W:-1,MAP_H:-1,cielingColorFront:"",floorColorFront:"",cielingColorBack:"",floorColorBack:""},g0=[{name:"Village",mapLayout:[[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,1,2,3,4,5,6,7,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,1,1,1,1,1,6,1,1,6,1,1,1,1,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3]],exitPos:{x:10,y:12},startPos:{x:9.5,y:1.5}},{name:"TowerFloor1",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,1,1,1,1,1,0,0,1,1,1,1,1,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,3,3,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,3,3,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,6,1,1,1,1,0,0,1,6,1,1,1,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,1,1,1,1,1,1,6,1,1,1,1,1,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,1,1,1,1,1,1,0,0,0,1,0,0,1],[1,0,0,1,1,1,1,1,0,0,0,0,1,1,1,1,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,4,4,1,1,1,1,1,1,1,1,1]],exitPos:{x:10,y:17},startPos:{x:5.5,y:4.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#000000",floorColorBack:"#000000"},{name:"Gallery",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,4,4,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,0,0,0,3,1],[1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,3,1,0,0,0,0,0,1],[1,1,0,0,0,7,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,2,0,0,1],[1,1,1,7,1,1,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,6],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0,0,2,0,0,1],[1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,0,0,2,0,0,1],[1,1,0,0,0,3,0,0,0,0,0,3,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,3,0,0,0,0,0,3,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,3,0,0,0,0,0,3,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,3,0,0,0,0,0,3,0,0,0,1,0,0,2,0,0,1],[1,1,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,0,0,2,0,0,1],[1,0,2,2,2,2,2,2,2,2,2,0,1,0,1,0,1,0,1,0,0,2,0,0,1],[4,0,2,2,2,2,2,2,2,2,2,0,6,0,6,0,6,0,6,0,0,2,0,0,1],[1,0,2,2,2,2,2,2,2,2,2,0,1,0,1,0,1,0,1,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,3,0,0,0,3,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],exitPos:{x:3,y:3},startPos:{x:1.5,y:21.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#ECDE60",floorColorBack:"#000000"},{name:"LongHallways",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,1,0,0,0,0,0,0,3,3,3,3,3,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,1,0,0,0,0,0,3,3,3,3,3,3,3,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,3,3,3,0,0,0,3,3,3,0,0,0,0,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,3,3,3,3,0,4,0,3,3,3,3,0,0,0,1,1,1],[1,7,7,1,1,6,1,1,1,6,1,1,1,6,1,1,1,6,1,1,0,0,3,3,3,3,3,0,0,0,3,3,3,3,3,0,0,1,1,1],[1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,0,1],[1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,6,0,1],[1,7,7,1,1,6,1,1,1,1,1,1,1,1,1,1,1,6,1,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,0,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,2,2,0,2,2,2,2,6,2,2,2,2,0,2,2,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,3,0,0,0,0,0,3,2,0,0,0,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,0,3,3,3,3,3,0,3,3,3,3,3,0,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,1,0,0,0,0,3,3,3,3,0,3,3,3,3,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,2,3,0,0,0,0,0,3,2,0,0,0,1,0,0,0,0,0,3,3,3,0,3,3,3,0,0,0,0,0,1,1,1],[1,7,7,1,2,2,0,2,2,2,2,6,2,2,2,2,0,2,2,1,0,0,0,0,0,0,3,3,0,3,3,0,0,0,0,0,0,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,1,1,1,1,1,1,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1],[1,7,7,1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,1,1,1],[1,7,7,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1],[1,7,7,1,0,0,6,0,3,3,3,3,3,3,3,3,3,3,3,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,1,1,1],[1,7,7,1,0,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,3,3,3,3,3,3,3,3,3,3,3,0,4,0,0,1,1,1],[1,7,7,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1],[1,7,7,1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,1,1,1],[1,7,7,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7,0,0,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,1,1],[1,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],exitPos:{x:1,y:1},startPos:{x:9.5,y:3.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#000000",floorColorBack:"#000000"}];var Q=new Float32Array(C);function Ge(t,e,o,n,i,r,a,s,l){let f=n-o;if(f<=0)return;t.save(),t.imageSmoothingEnabled=!1;let p=s||0,d=p<0?0:p>i.height?i.height:p,m=l||i.height,g=i.height-d,b=m<0?0:m>g?g:m;if(t.drawImage(i,r,d,1,b,e,o,1,f),a<.999){let G=(a<0?0:a)*255|0;t.globalCompositeOperation="multiply",t.fillStyle=`rgb(${G},${G},${G})`,t.fillRect(e,o,1,f)}t.restore()}var b0=B>>1;function Tt(t,e,o,n,i){let{dirX:r,dirY:a,planeX:s,planeY:l}=e,f=w.createLinearGradient(0,0,0,b0);f.addColorStop(0,u.cielingColorFront||"#6495ED"),u.cielingColorBack&&f.addColorStop(.5,u.cielingColorBack||"#6495ED"),f.addColorStop(.9,C0),w.fillStyle=f,w.fillRect(0,0,C,b0);let p=w.createLinearGradient(0,B,0,b0);p.addColorStop(0,u.floorColorFront||"#054213"),p.addColorStop(.85,u.floorColorBack||"#03210A"),p.addColorStop(.95,C0),w.fillStyle=p,w.fillRect(0,b0,C,b0);let d=w.createLinearGradient(0,0,0,B);d.addColorStop(0,"rgba(16,27,46,0.08)"),d.addColorStop(.5,"rgba(16,27,46,0.16)"),d.addColorStop(1,"rgba(16,27,46,0.20)"),w.save(),w.fillStyle=d,w.fillRect(0,0,C,B),w.restore();for(let m=0;m<C;m++){let g=2*(m+.5)/C-1,b=r+s*g,h=a+l*g;if(b<1e-8&&b>-1e-8&&h<1e-8&&h>-1e-8){Q[m]=Number.POSITIVE_INFINITY;continue}let G=1/(b||1e-9),T=1/(h||1e-9),D=c.x|0,H=c.y|0,L=G<0?-G:G,N=T<0?-T:T,Z,t0,X,V;b<0?(Z=-1,X=(c.x-D)*L):(Z=1,X=(D+1-c.x)*L),h<0?(t0=-1,V=(c.y-H)*N):(t0=1,V=(H+1-c.y)*N);let _=0,z=1,M0=!1,Qt=0,Jt=0;for(;!M0&&Qt++<256;){if(X<V?(X+=L,D+=Z,_=0):(V+=N,H+=t0,_=1),M>0){let E0=Math.min(X,V);if(E0>M){M0=!1,z=0,Jt=E0;break}}if(D<0||H<0||D>=n||H>=i){M0=!0,z=1;break}let u0=o[H][D];if(u0>0){M0=!0,z=u0;break}}if(z===0){Q[m]=Number.POSITIVE_INFINITY;continue}let v;_===0?v=X-L:v=V-N,v=Math.max(pt,v);let it=0,Zt=_===0?Z:0,te=_===1?t0:0,st=Math.abs(Zt*r+te*a)>=.9&&Math.abs(g)<=.9&&v<it?it:v,ct=c.x+st*b,lt=c.y+st*h,e0;_===0?e0=lt-(lt|0):e0=ct-(ct|0),e0=e0<0?0:e0>.999999?.999999:e0+1e-6;let ft=p0[z]||p0[4],f0=U[z],B0=f0?f0.width|0:ft.w|0,o0=e0*B0|0;(_===0&&Z>0||_===1&&t0<0)&&(o0=B0-o0-1),o0=o0<0?0:o0>=B0?B0-1:o0;let ee=v<L0?L0:v,S0=B/ee|0,O0=(B-S0*A0)/2|0,oe=O0+S0,n0=O0,d0=oe;n0<0&&(n0=0),d0>B&&(d0=B);let dt=d0-n0;if(dt<=0){Q[m]=v;continue}let ut=(f0?f0.height:ft.h||U[z]?.height||64)|0,ne=(n0-O0)*(ut/Math.max(1,S0)),re=dt*(ut/Math.max(1,S0)),mt=1/(1+v*.25)*(_?.5:1);if(z===7&&(mt*=.8+.2*Math.sin(t*6+m*.05)),Ge(w,m,n0,d0,f0,o0,mt,ne,re),M>0&&v>M*s0){let u0=M*s0,E0=M,wt=Math.min(1,Math.max(0,(v-u0)/Math.max(1e-6,E0-u0)));wt>0&&(w.save(),w.globalAlpha=wt*.85,w.fillStyle=C0,w.fillRect(m,n0,1,d0-n0),w.restore())}Q[m]=v}}function ge(t){return B/t}function be(t,e,o){let{dirY:n,dirX:i,planeY:r,planeX:a,invDet:s}=o,l=s*(n*t-i*e),f=s*(-r*t+a*e);return{transX:l,transY:f}}function xe(t,e){return Math.round((C>>1)*(1+t/e))}function ye(t,e=0,o=.5){let n=e*100,a=(B>>1)+(t>>1)+(n|0),s=a-t;return s<0&&(s=0),{startY:s,endY:a}}function Me(t){let o=(B>>1)-(t>>1);o<0&&(o=0);let n=o+t;return{startY:o,endY:n}}function T0(t,e){let o=t.x-c.x,n=t.y-c.y,{transX:i,transY:r}=be(o,n,e);if(r<=.01)return null;let a=xe(i,r),s=t&&typeof t.scale=="number"?t.scale:t&&t.img&&typeof t.img.scale=="number"?t.img.scale:1,l=ge(r)*s,f=typeof t._hR=="number"?t._hR:Math.round(l),p=.1,d=f;(l>f+p||l<f-p)&&(d=Math.round(l)),t._hR=d;let m=d,g=t.img,b=g&&g.width&&g.height?g.width/g.height:1,h=Math.max(1,Math.round(m*b)),G=m/B,T=(t.floorBias??0)*s*G*(2-A0),D=Math.min(.9,Math.max(.2,s)),H=t.ground?ye(m,T,D):Me(m),L=Math.round(a-(h>>1)),N=L+h;return{drawStartX:L,drawEndX:N,drawStartY:H.startY,drawEndY:H.endY,depth:r,size:m,width:N-L}}function x0(t,e,o=1){let n=t.trim().split(`
`).map(d=>d.replace(/\s+/g,"")),i=n.length-1;for(;i>=0&&n[i].split("").every(d=>d===".");)i--;i>=0&&i<n.length-1&&(n=n.slice(0,i+1));let r=n.length,a=n[0].length,s=1,l=document.createElement("canvas");l.width=a,l.height=r;let f=l.getContext("2d");f.imageSmoothingEnabled=!1;let p=f.createImageData(a,r);for(let d=0;d<r;d++)for(let m=0;m<a;m++){let g=n[d][m],b=(d*a+m)*4;if(g==="."){p.data[b+3]=0;continue}let h=e[g]||"#ffffff",G=parseInt(h.slice(1),16);p.data[b]=G>>16&255,p.data[b+1]=G>>8&255,p.data[b+2]=G&255,p.data[b+3]=255}if(f.putImageData(p,0,0),o!==1){let d=document.createElement("canvas");d.width=a*o,d.height=r*o;let m=d.getContext("2d");return m.imageSmoothingEnabled=!1,m.drawImage(l,0,0,d.width,d.height),d.baseline=s,d.scale=o,d}return l.baseline=s,l.scale=1,l}async function Be(t,e){return await Se(t,e,1)}async function Se(t,e=1,o=1){let n=`../assets/gfx/${t}`;return new Promise((i,r)=>{let a=new Image;a.onload=()=>{let s=document.createElement("canvas"),l=a.width,f=a.height;s.width=l*e,s.height=f*e;let p=s.getContext("2d");p.imageSmoothingEnabled=!1,p.drawImage(a,0,0,s.width,s.height),s.baseline=o,s.scale=e,i(s)},a.onerror=()=>r(new Error(`Failed to load sprite: ${n}`)),a.src=n})}var c0,v0,R0,I0,k0,N0;async function vt(){v0=v0=x0(`
  ................................
  ..............BB..BB............
  .............BbbbbbbB...........
  ...........BbbbGGGGbbbB.........
  ..........BbbbGGGGGGbbbB........
  .........BbbGGGGGGGGGGbbB.......
  ........BbbGGGgGGGGgGGbbB.......
  ........BbbGGgGyyGgGGGbbB.......
  .......BbbGGGGGGGGGGGGbbB.......
  .......BbbGGGGGGGGGGGGbbB.......
  ......BbbGGGGGGGGGGGGGGbbB......
  ......BbbGGGGgGGGGgGGGGbbB......
  ......BbbGGGGwwwwwwGGGGbbB......
  .....BbbGGGwwwWWkWWwwwGGbbB.....
  .....BbbGGGwwwwkkwwwwGGbbB......
  .....BbbGGGwwwwrwwwwGGGbbB......
  .....BbbGGGwwwwwwwwwGGGbbB......
  .....BbbGGGGwwwwwwwGGGGbbB......
  .....BbbGGGGGGGGGGGGGGGbbB......
  .....BbbGGGGGGGGGGGGGGGbbB......
  ......BbbGGGGGGGGGGGGGbbB.......
  ......BbbGGGGGGGGGGGGGbbB.......
  .......BBbbbgggGGGGgggbbBB......
  ........BBBbbbbbbbbbbbbBBB......
  ................................
  `,{B:"#2c1810",b:"#5c3d2e",g:"#7a6b5c",G:"#a89080",k:"#080508",w:"#e8e0d5",W:"#f5f0e8",r:"#8b4513",y:"#ffeb9c"},4),N0=x0(`
  ............
  ....bbbb....
  ..bbGGGGbb..
  .bGGGGGGGGb.
  .bGGgGGgGGb.
  .bGGGGGGGGb.
  .bGgGGGGgGb.
  .bGGGGGGGGb.
  .bGGgGGgGGb.
  .bGGGGGGGGb.
  .bGgGGGGgGb.
  .bGGGGGGGGb.
  .bGGgGGgGGb.
  .bGGGGGGGGb.
  .bGGgGGgGGb.
  .bGGGGGGGGb.
  ..bbGGGGbb..
  ....bbbb....
  ............
  ............
  `,{k:"#0a0f10",g:"#1b5c3a",G:"#2e874f",s:"#7fffd4",b:"#0e1620"},3),I0=x0(`
  ................
  .....B....B.....
  ....BBBBBBBB....
  ...BBbBBbBBB....
  ...BBbgBgbBB....
  ....BBgggBB.....
  .....kGGGk......
  ....kGGsGGk.....
  ...kGGGGGGGk....
  ...kGGGGGGGk....
  ....kGGGGGk.....
  .....kGGGk......
  .......GG.......
  .......GG.......
  .....GGGGGG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GGggGG.....
  `,{k:"#5a4500",g:"#FFD700",G:"#FFA500",s:"#FFF5CC",b:"#4169E1",B:"#87CEEB"},4),R0=x0(`
  ............r...
  ............rr..
  ...........w..r.
  .......sb.w...rr
  .......bdw...w..
  .......sfd..w...
  ......sfffdw....
  .....sfffffdb...
  ....sfbffffss...
  ...sfbfbffs.....
  ..sfbfbfbs......
  .sfbfbfbs.......
  .sffbfbs........
  ..sffbs.........
  ...sss..........
  ................
  `,{b:"#100904",d:"#8f715b",f:"#5a3b1a",r:"#DC143C",s:"#000000",w:"#4d260a"},3),c0=c0=x0(`
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ........................................................w.......
  ......................................................sww.......
  ..................................................wwwwws........
  ...............................................wwwwwwww.s.......
  ..............................................wwwwww....s.......
  ...........................................wwwwwww......s.......
  ...........................................wwwww........s.......
  ..........................................wwwww..........s......
  .........................................wwwww...........s......
  ........................................wwwwww...........s......
  ........................................wwwww............s......
  .......................................wwwww.............s......
  .......................................wwwww.............s......
  .......................................wwww...............s.....
  ......................................wwwww...............s.....
  ......................................wwww................s.....
  .....................................wwwww................s.....
  .....................................wwwww................s.....
  .....................................wwww.................s.....
  .....................................wwww.................s.....
  ....................................wwwww.................s.....
  ....................................wwww..................s.....
  ....................................wwww..................s.....
  ..............................ssss.wwwww..................s.....
  ..............................sss..wwww...................s.....
  ..............................s.bb.wwww....................s....
  ..............................s..bbwwww....................s....
  ..................................bwwww....................s....
  ..................................bbwww....................s....
  ...................................bbww....................s....
  ..................................wwbbww...................s....
  ..................................wwwbbb....................s...
  ..................................wwwwwbb...................s...
  ...................................wwwwwbb..................s...
  ....................................wwww.bb.................s...
  ....................................wwww..bbb...............s...
  ....................................wwww....bb..............s...
  ....................................wwww.....bb..............s..
  ....................................wwww......bb.............s..
  ...................................wwwww.......bb............s..
  ..................................wwwwww........bbb..........s..
  ..................................wwwwww.........bbb.........ss.
  ..................................wwwwww...........bbrrrrr....s.
  ..................................wwwwww...........fbbbrrrr...s.
  ...................................wwwww...........ffffbbrrr..s.
  ...................................wwwwww...........ffffbbrrr.s.
  ...................................wwwwww...........ffffffbb.ss.
  ...................................wwwwww.............ffff.bbbs.
  ...................................wwwwwww..............ff...bs.
  `,{b:"#5a3b1a",f:"#B8860B",r:"#DC143C",s:"#C0C0C0",w:"#8B4513"},3),k0=await Be("apple.png",3)}var E=[];function J(t,e){if(t<0||e<0||t>=u.MAP_W||e>=u.MAP_H)return!0;let o=u.MAP[e|0][t|0];return o===0||o===5?!1:o===7?!c.hasBlueKey:o!==6}function q0(t,e,o){return!!(J(t,e)||J(t-o,e)||J(t+o,e)||J(t,e-o)||J(t,e+o))}function P0(t){if(!Array.isArray(t)||t.length===0)throw new Error("Array must be non-empty.");let e=F(t.length)-1;return t[e]}function F(t){if(t<=0)throw new Error("The maximum value must be greater than 0.");return Math.floor(Math.random()*t)+1}var x=null,a0=null,I=null,V0=null,Rt=null;function $0(){x||(x=new(window.AudioContext||window.webkitAudioContext))}function R({freq:t=440,dur:e=.1,type:o="square",vol:n=.2,slide:i=0}){if(!x)return;let r=x.createOscillator(),a=x.createGain();r.type=o,r.frequency.value=t,a.gain.value=n,r.connect(a).connect(x.destination);let s=x.currentTime;i&&(r.frequency.setValueAtTime(t,s),r.frequency.linearRampToValueAtTime(t+i,s+e)),a.gain.setValueAtTime(n,s),a.gain.exponentialRampToValueAtTime(.001,s+e),r.start(s),r.stop(s+e)}function z0({dur:t=.2,vol:e=.2,lp:o=1200}){if(!x)return;let n=x.createBuffer(1,x.sampleRate*t,x.sampleRate),i=n.getChannelData(0);for(let f=0;f<i.length;f++)i[f]=Math.random()*2-1;let r=x.createBufferSource(),a=x.createGain(),s=x.createBiquadFilter();r.buffer=n,a.gain.value=e,s.type="lowpass",s.frequency.value=o,r.connect(s).connect(a).connect(x.destination);let l=x.currentTime;r.start(l),r.stop(l+t)}var k={shot:()=>{let t=F(50),e=-F(50);R({freq:220+t+e,dur:.05+F(3)/100,type:"square",vol:.25,slide:120}),z0({dur:.03+F(3)/100,vol:.15,lp:800})},pickup:()=>{R({freq:880,dur:.06,type:"triangle",vol:.2}),R({freq:1180,dur:.08,type:"triangle",vol:.18})},explode:()=>{z0({dur:1,vol:.3,lp:800}),R({freq:90,dur:.7,type:"sawtooth",vol:.12,slide:-60})},hurt:()=>{R({freq:140,dur:.12,type:"sawtooth",vol:.2,slide:-50})},killedEntity:()=>{let t=Math.random()*16-8;R({freq:320+t,dur:.26,type:"triangle",vol:.3,slide:-220}),R({freq:480+t,dur:.22,type:"sawtooth",vol:.1,slide:-260}),R({freq:90,dur:.08,type:"sine",vol:.18}),z0({dur:.05,vol:.1,lp:1e3}),setTimeout(()=>{R({freq:170+t,dur:.07,type:"triangle",vol:.16,slide:70})},90)},door:()=>{R({freq:420,dur:.12,type:"square",vol:.15})},portal:()=>{R({freq:600,dur:.5,type:"sawtooth",vol:.2}),R({freq:400,dur:.3,type:"sawtooth",vol:.2,slide:50}),R({freq:600,dur:.5,type:"sawtooth",vol:.2})}};async function Ee(t,{volume:e=.15}={}){if(x)try{if(!V0||t!==Rt){let n=await(await fetch(t,{cache:"force-cache"})).arrayBuffer();V0=await x.decodeAudioData(n),Rt=t}It(),I=x.createBufferSource(),I.buffer=V0,I.loop=!0,a0=x.createGain(),a0.gain.value=e,I.connect(a0).connect(x.destination),I.start()}catch(o){try{It();let n=new Audio(t);n.loop=!0,n.volume=Math.max(0,Math.min(1,e)),await n.play(),I={stop:()=>n.pause(),disconnect:()=>{}},a0=null}catch(n){}}}function It(){try{I&&I.stop(0)}catch(t){}if(I&&I.disconnect)try{I.disconnect()}catch(t){}if(a0)try{a0.disconnect()}catch(t){}I=null,a0=null}var kt=!1;async function K0(){if(!x||I||kt)return;kt=!0,await Ee("../assets/sfx/HexenST02SLowed.ogg",{volume:.12})}var U0=0,P=new Set,j0=!1,Q0=0,J0=!1;function Ht(t){window.addEventListener("keydown",e=>{P.add(e.code),$0(),K0(),e.code==="Space"&&(e.preventDefault(),Pt()),e.code==="KeyM"&&(e.preventDefault(),O.classList.toggle("visible"))}),window.addEventListener("keyup",e=>P.delete(e.code)),t.addEventListener("mousedown",e=>{e.button===0&&Pt(),j0=!0,Q0=e.clientX,$0(),K0()}),window.addEventListener("mouseup",()=>j0=!1),window.addEventListener("mousemove",e=>{if(j0){let o=e.clientX-Q0;Q0=e.clientX,c.a+=o*.0035}}),Bt.onclick=()=>Te(),St.onclick=()=>O.classList.toggle("visible")}function _t(t){let e=P.has("ShiftLeft")||P.has("ShiftRight"),o=c.speed*(e?2:1)*t,n=c.rotSpeed*t,i=Math.cos(c.a),r=Math.sin(c.a),a=-r,s=i,l=0,f=0;P.has("ArrowLeft")&&(c.a-=n),P.has("ArrowRight")&&(c.a+=n),(P.has("ArrowUp")||P.has("KeyW"))&&(l+=i*o,f+=r*o),(P.has("ArrowDown")||P.has("KeyS"))&&(l-=i*o,f-=r*o),P.has("KeyA")&&(l-=a*o,f-=s*o),P.has("KeyD")&&(l+=a*o,f+=s*o);let p=c.x+l,d=c.y+f;q0(p,c.y,X0)||(c.x=p),q0(c.x,d,X0)||(c.y=d)}function Pt(){let t=!1;c.ammo>0&&(c.ammo--,Y(),k.shot(),t=!0);let e=F0(),o=Ae(e);if(!o){t||y("No arrows. Look for quivers.");return}switch(o.type){case"key":o.alive=!1,c.hasBlueKey=!0,k.door(),y("Keycard found! Find the exit!"),Xt();break;case"food":{o.alive=!1;let n=c.health>=c.maxHealth;n&&(c.maxHealth+=1),c.health=i0(c.health+h0,0,c.maxHealth),y(n?"Ranger Became Stronger.":"Health restored."),Y(),k.pickup();break}case"arrows":o.alive=!1,c.ammo=Math.min(60,c.ammo+w0),Y(),y(`Arrows +${w0}`),k.pickup();break;default:o.onHit&&o.onHit(o,t);break}}function Ot(){for(let t of E)if(!(!t.alive||Math.hypot(t.x-c.x,t.y-c.y)>=.6))switch(t.type){case"key":t.alive=!1,c.hasBlueKey=!0,k.door(),y("Keycard found! Find the exit!"),Xt();break;case"food":t.alive=!1,c.health>=c.maxHealth?(y("Ranger Became Stronger"),c.maxHealth+=1,c.health=i0(c.health+h0,0,c.maxHealth)):(c.health=i0(c.health+h0,0,c.maxHealth),y(`Health +${h0}`)),Y(),k.pickup();break;case"arrows":t.alive=!1,c.ammo=Math.min(60,c.ammo+w0),Y(),k.pickup(),y(`Arrows +${w0}`);break;default:t.onTouch&&t.onTouch(t);break}}function Yt(){if(J0)return;let t=c.x|0,e=c.y|0;u.MAP[e][t]===5&&(k.portal(),y(`Floor ${$} cleared.`),W0($+1),J0=!0,setTimeout(()=>{Fe(!0),J0=!1},100))}function Ae(t){let o=document.getElementById("view").width>>1|0,n=Q[o]||1e9,i=null,r=1e9;for(let a of E){if(!a.alive)continue;let s=T0(a,t);s&&(M>0&&s.depth>M||o>=s.drawStartX&&o<s.drawEndX&&s.depth<n+.1&&s.depth<r&&(i=a,r=s.depth))}return i}function Lt(t,e,o){for(let n of E){if(!n.alive)continue;Math.hypot(n.x-t,n.y-e)<o&&(n.alive=!1)}}function y0(t=2){let e=0;for(;e++<200;){let o=(Math.random()*(u.MAP_W-2)|0)+1,n=(Math.random()*(u.MAP_H-2)|0)+1;if(u.MAP[n][o]!==0)continue;let i=o+.5-c.x,r=n+.5-c.y;if(!(Math.hypot(i,r)<t))return{x:o,y:n}}return{x:9,y:9}}function Xt(){let t=u.MAP_W,e=u.MAP_H;for(let o=0;o<e;o++)for(let n=0;n<t;n++)u.MAP[o][n]===7&&(u.MAP[o][n]=0)}function Wt(){let t=W.x,e=W.y;for(let o=e-1;o<=e+1;o++)for(let n=t-1;n<=t+1;n++)n===t&&o===e||(u.MAP[o][n]=7)}function Nt(t){let{enchantedKey:e,food:o,arrowQuiver:n}=t;if(E.length=0,F(100)<50)for(let s=0;s<F(2)*(u.MAP_H/20|0);s++){let l=y0(1);E.push(ot(A.barrel,{x:l.x+.5,y:l.y+.5}))}let i=y0(4);E.push({x:i.x+.5,y:i.y+.5,img:e,type:"key",alive:!0,dist:0,ground:!0,scale:.25,floorBias:35});let r=y0(3);E.push({x:r.x+.5,y:r.y+.5,img:o,type:"food",alive:!0,dist:0,ground:!0,scale:.25,floorBias:35});for(let s=0;s<1+($/3|0)*(u.MAP_H/20|0);s++)if(s<=1&&F(100)<50||s<1&&c.ammo<=0&&F(100)<80||F(100)<25){let l=y0(3);E.push({x:l.x+.5,y:l.y+.5,img:n,type:"arrows",alive:!0,dist:0,ground:!0,scale:.25,floorBias:35})}let a=Math.min((2+($-1)*2)*(u.MAP_H/20|0),8);for(let s=0;s<a;s++){let l=y0(3.5);E.push(ot(A.entity,{x:l.x+.5,y:l.y+.5}))}}function Y(){gt.style.width=`${c.health/c.maxHealth*100}%`,bt.style.width=`${c.ammo/60*100}%`,xt.textContent=Math.max(0,c.health),yt.textContent=c.ammo}var Z0=0,tt=0,et=!1,Dt=!1;function y(t){let e=document.getElementById("gameLog"),o=e?.querySelector(".log-items");if(!o)return;let n=document.createElement("div");n.textContent=t,o.prepend(n),e.classList.contains("collapsed")||requestAnimationFrame(()=>{o.scrollTop=0})}function qt(t){Z0>0&&(Z0-=t,Z0<=0&&(Mt.textContent=c.hasBlueKey?"Find the exit.":"Find the enchanted key."))}function Vt(){et||c.health<=0&&(et=!0,c.speed=0,c.rotSpeed=0,tt=2,y("YOU DIED! Soul disconnecting from the node..."))}function zt(t){et&&(tt-=t,tt<=0&&Ce())}function Ce(){if(Dt)return;Dt=!0;let t=document.getElementById("game");if(t){let e=document.createElement("div");e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100vw",e.style.height="100vh",e.style.background="#ff0000",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.zIndex="999999",e.style.fontFamily='"Courier New", monospace',e.style.opacity="0",e.style.transition="opacity 2s ease-in",e.innerHTML=`
      <div style="
        background: #000;
        border: 3px solid #04650d;
        color: #20b2db;
        width: 600px;
        max-width: 90vw;
        box-shadow: 0 0 20px #04650d;
        font-family: 'Courier New', monospace;
      ">
        <div style="
          background:#000;
          color: #04650d;
          padding: 8px 15px;
          display: flex;
          justify-content: space-between;
          font-weight: bold;
          font-size: 12px;
        ">
          <span style ="color: #FFFFFF; border: 1px solid #04650d;">Death...</span>
        </div>
        <div style="padding: 20px; min-height: 200px;">
          <div style="margin-bottom: 30px;">
            <div style="text-align: center; color: #FFFFFF; font-size: 32px; margin: 8px 0;">YOU HAVE DIED</div>
          </div>
          <div style="text-align: center; margin-top: 20px;">
            <button id="returnBtn" style="
              background: #000;
              border: 2px solid #04650d;
              color: #04650d;
              padding: 12px 24px;
              font-family: 'Courier New', monospace;
              font-size: 14px;
              font-weight: bold;
              cursor: pointer;
              text-transform: uppercase;
              letter-spacing: 1px;
            ">RETURN TO TERMINAL</button>
          </div>
        </div>
      </div>
    `,document.body.appendChild(e);let o=e.querySelector("#returnBtn");if(o){let n=!1;o.addEventListener("click",i=>{i.preventDefault(),!n&&(n=!0,setTimeout(()=>{window.location.href="../index.html"},100))})}setTimeout(()=>{e.style.opacity="1"},50),t.classList.add("game-paused"),P.clear()}}function nt(t=!1){t&&l0(),c.x=j.x,c.y=j.y,c.a=0,c.hasBlueKey=!1,u.MAP[W.y][W.x]=5,Wt(),Nt({enchantedKey:I0,food:k0,arrowQuiver:R0}),Y(),y(`Floor ${$}: Find the keycard.`)}function Fe(t=!1){t&&(U0>=g0.length-1?l0():(U0+=1,l0(U0))),c.x=j.x,c.y=j.y,c.a=0,c.hasBlueKey=!1,u.MAP[W.y][W.x]=5,Wt(),Nt({enchantedKey:I0,food:k0,arrowQuiver:R0}),Y(),y(`Floor ${$}: Find the keycard.`)}function Te(){W0(1),l0(0),nt()}function $t(t){for(let e of E)e.alive&&e.ai&&e.ai(e,t)}var A=Object.freeze({entity:"entity",barrel:"barrel"}),D0={[A.entity]:{type:A.entity,ground:!0,scale:.66,floorBias:3},[A.barrel]:{type:A.barrel,ground:!0,scale:.5,floorBias:5}};Object.freeze(D0);for(let t in D0)Object.freeze(D0[t]);var H0={[A.entity]:{ai(t,e){if(!t.alive)return;let o=c.x-t.x,n=c.y-t.y,i=Math.hypot(o,n);if(i>.3){let r=.9*e,a=o/i,s=n/i,l=t.x+a*r,f=t.y+s*r;J(l,t.y)||(t.x=l),J(t.x,f)||(t.y=f)}i<.6&&t.hurtCD<=0&&(c.health=Math.max(0,c.health-Gt)|0,Y(),y("Entity attacks!"),k.hurt(),t.hurtCD=.8,Vt()),t.hurtCD>0&&(t.hurtCD-=e)},onHit(t,e){e?(t.alive=!1,y(P0(["Entity murdered!","Entity destroyed!","Entity purged!"])),k.killedEntity()):y("No arrows.")},onTouch(t){rt(A.entity,1e4)&&y("You hear something like water nearby...")}},[A.barrel]:{onHit(t,e){e?(t.alive=!1,Lt(t.x,t.y,2.5),y("Kaboom!"),k.explode()):y("No arrows.")},onTouch(t){rt(A.barrel,1e4)&&y("Shooting this barrel may yield useful results...")}}};Object.freeze(H0);for(let t in H0)Object.freeze(H0[t]);var ve=0;function ot(t,e={x:0,y:0},o=void 0){let n=D0[t],i=H0[t],r=Object.assign(Object.create(i),n);switch(r.id=ve++,r.x=e.x,r.y=e.y,r.dist=0,r.alive=!0,r.hurtCD=0,t){case A.entity:r.img=v0;break;case A.barrel:r.img=N0;break}return o&&Object.assign(r,o),r}function Kt(t){S.clearRect(0,0,O.width,O.height);let e=6,o=20,n=2,i=Math.floor(o/2),r=Math.max(0,Math.min((c.x|0)-i,u.MAP_W-o)),a=Math.max(0,Math.min((c.y|0)-i,u.MAP_H-o));O.width=n+o*e+n,O.height=n+o*e+n;for(let d=0;d<o;d++)for(let m=0;m<o;m++){let g=a+d,b=r+m,h=u.MAP[g]?.[b]??0,G="#0c1220";h===1?G="#ECDE60":h===2?G="#707a88":h===3?G="#00e676":h===4?G="#996633":h===5?G="#FFE300":h===6?G=" #3561ff":h===7&&(G="#00FFFF"),S.fillStyle=G,S.fillRect(n+m*e,n+d*e,e-1,e-1)}for(let d of t){if(!d.alive)continue;let m=n+(d.x-r)*e,g=n+(d.y-a)*e;S.fillStyle=d.type===A.entity?"#ffeb9c":d.type===A.barrel?"#57d694":d.type==="key"?"#6aa2ff":d.type==="food"?"#7fffd4":d.type==="arrows"?"#DC143C":"#ffffff",S.fillRect(m-2,g-2,4,4)}let s=n+(c.x-r)*e,l=n+(c.y-a)*e;S.fillStyle="#e7f3ff",S.beginPath(),S.arc(s,l,2.5,0,ht),S.fill();let f=Math.cos(c.a),p=Math.sin(c.a);S.strokeStyle="#78f3d3",S.beginPath(),S.moveTo(s,l),S.lineTo(s+f*1.5*e,l+p*1.5*e),S.stroke()}var at=performance.now(),Ut=new Map;function rt(t,e){let o=at,n=Ut.get(t)??0;return o<n?!1:(Ut.set(t,o+e),!0)}Ht(q);var _0=0;function Re(t){let e=`FPS: ${Math.round(t)}`;w.save(),w.font="12px monospace",w.textAlign="right",w.textBaseline="top";let o=C-8,n=6,i=w.measureText(e).width+8,r=16;w.fillStyle="rgba(10, 15, 25, 0.6)",w.fillRect(o-i,n-2,i,r),w.strokeStyle="rgba(60, 80, 130, 0.9)",w.strokeRect(o-i+.5,n-2+.5,i-1,r-1),w.fillStyle="#dfe6ff",w.fillText(e,o,n),w.restore()}function l0(t=-1){let e;if(t!==-1){let o=g0[t];o&&(e=o)}else e=P0(g0);W.x=e.exitPos.x,W.y=e.exitPos.y,j.x=e.startPos.x,j.y=e.startPos.y,c.health=c.maxHealth,u.cielingColorFront=e.cielingColorFront||"#6495ED",u.floorColorFront=e.floorColorFront||"#054213",u.cielingColorBack=e.cielingColorBack||"#6495ED",u.floorColorBack=e.floorColorBack||"#03210A",u.MAP=e.mapLayout,u.MAP_W=u.MAP[0].length,u.MAP_H=u.MAP.length,c.x=c.x=e.startPos.x,c.y=e.startPos.y}async function Ie(){await vt(),await Ft(),l0(0),nt(),c.maxHealth=6+F(6),c.health=c.maxHealth,c.ammo=5+F(5),Y(),requestAnimationFrame(jt)}function ke(t){let e=F0();Tt(t,e,u.MAP,u.MAP_W,u.MAP_H),Pe(),E.sort((o,n)=>n.dist-o.dist),w.imageSmoothingEnabled=!1,De(e),Oe()}function Pe(){for(let t of E){let e=t.x-c.x,o=t.y-c.y;t.dist=e*e+o*o}}function De(t){for(let e of E){if(!e.alive)continue;let o=T0(e,t);if(!o||M>0&&o.depth>M)continue;let n=He(o);_e(e,o,n)}}function He(t){let e=1/(1+t.depth*.3);if(M>0&&t.depth>M*s0){let i=M*s0,r=Math.min(1,Math.max(0,(t.depth-i)/Math.max(1e-6,M-i)));e*=1-r*.6}let o=[1,.85,.7,.55,.4];return{quantizedShade:o.reduce((i,r)=>Math.abs(r-e)<Math.abs(i-e)?r:i,o[0])}}function _e(t,e,o){w.save(),o.quantizedShade<.999&&(w.filter=`brightness(${o.quantizedShade})`);let n=Math.max(1,(e.width??e.drawEndX-e.drawStartX)|0),i=e.drawStartY,r=e.drawEndY-e.drawStartY,a=f=>(f-e.drawStartX)*t.img.width/n|0,s=-1,l=0;for(let f=e.drawStartX;f<=e.drawEndX;f++){let d=f>=0&&f<C&&f<e.drawEndX&&e.depth<=Q[f];if(d&&s===-1&&(s=f,l=a(f)),(!d||f===e.drawEndX)&&s!==-1){let m=f,g=m-s,b=a(m);b<=l&&(b=l+1);let h=Math.min(t.img.width-l,b-l);g>0&&h>0&&r>0&&w.drawImage(t.img,l,0,h,t.img.height,s,i,g,r),s=-1}}w.restore()}function Oe(){let t=Math.round(C*.42),e=Math.round(t*(c0.height/c0.width)),o=Math.max(8,C*.02|0),n=C*.8-t-o,i=B-e-o+20;w.drawImage(c0,n,i,t,e)}function jt(t){let e=Math.min(.05,(t-at)/1e3);at=t;let o=e>0?1/e:0;_0=_0?_0*.9+o*.1:o,_t(e),$t(e),Ot(),ke(t/1e3),O.classList.contains("visible")&&Kt(E),Yt(),qt(e),zt(e),Re(_0),requestAnimationFrame(jt)}await Ie().catch(console.error);export{l0 as ChangeMapLevel,rt as tryCooldown};
