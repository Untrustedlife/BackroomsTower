import{a as u0,b as Wt,c as u}from"../chunks/chunk-75YVQ3JR.js";var D0=document.getElementById("view");D0.width=480;D0.height=270;var C=480,w=270,nt=new OffscreenCanvas(C,w),p=nt.getContext("2d");p.imageSmoothingEnabled=!1;var rt=D0.getContext("2d");rt.imageSmoothingEnabled=!1;var z=document.getElementById("mini"),D=z.getContext("2d");D.imageSmoothingEnabled=!1;var Gt=document.getElementById("hpBar"),zt=document.getElementById("ammoBar"),$t=document.getElementById("hpText"),Vt=document.getElementById("ammoText"),qt=document.getElementById("msg"),Ut=document.getElementById("btnReset"),Zt=document.getElementById("btnToggleMap");var je=90*Math.PI/180,at=je*.5,st=.01,lt=.01,te=15;var A0=.6,o0="#101b2e";var r={x:3.5,y:3.5,velX:0,velY:0,a:0,accel:10,rotSpeed:2.6,health:6,maxHealth:20,ammo:1,hasBlueKey:!1,isMoving:!1,weaponAnim:-1,tenacity:20,maxTenacity:20,height:.75,sightDist:15,mouseSensitivity:.22,calculatePlayerHeight:()=>r.height<.01?.01:r.height*1},ct=.2,m0=1,ee=1,Je=99;function ft(t){m0=Math.max(ee,Math.min(Je,t|0||ee))}function G0(){let t=Math.cos(r.a),e=Math.sin(r.a),o=-e*Math.tan(at),n=t*Math.tan(at),i=1/(o*e-t*n);return{dirX:t,dirY:e,planeX:o,planeY:n,invDet:i}}var oe=[{index:1,image:"OfficeWall.png"},{index:2,image:"Panel.png"},{index:3,image:"Hedge.png"},{index:4,image:"OfficeDoor.png"},{index:5,image:"Portal.png"},{index:6,image:"OfficeDoorBlue.png"},{index:7,image:"Field.png"},{index:8,image:"OfficeWall.png"},{index:9,image:"OfficeDoorBlue.png"}],ne={0:0,1:1,2:1,3:1,4:1,5:1,6:1,7:1,8:3,9:3};function Qe(t=64,e=64){return new OffscreenCanvas(t,e)}var $=new Array(8).fill(null);function re(t){let o=t.getContext("2d").getImageData(0,0,t.width,t.height),n=[];for(let i=0;i<t.width;i++){let a=new Uint8ClampedArray(t.height*4);for(let s=0;s<t.height;s++){let l=(s*t.width+i)*4,f=s*4;a[f]=o.data[l],a[f+1]=o.data[l+1],a[f+2]=o.data[l+2],a[f+3]=o.data[l+3]}n.push({data:a,h:t.height})}return{cols:n,w:t.width,h:t.height}}var P0=$.map(t=>t?re(t):null);function to(){P0.length=0,$.forEach(t=>{P0.push(t?re(t):null)})}var $0=Array.from({length:82},(t,e)=>e*.0125),z0={};function eo(){for(let t=1;t<$.length;t++)if($[t]){z0[t]={};for(let e of $0){let o=new OffscreenCanvas($[t].width,$[t].height),n=o.getContext("2d");n.drawImage($[t],0,0);let i=e*255|0;n.globalCompositeOperation="multiply",n.fillStyle=`rgb(${i},${i},${i})`,n.fillRect(0,0,o.width,o.height),z0[t][e]=o}}}async function oo(t){let e=`../assets/gfx/${t}`;return new Promise((o,n)=>{let i=new Image;i.onload=()=>{let a=Qe(64,64),s=a.getContext("2d",{willReadFrequently:!0});s.imageSmoothingEnabled=!1,s.drawImage(i,0,0,64,64),o(a)},i.onerror=()=>n(new Error(`Failed to load texture: ${e}`)),i.src=e})}async function ie(){try{await no(oe),to(),eo()}catch(t){console.warn("Failed to init wall textures:",t)}}async function no(t){if(!Array.isArray(t)){console.warn("Expected an array of { index, image } objects. In loadImagesToReplaceTextures");return}let e=t.map(async(o,n)=>{let{index:i,image:a}=o||{};try{let s=await oo(a);return i&&i>=0&&($[i]=s),s}catch(s){return console.warn(`Failed to load texture "${a}" for index ${i} and dont support replacing with cool gmod missing texture:`,s),null}});await Promise.all(e)}var ae=[{name:"Village",mapLayout:[[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,8,8,8,8,8,9,8,8,9,8,8,8,8,8,0,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,3],[3,0,0,8,8,8,8,8,8,8,8,8,8,8,0,0,8,0,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,3],[3,0,0,8,0,0,8,8,8,8,8,8,8,8,8,8,8,0,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,3],[3,0,0,8,8,8,8,8,8,8,8,8,0,0,0,0,8,0,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,3],[3,0,0,8,8,8,8,8,8,8,8,8,8,8,8,8,8,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3]],exitPos:{x:14,y:14},startPos:{x:9.5,y:1.5},zones:[{color:"#054213",x:0,y:0,w:1,h:1,floorColorBack:"#101b2e",fogColor:"#101b2e",spawnRules:[]},{color:"#8b8000",x:3,y:5,w:14,h:12,cielingColorFront:"#8b8000",cielingColorBack:"#000000",floorColorBack:"#000000",fogColor:"#000000",spawnRules:[{entityType:"entity",amount:5},{entityType:"barrel",amount:5},{entityType:"food",amount:2}]},{color:"#054213",x:1,y:0,w:18,h:19,cielingColorFront:"#6495ed",cielingColorBack:"#6495ed",floorColorBack:"#03210a",fogColor:"#101b2e",spawnRules:[]}]},{name:"TowerFloor1",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,1,1,1,1,1,0,0,1,1,1,1,1,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,3,3,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,3,3,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,6,1,1,1,1,0,0,1,6,1,1,1,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,1,1,1,1,1,1,6,1,1,1,1,1,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,1,1,1,1,1,1,0,0,0,1,0,0,1],[1,0,0,1,1,1,1,1,0,0,0,0,1,1,1,1,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,4,4,1,1,1,1,1,1,1,1,1]],exitPos:{x:10,y:17},startPos:{x:5.5,y:4.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#000000",floorColorBack:"#000000",zones:[{color:"#101b2e",x:0,y:0,w:1,h:1}]},{name:"Gallery",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,4,4,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,0,0,0,3,1],[1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,3,1,0,0,0,0,0,1],[1,1,0,0,0,7,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,2,0,0,1],[1,1,1,7,1,1,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,6],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0,0,2,0,0,1],[1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,0,0,2,0,0,1],[1,1,0,0,0,3,0,0,0,0,0,3,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,3,0,0,0,0,0,3,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,3,0,0,0,0,0,3,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,3,0,0,0,0,0,3,0,0,0,1,0,0,2,0,0,1],[1,1,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,0,0,2,0,0,1],[1,0,2,2,2,2,2,2,2,2,2,0,1,0,1,0,1,0,1,0,0,2,0,0,1],[4,0,2,2,2,2,2,2,2,2,2,0,6,0,6,0,6,0,6,0,0,2,0,0,1],[1,0,2,2,2,2,2,2,2,2,2,0,1,0,1,0,1,0,1,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,3,0,0,0,3,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],exitPos:{x:3,y:3},startPos:{x:1.5,y:21.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#ECDE60",floorColorBack:"#000000",sightDist:10,zones:[{color:"#888000",cielingColorFront:"#ecde69",cielingColorBack:"#ECDE60",floorColorBack:"#000000",fogColor:"#000000",x:0,y:0,w:0,h:0,spawnRules:[]},{color:"#888000",x:2,y:2,w:4,h:7,cielingColorFront:"#ecde69",cielingColorBack:"#000000",floorColorBack:"#000000",fogColor:"#000000",spawnRules:[]},{color:"#888000",x:6,y:2,w:12,h:7,cielingColorFront:"#ecde69",cielingColorBack:"#000000",floorColorBack:"#000000",fogColor:"#000000",spawnRules:[{entityType:"ball",amount:2},{entityType:"food",amount:1}]}]},{name:"LongHallways",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,1,0,0,0,0,0,0,3,3,3,3,3,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,1,0,0,0,0,0,3,3,3,3,3,3,3,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,3,3,3,0,0,0,3,3,3,0,0,0,0,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,3,3,3,3,0,4,0,3,3,3,3,0,0,0,1,1,1],[1,7,7,1,1,6,1,1,1,6,1,1,1,6,1,1,1,6,1,1,0,0,3,3,3,3,3,0,0,0,3,3,3,3,3,0,0,1,1,1],[1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,0,1],[1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,6,0,1],[1,7,7,1,1,6,1,1,1,1,1,1,1,1,1,1,1,6,1,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,0,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,2,2,0,2,2,2,2,6,2,2,2,2,0,2,2,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,3,0,0,0,0,0,3,2,0,0,0,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,0,3,3,3,3,3,0,3,3,3,3,3,0,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,1,0,0,0,0,3,3,3,3,0,3,3,3,3,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,2,3,0,0,0,0,0,3,2,0,0,0,1,0,0,0,0,0,3,3,3,0,3,3,3,0,0,0,0,0,1,1,1],[1,7,7,1,2,2,0,2,2,2,2,6,2,2,2,2,0,2,2,1,0,0,0,0,0,0,3,3,0,3,3,0,0,0,0,0,0,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,1,1,1,1,1,1,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1],[1,7,7,1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,1,1,1],[1,7,7,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1],[1,7,7,1,0,0,6,0,3,3,3,3,3,3,3,3,3,3,3,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,1,1,1],[1,7,7,1,0,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,3,3,3,3,3,3,3,3,3,3,3,0,4,0,0,1,1,1],[1,7,7,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1],[1,7,7,1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,1,1,1],[1,7,7,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7,0,0,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,1,1],[1,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],sightDist:10,exitPos:{x:1,y:1},startPos:{x:9.5,y:3.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#000000",floorColorBack:"#000000",zones:[{color:"#101b2e",x:0,y:0,w:1,h:1}]}];function n0(t){if(!Array.isArray(t)||t.length===0)throw new Error("Array must be non-empty.");let e=N(t.length)-1;return t[e]}function N(t){if(t<=0)throw new Error("The maximum value must be greater than 0.");return Math.floor(Math.random()*t)+1}function V0(t,e,o){return t+(e-t)*o}function se(t,e){let o=t?t.length:0;if(o===0)return-1;if(e<=t[0])return 0;if(e>=t[o-1])return o-1;let n=0,i=o-1;for(;n<=i;){let a=n+i>>1,s=t[a];if(s===e)return a;s<e?n=a+1:i=a-1}return e-t[i]<=t[n]-e?i:n}function le(t){let e=t.charCodeAt(0)===35?t.slice(1):t,o=parseInt(e.length===3?e.split("").map(n=>n+n).join(""):e,16);return[o>>16&255,o>>8&255,o&255]}var q={x:10,y:8},r0={x:3.5,y:3.5};var d={MAP:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,2,6,2,0,0,0,0,0,0,0,2,6,2,0,0,1],[1,0,0,0,2,0,2,0,0,0,0,0,0,0,2,0,2,0,0,1],[1,0,0,0,2,2,2,0,0,0,0,0,0,0,2,2,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,5,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,3,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,3,3,1,3,3,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,0,0,0,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,2,2,2,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,1,0,2,0,2,0,1,0,3,0,0,0,1],[1,0,0,0,0,0,0,0,0,2,6,2,0,0,0,0,0,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],MAP_W:-1,MAP_H:-1,cielingColorFront:"",floorColorFront:"",cielingColorBack:"",floorColorBack:"",dontPersist:!1,sightDist:15,zones:[{color:"#101b2e",x:0,y:0,w:1,h:1}]},O0=ae,ce=new Map;function fe(t){let e=d.zones,o=e&&e[t]?.color||o0,n=ce.get(o);return n||(n=le(o),ce.set(o,n)),n}function h0(t,e,o){for(let n=0;n<o.length;n++){let i=o[n],a=Math.min(i.x,i.x+i.w),s=Math.max(i.x,i.x+i.w)-1,l=Math.min(i.y,i.y+i.h),f=Math.max(i.y,i.y+i.h)-1;if(t>=a&&t<=s&&e>=l&&e<=f)return n}return 0}var i0=new Float32Array(C),U=w>>1,q0=new Int16Array(C).fill(U),pt=new Float32Array(w);function ro(){let t=U;for(let e=0;e<w;e++){let o=e-U;pt[e]=o!==0?t/o*(2-r.calculatePlayerHeight()):1e-6}}ro();var ut=[],mt=[],ht=[],U0=[],gt=[];function pe(){ut.length=0,mt.length=0,ht.length=0,U0.length=0,xt.clear()}function dt(t,e,o,n,i,a,s,l,f,c){if(!i)return;let y=n-o;if(y<=0)return;let h=l||0,m=h<0?0:h>i.height?i.height:h,g=f||i.height,S=i.height-m,E=g<0?0:g>S?S:g,b=se($0,s);t.drawImage(z0[c][$0[b]],a,m,1,E,e,o,1,y)}function ue(t){let e=r.x|0,o=r.y|0,n=h0(e,o,d.zones),i=ut[n];if(!i){i=t.createLinearGradient(0,0,0,U);let a=d.zones[n].cielingColorFront,s=d.zones[n].cielingColorBack,l=d.zones[n].fogColor;i.addColorStop(0,a||d.cielingColorFront||"#6495ED"),d.cielingColorBack&&i.addColorStop(.5,s||d.cielingColorBack||"#6495ED"),i.addColorStop(.9,l||o0),ut[n]=i}t.fillStyle=i,t.fillRect(0,0,C,U)}var xt=new Map;function de(t){let e=xt.get(t);if(!e){let[o,n,i]=fe(t);e=`rgb(${o|0},${n|0},${i|0})`,xt.set(t,e)}return e}function me(){gt.length=0;let t=d.zones,e=d.MAP_W,o=d.MAP_H;for(let n=0;n<o;n++)for(let i=0;i<e;i++)gt[n*e+i]=h0(i,n,t)}function he(t,e,o,n=0){let{dirX:i,dirY:a,planeX:s,planeY:l}=e;n=q0[o]??0;let f=n<U?U:n;if(f>=w)return;let c=2*(o+.5)/C-1,y=i+s*c,h=a+l*c,m=1/(i*y+a*h),g=pt[f],S=r.x+y*g*m,E=r.y+h*g*m,b=0,B=f,G=null;for(let F=f;F<w;F++){let _=S|0,O=E|0,v=0;if(f===U&&F===U?v=0:v=_>=0&&O>=0&&_<d.MAP_W&&O<d.MAP_H?gt[O*d.MAP_W+_]:0,v!==b){let l0=de(b);l0!==G&&(p.fillStyle=l0,G=l0),p.fillRect(o,B,1,F-B),b=v,B=F}let k=pt[F+1]??g,V=k-g;S+=y*V*m,E+=h*V*m,g=k}let Y=de(b);Y!==G&&(p.fillStyle=Y),p.fillRect(o,B,1,w-B)}function ge(t){let e=ht[0];e||(e=t.createLinearGradient(0,0,0,w),e.addColorStop(0,"rgba(16,27,46,0.08)"),e.addColorStop(.5,"rgba(16,27,46,0.16)"),e.addColorStop(1,"rgba(16,27,46,0.20)"),ht[0]=e),t.fillStyle=e,t.fillRect(0,0,C,w)}function xe(t){let e=U-1,o=w-e,n=r.x|0,i=r.y|0,a=h0(n,i,d.zones),s=mt[a];if(!s){let l=d.zones[a].floorColorBack;s=t.createLinearGradient(0,e,0,w),s.addColorStop(.05,d.zones[a].fogColor||o0),s.addColorStop(.15,l||d.floorColorBack||"#03210A"),s.addColorStop(1,"rgba(0,0,0,0)"),mt[a]=s}t.fillStyle=s,t.fillRect(0,e,C,o)}function ye(t,e,o,n,i){let{dirX:a,dirY:s,planeX:l,planeY:f}=e;for(let c=0;c<C;c++){let y=2*(c+.5)/C-1,h=a+l*y,m=s+f*y;if(h<1e-8&&h>-1e-8&&m<1e-8&&m>-1e-8){i0[c]=Number.POSITIVE_INFINITY,q0[c]=0;continue}let g=1/(h||1e-9),S=1/(m||1e-9),E=r.x|0,b=r.y|0,B=g<0?-g:g,G=S<0?-S:S,Y,F,_,O;h<0?(Y=-1,_=(r.x-E)*B):(Y=1,_=(E+1-r.x)*B),m<0?(F=-1,O=(r.y-b)*G):(F=1,O=(b+1-r.y)*G);let v=0,k=1,V=!1,l0=0,ze=0;for(;!V&&l0++<256;){if(_<O?(_+=B,E+=Y,v=0):(O+=G,b+=F,v=1),r.sightDist>0){let t0=Math.min(_,O);if(t0>r.sightDist){V=!1,k=0,ze=t0;break}}if(E<0||b<0||E>=n||b>=i){V=!0,k=1;break}let X=o[b][E];if(X>0){V=!0,k=X;break}}if(k===0){i0[c]=Number.POSITIVE_INFINITY,q0[c]=0;continue}let R;v===0?R=_-B:R=O-G,R=st>R?st:R;let It=0,$e=v===0?Y:0,Ve=v===1?F:0,Lt=Math.abs($e*a+Ve*s)>=.9&&Math.abs(y)<=.9&&R<It?It:R,Ht=r.x+Lt*h,Bt=r.y+Lt*m,c0;v===0?c0=Bt-(Bt|0):c0=Ht-(Ht|0),c0=c0<0?0:c0>.999999?.999999:c0+1e-6;let Q0=P0[k]||P0[4],Q=$[k],Y0=Q?Q.width|0:Q0.w|0,j=c0*Y0|0;(v===0&&Y>0||v===1&&F<0)&&(j=Y0-j-1),j=j<0?0:j>=Y0?Y0-1:j;let qe=R<lt?lt:R,E0=w/qe|0,T0=(w-E0*r.calculatePlayerHeight())/2|0,Yt=T0+E0,f0=T0,w0=Yt;f0<0&&(f0=0),w0>w&&(w0=w);let Xt=w0-f0;if(q0[c]=w0,Xt<=0){i0[c]=R;continue}let Nt=(Q?Q.height:Q0.h||$[k]?.height||64)|0,Ue=(f0-T0)*(Nt/(E0>1?E0:1)),Ze=Xt*(Nt/Math.max(1,E0)),X0=1/(1+R*.25)*(v?.5:1);k===7&&(X0*=.8+.2*Math.sin(t*6+c*.05)),dt(p,c,f0,w0,Q,j,X0,Ue,Ze,k);let tt=ne[k]||1;if(tt>1){let X=E0,t0=(Q?.height||Q0.h||64)|0,d0=t0/Math.max(1,X),b0=Math.floor(tt)-1;for(let e0=0;e0<b0;e0++){let M0=T0-X*(e0+1),et=Yt-X*(e0+1),p0=Math.max(0,Math.ceil(M0)),k0=Math.min(w,Math.floor(et)),v0=k0-p0;if(v0<=0)continue;let ot=(p0-M0)*d0,F0=v0*d0;dt(p,c,p0,k0,Q,j,X0,ot,F0,1)}let N0=tt-(1+b0);if(N0>1e-6){let e0=X*N0,M0=T0-X*b0,et=M0-e0,p0=Math.max(0,Math.ceil(et)),k0=Math.min(w,Math.floor(M0)),v0=k0-p0;if(v0>0){let ot=M0-X,F0=(p0-ot)*d0%t0;F0<0&&(F0+=t0);let Ke=v0*d0;dt(p,c,p0,k0,Q,j,X0,F0,Ke,1)}}}if(r.sightDist>0&&R>r.sightDist*A0){let X=r.sightDist*A0,t0=r.sightDist,d0=Math.min(1,Math.max(0,(R-X)/Math.max(1e-6,t0-X)));if(d0>0){let b0=r.x|0,N0=r.y|0,e0=h0(b0,N0,d.zones);p.save(),p.globalAlpha=d0*.85,p.fillStyle=d.zones[e0].fogColor||o0,p.fillRect(c,f0,1,w0-f0),p.restore()}}i0[c]=R}}var M={aiDrone1:null,ball:null,sparkle:null,barrel:null,food:null,keycard1:null,aiDrone2:null,aiDrone3:null,pitchfork:null,bow:null};async function Z(t,e){return await io(t,e,1)}async function io(t,e=1,o=1){let n=`../assets/gfx/${t}`;return new Promise((i,a)=>{let s=new Image;s.onload=()=>{let l=new OffscreenCanvas(s.width*e,s.height*e),f=l.getContext("2d");f.imageSmoothingEnabled=!1,f.drawImage(s,0,0,l.width,l.height),l.baseline=o,l.scale=e,i(l)},s.onerror=()=>a(new Error(`Failed to load sprite: ${n}`)),s.src=n})}async function Ee(){M.food=await Z("noodles.png",3),M.bow=await Z("bow.png",3),M.pitchfork=await Z("pitchfork.png",3),M.keycard1=await Z("keycard1.png",3),M.barrel=await Z("emp.png",3),M.aiDrone1=await Z("aiDrone1.png",3),M.aiDrone2=await Z("aiDrone2.png",3),M.aiDrone3=await Z("aiDrone3.png",3),M.ball=await Z("Palantrash1.png",3),M.sparkle=await Z("sparkle.png",3)}var T=[];function ao(t){return w/t}function so(t,e,o){let{dirY:n,dirX:i,planeY:a,planeX:s,invDet:l}=o,f=l*(n*t-i*e),c=l*(-a*t+s*e);return{transX:f,transY:c}}function lo(t,e){return Math.round((C>>1)*(1+t/e))}function R0(t,e){let o=t.x-r.x,n=t.y-r.y,{transX:i,transY:a}=so(o,n,e);if(a<=.01)return null;let s=lo(i,a),l=t&&typeof t.scale=="number"?t.scale:t&&M[t.img]&&typeof M[t.img].scale=="number"?M[t.img].scale:1,f=ao(a)*l,c=typeof t._hR=="number"?t._hR:Math.round(f),y=.1,h=c;(f>c+y||f<c-y)&&(h=Math.round(f)),t._hR=h;let m=h,g=M[t.img],S=g&&g.width&&g.height?g.width/g.height:1,E=Math.max(1,Math.round(m*S)),b=w,B=r.calculatePlayerHeight(),G=w*.5,Y,F;if(t.ground){let k=t.floorBiasFrac??.04,V=G+w*(2-B)/(2*a)-k*m,l0=V-m;Y=Math.round(l0),F=Math.round(V)}else{let k=Math.round(G-m*.5);Y=k,F=k+m}let _={startY:Y,endY:F},O=Math.round(s-(E>>1)),v=O+E;return{drawStartX:O,drawEndX:v,drawStartY:_.startY,drawEndY:_.endY,depth:a,size:m,width:v-O}}var we={0:"#0c1220",1:"#ECDE60",2:"#707a88",3:"#00e676",4:"#996633",5:"#FFE300",6:" #3561ff",7:"#00FFFF"},yt={[u.entity]:"#ffeb9c",[u.barrel]:"#CD1C18",[u.key]:"#6aa2ff",[u.food]:"#7fffd4",default:"#ffffff"};var W=6,g0=20,K=2,Me=Math.floor(g0/2);z.width=K+g0*W+K;z.height=K+g0*W+K;function Ae(t){D.clearRect(0,0,z.width,z.height);let e=Math.max(0,Math.min((r.x|0)-Me,d.MAP_W-g0)),o=Math.max(0,Math.min((r.y|0)-Me,d.MAP_H-g0));for(let l=0;l<g0;l++)for(let f=0;f<g0;f++){let c=o+l,y=e+f,h=d.MAP[c]?.[y]??0,m=we[h]||"#000000";D.fillStyle=m,D.fillRect(K+f*W,K+l*W,W-1,W-1)}for(let l of t){if(!l.alive)continue;let f=K+(l.x-e)*W,c=K+(l.y-o)*W;D.fillStyle=yt[l.type]||yt.default,D.fillRect(f-2,c-2,4,4)}let n=K+(r.x-e)*W,i=K+(r.y-o)*W;D.fillStyle="#e7f3ff",D.beginPath(),D.arc(n,i,2.5,0,Wt),D.fill();let a=Math.cos(r.a),s=Math.sin(r.a);D.strokeStyle="#78f3d3",D.beginPath(),D.moveTo(n,i),D.lineTo(n+a*1.5*W,i+s*1.5*W),D.stroke()}var A=null,x0=null,L=null,Et=null,Ce=null;function Mt(){A||(A=new(window.AudioContext||window.webkitAudioContext))}function I({freq:t=440,dur:e=.1,type:o="square",vol:n=.2,slide:i=0}){if(!A)return;let a=A.createOscillator(),s=A.createGain();a.type=o,a.frequency.value=t,s.gain.value=n,a.connect(s).connect(A.destination);let l=A.currentTime;i&&(a.frequency.setValueAtTime(t,l),a.frequency.linearRampToValueAtTime(t+i,l+e)),s.gain.setValueAtTime(n,l),s.gain.exponentialRampToValueAtTime(.001,l+e),a.start(l),a.stop(l+e)}function wt({dur:t=.2,vol:e=.2,lp:o=1200}){if(!A)return;let n=A.createBuffer(1,A.sampleRate*t,A.sampleRate),i=n.getChannelData(0);for(let c=0;c<i.length;c++)i[c]=Math.random()*2-1;let a=A.createBufferSource(),s=A.createGain(),l=A.createBiquadFilter();a.buffer=n,s.gain.value=e,l.type="lowpass",l.frequency.value=o,a.connect(l).connect(s).connect(A.destination);let f=A.currentTime;a.start(f),a.stop(f+t)}var P={shot:()=>{let t=N(50),e=-N(50);I({freq:220+t+e,dur:.05+N(3)/100,type:"square",vol:.25,slide:120}),wt({dur:.03+N(3)/100,vol:.15,lp:800})},pickup:()=>{I({freq:880,dur:.06,type:"triangle",vol:.2}),I({freq:1180,dur:.08,type:"triangle",vol:.18})},explode:()=>{wt({dur:1,vol:.3,lp:800}),I({freq:90,dur:.7,type:"sawtooth",vol:.12,slide:-60})},hurt:()=>{I({freq:140,dur:.12,type:"sawtooth",vol:.2,slide:-50})},killedEntity:()=>{let t=Math.random()*16-8;I({freq:320+t,dur:.26,type:"triangle",vol:.3,slide:-220}),I({freq:480+t,dur:.22,type:"sawtooth",vol:.1,slide:-260}),I({freq:90,dur:.08,type:"sine",vol:.18}),wt({dur:.05,vol:.1,lp:1e3}),setTimeout(()=>{I({freq:170+t,dur:.07,type:"triangle",vol:.16,slide:70})},90)},door:()=>{I({freq:420,dur:.12,type:"square",vol:.15})},portal:()=>{I({freq:600,dur:.5,type:"sawtooth",vol:.2}),I({freq:400,dur:.3,type:"sawtooth",vol:.2,slide:50}),I({freq:600,dur:.5,type:"sawtooth",vol:.2})}};async function co(t,{volume:e=.15}={}){if(A)try{if(!Et||t!==Ce){let n=await(await fetch(t,{cache:"force-cache"})).arrayBuffer();Et=await A.decodeAudioData(n),Ce=t}Se(),L=A.createBufferSource(),L.buffer=Et,L.loop=!0,x0=A.createGain(),x0.gain.value=e,L.connect(x0).connect(A.destination),L.start()}catch(o){try{Se();let n=new Audio(t);n.loop=!0,n.volume=Math.max(0,Math.min(1,e)),await n.play(),L={stop:()=>n.pause(),disconnect:()=>{}},x0=null}catch(n){}}}function Se(){try{L&&L.stop(0)}catch(t){}if(L&&L.disconnect)try{L.disconnect()}catch(t){}if(x0)try{x0.disconnect()}catch(t){}L=null,x0=null}var Te=!1;async function At(){if(!A||L||Te)return;Te=!0,await co("../assets/sfx/HexenST02SLowed.ogg",{volume:.12})}function y0(t,e){if(t<0||e<0||t>=d.MAP_W||e>=d.MAP_H)return!0;let o=d.MAP[e|0][t|0];return o===0||o===5?!1:o===7?!r.hasBlueKey:!(o===6||o===9)}function a0(t,e,o){return!!(y0(t,e)||y0(t-o,e)||y0(t+o,e)||y0(t,e-o)||y0(t,e+o))}var C0={EXPLOSION:"explosion",SCREEN_FLASH:"screen_flash"},fo={[C0.EXPLOSION]:{lifetime:.5,startRadius:.1,endRadius:1,expansionTime:.4,startOpacity:1,endOpacity:0,primaryColor:{h:30,s:90,l:60},secondaryColor:{h:15,s:85,l:50},glowColor:{h:45,s:100,l:75},fillColor:{h:25,s:80,l:40},ringLineWidth:3,glowLineWidth:2,innerLineWidth:1,renderFunction:yo,ignoreBounds:!1},[C0.SCREEN_FLASH]:{lifetime:.15,startOpacity:.85,endOpacity:0,color:"#ffffff",renderFunction:Eo,ignoreBounds:!0}},_0=[];function be(t,e,o,n,i={}){let a=fo[t];if(!a)return console.warn(`Unknown effect type: ${t}`),null;let s={ignoreBounds:!1,type:t,x:e,y:o,radius:n,maxRadius:n,age:0,lifetime:i.lifetime??a.lifetime,opacity:i.startOpacity??a.startOpacity,startOpacity:i.startOpacity??a.startOpacity,endOpacity:i.endOpacity??a.endOpacity,...a,...i};return _0.push(s),s}function ke(t,e,o,n={}){return be(C0.EXPLOSION,t,e,o,n)}function Ct({color:t="#ffffff",duration:e=.15,alpha:o=.85}={}){be(C0.SCREEN_FLASH,0,0,1,{lifetime:e,startOpacity:o,endOpacity:0,color:t,ignoreBounds:!0})}function ve(t){for(let e=_0.length-1;e>=0;e--){let o=_0[e];o.age+=t;let n=Math.min(o.age/o.lifetime,1);po(o,n),o.age>=o.lifetime&&_0.splice(e,1)}}function po(t,e){switch(t.type){case C0.EXPLOSION:uo(t,e);break;case C0.SCREEN_FLASH:mo(t,e);break}}function uo(t,e){t.opacity=V0(t.startOpacity,t.endOpacity,e);let o=Math.min(e/t.expansionTime,1),n=V0(t.startRadius,t.endRadius,o);t.radius=t.maxRadius*n}function mo(t,e){let o=1-(1-e)*(1-e);t.opacity=V0(t.startOpacity,t.endOpacity,o)}function ho(){return _0}function Fe(t,e,o,n,i){let a=ho();if(a.length!==0){t.save();for(let s of a)go(t,s,e,o,n,i);t.restore()}}function go(t,e,o,n,i,a){let s=xo(e.x,e.y,o,n,i,a,e.ignoreBounds);!s&&!e.ignoreBounds||e.renderFunction(t,e,s)}function xo(t,e,o,n,i,a,s=!1){let l=t-a.x,f=e-a.y,{dirY:c,dirX:y,planeY:h,planeX:m,invDet:g}=o,S=g*(c*l-y*f),E=g*(-h*l+m*f);return E<=.1&&!s?null:s?{x:n/2,y:i/2,radius:i,depth:E}:{x:n/2*(1+S/E),y:i/2+64,radius:i/E*.5,depth:E}}function yo(t,e,o){let n=o.radius*e.radius,i=performance.now()*.001,a=Math.sin(i*8)*12,s=Math.sin(i*12)*.15+1,l=o.y,f=o.x;t.globalAlpha=e.opacity*.3,t.fillStyle=`hsl(${e.fillColor.h+a*.5}, ${e.fillColor.s}%, ${e.fillColor.l}%)`,t.beginPath(),t.arc(f,l,n*.7,0,2*Math.PI),t.fill(),t.globalAlpha=e.opacity*.5,t.strokeStyle=`hsl(${e.glowColor.h+a}, ${e.glowColor.s}%, ${e.glowColor.l}%)`,t.lineWidth=e.glowLineWidth*1.5,t.beginPath(),t.arc(f,l,n*s,0,2*Math.PI),t.stroke(),t.globalAlpha=e.opacity*.85,t.strokeStyle=`hsl(${e.primaryColor.h+a*.8}, ${e.primaryColor.s}%, ${e.primaryColor.l}%)`,t.lineWidth=e.ringLineWidth,t.beginPath(),t.arc(f,l,n*.9,0,2*Math.PI),t.stroke(),t.globalAlpha=e.opacity*.6,t.strokeStyle=`hsl(${e.secondaryColor.h+a*1.3}, ${e.secondaryColor.s}%, ${e.secondaryColor.l}%)`,t.lineWidth=e.innerLineWidth,t.beginPath(),t.arc(f,l,n*.5,0,2*Math.PI),t.stroke()}function Eo(t,e){if(e.opacity<=0)return;let o=t.canvas.width,n=t.canvas.height;t.save(),t.globalAlpha=e.opacity,t.fillStyle=e.color||"#ffffff",t.fillRect(0,0,o,n),t.restore()}var L0={[u.entity]:{type:u.entity,ground:!0,scale:.66,floorBiasFrac:0,animationTime:0,animationFrame:0,img:"aiDrone1"},[u.ball]:{type:u.ball,ground:!1,scale:.75,floorBiasFrac:0,cooldownTime:.5,health:3,img:"ball"},[u.sparkle]:{type:u.sparkle,ground:!1,scale:.75,floorBiasFrac:0,cooldownTime:3,img:"sparkle"},[u.barrel]:{type:u.barrel,ground:!0,scale:.66,floorBiasFrac:0,img:"barrel"},[u.food]:{type:u.food,ground:!0,scale:.25,floorBiasFrac:0,img:"food"},[u.key]:{type:u.key,ground:!0,scale:.25,floorBiasFrac:0,img:"keycard1"}},St=null,I0=null;function De(t,e){St=t,I0=e}var H0={[u.ball]:{ai(t,e){if(!t.alive)return;t.cooldownTime-=e,t.cooldownTime<=0&&(t.cooldownTime=.5,St&&T.push(St(u.sparkle,{x:t.x,y:t.y})));let o=r.x-t.x,n=r.y-t.y,i=Math.hypot(o,n);if(i>.3){let a=1*e,s=o/i,l=n/i,f=t.x+s*a,c=t.y+l*a;a0(f,t.y,.4)||(t.x=f),a0(t.x,c,.4)||(t.y=c)}i<.6&&t.hurtCD<=0&&(r.health=Math.max(0,r.health-3.33)|0,J(),x("Ball attacks!"),P.hurt(),t.hurtCD=.8,Ct({color:"	#740707",duration:.5}),bt()),t.hurtCD>0&&(t.hurtCD-=e)},onHit(t,e){e?t.health>1?(x(n0(["Ball Hit!"])),t.health-=1,P.killedEntity()):(t.alive=!1,x(n0(["Ball Busted!"])),P.killedEntity()):x("No arrows.")},onTouch(t){Z0(u.entity,1e4)&&x("You hear something like echoes nearby...")},onExplode(t){t.alive=!1,P.killedEntity(),x("The ball is blown to bits.")}},[u.sparkle]:{ai(t,e){t.alive&&(t.cooldownTime-=e,t.cooldownTime<=0&&(t.alive=!1))}},[u.entity]:{ai(t,e){if(!t.alive)return;switch(t.animationTime+=e,t.animationTime>.2&&(t.animationTime-=.2,t.animationFrame+=1,t.animationFrame%=4),t.animationFrame){case 0:t.img="aiDrone1";break;case 1:t.img="aiDrone2";break;case 2:t.img="aiDrone3";break;case 3:t.img="aiDrone2";break}let o=r.x-t.x,n=r.y-t.y,i=Math.hypot(o,n);if(i>.3){let a=1.5*e,s=o/i,l=n/i,f=t.x+s*a,c=t.y+l*a;a0(f,t.y,.4)||(t.x=f),a0(t.x,c,.4)||(t.y=c)}i<.6&&t.hurtCD<=0&&(r.health=Math.max(0,r.health-3.33)|0,J(),x("Entity attacks!"),P.hurt(),t.hurtCD=.8,Ct({color:"	#740707",duration:.5}),bt()),t.hurtCD>0&&(t.hurtCD-=e)},onHit(t,e){e?(t.alive=!1,x(n0(["Entity murdered!","Entity destroyed!","Entity purged!"])),P.killedEntity()):x("No arrows.")},onTouch(t){Z0(u.entity,1e4)&&x("You hear something like water nearby...")},onExplode(t){t.alive=!1,P.killedEntity(),x("The entity is blown to gibs.")}},[u.barrel]:{onHit(t,e){e?(t.alive=!1,I0&&I0(t.x,t.y,2.5),x("Kaboom!"),P.explode()):x("No arrows.")},onTouch(t){Z0(u.barrel,1e4)&&x("Shooting this barrel may yield useful results...")},onExplode(t){t.alive=!1,I0&&I0(t.x,t.y,2.5)}},[u.food]:{onTouch(t){t.alive=!1;let e=r.health>=r.maxHealth;e&&(r.maxHealth+=1),r.health=u0(r.health+10,0,r.maxHealth),x(e?"Yummy!":"Health restored."),J(),P.pickup()},onExplode(t){}},[u.key]:{onTouch(t){t.alive=!1,r.hasBlueKey=!0,P.door(),x("Keycard found! Find the exit!"),Tt()},onExplode(t){t.alive=!1,r.hasBlueKey=!0,P.door(),x("The forcefield protecting the exit has suddenly lifted!"),Tt()}}};Object.freeze(L0);for(let t in L0)Object.freeze(L0[t]);Object.freeze(H0);for(let t in H0)Object.freeze(H0[t]);var wo=L0,Mo=H0,Ao=0;function s0(t,e={x:0,y:0},o=void 0){let n=wo[t],i=Mo[t],a=Object.assign(Object.create(i),n);return a.id=Ao++,a.x=e.x,a.y=e.y,a.dist=0,a.alive=!0,a.hurtCD=0,o&&Object.assign(a,o),a}function Co(t,e,o){ke(t,e,o);for(let n of T){if(!n.alive)continue;Math.hypot(n.x-t,n.y-e)<o&&(n.onExplode?n.onExplode(n):n.alive=!1)}}De(s0,Co);var kt=0,H=new Set,So=0,vt=!1;function Re(t){window.addEventListener("keydown",e=>{if(H.add(e.code),Mt(),At(),e.code==="Space"&&(e.preventDefault(),Pe()),e.code==="KeyM"&&(e.preventDefault(),z.classList.toggle("visible")),e.code==="Enter"&&(!!document.pointerLockElement||!!document.mozPointerLockElement||!!document.webkitPointerLockElement?document.exitPointerLock?document.exitPointerLock():document.mozExitPointerLock?document.mozExitPointerLock():document.webkitExitPointerLock&&document.webkitExitPointerLock():t.requestPointerLock?t.requestPointerLock():t.mozRequestPointerLock?t.mozRequestPointerLock():t.webkitRequestPointerLock&&t.webkitRequestPointerLock()),e.code==="Escape"&&(document.exitPointerLock?document.exitPointerLock():document.mozExitPointerLock?document.mozExitPointerLock():document.webkitExitPointerLock&&document.webkitExitPointerLock()),e.code==="BracketLeft")switch(r.mouseSensitivity){case .33:x("Mouse sensitivity set to high."),r.mouseSensitivity=.22;break;case .22:x("Mouse sensitivity set to medium."),r.mouseSensitivity=.11;break;case .11:x("Mouse sensitivity set to low."),r.mouseSensitivity=.05;break;case .05:x("Mouse sensitivity already lowest."),r.mouseSensitivity=.05;break}if(e.code==="BracketRight")switch(r.mouseSensitivity){case .33:x("Mouse sensitivity already set to highest."),r.mouseSensitivity=.33;break;case .22:x("Mouse sensitivity set to highest."),r.mouseSensitivity=.33;break;case .11:x("Mouse sensitivity set to high."),r.mouseSensitivity=.22;break;case .05:x("Mouse sensitivity set to medium."),r.mouseSensitivity=.11;break}}),window.addEventListener("keyup",e=>H.delete(e.code)),t.addEventListener("mousedown",e=>{e.button===0&&Pe(),So=e.clientX,Mt(),At()}),t.addEventListener("mousemove",e=>{if(!!document.pointerLockElement||!!document.mozPointerLockElement||!!document.webkitPointerLockElement){let n=e.movementX*Math.PI*(.015*r.mouseSensitivity);r.a+=n}}),Ut.onclick=()=>Fo(),Zt.onclick=()=>z.classList.toggle("visible")}function _e(t){let e=H.has("ShiftLeft")||H.has("ShiftRight"),o=r.rotSpeed*t,n=r.accel*t,i=Math.cos(r.a),a=Math.sin(r.a),s=-a,l=i;r.weaponAnim>.75&&(r.weaponAnim=-1),r.weaponAnim>=0&&(r.weaponAnim+=t);let f=3;r.velX-=r.velX*f*t,r.velY-=r.velY*f*t,Math.abs(r.velX)<.002&&(r.velX=0),Math.abs(r.velY)<.002&&(r.velY=0),r.isMoving=!1;let c=0,y=0;H.has("ArrowLeft")&&(r.a-=o),H.has("ArrowRight")&&(r.a+=o),(H.has("ArrowUp")||H.has("KeyW"))&&(c+=i*n,y+=a*n,r.isMoving=!0),(H.has("ArrowDown")||H.has("KeyS"))&&(c-=i*n,y-=a*n,r.isMoving=!0),H.has("KeyA")&&(c-=s*n,y-=l*n,r.isMoving=!0),H.has("KeyD")&&(c+=s*n,y+=l*n,r.isMoving=!0),r.velX+=c,r.velY+=y;let h=Math.hypot(r.velX,r.velY);h>20&&(r.velX*=20/h,r.velY*=20/h);let m=r.x+r.velX*t,g=r.y+r.velY*t;a0(m,r.y,ct)?r.velX=0:r.x=m,a0(r.x,g,ct)?r.velY=0:r.y=g}function Pe(){if(r.weaponAnim>=0)return;r.weaponAnim=0,J(),P.shot();let t=G0(),e=To(t);!e||R0(e,t).depth>2.5||e.onHit&&e.onHit(e,!0)}function Ie(){for(let t of T)!t.alive||Math.hypot(t.x-r.x,t.y-r.y)>=.6||t.onTouch&&t.onTouch(t)}function Le(){if(vt)return;let t=r.x|0,e=r.y|0;d.MAP[e][t]===5&&(P.portal(),x(`Floor ${m0} cleared.`),ft(m0+1),vt=!0,r.velX=0,r.velY=0,setTimeout(()=>{vo(!0),vt=!1},100))}function To(t){let o=document.getElementById("view").width>>1|0,n=i0[o]||1e9,i=null,a=1e9;for(let s of T){if(!s.alive)continue;let l=R0(s,t);l&&(r.sightDist>0&&l.depth>r.sightDist||o>=l.drawStartX&&o<l.drawEndX&&l.depth<n+.1&&l.depth<a&&(i=s,a=l.depth))}return i}function B0(t=2){let e=0;for(;e++<200;){let o=(Math.random()*(d.MAP_W-2)|0)+1,n=(Math.random()*(d.MAP_H-2)|0)+1;if(d.MAP[n][o]!==0)continue;let i=o+.5-r.x,a=n+.5-r.y;if(!(Math.hypot(i,a)<t))return{x:o,y:n}}return{x:9,y:9}}var Dt=new Map;function He(){Dt.clear();let{MAP_W:t,MAP_H:e,MAP:o,zones:n}=d;for(let i=0;i<n.length;i++){let a=n[i],s=Math.min(a.x,a.x+a.w),l=Math.max(a.x,a.x+a.w)-1,f=Math.min(a.y,a.y+a.h),c=Math.max(a.y,a.y+a.h)-1,y=u0(s,0,t-1),h=u0(l,0,t-1),m=u0(f,0,e-1),g=u0(c,0,e-1),S=[];for(let E=m;E<=g;E++)for(let b=y;b<=h;b++)y0(b,E)||S.push({x:b,y:E});Dt.set(i,S)}}function bo(t){let e=Dt.get(t);return!e||e.length===0?null:n0(e)}function Tt(){let t=d.MAP_W,e=d.MAP_H;for(let o=0;o<e;o++)for(let n=0;n<t;n++)d.MAP[o][n]===7&&(d.MAP[o][n]=0)}function Be(){let t=q.x,e=q.y;for(let o=e-1;o<=e+1;o++)for(let n=t-1;n<=t+1;n++)n===t&&o===e||(d.MAP[o][n]=7)}function Ye(){if(T.length=0,N(100)<50)for(let o=0;o<N(2)*(d.MAP_H/20|0);o++){let n=B0(1);T.push(s0(u.barrel,{x:n.x+.5,y:n.y+.5}))}let t=B0(4);T.push(s0(u.key,{x:t.x+.5,y:t.y+.5})),t=B0(4),T.push(s0(u.food,{x:t.x+.5,y:t.y+.5}));let e=Math.min((2+(m0-1)*2)*(d.MAP_H/20|0),8);for(let o=0;o<e;o++){let n=B0(3.5);T.push(s0(u.entity,{x:n.x+.5,y:n.y+.5}))}t=B0(4),T.push(s0(u.ball,{x:t.x+.5,y:t.y+.5})),d.zones.forEach((o,n)=>{let i=n;o.spawnRules?.forEach(s=>{let l=Math.max(0,s.amount|0);for(let f=0;f<l;f++){let c=bo(i);if(!c)break;T.push(s0(s.entityType,{x:c.x+.5,y:c.y+.5}))}})})}function J(){Gt.style.width=`${r.health/r.maxHealth*100}%`,zt.style.width=`${r.ammo/60*100}%`,$t.textContent=Math.max(0,r.health),Vt.textContent=r.ammo}var Ft=0,Pt=0,Ot=!1,Oe=!1;function x(t){let e=document.getElementById("gameLog"),o=e?.querySelector(".log-items");if(!o)return;let n=o.firstElementChild;if(n){let a=n.innerHTML,s=a.match(/^(.*?)(?:\s+x(\d+))?$/),l=s?s[1]:a,f=s&&s[2]?parseInt(s[2]):1;if(l===t){let c=s&&s[2]?f+1:2;n.innerHTML=`${t} x${c}`;return}}let i=document.createElement("div");i.innerHTML=t,o.prepend(i),e.classList.contains("collapsed")||requestAnimationFrame(()=>{o.scrollTop=0})}function Xe(t){Ft>0&&(Ft-=t,Ft<=0&&(qt.textContent=r.hasBlueKey?"Find the exit.":"Find the key card."))}function bt(){Ot||r.health<=0&&(Ot=!0,r.speed=0,r.rotSpeed=0,Pt=2,x("YOU DIED! Soul disconnecting from the node..."))}function Ne(t){Ot&&(Pt-=t,Pt<=0&&ko())}function ko(){if(Oe)return;Oe=!0;let t=document.getElementById("game");if(t){let e=document.createElement("div");e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100vw",e.style.height="100vh",e.style.background="#ff0000",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.zIndex="999999",e.style.fontFamily='"Courier New", monospace',e.style.opacity="0",e.style.transition="opacity 2s ease-in",e.innerHTML=`
      <div style="
        background: #000;
        border: 3px solid #04650d;
        color: #20b2db;
        width: 600px;
        max-width: 90vw;
        box-shadow: 0 0 20px #04650d;
        font-family: 'Courier New', monospace;
      ">
        <div style="
          background:#000;
          color: #04650d;
          padding: 8px 15px;
          display: flex;
          justify-content: space-between;
          font-weight: bold;
          font-size: 12px;
        ">
          <span style ="color: #FFFFFF; border: 1px solid #04650d;">Death...</span>
        </div>
        <div style="padding: 20px; min-height: 200px;">
          <div style="margin-bottom: 30px;">
            <div style="text-align: center; color: #FFFFFF; font-size: 32px; margin: 8px 0;">YOU HAVE DIED</div>
          </div>
          <div style="text-align: center; margin-top: 20px;">
            <button id="returnBtn" style="
              background: #000;
              border: 2px solid #04650d;
              color: #04650d;
              padding: 12px 24px;
              font-family: 'Courier New', monospace;
              font-size: 14px;
              font-weight: bold;
              cursor: pointer;
              text-transform: uppercase;
              letter-spacing: 1px;
            ">RETURN TO TERMINAL</button>
          </div>
        </div>
      </div>
    `,document.body.appendChild(e);let o=e.querySelector("#returnBtn");if(o){let n=!1;o.addEventListener("click",i=>{i.preventDefault(),!n&&(n=!0,setTimeout(()=>{window.location.href="../index.html"},100))})}setTimeout(()=>{e.style.opacity="1"},50),t.classList.add("game-paused"),H.clear()}}function Rt(t=!1){t&&S0(),r.x=r0.x,r.y=r0.y,r.a=0,r.hasBlueKey=!1,d.MAP[q.y][q.x]=5,Be(),Ye(),J(),x(`Floor ${m0}: Find the keycard.`)}function vo(t=!1){t&&(kt>=O0.length-1?S0():(kt+=1,S0(kt))),r.x=r0.x,r.y=r0.y,r.a=0,r.hasBlueKey=!1,d.MAP[q.y][q.x]=5,Be(),Ye(),J(),x(`Floor ${m0}: Find the keycard.`)}function Fo(){ft(1),S0(0),Rt()}function We(t){for(let e of T)e.alive&&e.ai&&e.ai(e,t)}var J0=performance.now(),j0=new Map;function Z0(t,e=0){if(e===0)return!(J0<j0.get(t));let o=J0,n=j0.get(t)??0;return o<n?!1:(j0.set(t,o+e),!0)}function Ur(t){j0.set(t,performance.now())}var _t=w>>1;Re(D0);var K0=0;function Do(t){let e=`FPS: ${Math.round(t)}`;p.save(),p.font="12px monospace",p.textAlign="right",p.textBaseline="top";let o=C-8,n=6,i=p.measureText(e).width+8,a=16;p.fillStyle="rgba(10, 15, 25, 0.6)",p.fillRect(o-i,n-2,i,a),p.strokeStyle="rgba(60, 80, 130, 0.9)",p.strokeRect(o-i+.5,n-2+.5,i-1,a-1),p.fillStyle="#dfe6ff",p.fillText(e,o,n),p.restore()}function S0(t=-1){let e;if(t!==-1){let o=O0[t];o&&(e=o.dontPersist?JSON.parse(JSON.stringify(o)):o)}else{let o=n0(O0);o&&(e=o.dontPersist?JSON.parse(JSON.stringify(o)):o)}q.x=e.exitPos.x,q.y=e.exitPos.y,r0.x=e.startPos.x,r0.y=e.startPos.y,r.sightDist=e.sightDist||te,d.cielingColorFront=e.cielingColorFront||"#6495ED",d.floorColorFront=e.floorColorFront||"#054213",d.cielingColorBack=e.cielingColorBack||"#6495ED",d.floorColorBack=e.floorColorBack||"#03210A",d.MAP=e.mapLayout,d.MAP_W=d.MAP[0].length,d.MAP_H=d.MAP.length,d.zones=e.zones,He(),pe(),me(),r.x=r.x=e.startPos.x,r.y=e.startPos.y}async function Po(){await Ee(),await ie(),S0(0),Rt(),r.maxHealth=20+N(6),r.health=r.maxHealth,r.ammo=5+N(5),J(),requestAnimationFrame(Ge)}function Oo(t){let e=G0();if(ue(p),d.zones.length<=2){let o=r.x|0,n=r.y|0,i=h0(o,n,d.zones),a=U0[i];if(!a){let s=d.zones[i].fogColor;a=p.createLinearGradient(0,w,0,_t),a.addColorStop(0,d.floorColorFront||"#054213"),a.addColorStop(.85,d.floorColorBack||"#03210A"),a.addColorStop(.95,s||o0),U0[i]=a}p.fillStyle=a,p.fillRect(0,_t,C,_t)}else{for(let o=0;o<C;o++)he(t,e,o,0);xe(p)}ge(p),ye(t,e,d.MAP,d.MAP_W,d.MAP_H),Ro(),T.sort((o,n)=>n.dist-o.dist),_o(e),Ho(t),Fe(p,e,C,w,r)}function Ro(){for(let t of T){let e=t.x-r.x,o=t.y-r.y;t.dist=e*e+o*o}}function _o(t){p.save();for(let e of T){if(!e.alive)continue;let o=R0(e,t);if(!o||r.sightDist>0&&o.depth>r.sightDist)continue;let n=Io(o);Lo(e,o,n),p.filter="none"}p.restore()}function Io(t){let e=1/(1+t.depth*.3);if(r.sightDist>0&&t.depth>r.sightDist*A0){let i=r.sightDist*A0,a=Math.min(1,Math.max(0,(t.depth-i)/Math.max(1e-6,r.sightDist-i)));e*=1-a*.6}let o=[1,.85,.7,.55,.4];return{quantizedShade:o.reduce((i,a)=>Math.abs(a-e)<Math.abs(i-e)?a:i,o[0])}}function Lo(t,e,o){o.quantizedShade<.999&&(p.filter=`brightness(${o.quantizedShade})`);let n=Math.max(1,(e.width??e.drawEndX-e.drawStartX)|0),i=e.drawStartY,a=e.drawEndY-e.drawStartY,s=c=>(c-e.drawStartX)*M[t.img].width/n|0,l=-1,f=0;for(let c=e.drawStartX;c<=e.drawEndX;c++){let h=c>=0&&c<C&&c<e.drawEndX&&e.depth<=i0[c];if(h&&l===-1&&(l=c,f=s(c)),(!h||c===e.drawEndX)&&l!==-1){let m=c,g=m-l,S=s(m);S<=f&&(S=f+1);let E=Math.min(M[t.img].width-f,S-f);g>0&&E>0&&a>0&&p.drawImage(M[t.img],f,0,E,M[t.img].height,l,i,g,a),l=-1}}}function Ho(t){if(!M.pitchfork)return;let e=Math.round(C*.42),o=Math.round(e*(M.pitchfork.height/M.pitchfork.width)),n=r.isMoving&&r.weaponAnim<0?10*Math.sin(t*5):0,i=Math.max(8,C*.02|0),a=C*.5-e/2-i/2+n,s=(r.weaponAnim+1)**10,l=s>7?7:s,f=r.weaponAnim>=0?100-l*20:0,c=r.isMoving&&r.weaponAnim<0?10*Math.sin(t*10):0,y=w-o-i+70+c+f;p.drawImage(M.pitchfork,a,y,e,o)}function Ge(t){let e=Math.min(.05,(t-J0)/1e3);J0=t;let o=e>0?1/e:0;K0=K0?K0*.9+o*.1:o,_e(e),We(e),ve(e),Ie(),Oo(t/1e3),z.classList.contains("visible")&&Ae(T),Le(),Xe(e),Ne(e),Do(K0),rt.drawImage(nt,0,0),requestAnimationFrame(Ge)}await Po().catch(console.error);export{S0 as ChangeMapLevel,Ur as resetCooldown,Z0 as tryCooldown};
