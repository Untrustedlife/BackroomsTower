import{a as x0,b as wt}from"../chunks/chunk-B3G4DJQ2.js";var ue=90*Math.PI/180,_0=ue*.5,L0=.01,Y0=.01,E=15;var l0=.95,E0=.75,e0=.6,S0="#101b2e",c0=5,f0=10,ht=3.33;var W=document.getElementById("view"),m=W.getContext("2d");l0&&l0!==1&&(W.width=Math.max(1,Math.round(W.width*l0)),W.height=Math.max(1,Math.round(W.height*l0)));var A=W.width,S=W.height,D=document.getElementById("mini"),M=D.getContext("2d");M.imageSmoothingEnabled=!1;var gt=document.getElementById("hpBar"),bt=document.getElementById("ammoBar"),Gt=document.getElementById("hpText"),yt=document.getElementById("ammoText"),xt=document.getElementById("msg"),Et=document.getElementById("btnReset"),St=document.getElementById("btnToggleMap");var a={x:3.5,y:3.5,a:0,speed:2,rotSpeed:2.6,health:6,maxHealth:6,ammo:1,hasBlueKey:!1,tenacity:20,maxTenacity:20},X0=.2,$=1,Bt=1,pe=99;function W0(t){$=Math.max(Bt,Math.min(pe,t|0||Bt))}function B0(){let t=Math.cos(a.a),e=Math.sin(a.a),o=-e*Math.tan(_0),n=t*Math.tan(_0),r=1/(o*e-t*n);return{dirX:t,dirY:e,planeX:o,planeY:n,invDet:r}}function me(t=64,e=64){let o=document.createElement("canvas");return o.width=t,o.height=e,o}var v=[null];function At(t){let o=t.getContext("2d").getImageData(0,0,t.width,t.height),n=[];for(let r=0;r<t.width;r++){let i=new Uint8ClampedArray(t.height*4);for(let l=0;l<t.height;l++){let s=(l*t.width+r)*4,c=l*4;i[c]=o.data[s],i[c+1]=o.data[s+1],i[c+2]=o.data[s+2],i[c+3]=o.data[s+3]}n.push({data:i,h:t.height})}return{cols:n,w:t.width,h:t.height}}var d0=v.map(t=>t?At(t):null);function we(){d0.length=0,v.forEach(t=>{d0.push(t?At(t):null)})}var M0=Array.from({length:82},(t,e)=>e*.0125),A0={};function he(){for(let t=1;t<v.length;t++)if(v[t]){A0[t]={};for(let e of M0){let o=document.createElement("canvas");o.width=v[t].width,o.height=v[t].height;let n=o.getContext("2d");n.drawImage(v[t],0,0);let r=e*255|0;n.globalCompositeOperation="multiply",n.fillStyle=`rgb(${r},${r},${r})`,n.fillRect(0,0,o.width,o.height),A0[t][e]=o}}}async function ge(t){let e=`../assets/gfx/${t}`;return new Promise((o,n)=>{let r=new Image;r.onload=()=>{let i=me(64,64),l=i.getContext("2d",{willReadFrequently:!0});l.imageSmoothingEnabled=!1,l.drawImage(r,0,0,64,64),o(i)},r.onerror=()=>n(new Error(`Failed to load texture: ${e}`)),r.src=e})}async function Mt(){try{await be([{index:1,image:"OfficeWall.png"},{index:2,image:"Panel.png"},{index:3,image:"Hedge.png"},{index:4,image:"OfficeDoor.png"},{index:5,image:"Portal.png"},{index:6,image:"OfficeDoorBlue.png"},{index:7,image:"Field.png"}]),we(),he()}catch(t){console.warn("Failed to init backrooms wallpaper:",t)}}async function be(t){if(!Array.isArray(t)){console.warn("Expected an array of { index, image } objects. In loadImagesToReplaceTextures");return}let e=t.map(async(o,n)=>{let{index:r,image:i}=o||{};try{let l=await ge(i);return r&&r>=0&&r<v.length?v[r]=l:v.push(l),l}catch(l){return console.warn(`Failed to load texture "${i}" for index ${r} and dont support replacing with cool gmod missing texture:`,l),null}});await Promise.all(e)}var H={x:10,y:8},V={x:3.5,y:3.5},u={MAP:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,2,6,2,0,0,0,0,0,0,0,2,6,2,0,0,1],[1,0,0,0,2,0,2,0,0,0,0,0,0,0,2,0,2,0,0,1],[1,0,0,0,2,2,2,0,0,0,0,0,0,0,2,2,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,5,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,3,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,3,3,1,3,3,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,0,0,0,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,2,2,2,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,1,0,2,0,2,0,1,0,3,0,0,0,1],[1,0,0,0,0,0,0,0,0,2,6,2,0,0,0,0,0,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],MAP_W:-1,MAP_H:-1,cielingColorFront:"",floorColorFront:"",cielingColorBack:"",floorColorBack:""},u0=[{name:"Village",mapLayout:[[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,1,2,3,4,5,6,7,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,1,1,1,1,1,6,1,1,6,1,1,1,1,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3],[3,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3]],exitPos:{x:10,y:12},startPos:{x:9.5,y:1.5}},{name:"TowerFloor1",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,1,1,1,1,1,0,0,1,1,1,1,1,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,3,3,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,3,3,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,6,1,1,1,1,0,0,1,6,1,1,1,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,1,1,1,1,1,1,6,1,1,1,1,1,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,1,1,1,1,1,1,0,0,0,1,0,0,1],[1,0,0,1,1,1,1,1,0,0,0,0,1,1,1,1,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,4,4,1,1,1,1,1,1,1,1,1]],exitPos:{x:10,y:17},startPos:{x:5.5,y:4.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#000000",floorColorBack:"#000000"},{name:"Gallery",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,4,4,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,0,0,0,3,1],[1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,3,1,0,0,0,0,0,1],[1,1,0,0,0,7,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,2,0,0,1],[1,1,1,7,1,1,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,6],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0,0,2,0,0,1],[1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,0,0,2,0,0,1],[1,1,0,0,0,3,0,0,0,0,0,3,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,3,0,0,0,0,0,3,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,3,0,0,0,0,0,3,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,3,0,0,0,0,0,3,0,0,0,1,0,0,2,0,0,1],[1,1,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,0,0,2,0,0,1],[1,0,2,2,2,2,2,2,2,2,2,0,1,0,1,0,1,0,1,0,0,2,0,0,1],[4,0,2,2,2,2,2,2,2,2,2,0,6,0,6,0,6,0,6,0,0,2,0,0,1],[1,0,2,2,2,2,2,2,2,2,2,0,1,0,1,0,1,0,1,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,3,0,0,0,3,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],exitPos:{x:3,y:3},startPos:{x:1.5,y:21.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#ECDE60",floorColorBack:"#000000"},{name:"LongHallways",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,1,0,0,0,0,0,0,3,3,3,3,3,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,1,0,0,0,0,0,3,3,3,3,3,3,3,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,3,3,3,0,0,0,3,3,3,0,0,0,0,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,3,3,3,3,0,4,0,3,3,3,3,0,0,0,1,1,1],[1,7,7,1,1,6,1,1,1,6,1,1,1,6,1,1,1,6,1,1,0,0,3,3,3,3,3,0,0,0,3,3,3,3,3,0,0,1,1,1],[1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,0,1],[1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,6,0,1],[1,7,7,1,1,6,1,1,1,1,1,1,1,1,1,1,1,6,1,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,0,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,2,2,0,2,2,2,2,6,2,2,2,2,0,2,2,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,3,0,0,0,0,0,3,2,0,0,0,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,0,3,3,3,3,3,0,3,3,3,3,3,0,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,1,0,0,0,0,3,3,3,3,0,3,3,3,3,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,2,3,0,0,0,0,0,3,2,0,0,0,1,0,0,0,0,0,3,3,3,0,3,3,3,0,0,0,0,0,1,1,1],[1,7,7,1,2,2,0,2,2,2,2,6,2,2,2,2,0,2,2,1,0,0,0,0,0,0,3,3,0,3,3,0,0,0,0,0,0,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,1,1,1,1,1,1,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1],[1,7,7,1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,1,1,1],[1,7,7,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1],[1,7,7,1,0,0,6,0,3,3,3,3,3,3,3,3,3,3,3,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,1,1,1],[1,7,7,1,0,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,3,3,3,3,3,3,3,3,3,3,3,0,4,0,0,1,1,1],[1,7,7,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1],[1,7,7,1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,1,1,1],[1,7,7,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7,0,0,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,1,1],[1,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],exitPos:{x:1,y:1},startPos:{x:9.5,y:3.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#000000",floorColorBack:"#000000"}];function C0(t){if(!Array.isArray(t)||t.length===0)throw new Error("Array must be non-empty.");let e=T(t.length)-1;return t[e]}function T(t){if(t<=0)throw new Error("The maximum value must be greater than 0.");return Math.floor(Math.random()*t)+1}function T0(t,e,o){return t+(e-t)*o}function Ct(t,e){let o=t?t.length:0;if(o===0)return-1;if(e<=t[0])return 0;if(e>=t[o-1])return o-1;let n=0,r=o-1;for(;n<=r;){let i=n+r>>1,l=t[i];if(l===e)return i;l<e?n=i+1:r=i-1}return e-t[r]<=t[n]-e?r:n}var q=new Float32Array(A);function Ge(t,e,o,n,r,i,l,s,c,f){if(!f||!r)return;let h=n-o;if(h<=0)return;let d=s||0,p=d<0?0:d>r.height?r.height:d,g=c||r.height,G=r.height-p,w=g<0?0:g>G?G:g,b=Ct(M0,l);t.drawImage(A0[f][M0[b]],i,p,1,w,e,o,1,h)}var p0=S>>1;function Tt(t){let e=t.createLinearGradient(0,0,0,p0);e.addColorStop(0,u.cielingColorFront||"#6495ED"),u.cielingColorBack&&e.addColorStop(.5,u.cielingColorBack||"#6495ED"),e.addColorStop(.9,S0),t.fillStyle=e,t.fillRect(0,0,A,p0)}function Ft(t){let e=t.createLinearGradient(0,S,0,p0);e.addColorStop(0,u.floorColorFront||"#054213"),e.addColorStop(.85,u.floorColorBack||"#03210A"),e.addColorStop(.95,S0),t.fillStyle=e,t.fillRect(0,p0,A,p0)}function vt(t){let e=t.createLinearGradient(0,0,0,S);e.addColorStop(0,"rgba(16,27,46,0.08)"),e.addColorStop(.5,"rgba(16,27,46,0.16)"),e.addColorStop(1,"rgba(16,27,46,0.20)"),t.fillStyle=e,t.fillRect(0,0,A,S)}function Rt(t,e,o,n,r){let{dirX:i,dirY:l,planeX:s,planeY:c}=e;for(let f=0;f<A;f++){let h=2*(f+.5)/A-1,d=i+s*h,p=l+c*h;if(d<1e-8&&d>-1e-8&&p<1e-8&&p>-1e-8){q[f]=Number.POSITIVE_INFINITY;continue}let g=1/(d||1e-9),G=1/(p||1e-9),w=a.x|0,b=a.y|0,J=g<0?-g:g,Z=G<0?-G:G,N,_,L,t0;d<0?(N=-1,L=(a.x-w)*J):(N=1,L=(w+1-a.x)*J),p<0?(_=-1,t0=(a.y-b)*Z):(_=1,t0=(b+1-a.y)*Z);let Y=0,X=1,b0=!1,re=0,ie=0;for(;!b0&&re++<256;){if(L<t0?(L+=J,w+=N,Y=0):(t0+=Z,b+=_,Y=1),E>0){let y0=Math.min(L,t0);if(y0>E){b0=!1,X=0,ie=y0;break}}if(w<0||b<0||w>=n||b>=r){b0=!0,X=1;break}let s0=o[b][w];if(s0>0){b0=!0,X=s0;break}}if(X===0){q[f]=Number.POSITIVE_INFINITY;continue}let F;Y===0?F=L-J:F=t0-Z,F=L0>F?L0:F;let at=0,ae=Y===0?N:0,se=Y===1?_:0,st=Math.abs(ae*i+se*l)>=.9&&Math.abs(h)<=.9&&F<at?at:F,lt=a.x+st*d,ct=a.y+st*p,K;Y===0?K=ct-(ct|0):K=lt-(lt|0),K=K<0?0:K>.999999?.999999:K+1e-6;let ft=d0[X]||d0[4],r0=v[X],G0=r0?r0.width|0:ft.w|0,U=K*G0|0;(Y===0&&N>0||Y===1&&_<0)&&(U=G0-U-1),U=U<0?0:U>=G0?G0-1:U;let le=F<Y0?Y0:F,i0=S/le|0,H0=(S-i0*E0)/2|0,ce=H0+i0,j=H0,a0=ce;j<0&&(j=0),a0>S&&(a0=S);let dt=a0-j;if(dt<=0){q[f]=F;continue}let ut=(r0?r0.height:ft.h||v[X]?.height||64)|0,fe=(j-H0)*(ut/(i0>1?i0:1)),de=dt*(ut/Math.max(1,i0)),pt=1/(1+F*.25)*(Y?.5:1);if(X===7&&(pt*=.8+.2*Math.sin(t*6+f*.05)),Ge(m,f,j,a0,r0,U,pt,fe,de,X),E>0&&F>E*e0){let s0=E*e0,y0=E,mt=Math.min(1,Math.max(0,(F-s0)/Math.max(1e-6,y0-s0)));mt>0&&(m.save(),m.globalAlpha=mt*.85,m.fillStyle=S0,m.fillRect(f,j,1,a0-j),m.restore())}q[f]=F}}function ye(t){return S/t}function xe(t,e,o){let{dirY:n,dirX:r,planeY:i,planeX:l,invDet:s}=o,c=s*(n*t-r*e),f=s*(-i*t+l*e);return{transX:c,transY:f}}function Ee(t,e){return Math.round((A>>1)*(1+t/e))}function Se(t,e=0,o=.5){let n=e*100,l=(S>>1)+(t>>1)+(n|0),s=l-t;return s<0&&(s=0),{startY:s,endY:l}}function Be(t){let o=(S>>1)-(t>>1);o<0&&(o=0);let n=o+t;return{startY:o,endY:n}}function F0(t,e){let o=t.x-a.x,n=t.y-a.y,{transX:r,transY:i}=xe(o,n,e);if(i<=.01)return null;let l=Ee(r,i),s=t&&typeof t.scale=="number"?t.scale:t&&t.img&&typeof t.img.scale=="number"?t.img.scale:1,c=ye(i)*s,f=typeof t._hR=="number"?t._hR:Math.round(c),h=.1,d=f;(c>f+h||c<f-h)&&(d=Math.round(c)),t._hR=d;let p=d,g=t.img,G=g&&g.width&&g.height?g.width/g.height:1,w=Math.max(1,Math.round(p*G)),b=p/S,J=(t.floorBias??0)*s*b*(2-E0),Z=Math.min(.9,Math.max(.2,s)),N=t.ground?Se(p,J,Z):Be(p),_=Math.round(l-(w>>1)),L=_+w;return{drawStartX:_,drawEndX:L,drawStartY:N.startY,drawEndY:N.endY,depth:i,size:p,width:L-_}}function m0(t,e,o=1){let n=t.trim().split(`
`).map(d=>d.replace(/\s+/g,"")),r=n.length-1;for(;r>=0&&n[r].split("").every(d=>d===".");)r--;r>=0&&r<n.length-1&&(n=n.slice(0,r+1));let i=n.length,l=n[0].length,s=1,c=document.createElement("canvas");c.width=l,c.height=i;let f=c.getContext("2d");f.imageSmoothingEnabled=!1;let h=f.createImageData(l,i);for(let d=0;d<i;d++)for(let p=0;p<l;p++){let g=n[d][p],G=(d*l+p)*4;if(g==="."){h.data[G+3]=0;continue}let w=e[g]||"#ffffff",b=parseInt(w.slice(1),16);h.data[G]=b>>16&255,h.data[G+1]=b>>8&255,h.data[G+2]=b&255,h.data[G+3]=255}if(f.putImageData(h,0,0),o!==1){let d=document.createElement("canvas");d.width=l*o,d.height=i*o;let p=d.getContext("2d");return p.imageSmoothingEnabled=!1,p.drawImage(c,0,0,d.width,d.height),d.baseline=s,d.scale=o,d}return c.baseline=s,c.scale=1,c}async function Ae(t,e){return await Me(t,e,1)}async function Me(t,e=1,o=1){let n=`../assets/gfx/${t}`;return new Promise((r,i)=>{let l=new Image;l.onload=()=>{let s=document.createElement("canvas"),c=l.width,f=l.height;s.width=c*e,s.height=f*e;let h=s.getContext("2d");h.imageSmoothingEnabled=!1,h.drawImage(l,0,0,s.width,s.height),s.baseline=o,s.scale=e,r(s)},l.onerror=()=>i(new Error(`Failed to load sprite: ${n}`)),l.src=n})}var w0,v0,R0,k0,I0,N0;async function kt(){v0=v0=m0(`
  ................................
  ..............BB..BB............
  .............BbbbbbbB...........
  ...........BbbbGGGGbbbB.........
  ..........BbbbGGGGGGbbbB........
  .........BbbGGGGGGGGGGbbB.......
  ........BbbGGGgGGGGgGGbbB.......
  ........BbbGGgGyyGgGGGbbB.......
  .......BbbGGGGGGGGGGGGbbB.......
  .......BbbGGGGGGGGGGGGbbB.......
  ......BbbGGGGGGGGGGGGGGbbB......
  ......BbbGGGGgGGGGgGGGGbbB......
  ......BbbGGGGwwwwwwGGGGbbB......
  .....BbbGGGwwwWWkWWwwwGGbbB.....
  .....BbbGGGwwwwkkwwwwGGbbB......
  .....BbbGGGwwwwrwwwwGGGbbB......
  .....BbbGGGwwwwwwwwwGGGbbB......
  .....BbbGGGGwwwwwwwGGGGbbB......
  .....BbbGGGGGGGGGGGGGGGbbB......
  .....BbbGGGGGGGGGGGGGGGbbB......
  ......BbbGGGGGGGGGGGGGbbB.......
  ......BbbGGGGGGGGGGGGGbbB.......
  .......BBbbbgggGGGGgggbbBB......
  ........BBBbbbbbbbbbbbbBBB......
  ................................
  `,{B:"#2c1810",b:"#5c3d2e",g:"#7a6b5c",G:"#a89080",k:"#080508",w:"#e8e0d5",W:"#f5f0e8",r:"#8b4513",y:"#ffeb9c"},4),N0=m0(`
  ............
  ....bbbb....
  ..bbGGGGbb..
  .bssssssssb.
  .bGGgGGgGGb.
  .bssssssssb.
  .bGgGGGGgGb.
  .bssssssssb.
  .bGGgGGgGGb.
  .bssssssssb.
  .bGgGGGGgGb.
  .bssssssssb.
  .bGGgGGgGGb.
  .bssssssssb.
  .bGGgGGgGGb.
  .bssssssssb.
  ..bbGGGGbb..
  ....bbbb....
  ............
  ............
  `,{k:"#0a0f10",g:"#FA5053",G:"#CD1C18",s:"#950606",b:"#0e1620"},3),k0=m0(`
  ................
  .....B....B.....
  ....BBBBBBBB....
  ...BBbBBbBBB....
  ...BBbgBgbBB....
  ....BBgggBB.....
  .....kGGGk......
  ....kGGsGGk.....
  ...kGGGGGGGk....
  ...kGGGGGGGk....
  ....kGGGGGk.....
  .....kGGGk......
  .......GG.......
  .......GG.......
  .....GGGGGG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GG..GG.....
  .....GGggGG.....
  `,{k:"#5a4500",g:"#FFD700",G:"#FFA500",s:"#FFF5CC",b:"#4169E1",B:"#87CEEB"},4),R0=m0(`
  ............r...
  ............rr..
  ...........w..r.
  .......sb.w...rr
  .......bdw...w..
  .......sfd..w...
  ......sfffdw....
  .....sfffffdb...
  ....sfbffffss...
  ...sfbfbffs.....
  ..sfbfbfbs......
  .sfbfbfbs.......
  .sffbfbs........
  ..sffbs.........
  ...sss..........
  ................
  `,{b:"#100904",d:"#8f715b",f:"#5a3b1a",r:"#DC143C",s:"#000000",w:"#4d260a"},3),w0=m0(`
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ................................................................
  ........................................................w.......
  ......................................................sww.......
  ..................................................wwwwws........
  ...............................................wwwwwwww.s.......
  ..............................................wwwwww....s.......
  ...........................................wwwwwww......s.......
  ...........................................wwwww........s.......
  ..........................................wwwww..........s......
  .........................................wwwww...........s......
  ........................................wwwwww...........s......
  ........................................wwwww............s......
  .......................................wwwww.............s......
  .......................................wwwww.............s......
  .......................................wwww...............s.....
  ......................................wwwww...............s.....
  ......................................wwww................s.....
  .....................................wwwww................s.....
  .....................................wwwww................s.....
  .....................................wwww.................s.....
  .....................................wwww.................s.....
  ....................................wwwww.................s.....
  ....................................wwww..................s.....
  ....................................wwww..................s.....
  ..............................ssss.wwwww..................s.....
  ..............................sss..wwww...................s.....
  ..............................s.bb.wwww....................s....
  ..............................s..bbwwww....................s....
  ..................................bwwww....................s....
  ..................................bbwww....................s....
  ...................................bbww....................s....
  ..................................wwbbww...................s....
  ..................................wwwbbb....................s...
  ..................................wwwwwbb...................s...
  ...................................wwwwwbb..................s...
  ....................................wwww.bb.................s...
  ....................................wwww..bbb...............s...
  ....................................wwww....bb..............s...
  ....................................wwww.....bb..............s..
  ....................................wwww......bb.............s..
  ...................................wwwww.......bb............s..
  ..................................wwwwww........bbb..........s..
  ..................................wwwwww.........bbb.........ss.
  ..................................wwwwww...........bbrrrrr....s.
  ..................................wwwwww...........fbbbrrrr...s.
  ...................................wwwww...........ffffbbrrr..s.
  ...................................wwwwww...........ffffbbrrr.s.
  ...................................wwwwww...........ffffffbb.ss.
  ...................................wwwwww.............ffff.bbbs.
  ...................................wwwwwww..............ff...bs.
  `,{b:"#5a3b1a",f:"#B8860B",r:"#DC143C",s:"#C0C0C0",w:"#8B4513"},3),I0=await Ae("apple.png",3)}var B=[];function z(t,e){if(t<0||e<0||t>=u.MAP_W||e>=u.MAP_H)return!0;let o=u.MAP[e|0][t|0];return o===0||o===5?!1:o===7?!a.hasBlueKey:o!==6}function $0(t,e,o){return!!(z(t,e)||z(t-o,e)||z(t+o,e)||z(t,e-o)||z(t,e+o))}var y=null,Q=null,k=null,V0=null,It=null;function z0(){y||(y=new(window.AudioContext||window.webkitAudioContext))}function R({freq:t=440,dur:e=.1,type:o="square",vol:n=.2,slide:r=0}){if(!y)return;let i=y.createOscillator(),l=y.createGain();i.type=o,i.frequency.value=t,l.gain.value=n,i.connect(l).connect(y.destination);let s=y.currentTime;r&&(i.frequency.setValueAtTime(t,s),i.frequency.linearRampToValueAtTime(t+r,s+e)),l.gain.setValueAtTime(n,s),l.gain.exponentialRampToValueAtTime(.001,s+e),i.start(s),i.stop(s+e)}function q0({dur:t=.2,vol:e=.2,lp:o=1200}){if(!y)return;let n=y.createBuffer(1,y.sampleRate*t,y.sampleRate),r=n.getChannelData(0);for(let f=0;f<r.length;f++)r[f]=Math.random()*2-1;let i=y.createBufferSource(),l=y.createGain(),s=y.createBiquadFilter();i.buffer=n,l.gain.value=e,s.type="lowpass",s.frequency.value=o,i.connect(s).connect(l).connect(y.destination);let c=y.currentTime;i.start(c),i.stop(c+t)}var I={shot:()=>{let t=T(50),e=-T(50);R({freq:220+t+e,dur:.05+T(3)/100,type:"square",vol:.25,slide:120}),q0({dur:.03+T(3)/100,vol:.15,lp:800})},pickup:()=>{R({freq:880,dur:.06,type:"triangle",vol:.2}),R({freq:1180,dur:.08,type:"triangle",vol:.18})},explode:()=>{q0({dur:1,vol:.3,lp:800}),R({freq:90,dur:.7,type:"sawtooth",vol:.12,slide:-60})},hurt:()=>{R({freq:140,dur:.12,type:"sawtooth",vol:.2,slide:-50})},killedEntity:()=>{let t=Math.random()*16-8;R({freq:320+t,dur:.26,type:"triangle",vol:.3,slide:-220}),R({freq:480+t,dur:.22,type:"sawtooth",vol:.1,slide:-260}),R({freq:90,dur:.08,type:"sine",vol:.18}),q0({dur:.05,vol:.1,lp:1e3}),setTimeout(()=>{R({freq:170+t,dur:.07,type:"triangle",vol:.16,slide:70})},90)},door:()=>{R({freq:420,dur:.12,type:"square",vol:.15})},portal:()=>{R({freq:600,dur:.5,type:"sawtooth",vol:.2}),R({freq:400,dur:.3,type:"sawtooth",vol:.2,slide:50}),R({freq:600,dur:.5,type:"sawtooth",vol:.2})}};async function Ce(t,{volume:e=.15}={}){if(y)try{if(!V0||t!==It){let n=await(await fetch(t,{cache:"force-cache"})).arrayBuffer();V0=await y.decodeAudioData(n),It=t}Pt(),k=y.createBufferSource(),k.buffer=V0,k.loop=!0,Q=y.createGain(),Q.gain.value=e,k.connect(Q).connect(y.destination),k.start()}catch(o){try{Pt();let n=new Audio(t);n.loop=!0,n.volume=Math.max(0,Math.min(1,e)),await n.play(),k={stop:()=>n.pause(),disconnect:()=>{}},Q=null}catch(n){}}}function Pt(){try{k&&k.stop(0)}catch(t){}if(k&&k.disconnect)try{k.disconnect()}catch(t){}if(Q)try{Q.disconnect()}catch(t){}k=null,Q=null}var Dt=!1;async function K0(){if(!y||k||Dt)return;Dt=!0,await Ce("../assets/sfx/HexenST02SLowed.ogg",{volume:.12})}var U0=0,P=new Set,j0=!1,Q0=0,J0=!1;function _t(t){window.addEventListener("keydown",e=>{P.add(e.code),z0(),K0(),e.code==="Space"&&(e.preventDefault(),Ot()),e.code==="KeyM"&&(e.preventDefault(),D.classList.toggle("visible"))}),window.addEventListener("keyup",e=>P.delete(e.code)),t.addEventListener("mousedown",e=>{e.button===0&&Ot(),j0=!0,Q0=e.clientX,z0(),K0()}),window.addEventListener("mouseup",()=>j0=!1),window.addEventListener("mousemove",e=>{if(j0){let o=e.clientX-Q0;Q0=e.clientX,a.a+=o*.0035}}),Et.onclick=()=>Re(),St.onclick=()=>D.classList.toggle("visible")}function Lt(t){let e=P.has("ShiftLeft")||P.has("ShiftRight"),o=a.speed*(e?2:1)*t,n=a.rotSpeed*t,r=Math.cos(a.a),i=Math.sin(a.a),l=-i,s=r,c=0,f=0;P.has("ArrowLeft")&&(a.a-=n),P.has("ArrowRight")&&(a.a+=n),(P.has("ArrowUp")||P.has("KeyW"))&&(c+=r*o,f+=i*o),(P.has("ArrowDown")||P.has("KeyS"))&&(c-=r*o,f-=i*o),P.has("KeyA")&&(c-=l*o,f-=s*o),P.has("KeyD")&&(c+=l*o,f+=s*o);let h=a.x+c,d=a.y+f;$0(h,a.y,X0)||(a.x=h),$0(a.x,d,X0)||(a.y=d)}function Ot(){let t=!1;a.ammo>0&&(a.ammo--,O(),I.shot(),t=!0);let e=B0(),o=Te(e);if(!o){t||x("No arrows. Look for quivers.");return}switch(o.type){case"key":o.alive=!1,a.hasBlueKey=!0,I.door(),x("Keycard found! Find the exit!"),Wt();break;case"food":{o.alive=!1;let n=a.health>=a.maxHealth;n&&(a.maxHealth+=1),a.health=x0(a.health+f0,0,a.maxHealth),x(n?"Ranger Became Stronger.":"Health restored."),O(),I.pickup();break}case"arrows":o.alive=!1,a.ammo=Math.min(60,a.ammo+c0),O(),x(`Arrows +${c0}`),I.pickup();break;default:o.onHit&&o.onHit(o,t);break}}function Yt(){for(let t of B)if(!(!t.alive||Math.hypot(t.x-a.x,t.y-a.y)>=.6))switch(t.type){case"key":t.alive=!1,a.hasBlueKey=!0,I.door(),x("Keycard found! Find the exit!"),Wt();break;case"food":t.alive=!1,a.health>=a.maxHealth?(x("Ranger Became Stronger"),a.maxHealth+=1,a.health=x0(a.health+f0,0,a.maxHealth)):(a.health=x0(a.health+f0,0,a.maxHealth),x(`Health +${f0}`)),O(),I.pickup();break;case"arrows":t.alive=!1,a.ammo=Math.min(60,a.ammo+c0),O(),I.pickup(),x(`Arrows +${c0}`);break;default:t.onTouch&&t.onTouch(t);break}}function Xt(){if(J0)return;let t=a.x|0,e=a.y|0;u.MAP[e][t]===5&&(I.portal(),x(`Floor ${$} cleared.`),W0($+1),J0=!0,setTimeout(()=>{ve(!0),J0=!1},100))}function Te(t){let o=document.getElementById("view").width>>1|0,n=q[o]||1e9,r=null,i=1e9;for(let l of B){if(!l.alive)continue;let s=F0(l,t);s&&(E>0&&s.depth>E||o>=s.drawStartX&&o<s.drawEndX&&s.depth<n+.1&&s.depth<i&&(r=l,i=s.depth))}return r}function h0(t=2){let e=0;for(;e++<200;){let o=(Math.random()*(u.MAP_W-2)|0)+1,n=(Math.random()*(u.MAP_H-2)|0)+1;if(u.MAP[n][o]!==0)continue;let r=o+.5-a.x,i=n+.5-a.y;if(!(Math.hypot(r,i)<t))return{x:o,y:n}}return{x:9,y:9}}function Wt(){let t=u.MAP_W,e=u.MAP_H;for(let o=0;o<e;o++)for(let n=0;n<t;n++)u.MAP[o][n]===7&&(u.MAP[o][n]=0)}function Nt(){let t=H.x,e=H.y;for(let o=e-1;o<=e+1;o++)for(let n=t-1;n<=t+1;n++)n===t&&o===e||(u.MAP[o][n]=7)}function $t(t){let{enchantedKey:e,food:o,arrowQuiver:n}=t;if(B.length=0,T(100)<50)for(let s=0;s<T(2)*(u.MAP_H/20|0);s++){let c=h0(1);B.push(ot(C.barrel,{x:c.x+.5,y:c.y+.5}))}let r=h0(4);B.push({x:r.x+.5,y:r.y+.5,img:e,type:"key",alive:!0,dist:0,ground:!0,scale:.25,floorBias:35});let i=h0(3);B.push({x:i.x+.5,y:i.y+.5,img:o,type:"food",alive:!0,dist:0,ground:!0,scale:.25,floorBias:35});for(let s=0;s<1+($/3|0)*(u.MAP_H/20|0);s++)if(s<=1&&T(100)<50||s<1&&a.ammo<=0&&T(100)<80||T(100)<25){let c=h0(3);B.push({x:c.x+.5,y:c.y+.5,img:n,type:"arrows",alive:!0,dist:0,ground:!0,scale:.25,floorBias:35})}let l=Math.min((2+($-1)*2)*(u.MAP_H/20|0),8);for(let s=0;s<l;s++){let c=h0(3.5);B.push(ot(C.entity,{x:c.x+.5,y:c.y+.5}))}}function O(){gt.style.width=`${a.health/a.maxHealth*100}%`,bt.style.width=`${a.ammo/60*100}%`,Gt.textContent=Math.max(0,a.health),yt.textContent=a.ammo}var Z0=0,tt=0,et=!1,Ht=!1;function x(t){let e=document.getElementById("gameLog"),o=e?.querySelector(".log-items");if(!o)return;let n=document.createElement("div");n.textContent=t,o.prepend(n),e.classList.contains("collapsed")||requestAnimationFrame(()=>{o.scrollTop=0})}function Vt(t){Z0>0&&(Z0-=t,Z0<=0&&(xt.textContent=a.hasBlueKey?"Find the exit.":"Find the enchanted key."))}function qt(){et||a.health<=0&&(et=!0,a.speed=0,a.rotSpeed=0,tt=2,x("YOU DIED! Soul disconnecting from the node..."))}function zt(t){et&&(tt-=t,tt<=0&&Fe())}function Fe(){if(Ht)return;Ht=!0;let t=document.getElementById("game");if(t){let e=document.createElement("div");e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100vw",e.style.height="100vh",e.style.background="#ff0000",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.zIndex="999999",e.style.fontFamily='"Courier New", monospace',e.style.opacity="0",e.style.transition="opacity 2s ease-in",e.innerHTML=`
      <div style="
        background: #000;
        border: 3px solid #04650d;
        color: #20b2db;
        width: 600px;
        max-width: 90vw;
        box-shadow: 0 0 20px #04650d;
        font-family: 'Courier New', monospace;
      ">
        <div style="
          background:#000;
          color: #04650d;
          padding: 8px 15px;
          display: flex;
          justify-content: space-between;
          font-weight: bold;
          font-size: 12px;
        ">
          <span style ="color: #FFFFFF; border: 1px solid #04650d;">Death...</span>
        </div>
        <div style="padding: 20px; min-height: 200px;">
          <div style="margin-bottom: 30px;">
            <div style="text-align: center; color: #FFFFFF; font-size: 32px; margin: 8px 0;">YOU HAVE DIED</div>
          </div>
          <div style="text-align: center; margin-top: 20px;">
            <button id="returnBtn" style="
              background: #000;
              border: 2px solid #04650d;
              color: #04650d;
              padding: 12px 24px;
              font-family: 'Courier New', monospace;
              font-size: 14px;
              font-weight: bold;
              cursor: pointer;
              text-transform: uppercase;
              letter-spacing: 1px;
            ">RETURN TO TERMINAL</button>
          </div>
        </div>
      </div>
    `,document.body.appendChild(e);let o=e.querySelector("#returnBtn");if(o){let n=!1;o.addEventListener("click",r=>{r.preventDefault(),!n&&(n=!0,setTimeout(()=>{window.location.href="../index.html"},100))})}setTimeout(()=>{e.style.opacity="1"},50),t.classList.add("game-paused"),P.clear()}}function nt(t=!1){t&&o0(),a.x=V.x,a.y=V.y,a.a=0,a.hasBlueKey=!1,u.MAP[H.y][H.x]=5,Nt(),$t({enchantedKey:k0,food:I0,arrowQuiver:R0}),O(),x(`Floor ${$}: Find the keycard.`)}function ve(t=!1){t&&(U0>=u0.length-1?o0():(U0+=1,o0(U0))),a.x=V.x,a.y=V.y,a.a=0,a.hasBlueKey=!1,u.MAP[H.y][H.x]=5,Nt(),$t({enchantedKey:k0,food:I0,arrowQuiver:R0}),O(),x(`Floor ${$}: Find the keycard.`)}function Re(){W0(1),o0(0),nt()}function Kt(t){for(let e of B)e.alive&&e.ai&&e.ai(e,t)}var n0={EXPLOSION:"explosion",SCREEN_FLASH:"screen_flash"},ke={[n0.EXPLOSION]:{lifetime:.5,startRadius:.1,endRadius:1,expansionTime:.4,startOpacity:1,endOpacity:0,primaryColor:{h:30,s:90,l:60},secondaryColor:{h:15,s:85,l:50},glowColor:{h:45,s:100,l:75},fillColor:{h:25,s:80,l:40},ringLineWidth:3,glowLineWidth:2,innerLineWidth:1,renderFunction:Le,ignoreBounds:!1},[n0.SCREEN_FLASH]:{lifetime:.15,startOpacity:.85,endOpacity:0,color:"#ffffff",renderFunction:Ye,ignoreBounds:!0}},g0=[];function Ut(t,e,o,n,r={}){let i=ke[t];if(!i)return console.warn(`Unknown effect type: ${t}`),null;let l={ignoreBounds:!1,type:t,x:e,y:o,radius:n,maxRadius:n,age:0,lifetime:r.lifetime??i.lifetime,opacity:r.startOpacity??i.startOpacity,startOpacity:r.startOpacity??i.startOpacity,endOpacity:r.endOpacity??i.endOpacity,...i,...r};return g0.push(l),l}function jt(t,e,o,n={}){return Ut(n0.EXPLOSION,t,e,o,n)}function Qt({color:t="#ffffff",duration:e=.15,alpha:o=.85}={}){Ut(n0.SCREEN_FLASH,0,0,1,{lifetime:e,startOpacity:o,endOpacity:0,color:t,ignoreBounds:!0})}function Jt(t){for(let e=g0.length-1;e>=0;e--){let o=g0[e];o.age+=t;let n=Math.min(o.age/o.lifetime,1);Ie(o,n),o.age>=o.lifetime&&g0.splice(e,1)}}function Ie(t,e){switch(t.type){case n0.EXPLOSION:Pe(t,e);break;case n0.SCREEN_FLASH:De(t,e);break}}function Pe(t,e){t.opacity=T0(t.startOpacity,t.endOpacity,e);let o=Math.min(e/t.expansionTime,1),n=T0(t.startRadius,t.endRadius,o);t.radius=t.maxRadius*n}function De(t,e){let o=1-(1-e)*(1-e);t.opacity=T0(t.startOpacity,t.endOpacity,o)}function Oe(){return g0}function Zt(t,e,o,n,r){let i=Oe();if(i.length!==0){t.save();for(let l of i)He(t,l,e,o,n,r);t.restore()}}function He(t,e,o,n,r,i){let l=_e(e.x,e.y,o,n,r,i,e.ignoreBounds);!l&&!e.ignoreBounds||e.renderFunction(t,e,l)}function _e(t,e,o,n,r,i,l=!1){let s=t-i.x,c=e-i.y,{dirY:f,dirX:h,planeY:d,planeX:p,invDet:g}=o,G=g*(f*s-h*c),w=g*(-d*s+p*c);return w<=.1&&!l?null:l?{x:n/2,y:r/2,radius:r,depth:w}:{x:n/2*(1+G/w),y:r/2+64,radius:r/w*.5,depth:w}}function Le(t,e,o){let n=o.radius*e.radius,r=performance.now()*.001,i=Math.sin(r*8)*12,l=Math.sin(r*12)*.15+1,s=o.y,c=o.x;t.globalAlpha=e.opacity*.3,t.fillStyle=`hsl(${e.fillColor.h+i*.5}, ${e.fillColor.s}%, ${e.fillColor.l}%)`,t.beginPath(),t.arc(c,s,n*.7,0,2*Math.PI),t.fill(),t.globalAlpha=e.opacity*.5,t.strokeStyle=`hsl(${e.glowColor.h+i}, ${e.glowColor.s}%, ${e.glowColor.l}%)`,t.lineWidth=e.glowLineWidth*1.5,t.beginPath(),t.arc(c,s,n*l,0,2*Math.PI),t.stroke(),t.globalAlpha=e.opacity*.85,t.strokeStyle=`hsl(${e.primaryColor.h+i*.8}, ${e.primaryColor.s}%, ${e.primaryColor.l}%)`,t.lineWidth=e.ringLineWidth,t.beginPath(),t.arc(c,s,n*.9,0,2*Math.PI),t.stroke(),t.globalAlpha=e.opacity*.6,t.strokeStyle=`hsl(${e.secondaryColor.h+i*1.3}, ${e.secondaryColor.s}%, ${e.secondaryColor.l}%)`,t.lineWidth=e.innerLineWidth,t.beginPath(),t.arc(c,s,n*.5,0,2*Math.PI),t.stroke()}function Ye(t,e){if(e.opacity<=0)return;let o=t.canvas.width,n=t.canvas.height;t.save(),t.globalAlpha=e.opacity,t.fillStyle=e.color||"#ffffff",t.fillRect(0,0,o,n),t.restore()}var C=Object.freeze({entity:"entity",barrel:"barrel"}),P0={[C.entity]:{type:C.entity,ground:!0,scale:.66,floorBias:3},[C.barrel]:{type:C.barrel,ground:!0,scale:.5,floorBias:5}};Object.freeze(P0);for(let t in P0)Object.freeze(P0[t]);var D0={[C.entity]:{ai(t,e){if(!t.alive)return;let o=a.x-t.x,n=a.y-t.y,r=Math.hypot(o,n);if(r>.3){let i=.9*e,l=o/r,s=n/r,c=t.x+l*i,f=t.y+s*i;z(c,t.y)||(t.x=c),z(t.x,f)||(t.y=f)}r<.6&&t.hurtCD<=0&&(a.health=Math.max(0,a.health-ht)|0,O(),x("Entity attacks!"),I.hurt(),t.hurtCD=.8,Qt({color:"	#740707",duration:.5}),qt()),t.hurtCD>0&&(t.hurtCD-=e)},onHit(t,e){e?(t.alive=!1,x(C0(["Entity murdered!","Entity destroyed!","Entity purged!"])),I.killedEntity()):x("No arrows.")},onTouch(t){rt(C.entity,1e4)&&x("You hear something like water nearby...")}},[C.barrel]:{onHit(t,e){e?(t.alive=!1,te(t.x,t.y,2.5),x("Kaboom!"),I.explode()):x("No arrows.")},onTouch(t){rt(C.barrel,1e4)&&x("Shooting this barrel may yield useful results...")}}};Object.freeze(D0);for(let t in D0)Object.freeze(D0[t]);var Xe=0;function ot(t,e={x:0,y:0},o=void 0){let n=P0[t],r=D0[t],i=Object.assign(Object.create(r),n);switch(i.id=Xe++,i.x=e.x,i.y=e.y,i.dist=0,i.alive=!0,i.hurtCD=0,t){case C.entity:i.img=v0;break;case C.barrel:i.img=N0;break}return o&&Object.assign(i,o),i}function te(t,e,o){jt(t,e,o);for(let n of B){if(!n.alive)continue;Math.hypot(n.x-t,n.y-e)<o&&(n.type===itemTypes.barrel&&(n.alive=!1,te(n.x,n.y,2.5)),n.alive=!1)}}function ee(t){M.clearRect(0,0,D.width,D.height);let e=6,o=20,n=2,r=Math.floor(o/2),i=Math.max(0,Math.min((a.x|0)-r,u.MAP_W-o)),l=Math.max(0,Math.min((a.y|0)-r,u.MAP_H-o));D.width=n+o*e+n,D.height=n+o*e+n;for(let d=0;d<o;d++)for(let p=0;p<o;p++){let g=l+d,G=i+p,w=u.MAP[g]?.[G]??0,b="#0c1220";w===1?b="#ECDE60":w===2?b="#707a88":w===3?b="#00e676":w===4?b="#996633":w===5?b="#FFE300":w===6?b=" #3561ff":w===7&&(b="#00FFFF"),M.fillStyle=b,M.fillRect(n+p*e,n+d*e,e-1,e-1)}for(let d of t){if(!d.alive)continue;let p=n+(d.x-i)*e,g=n+(d.y-l)*e;M.fillStyle=d.type===C.entity?"#ffeb9c":d.type===C.barrel?"#CD1C18":d.type==="key"?"#6aa2ff":d.type==="food"?"#7fffd4":(d.type==="arrows","#ffffff"),M.fillRect(p-2,g-2,4,4)}let s=n+(a.x-i)*e,c=n+(a.y-l)*e;M.fillStyle="#e7f3ff",M.beginPath(),M.arc(s,c,2.5,0,wt),M.fill();let f=Math.cos(a.a),h=Math.sin(a.a);M.strokeStyle="#78f3d3",M.beginPath(),M.moveTo(s,c),M.lineTo(s+f*1.5*e,c+h*1.5*e),M.stroke()}var it=performance.now(),oe=new Map;function rt(t,e){let o=it,n=oe.get(t)??0;return o<n?!1:(oe.set(t,o+e),!0)}_t(W);var O0=0;function We(t){let e=`FPS: ${Math.round(t)}`;m.save(),m.font="12px monospace",m.textAlign="right",m.textBaseline="top";let o=A-8,n=6,r=m.measureText(e).width+8,i=16;m.fillStyle="rgba(10, 15, 25, 0.6)",m.fillRect(o-r,n-2,r,i),m.strokeStyle="rgba(60, 80, 130, 0.9)",m.strokeRect(o-r+.5,n-2+.5,r-1,i-1),m.fillStyle="#dfe6ff",m.fillText(e,o,n),m.restore()}function o0(t=-1){let e;if(t!==-1){let o=u0[t];o&&(e=o)}else e=C0(u0);H.x=e.exitPos.x,H.y=e.exitPos.y,V.x=e.startPos.x,V.y=e.startPos.y,a.health=a.maxHealth,u.cielingColorFront=e.cielingColorFront||"#6495ED",u.floorColorFront=e.floorColorFront||"#054213",u.cielingColorBack=e.cielingColorBack||"#6495ED",u.floorColorBack=e.floorColorBack||"#03210A",u.MAP=e.mapLayout,u.MAP_W=u.MAP[0].length,u.MAP_H=u.MAP.length,a.x=a.x=e.startPos.x,a.y=e.startPos.y}async function Ne(){await kt(),await Mt(),o0(0),nt(),a.maxHealth=6+T(6),a.health=a.maxHealth,a.ammo=5+T(5),O(),requestAnimationFrame(ne)}function $e(t){let e=B0();m.imageSmoothingEnabled=!1,Tt(m),Ft(m),vt(m),Rt(t,e,u.MAP,u.MAP_W,u.MAP_H),Ve(),B.sort((o,n)=>n.dist-o.dist),qe(e),Ue(),Zt(m,e,A,S,a)}function Ve(){for(let t of B){let e=t.x-a.x,o=t.y-a.y;t.dist=e*e+o*o}}function qe(t){m.save();for(let e of B){if(!e.alive)continue;let o=F0(e,t);if(!o||E>0&&o.depth>E)continue;let n=ze(o);Ke(e,o,n),m.filter="none"}m.restore()}function ze(t){let e=1/(1+t.depth*.3);if(E>0&&t.depth>E*e0){let r=E*e0,i=Math.min(1,Math.max(0,(t.depth-r)/Math.max(1e-6,E-r)));e*=1-i*.6}let o=[1,.85,.7,.55,.4];return{quantizedShade:o.reduce((r,i)=>Math.abs(i-e)<Math.abs(r-e)?i:r,o[0])}}function Ke(t,e,o){o.quantizedShade<.999&&(m.filter=`brightness(${o.quantizedShade})`);let n=Math.max(1,(e.width??e.drawEndX-e.drawStartX)|0),r=e.drawStartY,i=e.drawEndY-e.drawStartY,l=f=>(f-e.drawStartX)*t.img.width/n|0,s=-1,c=0;for(let f=e.drawStartX;f<=e.drawEndX;f++){let d=f>=0&&f<A&&f<e.drawEndX&&e.depth<=q[f];if(d&&s===-1&&(s=f,c=l(f)),(!d||f===e.drawEndX)&&s!==-1){let p=f,g=p-s,G=l(p);G<=c&&(G=c+1);let w=Math.min(t.img.width-c,G-c);g>0&&w>0&&i>0&&m.drawImage(t.img,c,0,w,t.img.height,s,r,g,i),s=-1}}}function Ue(){let t=Math.round(A*.42),e=Math.round(t*(w0.height/w0.width)),o=Math.max(8,A*.02|0),n=A*.8-t-o,r=S-e-o+20;m.drawImage(w0,n,r,t,e)}function ne(t){let e=Math.min(.05,(t-it)/1e3);it=t;let o=e>0?1/e:0;O0=O0?O0*.9+o*.1:o,Lt(e),Kt(e),Jt(e),Yt(),$e(t/1e3),D.classList.contains("visible")&&ee(B),Xt(),Vt(e),zt(e),We(O0),requestAnimationFrame(ne)}await Ne().catch(console.error);export{o0 as ChangeMapLevel,rt as tryCooldown};
