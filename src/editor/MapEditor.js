import{a as L}from"../../chunks/chunk-B3G4DJQ2.js";var g=[{id:0,name:"empty",color:"#0b1020"},{id:1,name:"backroomswall",color:"#ECDE60"},{id:2,name:"panel",color:"#707a88"},{id:3,name:"hedge",color:"#00e676"},{id:4,name:"door",color:"#996633"},{id:5,name:"exit",color:"#FFE300"},{id:6,name:"blue_door",color:"#3561ff"},{id:7,name:"Forcefield",color:"#00FFFF"},{id:-1,name:"infoPlayerStart",color:"#00FF00"},{id:-2,name:"infoPlayerExit",color:"#FF0000"}],u={PLAYER_START:-1,PLAYER_EXIT:-2},f=[-1,-2],k=[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,2,6,2,0,0,0,0,0,0,0,2,6,2,0,0,1],[1,0,0,0,2,0,2,0,0,0,0,0,0,0,2,0,2,0,0,1],[1,0,0,0,2,2,2,0,0,0,0,0,0,0,2,2,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,5,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,3,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,3,3,1,3,3,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,0,0,0,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,2,2,2,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,1,0,2,0,2,0,1,0,3,0,0,0,1],[1,0,0,0,0,0,0,0,0,2,6,2,0,0,0,0,0,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]];function m(d,e,t){return Array.from({length:e},()=>Array.from({length:d},()=>t|0))}function b(d,e,t){let i=e/100,n=t/100,s=r=>(r+d/30)%12,o=i*Math.min(n,1-n),a=r=>n-o*Math.max(-1,Math.min(s(r)-3,Math.min(9-s(r),1))),c=r=>`0${Math.round(r*255).toString(16)}`.slice(-2);return`#${c(a(0))}${c(a(8))}${c(a(4))}`}function y(d){let e=d*47%360;return b(e,60,45)}function T(d){return{0:"empty",1:"brick",2:"panel",3:"hedge",4:"door",5:"exit",6:"blue_door",7:"[NODEOSERROR] Flesh"}[d]||`tile_${d}`}function P(d,e,t){let i=e.getBoundingClientRect(),n=Math.floor((d.clientX-i.left)/t),s=Math.floor((d.clientY-i.top)/t);return{x:n,y:s}}function x(d){let e=document.createElement("div");e.textContent=d,e.style.position="fixed",e.style.bottom="14px",e.style.left="50%",e.style.transform="translateX(-50%)",e.style.background="#0b162f",e.style.border="1px solid #294173",e.style.padding="8px 12px",e.style.borderRadius="10px",e.style.boxShadow="0 6px 20px #0007",e.style.zIndex="1000",document.body.appendChild(e),setTimeout(()=>e.remove(),900)}function l(d,e,t){return L(+d|0,e,t)}var z=class{constructor(e,t){this.canvas=e,this.canvasContext=e.getContext("2d",{alpha:!1}),this.canvasContext.imageSmoothingEnabled=!1,this.editor=t}draw(){this.syncCanvasSize(),this.drawAllMapCells(),this.editor.showGrid&&this.editor.cellSize>=6&&this.drawGrid()}drawAllMapCells(){for(let e=0;e<this.editor.height;e++)for(let t=0;t<this.editor.width;t++){let i=this.editor.map[e][t];this.canvasContext.fillStyle=this.colorFor(i),this.canvasContext.fillRect(t*this.editor.cellSize,e*this.editor.cellSize,this.editor.cellSize,this.editor.cellSize)}}drawCell(e,t){let i=this.editor.map[t][e];this.canvasContext.fillStyle=this.colorFor(i),this.canvasContext.fillRect(e*this.editor.cellSize,t*this.editor.cellSize,this.editor.cellSize,this.editor.cellSize),this.editor.showGrid&&this.editor.cellSize>=6&&this.drawCellGrid(e,t)}drawGrid(){this.canvasContext.strokeStyle="#1e263f",this.canvasContext.lineWidth=1,this.canvasContext.beginPath();for(let e=.5;e<=this.editor.width*this.editor.cellSize;e+=this.editor.cellSize)this.canvasContext.moveTo(e,0),this.canvasContext.lineTo(e,this.editor.height*this.editor.cellSize);for(let e=.5;e<=this.editor.height*this.editor.cellSize;e+=this.editor.cellSize)this.canvasContext.moveTo(0,e),this.canvasContext.lineTo(this.editor.width*this.editor.cellSize,e);this.canvasContext.stroke()}drawCellGrid(e,t){this.canvasContext.strokeStyle="#1e263f",this.canvasContext.strokeRect(e*this.editor.cellSize+.5,t*this.editor.cellSize+.5,this.editor.cellSize-1,this.editor.cellSize-1)}colorFor(e){let t=this.editor.tileManager.tiles.find(i=>i.id===e);return t?t.color:"#000000"}syncCanvasSize(){this.canvas.width=this.editor.width*this.editor.cellSize,this.canvas.height=this.editor.height*this.editor.cellSize,this.canvasContext.imageSmoothingEnabled=!1}cellFromEvent(e){return P(e,this.canvas,this.editor.cellSize)}};var I=class{constructor(){this.undoStack=[],this.redoStack=[],this.editor=null}setEditor(e){this.editor=e}pushUndo(e,t){if(!e||!e.length){if(t&&this.editor){let i={type:"full",width:this.editor.width,height:this.editor.height,map:t.map(n=>[...n])};this.undoStack.push(i)}}else this.undoStack.push({type:"stroke",changes:[...e]});this.undoStack.length>300&&this.undoStack.shift(),this.redoStack.length=0}undo(){if(!this.undoStack.length||!this.editor)return;let e=this.undoStack.pop();if(e.type==="stroke"){let t=e.changes.map(i=>({x:i.x,y:i.y,prev:i.next,next:i.prev}));this.redoStack.push({type:"stroke",changes:t});for(let i of e.changes)this.editor.map[i.y][i.x]=i.prev}else if(e.type==="full"){let t={type:"full",width:this.editor.width,height:this.editor.height,map:this.editor.map.map(i=>[...i])};this.redoStack.push(t),this.editor.width=e.width,this.editor.height=e.height,this.editor.map=e.map.map(i=>[...i]),this.editor.elements.wInput.value=String(this.editor.width),this.editor.elements.hInput.value=String(this.editor.height)}this.editor.render()}redo(){if(!this.redoStack.length||!this.editor)return;let e=this.redoStack.pop();if(e.type==="stroke"){let t=e.changes.map(i=>({x:i.x,y:i.y,prev:i.next,next:i.prev}));this.undoStack.push({type:"stroke",changes:t});for(let i of e.changes)this.editor.map[i.y][i.x]=i.next}else if(e.type==="full"){let t={type:"full",width:this.editor.width,height:this.editor.height,map:this.editor.map.map(i=>[...i])};this.undoStack.push(t),this.editor.width=e.width,this.editor.height=e.height,this.editor.map=e.map.map(i=>[...i]),this.editor.elements.wInput.value=String(this.editor.width),this.editor.elements.hInput.value=String(this.editor.height)}this.editor.render()}clear(){this.undoStack.length=0,this.redoStack.length=0}};var v=class{constructor(e,t=g){this.editor=e,this.tiles=[...t],this.renderPalette()}generateIds(){let e=l(this.editor.elements.maxIdInput.value,0,255),t=[],i=g.filter(n=>f.includes(n.id));for(let n of i){let s=this.tiles.find(o=>o.id===n.id);t.push(s||{...n})}for(let n=0;n<=e;n++){let s=this.tiles.find(o=>o.id===n);t.push(s||{id:n,name:`tile_${n}`,color:y(n)})}this.tiles=t,this.renderPalette(),this.editor.render()}autoNameTiles(){this.tiles=this.tiles.map(e=>({...e,name:T(e.id)})),this.renderPalette()}seedFromUserSample(){this.tiles=[...g],this.editor.elements.maxIdInput.value="7",this.renderPalette(),this.editor.render()}renderPalette(){let e=this.editor.elements.palListEl;e.innerHTML="";let t=[...this.tiles].sort((i,n)=>i.id-n.id);for(let i of t){let n=this.createPaletteRow(i);e.appendChild(n)}this.updateActiveBadgeColor()}createPaletteRow(e){let t=document.createElement("div");t.className="palItem";let i=document.createElement("input");i.type="color",i.value=e.color,i.oninput=()=>{e.color=i.value,e.id===this.editor.activeId&&this.updateActiveBadgeColor(),this.editor.render()};let n=document.createElement("div");n.className="palMeta";let s=document.createElement("div");s.className="idBadge",s.textContent=String(e.id),s.title="Select this tile",s.onclick=()=>this.editor.setActiveId(e.id);let o=document.createElement("input");o.placeholder=`tile_${e.id}`,o.value=e.name||"",o.oninput=()=>{e.name=o.value.trim()||`tile_${e.id}`};let a=document.createElement("button");return a.textContent="\xD7",a.title="Remove (only if not last in range)",a.onclick=()=>this.deleteTile(e),(e.id===0||f.includes(e.id))&&(a.style.visibility="hidden"),n.appendChild(s),n.appendChild(o),t.appendChild(i),t.appendChild(n),t.appendChild(a),t}deleteTile(e){if(e.id===0||f.includes(e.id))return;let t=this.tiles[this.tiles.length-1];e.id===t.id?(this.tiles=this.tiles.filter(i=>i.id!==e.id),this.tiles.length>0&&(this.editor.elements.maxIdInput.value=String(t.id-1))):(e.name=`tile_${e.id}`,e.color=y(e.id)),this.renderPalette(),this.editor.render()}updateActiveBadgeColor(){let e=this.tiles.find(t=>t.id===this.editor.activeId);this.editor.elements.activeBadge.style.background=e?e.color:"transparent"}getTile(e){return this.tiles.find(t=>t.id===e)}getSortedTiles(){return[...this.tiles].sort((e,t)=>e.id-t.id)}updateTiles(e){Array.isArray(e)&&e.length&&(this.tiles=[...e].sort((t,i)=>t.id-i.id).map((t,i)=>({id:+t.id|0,name:String(t.name||`tile_${i}`),color:String(t.color||y(+t.id|0))})),this.editor.elements.maxIdInput.value=String(this.tiles[this.tiles.length-1].id),this.renderPalette())}};var C=class{constructor(e){this.editor=e}exportJS(){let e=this.editor.elements.mapNameInput?.value||"Untitled",t=null,i=null;for(let r=0;r<this.editor.height;r++)for(let h=0;h<this.editor.width;h++){let w=this.editor.map[r][h];w===u.PLAYER_START?t={x:h+.5,y:r+.5}:w===u.PLAYER_EXIT&&(i={x:h,y:r})}let n=this.editor.map.map(r=>r.map(h=>h===u.PLAYER_START||h===u.PLAYER_EXIT?0:h));t||(t={x:3.5,y:3.5}),i||(i={x:10,y:8});let o=(this.editor.zoneManager?this.editor.zoneManager.exportZones():[]).map(r=>({color:r.color??"#101b2e",x:r.x??0,y:r.y??0,w:r.w??0,h:r.h??0,cielingColorFront:r.cielingColorFront??"",cielingColorBack:r.cielingColorBack??"",floorColorBack:r.floorColorBack??"",fogColor:r.fogColor??""})),a={name:e,mapLayout:n,exitPos:i,startPos:t,...o.length?{zones:o}:{}},c=`${JSON.stringify(a,null,2)};
`;this.editor.elements.io.value=c}async copyJS(){this.editor.elements.io.value||this.exportJS();try{await navigator.clipboard.writeText(this.editor.elements.io.value),x("Copied")}catch{alert("Copy failed")}}downloadJS(){this.editor.elements.io.value||this.exportJS();let e=new Blob([this.editor.elements.io.value],{type:"text/javascript"}),t=URL.createObjectURL(e),i=document.createElement("a");i.href=t,i.download="map.js",i.click(),URL.revokeObjectURL(t)}downloadJSON(){let e={width:this.editor.width,height:this.editor.height,tiles:this.editor.tileManager.getSortedTiles(),map:this.editor.map},t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),i=URL.createObjectURL(t),n=document.createElement("a");n.href=i,n.download="map.json",n.click(),URL.revokeObjectURL(i)}loadFromText(){let e=this.editor.elements.io.value.trim();if(!e){alert("Paste a JSON object first.");return}try{let t=new Function(`return (${e})`)();if(t&&t.mapLayout&&Array.isArray(t.mapLayout)&&Array.isArray(t.mapLayout[0])){this.applyLoadedObject(t);return}}catch(t){console.warn("Object parse failed",t)}alert("Could not parse. Paste a valid JavaScript object with mapLayout.")}loadSampleMapOnly(){let e=k;this.applyLoaded(e,this.editor.tileManager.tiles)}applyLoadedObject(e){if(!e||!e.mapLayout||!Array.isArray(e.mapLayout)||!Array.isArray(e.mapLayout[0])){alert("Invalid map data - missing or invalid mapLayout");return}let t=e.mapLayout;this.editor.height=t.length,this.editor.width=t[0].length,this.editor.map=m(this.editor.width,this.editor.height,0);for(let i=0;i<this.editor.height;i++)for(let n=0;n<this.editor.width;n++)this.editor.map[i][n]=l(t[i][n],0,255);if(e.startPos&&typeof e.startPos.x=="number"&&typeof e.startPos.y=="number"){let i=e.startPos.x|0,n=e.startPos.y|0;i>=0&&i<this.editor.width&&n>=0&&n<this.editor.height&&(this.editor.map[n][i]=u.PLAYER_START)}if(e.exitPos&&typeof e.exitPos.x=="number"&&typeof e.exitPos.y=="number"){let i=e.exitPos.x,n=e.exitPos.y;i>=0&&i<this.editor.width&&n>=0&&n<this.editor.height&&(this.editor.map[n][i]=u.PLAYER_EXIT)}this.editor.elements.wInput.value=String(this.editor.width),this.editor.elements.hInput.value=String(this.editor.height),e.name&&this.editor.elements.mapNameInput&&(this.editor.elements.mapNameInput.value=e.name),e.tiles&&Array.isArray(e.tiles)&&this.editor.tileManager.updateTiles(e.tiles),e.zones&&Array.isArray(e.zones)&&this.editor.zoneManager&&this.editor.zoneManager.importZones(e.zones),this.editor.render(),x("Loaded")}applyLoaded(e,t){if(!e||!Array.isArray(e)||!Array.isArray(e[0])){alert("Invalid map data");return}this.editor.height=e.length,this.editor.width=e[0].length,this.editor.map=m(this.editor.width,this.editor.height,0);for(let i=0;i<this.editor.height;i++)for(let n=0;n<this.editor.width;n++)this.editor.map[i][n]=l(e[i][n],0,255);this.editor.elements.wInput.value=String(this.editor.width),this.editor.elements.hInput.value=String(this.editor.height),t&&Array.isArray(t)&&this.editor.tileManager.updateTiles(t),this.editor.render(),x("Loaded")}};var M=class{constructor(e){this.editor=e,this.zones=[],this.selectedZoneId=null,this.isCreating=!1,this.creationStart=null,this.creationEnd=null,this.isDragging=!1,this.isResizing=!1,this.resizeHandle=null,this.dragOffset={x:0,y:0},this.defaultZone={color:"#271810",cielingColorFront:"#271810",cielingColorBack:"#271810",floorColorBack:"#101b2e",fogColor:"#101b2e"}}createZone(e,t,i,n){let s={id:this.zones.length,x:Math.min(e,e+i),y:Math.min(t,t+n),w:Math.abs(i),h:Math.abs(n),...this.defaultZone},o=this.zones.length>0?1:0;return this.zones.splice(o,0,s),this.selectedZoneId=s.id,this.reassignZoneIds(),s}addNewZone(){let e=Math.floor(this.editor.width/4),t=Math.floor(this.editor.height/4),i=Math.floor(this.editor.width/8),n=Math.floor(this.editor.height/8);return this.createZone(e,t,i,n)}reassignZoneIds(){if(this.zones.forEach((e,t)=>{e.id=t}),this.selectedZoneId!==null){let e=this.zones.find((t,i)=>this.selectedZoneId===i||t===this.getSelectedZone());e&&(this.selectedZoneId=this.zones.indexOf(e))}}deleteZone(e){let t=this.zones.findIndex(i=>i.id===e);return t!==-1?(this.zones.splice(t,1),this.selectedZoneId===e&&(this.selectedZoneId=null),this.reassignZoneIds(),!0):!1}deleteSelectedZone(){return this.deleteZone(this.selectedZoneId)}getZone(e){return this.zones.find(t=>t.id===e)}getSelectedZone(){return this.selectedZoneId!==null?this.getZone(this.selectedZoneId):null}updateZone(e,t){let i=this.getZone(e);return i?(Object.assign(i,t),i.x=l(i.x,0,this.editor.width-1),i.y=l(i.y,0,this.editor.height-1),i.w=l(i.w,1,this.editor.width-i.x),i.h=l(i.h,1,this.editor.height-i.y),!0):!1}selectZone(e){return this.zones.find(t=>t.id===e)?(this.selectedZoneId=e,!0):!1}deselectZone(){this.selectedZoneId=null}getZoneAt(e,t){for(let i=0;i<this.zones.length;i++){let n=this.zones[i];if(e>=n.x&&e<n.x+n.w&&t>=n.y&&t<n.y+n.h)return n}return null}getResizeHandle(e,t){let i=this.getSelectedZone();if(!i)return null;let n=.3;if(Math.abs(e-i.x)<=n&&Math.abs(t-i.y)<=n)return"nw";if(Math.abs(e-(i.x+i.w))<=n&&Math.abs(t-i.y)<=n)return"ne";if(Math.abs(e-i.x)<=n&&Math.abs(t-(i.y+i.h))<=n)return"sw";if(Math.abs(e-(i.x+i.w))<=n&&Math.abs(t-(i.y+i.h))<=n)return"se";if(t>=i.y&&t<=i.y+i.h){if(Math.abs(e-i.x)<=n)return"w";if(Math.abs(e-(i.x+i.w))<=n)return"e"}if(e>=i.x&&e<=i.x+i.w){if(Math.abs(t-i.y)<=n)return"n";if(Math.abs(t-(i.y+i.h))<=n)return"s"}return null}startCreation(e,t){this.isCreating=!0,this.creationStart={x:e,y:t},this.creationEnd={x:e,y:t},this.deselectZone()}updateCreation(e,t){this.isCreating&&(this.creationEnd={x:e,y:t})}finishCreation(){if(this.isCreating&&this.creationStart&&this.creationEnd){let e=this.creationStart.x,t=this.creationStart.y,i=this.creationEnd.x-this.creationStart.x,n=this.creationEnd.y-this.creationStart.y;Math.abs(i)>=1&&Math.abs(n)>=1&&this.createZone(e,t,i,n),this.isCreating=!1,this.creationStart=null,this.creationEnd=null}}cancelCreation(){this.isCreating=!1,this.creationStart=null,this.creationEnd=null}startDrag(e,t){let i=this.getSelectedZone();i&&(this.isDragging=!0,this.dragOffset={x:e-i.x,y:t-i.y})}updateDrag(e,t){if(this.isDragging){let i=this.getSelectedZone();i&&this.updateZone(i.id,{x:e-this.dragOffset.x,y:t-this.dragOffset.y})}}endDrag(){this.isDragging=!1,this.dragOffset={x:0,y:0}}startResize(e){this.isResizing=!0,this.resizeHandle=e}updateResize(e,t){if(this.isResizing&&this.resizeHandle){let i=this.getSelectedZone();if(!i)return;let n={};switch(this.resizeHandle){case"nw":n={x:e,y:t,w:i.w+(i.x-e),h:i.h+(i.y-t)};break;case"ne":n={y:t,w:e-i.x,h:i.h+(i.y-t)};break;case"sw":n={x:e,w:i.w+(i.x-e),h:t-i.y};break;case"se":n={w:e-i.x,h:t-i.y};break;case"n":n={y:t,h:i.h+(i.y-t)};break;case"s":n={h:t-i.y};break;case"w":n={x:e,w:i.w+(i.x-e)};break;case"e":n={w:e-i.x};break}this.updateZone(i.id,n)}}endResize(){this.isResizing=!1,this.resizeHandle=null}exportZones(){let e=this.zones.map(t=>({color:t.color,x:t.x,y:t.y,w:t.w,h:t.h,cielingColorFront:t.cielingColorFront,cielingColorBack:t.cielingColorBack,floorColorBack:t.floorColorBack,fogColor:t.fogColor}));return(e.length===0||e[0].color!=="#101b2e")&&e.unshift({color:"#101b2e",x:0,y:0,w:0,h:0}),e}importZones(e){this.zones=[],this.selectedZoneId=null,Array.isArray(e)&&e.forEach((t,i)=>{let n={id:i,x:l(t.x||0,0,this.editor.width-1),y:l(t.y||0,0,this.editor.height-1),w:l(t.w||1,1,this.editor.width),h:l(t.h||1,1,this.editor.height),color:t.color||this.defaultZone.color,cielingColorFront:t.cielingColorFront||this.defaultZone.cielingColorFront,cielingColorBack:t.cielingColorBack||this.defaultZone.cielingColorBack,floorColorBack:t.floorColorBack||this.defaultZone.floorColorBack,fogColor:t.fogColor||this.defaultZone.fogColor};this.zones.push(n)})}moveZone(e,t){let i=this.zones.findIndex(s=>s.id===e);if(i===-1||t<0||t>=this.zones.length)return!1;let n=this.zones.splice(i,1)[0];return this.zones.splice(t,0,n),this.reassignZoneIds(),!0}moveZoneUp(e){let t=this.zones.findIndex(i=>i.id===e);return t>0?this.moveZone(e,t-1):!1}moveZoneDown(e){let t=this.zones.findIndex(i=>i.id===e);return t>=0&&t<this.zones.length-1?this.moveZone(e,t+1):!1}getZoneIndex(e){return this.zones.findIndex(t=>t.id===e)}getZoneDisplayInfo(){return this.zones.map((e,t)=>({id:e.id,index:t,priority:t+1,name:`Zone ${e.id} (${e.x},${e.y} - ${e.w}x${e.h})`,color:e.color,bounds:`${e.x},${e.y} - ${e.w}x${e.h}`,selected:e.id===this.selectedZoneId}))}clear(){this.zones=[],this.selectedZoneId=null}};var S=class{constructor(e,t){this.canvasContext=e,this.editor=t}drawZones(e="zone"){!this.editor.zoneManager||this.editor.zoneManager.zones.length===0||(this.canvasContext.save(),this.editor.zoneManager.zones.forEach(t=>{this.drawZone(t,e)}),this.editor.zoneManager.isCreating&&e==="zone"&&this.drawCreationPreview(),e==="zone"&&this.drawSelectionHandles(),this.canvasContext.restore())}drawZone(e,t){let i=this.editor.cellSize,n=e.x*i,s=e.y*i,o=e.w*i,a=e.h*i,c=t==="tile"?.15:.3;this.canvasContext.fillStyle=this.hexToRgba(e.color,c),this.canvasContext.fillRect(n,s,o,a);let r=t==="tile"?.25:.6;this.canvasContext.strokeStyle=this.hexToRgba(e.color,r),this.canvasContext.lineWidth=t==="tile"?1:2,this.canvasContext.strokeRect(n+.5,s+.5,o-1,a-1),t==="zone"&&this.drawZoneLabel(e,n,s,o,a)}drawZoneLabel(e,t,i,n,s){if(n<20||s<20)return;let o=t+n/2,a=i+s/2,r=this.editor.zoneManager.getZoneIndex(e.id)+1;this.canvasContext.fillStyle="rgba(0, 0, 0, 0.7)";let h=`#${e.id}:${r}`,Z=this.canvasContext.measureText(h).width+8,B=16;this.canvasContext.fillRect(o-Z/2,a-B/2,Z,B),this.canvasContext.fillStyle="white",this.canvasContext.font="11px monospace",this.canvasContext.textAlign="center",this.canvasContext.textBaseline="middle",this.canvasContext.fillText(h,o,a),r<=3&&this.drawPriorityIndicator(e,t,i,r)}drawPriorityIndicator(e,t,i,n){let o=["#ff0000","#ff8800","#ffff00"];this.canvasContext.fillStyle=o[n-1]||"#ffff00",this.canvasContext.fillRect(t+2,i+2,8,8),this.canvasContext.strokeStyle="#000000",this.canvasContext.lineWidth=1,this.canvasContext.strokeRect(t+2,i+2,8,8),this.canvasContext.fillStyle="#000000",this.canvasContext.font="8px monospace",this.canvasContext.textAlign="center",this.canvasContext.textBaseline="middle",this.canvasContext.fillText(n.toString(),t+2+8/2,i+2+8/2)}drawCreationPreview(){let e=this.editor.zoneManager;if(!e.creationStart||!e.creationEnd)return;let t=this.editor.cellSize,i=Math.min(e.creationStart.x,e.creationEnd.x),n=Math.min(e.creationStart.y,e.creationEnd.y),s=Math.max(e.creationStart.x,e.creationEnd.x),o=Math.max(e.creationStart.y,e.creationEnd.y),a=i*t,c=n*t,r=(s-i)*t,h=(o-n)*t;this.canvasContext.strokeStyle="rgba(255, 255, 255, 0.8)",this.canvasContext.lineWidth=2,this.canvasContext.setLineDash([5,5]),this.canvasContext.strokeRect(a+1,c+1,r-2,h-2),this.canvasContext.setLineDash([]),this.canvasContext.fillStyle="rgba(255, 255, 255, 0.1)",this.canvasContext.fillRect(a,c,r,h)}drawSelectionHandles(){let e=this.editor.zoneManager.getSelectedZone();if(!e)return;let t=this.editor.cellSize,i=e.x*t,n=e.y*t,s=e.w*t,o=e.h*t,a=8,c=a/2,r=[{x:i,y:n,type:"nw"},{x:i+s,y:n,type:"ne"},{x:i,y:n+o,type:"sw"},{x:i+s,y:n+o,type:"se"},{x:i+s/2,y:n,type:"n"},{x:i+s/2,y:n+o,type:"s"},{x:i,y:n+o/2,type:"w"},{x:i+s,y:n+o/2,type:"e"}];this.canvasContext.strokeStyle="#ffffff",this.canvasContext.lineWidth=2,this.canvasContext.strokeRect(i,n,s,o),r.forEach(h=>{this.canvasContext.fillStyle="#ffffff",this.canvasContext.fillRect(h.x-c,h.y-c,a,a),this.canvasContext.strokeStyle="#000000",this.canvasContext.lineWidth=1,this.canvasContext.strokeRect(h.x-c,h.y-c,a,a)})}getCursorForPosition(e,t){if(!this.editor.zoneManager)return"default";let i=this.editor.zoneManager.getResizeHandle(e,t);return i?this.getCursorForHandle(i):this.editor.zoneManager.getZoneAt(e,t)?"move":"crosshair"}getCursorForHandle(e){switch(e){case"nw":case"se":return"nw-resize";case"ne":case"sw":return"ne-resize";case"n":case"s":return"ns-resize";case"e":case"w":return"ew-resize";default:return"default"}}hexToRgba(e,t){e=e.replace("#","");let i=parseInt(e.substring(0,2),16),n=parseInt(e.substring(2,4),16),s=parseInt(e.substring(4,6),16);return`rgba(${i}, ${n}, ${s}, ${t})`}clear(){}};var E=class{constructor(){console.log("In editor code"),this.width=20,this.height=20,this.cellSize=16,this.showGrid=!0,this.activeId=1,this.map=m(this.width,this.height,0),this.currentMode="tile",this.renderer=null,this.undoManager=null,this.tileManager=null,this.exportImport=null,this.zoneManager=null,this.zoneRenderer=null,this.painting=!1,this.strokeChanges=null,this.idBuffer="",this.elements={},this.initializeDOM(),this.initializeComponents(),this.bindEvents(),this.render()}initializeDOM(){this.elements={canvas:document.getElementById("editor"),wInput:document.getElementById("w"),hInput:document.getElementById("h"),cellInput:document.getElementById("cell"),maxIdInput:document.getElementById("maxId"),activeIdInput:document.getElementById("activeId"),activeBadge:document.getElementById("activeBadge"),palListEl:document.getElementById("palList"),statusEl:document.getElementById("status"),io:document.getElementById("io"),gridBtn:document.getElementById("gridBtn"),mapNameInput:document.getElementById("mapName"),modeBtn:document.getElementById("modeBtn"),tilePanel:document.getElementById("tilePanel"),zonePanel:document.getElementById("zonePanel"),noZoneSelected:document.getElementById("noZoneSelected"),zoneEditor:document.getElementById("zoneEditor"),zoneId:document.getElementById("zoneId"),zoneX:document.getElementById("zoneX"),zoneY:document.getElementById("zoneY"),zoneW:document.getElementById("zoneW"),zoneH:document.getElementById("zoneH"),zoneColor:document.getElementById("zoneColor"),zoneCeilFront:document.getElementById("zoneCeilFront"),zoneCeilBack:document.getElementById("zoneCeilBack"),zoneFloorBack:document.getElementById("zoneFloorBack"),zoneFogColor:document.getElementById("zoneFogColor"),deleteZoneBtn:document.getElementById("deleteZoneBtn"),zoneMiniPanel:document.getElementById("zoneMiniPanel"),zoneMiniList:document.getElementById("zoneMiniList"),zoneLayerList:document.getElementById("zoneLayerList"),addZoneBtn:document.getElementById("addZoneBtn")},this.elements.wInput.value=String(this.width),this.elements.hInput.value=String(this.height),this.elements.cellInput.value=String(this.cellSize),this.elements.maxIdInput.value="7"}initializeComponents(){this.renderer=new z(this.elements.canvas,this),this.undoManager=new I,this.undoManager.setEditor(this),this.tileManager=new v(this,g),this.exportImport=new C(this),this.zoneManager=new M(this),this.zoneRenderer=new S(this.renderer.canvasContext,this),this.setActiveId(1)}bindEvents(){document.getElementById("genBtn").onclick=()=>this.tileManager.generateIds(),document.getElementById("resetNamesBtn").onclick=()=>this.tileManager.autoNameTiles(),document.getElementById("seedWolf3dBtn").onclick=()=>this.tileManager.seedFromUserSample(),document.getElementById("resizeBtn").onclick=()=>this.handleResize(),document.getElementById("clearBtn").onclick=()=>this.clearMap(),document.getElementById("fillBtn").onclick=()=>this.fillMap(),document.getElementById("gridBtn").onclick=()=>this.toggleGrid(),document.getElementById("undoBtn").onclick=()=>this.undoManager.undo(),document.getElementById("redoBtn").onclick=()=>this.undoManager.redo(),document.getElementById("loadArrayBtn").onclick=()=>this.exportImport.loadFromText(),document.getElementById("loadSampleBtn").onclick=()=>this.exportImport.loadSampleMapOnly(),document.getElementById("exportTsBtn").onclick=()=>this.exportImport.exportJS(),document.getElementById("copyTsBtn").onclick=()=>this.exportImport.copyJS(),document.getElementById("downloadTsBtn").onclick=()=>this.exportImport.downloadJS(),document.getElementById("downloadJsonBtn").onclick=()=>this.exportImport.downloadJSON(),this.elements.modeBtn.onclick=()=>this.toggleMode(),this.elements.addZoneBtn.onclick=()=>this.addNewZone(),this.elements.deleteZoneBtn.onclick=()=>this.deleteSelectedZone(),this.elements.zoneX.oninput=()=>this.updateSelectedZoneFromInputs(),this.elements.zoneY.oninput=()=>this.updateSelectedZoneFromInputs(),this.elements.zoneW.oninput=()=>this.updateSelectedZoneFromInputs(),this.elements.zoneH.oninput=()=>this.updateSelectedZoneFromInputs(),this.elements.zoneColor.oninput=()=>this.updateSelectedZoneFromInputs(),this.elements.zoneCeilFront.oninput=()=>this.updateSelectedZoneFromInputs(),this.elements.zoneCeilBack.oninput=()=>this.updateSelectedZoneFromInputs(),this.elements.zoneCeilFront.oninput=()=>this.updateSelectedZoneFromInputs(),this.elements.zoneFloorBack.oninput=()=>this.updateSelectedZoneFromInputs(),this.elements.zoneFogColor.oninput=()=>this.updateSelectedZoneFromInputs(),this.elements.activeIdInput.oninput=()=>{this.setActiveId(l(this.elements.activeIdInput.value,0,255))},this.elements.cellInput.addEventListener("input",()=>this.renderer.syncCanvasSize()),document.addEventListener("keydown",e=>this.handleKeyDown(e)),this.bindCanvasEvents()}bindCanvasEvents(){let e=this.elements.canvas;e.addEventListener("mousemove",t=>this.handleMouseMove(t)),e.addEventListener("mousedown",t=>this.handleMouseDown(t)),e.addEventListener("mouseup",()=>this.endStroke()),e.addEventListener("mouseleave",()=>this.endStroke()),e.addEventListener("contextmenu",t=>t.preventDefault())}handleKeyDown(e){if(e.ctrlKey&&!e.shiftKey&&e.key.toLowerCase()==="z"){e.preventDefault(),this.undoManager.undo();return}if(e.ctrlKey&&e.key.toLowerCase()==="y"){e.preventDefault(),this.undoManager.redo();return}if(!(document.activeElement&&["INPUT","TEXTAREA"].includes(document.activeElement.tagName))){if(e.key.toLowerCase()==="e"){this.setActiveId(-1),this.status("Selected: infoPlayerStart (E)");return}if(e.key.toLowerCase()==="x"){this.setActiveId(-2),this.status("Selected: infoPlayerExit (X)");return}if(/^[0-9]$/.test(e.key)&&(this.idBuffer+=e.key,this.idBuffer.length>3&&(this.idBuffer=this.idBuffer.slice(-3)),this.status(`ID input: ${this.idBuffer}`)),e.key==="Enter"&&this.idBuffer){let t=this.tileManager.tiles.length?this.tileManager.tiles[this.tileManager.tiles.length-1].id:255;this.setActiveId(l(this.idBuffer,0,t)),this.idBuffer=""}}}handleMouseMove(e){let t=this.renderer.cellFromEvent(e);if(t.x>=0&&t.y>=0&&t.x<this.width&&t.y<this.height)if(this.currentMode==="zone")this.handleZoneMouseMove(t);else{let n=this.map[t.y][t.x];this.status(`(x:${t.x}, y:${t.y}) id:${n}`),this.painting&&this.paintCell(t.x,t.y,this.activeId)}}handleMouseDown(e){e.preventDefault();let t=this.renderer.cellFromEvent(e);if(!(t.x<0||t.y<0||t.x>=this.width||t.y>=this.height))if(this.currentMode==="zone")this.handleZoneMouseDown(t,e);else{if(e.button===2){let i=this.map[t.y][t.x];this.setActiveId(i);return}this.painting=!0,this.strokeChanges=[],this.paintCell(t.x,t.y,this.activeId)}}endStroke(){this.painting&&(this.painting=!1,this.undoManager.pushUndo(this.strokeChanges,this.map),this.strokeChanges=null),this.currentMode==="zone"&&this.zoneManager&&(this.zoneManager.finishCreation(),this.zoneManager.endDrag(),this.zoneManager.endResize(),this.updateZoneUI(),this.updateZoneMiniPanel(),this.render())}handleZoneMouseMove(e){let t=e.x,i=e.y;if(this.zoneRenderer){let s=this.zoneRenderer.getCursorForPosition(t,i);this.elements.canvas.style.cursor=s}this.zoneManager.isCreating?(this.zoneManager.updateCreation(t,i),this.render()):this.zoneManager.isDragging?(this.zoneManager.updateDrag(t,i),this.render()):this.zoneManager.isResizing&&(this.zoneManager.updateResize(t,i),this.render());let n=this.zoneManager.getZoneAt(t,i);n?this.status(`Zone #${n.id} (x:${t}, y:${i}) ${n.w}x${n.h}`):this.status(`(x:${t}, y:${i}) - Zone Mode`)}handleZoneMouseDown(e,t){let i=e.x,n=e.y;if(t.button===2){let o=this.zoneManager.getZoneAt(i,n);o&&(this.zoneManager.deleteZone(o.id),this.updateZoneUI(),this.updateZoneMiniPanel(),this.render(),this.status(`Deleted zone #${o.id}`));return}let s=this.zoneManager.getResizeHandle(i,n);if(s)this.zoneManager.startResize(s),this.status(`Resizing zone #${this.zoneManager.getSelectedZone().id}`);else{let o=this.zoneManager.getZoneAt(i,n);o?(this.zoneManager.selectZone(o.id),this.zoneManager.startDrag(i,n),this.status(`Selected zone #${o.id} - drag to move`),this.updateZoneUI()):(this.zoneManager.startCreation(i,n),this.status("Creating zone - drag to set size"))}this.render()}paintCell(e,t,i){let n=this.map[t][e];n!==i&&(this.map[t][e]=i,this.strokeChanges.push({x:e,y:t,prev:n,next:i}),this.renderer.drawCell(e,t))}setActiveId(e){e===-1||e===-2?this.activeId=e:this.activeId=l(e,0,255),this.elements.activeIdInput.value=String(this.activeId),this.elements.activeBadge.textContent=`ID ${this.activeId}`;let t=this.tileManager.tiles.find(i=>i.id===this.activeId);this.elements.activeBadge.style.background=t?t.color:"transparent"}handleResize(){let e=l(this.elements.wInput.value,1,256),t=l(this.elements.hInput.value,1,256),i=l(this.elements.cellInput.value,2,48),n=m(e,t,0);for(let s=0;s<Math.min(this.height,t);s++)for(let o=0;o<Math.min(this.width,e);o++)n[s][o]=this.map[s][o];this.width=e,this.height=t,this.cellSize=i,this.map=n,this.render()}clearMap(){this.undoManager.pushUndo([],this.map),this.fillMapWithValue(0),this.render()}fillMap(){this.undoManager.pushUndo([],this.map),this.fillMapWithValue(this.activeId),this.render()}fillMapWithValue(e){for(let t=0;t<this.height;t++)for(let i=0;i<this.width;i++)this.map[t][i]=e}toggleGrid(){this.showGrid=!this.showGrid,this.elements.gridBtn.textContent=`Grid: ${this.showGrid?"on":"off"}`,this.render()}setMode(e){e!==this.currentMode&&(this.currentMode=e,this.updateModeUI(),this.currentMode==="zone"&&(this.endStroke(),this.zoneManager.cancelCreation()),this.render(),this.status(`Switched to ${e.toUpperCase()} mode`))}toggleMode(){let e=this.currentMode==="tile"?"zone":"tile";this.setMode(e)}updateModeUI(){this.elements.modeBtn.textContent=this.currentMode==="tile"?"MODE: TILE EDIT":"MODE: ZONE EDIT",this.currentMode==="zone"?(this.elements.tilePanel.style.display="none",this.elements.zonePanel.style.display="block",this.elements.zoneMiniPanel.style.display="none"):(this.elements.tilePanel.style.display="block",this.elements.zonePanel.style.display="none",this.updateZoneMiniPanel()),this.updateCanvasCursor(),this.updateZoneUI()}addNewZone(){if(this.zoneManager){let e=this.zoneManager.addNewZone();this.status(`Created zone #${e.id}`),this.updateZoneUI(),this.updateZoneMiniPanel(),this.render()}}deleteSelectedZone(){if(this.zoneManager&&this.zoneManager.selectedZoneId!==null){let e=this.zoneManager.selectedZoneId;this.zoneManager.deleteSelectedZone(),this.status(`Deleted zone #${e}`),this.updateZoneUI(),this.render()}}updateSelectedZoneFromInputs(){let e=this.zoneManager?.getSelectedZone();if(!e||this._updatingZoneUI)return;let t={x:l(parseInt(this.elements.zoneX.value)||0,0,this.width-1),y:l(parseInt(this.elements.zoneY.value)||0,0,this.height-1),w:l(parseInt(this.elements.zoneW.value)||1,1,this.width),h:l(parseInt(this.elements.zoneH.value)||1,1,this.height),color:this.elements.zoneColor.value,cielingColorFront:this.elements.zoneCeilFront.value,cielingColorBack:this.elements.zoneCeilBack.value,floorColorBack:this.elements.zoneFloorBack.value,fogColor:this.elements.zoneFogColor.value};this.zoneManager.updateZone(e.id,t),this.render(),this.updateZoneMiniPanel()}updateZoneUI(){if(this.currentMode!=="zone"||!this.zoneManager)return;this.updateZoneLayerPanel();let e=this.zoneManager.getSelectedZone();e?(this.elements.noZoneSelected.style.display="none",this.elements.zoneEditor.style.display="block",this._updatingZoneUI=!0,this.elements.zoneId.textContent=e.id,this.elements.zoneX.value=e.x,this.elements.zoneY.value=e.y,this.elements.zoneW.value=e.w,this.elements.zoneH.value=e.h,this.elements.zoneColor.value=e.color,this.elements.zoneCeilFront.value=e.cielingColorFront,this.elements.zoneCeilBack.value=e.cielingColorBack,this.elements.zoneFloorBack.value=e.floorColorBack,this.elements.zoneFogColor.value=e.fogColor,this._updatingZoneUI=!1):(this.elements.noZoneSelected.style.display="block",this.elements.zoneEditor.style.display="none")}updateZoneLayerPanel(){if(!this.zoneManager||this.currentMode!=="zone")return;let e=this.zoneManager.getZoneDisplayInfo();if(this.elements.zoneLayerList.innerHTML="",e.length===0){let t=document.createElement("div");t.className="zone-empty-message",t.textContent="No zones created",this.elements.zoneLayerList.appendChild(t);return}e.forEach((t,i)=>{let n=document.createElement("div");n.className=`zone-layer-item ${t.selected?"selected":""}`,n.dataset.zoneId=t.id,n.draggable=!0,n.innerHTML=`
        <div class="zone-layer-color" style="background-color: ${t.color}"></div>
        <div class="zone-layer-priority">${t.priority}</div>
        <div class="zone-layer-info">${t.name}</div>
        <div class="zone-layer-controls">
          <button class="zone-layer-btn" data-action="up" ${i===0?"disabled":""}>\u2191</button>
          <button class="zone-layer-btn" data-action="down" ${i===e.length-1?"disabled":""}>\u2193</button>
        </div>
      `,n.addEventListener("click",s=>{if(s.target.classList.contains("zone-layer-btn")){let o=s.target.dataset.action;o==="up"?this.zoneManager.moveZoneUp(t.id):o==="down"&&this.zoneManager.moveZoneDown(t.id),this.updateZoneUI(),this.render(),s.stopPropagation()}else this.zoneManager.selectZone(t.id),this.updateZoneUI(),this.render()}),n.addEventListener("dragstart",s=>{s.dataTransfer.setData("text/plain",t.id.toString()),n.classList.add("dragging"),this.elements.zoneLayerList.classList.add("drag-active")}),n.addEventListener("dragend",()=>{n.classList.remove("dragging"),this.elements.zoneLayerList.classList.remove("drag-active")}),n.addEventListener("dragover",s=>{s.preventDefault()}),n.addEventListener("drop",s=>{s.preventDefault();let o=parseInt(s.dataTransfer.getData("text/plain")),a=Array.from(this.elements.zoneLayerList.children).indexOf(n);o!==t.id&&(this.zoneManager.moveZone(o,a),this.updateZoneUI(),this.render())}),this.elements.zoneLayerList.appendChild(n)})}updateZoneMiniPanel(){if(this.currentMode==="zone"||!this.zoneManager){this.elements.zoneMiniPanel.style.display="none";return}let e=this.zoneManager.zones;if(e.length===0){this.elements.zoneMiniPanel.style.display="none";return}this.elements.zoneMiniPanel.style.display="block",this.elements.zoneMiniList.innerHTML="",e.forEach(t=>{let i=document.createElement("div");i.className="zone-mini-item",i.textContent=`#${t.id}`,i.style.backgroundColor=t.color,i.title=`Zone ${t.id}: ${t.x},${t.y} (${t.w}x${t.h})`,this.elements.zoneMiniList.appendChild(i)})}updateCanvasCursor(){if(this.currentMode==="zone"&&this.zoneRenderer){let e=this.elements.canvas;e.style.cursor="crosshair"}else this.elements.canvas.style.cursor="default"}status(e){this.elements.statusEl.textContent=e}render(){if(this.renderer.draw(),this.zoneRenderer){let e=this.currentMode==="zone"?"zone":"tile";this.zoneRenderer.drawZones(e)}this.currentMode==="zone"&&this.updateZoneLayerPanel()}};new E;export{E as MapEditor};
