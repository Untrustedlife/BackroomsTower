import{a as w}from"../../chunks/chunk-B3G4DJQ2.js";var u=[{id:0,name:"empty",color:"#0b1020"},{id:1,name:"backroomswall",color:"#ECDE60"},{id:2,name:"panel",color:"#707a88"},{id:3,name:"hedge",color:"#00e676"},{id:4,name:"door",color:"#996633"},{id:5,name:"exit",color:"#FFE300"},{id:6,name:"blue_door",color:"#3561ff"},{id:7,name:"[NODEOSERROR] Flesh",color:"#FE6660"},{id:-1,name:"infoPlayerStart",color:"#00FF00"},{id:-2,name:"infoPlayerExit",color:"#FF0000"}],c={PLAYER_START:-1,PLAYER_EXIT:-2},g=[-1,-2],C=[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,2,6,2,0,0,0,0,0,0,0,2,6,2,0,0,1],[1,0,0,0,2,0,2,0,0,0,0,0,0,0,2,0,2,0,0,1],[1,0,0,0,2,2,2,0,0,0,0,0,0,0,2,2,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,5,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,3,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,3,3,1,3,3,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,0,0,0,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,2,2,2,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,1,0,2,0,2,0,1,0,3,0,0,0,1],[1,0,0,0,0,0,0,0,0,2,6,2,0,0,0,0,0,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]];function m(n,t,e){return Array.from({length:t},()=>Array.from({length:n},()=>e|0))}function A(n,t,e){let i=t/100,s=e/100,o=a=>(a+n/30)%12,l=i*Math.min(s,1-s),r=a=>s-l*Math.max(-1,Math.min(o(a)-3,Math.min(9-o(a),1))),d=a=>`0${Math.round(a*255).toString(16)}`.slice(-2);return`#${d(r(0))}${d(r(8))}${d(r(4))}`}function f(n){let t=n*47%360;return A(t,60,45)}function L(n){return{0:"empty",1:"brick",2:"panel",3:"hedge",4:"door",5:"exit",6:"blue_door",7:"[NODEOSERROR] Flesh"}[n]||`tile_${n}`}function T(n,t,e){let i=t.getBoundingClientRect(),s=Math.floor((n.clientX-i.left)/e),o=Math.floor((n.clientY-i.top)/e);return{x:s,y:o}}function I(n){let t=document.createElement("div");t.textContent=n,t.style.position="fixed",t.style.bottom="14px",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.background="#0b162f",t.style.border="1px solid #294173",t.style.padding="8px 12px",t.style.borderRadius="10px",t.style.boxShadow="0 6px 20px #0007",t.style.zIndex="1000",document.body.appendChild(t),setTimeout(()=>t.remove(),900)}function h(n,t,e){return w(+n|0,t,e)}var y=class{constructor(t,e){this.canvas=t,this.canvasContext=t.getContext("2d",{alpha:!1}),this.canvasContext.imageSmoothingEnabled=!1,this.editor=e}draw(){this.syncCanvasSize(),this.drawAllMapCells(),this.editor.showGrid&&this.editor.cellSize>=6&&this.drawGrid()}drawAllMapCells(){for(let t=0;t<this.editor.height;t++)for(let e=0;e<this.editor.width;e++){let i=this.editor.map[t][e];this.canvasContext.fillStyle=this.colorFor(i),this.canvasContext.fillRect(e*this.editor.cellSize,t*this.editor.cellSize,this.editor.cellSize,this.editor.cellSize)}}drawCell(t,e){let i=this.editor.map[e][t];this.canvasContext.fillStyle=this.colorFor(i),this.canvasContext.fillRect(t*this.editor.cellSize,e*this.editor.cellSize,this.editor.cellSize,this.editor.cellSize),this.editor.showGrid&&this.editor.cellSize>=6&&this.drawCellGrid(t,e)}drawGrid(){this.canvasContext.strokeStyle="#1e263f",this.canvasContext.lineWidth=1,this.canvasContext.beginPath();for(let t=.5;t<=this.editor.width*this.editor.cellSize;t+=this.editor.cellSize)this.canvasContext.moveTo(t,0),this.canvasContext.lineTo(t,this.editor.height*this.editor.cellSize);for(let t=.5;t<=this.editor.height*this.editor.cellSize;t+=this.editor.cellSize)this.canvasContext.moveTo(0,t),this.canvasContext.lineTo(this.editor.width*this.editor.cellSize,t);this.canvasContext.stroke()}drawCellGrid(t,e){this.canvasContext.strokeStyle="#1e263f",this.canvasContext.strokeRect(t*this.editor.cellSize+.5,e*this.editor.cellSize+.5,this.editor.cellSize-1,this.editor.cellSize-1)}colorFor(t){let e=this.editor.tileManager.tiles.find(i=>i.id===t);return e?e.color:"#000000"}syncCanvasSize(){this.canvas.width=this.editor.width*this.editor.cellSize,this.canvas.height=this.editor.height*this.editor.cellSize,this.canvasContext.imageSmoothingEnabled=!1}cellFromEvent(t){return T(t,this.canvas,this.editor.cellSize)}};var x=class{constructor(){this.undoStack=[],this.redoStack=[],this.editor=null}setEditor(t){this.editor=t}pushUndo(t,e){if(!t||!t.length){if(e&&this.editor){let i={type:"full",width:this.editor.width,height:this.editor.height,map:e.map(s=>[...s])};this.undoStack.push(i)}}else this.undoStack.push({type:"stroke",changes:[...t]});this.undoStack.length>300&&this.undoStack.shift(),this.redoStack.length=0}undo(){if(!this.undoStack.length||!this.editor)return;let t=this.undoStack.pop();if(t.type==="stroke"){let e=t.changes.map(i=>({x:i.x,y:i.y,prev:i.next,next:i.prev}));this.redoStack.push({type:"stroke",changes:e});for(let i of t.changes)this.editor.map[i.y][i.x]=i.prev}else if(t.type==="full"){let e={type:"full",width:this.editor.width,height:this.editor.height,map:this.editor.map.map(i=>[...i])};this.redoStack.push(e),this.editor.width=t.width,this.editor.height=t.height,this.editor.map=t.map.map(i=>[...i]),this.editor.elements.wInput.value=String(this.editor.width),this.editor.elements.hInput.value=String(this.editor.height)}this.editor.render()}redo(){if(!this.redoStack.length||!this.editor)return;let t=this.redoStack.pop();if(t.type==="stroke"){let e=t.changes.map(i=>({x:i.x,y:i.y,prev:i.next,next:i.prev}));this.undoStack.push({type:"stroke",changes:e});for(let i of t.changes)this.editor.map[i.y][i.x]=i.next}else if(t.type==="full"){let e={type:"full",width:this.editor.width,height:this.editor.height,map:this.editor.map.map(i=>[...i])};this.undoStack.push(e),this.editor.width=t.width,this.editor.height=t.height,this.editor.map=t.map.map(i=>[...i]),this.editor.elements.wInput.value=String(this.editor.width),this.editor.elements.hInput.value=String(this.editor.height)}this.editor.render()}clear(){this.undoStack.length=0,this.redoStack.length=0}};var v=class{constructor(t,e=u){this.editor=t,this.tiles=[...e],this.renderPalette()}generateIds(){let t=h(this.editor.elements.maxIdInput.value,0,255),e=[],i=u.filter(s=>g.includes(s.id));for(let s of i){let o=this.tiles.find(l=>l.id===s.id);e.push(o||{...s})}for(let s=0;s<=t;s++){let o=this.tiles.find(l=>l.id===s);e.push(o||{id:s,name:`tile_${s}`,color:f(s)})}this.tiles=e,this.renderPalette(),this.editor.render()}autoNameTiles(){this.tiles=this.tiles.map(t=>({...t,name:L(t.id)})),this.renderPalette()}seedFromUserSample(){this.tiles=[...u],this.editor.elements.maxIdInput.value="7",this.renderPalette(),this.editor.render()}renderPalette(){let t=this.editor.elements.palListEl;t.innerHTML="";let e=[...this.tiles].sort((i,s)=>i.id-s.id);for(let i of e){let s=this.createPaletteRow(i);t.appendChild(s)}this.updateActiveBadgeColor()}createPaletteRow(t){let e=document.createElement("div");e.className="palItem";let i=document.createElement("input");i.type="color",i.value=t.color,i.oninput=()=>{t.color=i.value,t.id===this.editor.activeId&&this.updateActiveBadgeColor(),this.editor.render()};let s=document.createElement("div");s.className="palMeta";let o=document.createElement("div");o.className="idBadge",o.textContent=String(t.id),o.title="Select this tile",o.onclick=()=>this.editor.setActiveId(t.id);let l=document.createElement("input");l.placeholder=`tile_${t.id}`,l.value=t.name||"",l.oninput=()=>{t.name=l.value.trim()||`tile_${t.id}`};let r=document.createElement("button");return r.textContent="\xD7",r.title="Remove (only if not last in range)",r.onclick=()=>this.deleteTile(t),(t.id===0||g.includes(t.id))&&(r.style.visibility="hidden"),s.appendChild(o),s.appendChild(l),e.appendChild(i),e.appendChild(s),e.appendChild(r),e}deleteTile(t){if(t.id===0||g.includes(t.id))return;let e=this.tiles[this.tiles.length-1];t.id===e.id?(this.tiles=this.tiles.filter(i=>i.id!==t.id),this.tiles.length>0&&(this.editor.elements.maxIdInput.value=String(e.id-1))):(t.name=`tile_${t.id}`,t.color=f(t.id)),this.renderPalette(),this.editor.render()}updateActiveBadgeColor(){let t=this.tiles.find(e=>e.id===this.editor.activeId);this.editor.elements.activeBadge.style.background=t?t.color:"transparent"}getTile(t){return this.tiles.find(e=>e.id===t)}getSortedTiles(){return[...this.tiles].sort((t,e)=>t.id-e.id)}updateTiles(t){Array.isArray(t)&&t.length&&(this.tiles=[...t].sort((e,i)=>e.id-i.id).map((e,i)=>({id:+e.id|0,name:String(e.name||`tile_${i}`),color:String(e.color||f(+e.id|0))})),this.editor.elements.maxIdInput.value=String(this.tiles[this.tiles.length-1].id),this.renderPalette())}};var S=class{constructor(t){this.editor=t}exportJS(){let t=(this.editor.elements.io.parentElement.querySelector("#jsMapName")?.value||"MAP").replace(/\W+/g,"_"),e=this.editor.elements.mapNameInput?.value||"Untitled",i=null,s=null;for(let r=0;r<this.editor.height;r++)for(let d=0;d<this.editor.width;d++){let a=this.editor.map[r][d];a===c.PLAYER_START?i={x:d+.5,y:r+.5}:a===c.PLAYER_EXIT&&(s={x:d,y:r})}let o=this.editor.map.map(r=>r.map(d=>d===c.PLAYER_START||d===c.PLAYER_EXIT?0:d));i||(i={x:3.5,y:3.5}),s||(s={x:10,y:8});let l=`export const ${t} = {
  name: "${e}",
  mapLayout: [
${o.map(r=>`    [${r.join(", ")}]`).join(`,
`)}
  ],
  exitPos: { x: ${s.x}, y: ${s.y} },
  startPos: { x: ${i.x}, y: ${i.y} },
};`;this.editor.elements.io.value=`${l}
`}async copyJS(){this.editor.elements.io.value||this.exportJS();try{await navigator.clipboard.writeText(this.editor.elements.io.value),I("Copied")}catch{alert("Copy failed")}}downloadJS(){this.editor.elements.io.value||this.exportJS();let t=new Blob([this.editor.elements.io.value],{type:"text/javascript"}),e=URL.createObjectURL(t),i=document.createElement("a");i.href=e,i.download="map.js",i.click(),URL.revokeObjectURL(e)}downloadJSON(){let t={width:this.editor.width,height:this.editor.height,tiles:this.editor.tileManager.getSortedTiles(),map:this.editor.map},e=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),i=URL.createObjectURL(e),s=document.createElement("a");s.href=i,s.download="map.json",s.click(),URL.revokeObjectURL(i)}loadFromText(){let t=this.editor.elements.io.value.trim();if(!t){alert("Paste a JSON object first.");return}try{let e=new Function(`return (${t})`)();if(e&&e.mapLayout&&Array.isArray(e.mapLayout)&&Array.isArray(e.mapLayout[0])){this.applyLoadedObject(e);return}}catch(e){console.warn("Object parse failed",e)}alert("Could not parse. Paste a valid JavaScript object with mapLayout.")}loadSampleMapOnly(){let t=C;this.applyLoaded(t,this.editor.tileManager.tiles)}applyLoadedObject(t){if(!t||!t.mapLayout||!Array.isArray(t.mapLayout)||!Array.isArray(t.mapLayout[0])){alert("Invalid map data - missing or invalid mapLayout");return}let e=t.mapLayout;this.editor.height=e.length,this.editor.width=e[0].length,this.editor.map=m(this.editor.width,this.editor.height,0);for(let i=0;i<this.editor.height;i++)for(let s=0;s<this.editor.width;s++)this.editor.map[i][s]=h(e[i][s],0,255);if(t.startPos&&typeof t.startPos.x=="number"&&typeof t.startPos.y=="number"){let i=Math.floor(t.startPos.x),s=Math.floor(t.startPos.y);i>=0&&i<this.editor.width&&s>=0&&s<this.editor.height&&(this.editor.map[s][i]=c.PLAYER_START)}if(t.exitPos&&typeof t.exitPos.x=="number"&&typeof t.exitPos.y=="number"){let i=t.exitPos.x,s=t.exitPos.y;i>=0&&i<this.editor.width&&s>=0&&s<this.editor.height&&(this.editor.map[s][i]=c.PLAYER_EXIT)}this.editor.elements.wInput.value=String(this.editor.width),this.editor.elements.hInput.value=String(this.editor.height),t.name&&this.editor.elements.mapNameInput&&(this.editor.elements.mapNameInput.value=t.name),t.tiles&&Array.isArray(t.tiles)&&this.editor.tileManager.updateTiles(t.tiles),this.editor.render(),I("Loaded")}applyLoaded(t,e){if(!t||!Array.isArray(t)||!Array.isArray(t[0])){alert("Invalid map data");return}this.editor.height=t.length,this.editor.width=t[0].length,this.editor.map=m(this.editor.width,this.editor.height,0);for(let i=0;i<this.editor.height;i++)for(let s=0;s<this.editor.width;s++)this.editor.map[i][s]=h(t[i][s],0,255);this.editor.elements.wInput.value=String(this.editor.width),this.editor.elements.hInput.value=String(this.editor.height),e&&Array.isArray(e)&&this.editor.tileManager.updateTiles(e),this.editor.render(),I("Loaded")}};var E=class{constructor(){console.log("In editor code"),this.width=20,this.height=20,this.cellSize=16,this.showGrid=!0,this.activeId=1,this.map=m(this.width,this.height,0),this.renderer=null,this.undoManager=null,this.tileManager=null,this.exportImport=null,this.painting=!1,this.strokeChanges=null,this.idBuffer="",this.elements={},this.initializeDOM(),this.initializeComponents(),this.bindEvents(),this.render()}initializeDOM(){this.elements={canvas:document.getElementById("editor"),wInput:document.getElementById("w"),hInput:document.getElementById("h"),cellInput:document.getElementById("cell"),maxIdInput:document.getElementById("maxId"),activeIdInput:document.getElementById("activeId"),activeBadge:document.getElementById("activeBadge"),palListEl:document.getElementById("palList"),statusEl:document.getElementById("status"),io:document.getElementById("io"),gridBtn:document.getElementById("gridBtn"),mapNameInput:document.getElementById("mapName")},this.elements.wInput.value=String(this.width),this.elements.hInput.value=String(this.height),this.elements.cellInput.value=String(this.cellSize),this.elements.maxIdInput.value="7"}initializeComponents(){this.renderer=new y(this.elements.canvas,this),this.undoManager=new x,this.undoManager.setEditor(this),this.tileManager=new v(this,u),this.exportImport=new S(this),this.setActiveId(1)}bindEvents(){document.getElementById("genBtn").onclick=()=>this.tileManager.generateIds(),document.getElementById("resetNamesBtn").onclick=()=>this.tileManager.autoNameTiles(),document.getElementById("seedWolf3dBtn").onclick=()=>this.tileManager.seedFromUserSample(),document.getElementById("resizeBtn").onclick=()=>this.handleResize(),document.getElementById("clearBtn").onclick=()=>this.clearMap(),document.getElementById("fillBtn").onclick=()=>this.fillMap(),document.getElementById("gridBtn").onclick=()=>this.toggleGrid(),document.getElementById("undoBtn").onclick=()=>this.undoManager.undo(),document.getElementById("redoBtn").onclick=()=>this.undoManager.redo(),document.getElementById("loadArrayBtn").onclick=()=>this.exportImport.loadFromText(),document.getElementById("loadSampleBtn").onclick=()=>this.exportImport.loadSampleMapOnly(),document.getElementById("exportTsBtn").onclick=()=>this.exportImport.exportJS(),document.getElementById("copyTsBtn").onclick=()=>this.exportImport.copyJS(),document.getElementById("downloadTsBtn").onclick=()=>this.exportImport.downloadJS(),document.getElementById("downloadJsonBtn").onclick=()=>this.exportImport.downloadJSON(),this.elements.activeIdInput.oninput=()=>{this.setActiveId(h(this.elements.activeIdInput.value,0,255))},this.elements.cellInput.addEventListener("input",()=>this.renderer.syncCanvasSize()),document.addEventListener("keydown",t=>this.handleKeyDown(t)),this.bindCanvasEvents()}bindCanvasEvents(){let t=this.elements.canvas;t.addEventListener("mousemove",e=>this.handleMouseMove(e)),t.addEventListener("mousedown",e=>this.handleMouseDown(e)),t.addEventListener("mouseup",()=>this.endStroke()),t.addEventListener("mouseleave",()=>this.endStroke()),t.addEventListener("contextmenu",e=>e.preventDefault())}handleKeyDown(t){if(t.ctrlKey&&!t.shiftKey&&t.key.toLowerCase()==="z"){t.preventDefault(),this.undoManager.undo();return}if(t.ctrlKey&&t.key.toLowerCase()==="y"){t.preventDefault(),this.undoManager.redo();return}if(!(document.activeElement&&["INPUT","TEXTAREA"].includes(document.activeElement.tagName))){if(t.key.toLowerCase()==="e"){this.setActiveId(-1),this.status("Selected: infoPlayerStart (E)");return}if(t.key.toLowerCase()==="x"){this.setActiveId(-2),this.status("Selected: infoPlayerExit (X)");return}if(/^[0-9]$/.test(t.key)&&(this.idBuffer+=t.key,this.idBuffer.length>3&&(this.idBuffer=this.idBuffer.slice(-3)),this.status(`ID input: ${this.idBuffer}`)),t.key==="Enter"&&this.idBuffer){let e=this.tileManager.tiles.length?this.tileManager.tiles[this.tileManager.tiles.length-1].id:255;this.setActiveId(h(this.idBuffer,0,e)),this.idBuffer=""}}}handleMouseMove(t){let e=this.renderer.cellFromEvent(t),i=e.x>=0&&e.y>=0&&e.x<this.width&&e.y<this.height;if(i){let s=this.map[e.y][e.x];this.status(`(x:${e.x}, y:${e.y}) id:${s}`)}this.painting&&i&&this.paintCell(e.x,e.y,this.activeId)}handleMouseDown(t){t.preventDefault();let e=this.renderer.cellFromEvent(t);if(!(e.x<0||e.y<0||e.x>=this.width||e.y>=this.height)){if(t.button===2){let i=this.map[e.y][e.x];this.setActiveId(i);return}this.painting=!0,this.strokeChanges=[],this.paintCell(e.x,e.y,this.activeId)}}endStroke(){this.painting&&(this.painting=!1,this.undoManager.pushUndo(this.strokeChanges,this.map),this.strokeChanges=null)}paintCell(t,e,i){let s=this.map[e][t];s!==i&&(this.map[e][t]=i,this.strokeChanges.push({x:t,y:e,prev:s,next:i}),this.renderer.drawCell(t,e))}setActiveId(t){t===-1||t===-2?this.activeId=t:this.activeId=h(t,0,255),this.elements.activeIdInput.value=String(this.activeId),this.elements.activeBadge.textContent=`ID ${this.activeId}`;let e=this.tileManager.tiles.find(i=>i.id===this.activeId);this.elements.activeBadge.style.background=e?e.color:"transparent"}handleResize(){let t=h(this.elements.wInput.value,1,256),e=h(this.elements.hInput.value,1,256),i=h(this.elements.cellInput.value,2,48),s=m(t,e,0);for(let o=0;o<Math.min(this.height,e);o++)for(let l=0;l<Math.min(this.width,t);l++)s[o][l]=this.map[o][l];this.width=t,this.height=e,this.cellSize=i,this.map=s,this.render()}clearMap(){this.undoManager.pushUndo([],this.map),this.fillMapWithValue(0),this.render()}fillMap(){this.undoManager.pushUndo([],this.map),this.fillMapWithValue(this.activeId),this.render()}fillMapWithValue(t){for(let e=0;e<this.height;e++)for(let i=0;i<this.width;i++)this.map[e][i]=t}toggleGrid(){this.showGrid=!this.showGrid,this.elements.gridBtn.textContent=`Grid: ${this.showGrid?"on":"off"}`,this.render()}status(t){this.elements.statusEl.textContent=t}render(){this.renderer.draw()}};new E;export{E as MapEditor};
